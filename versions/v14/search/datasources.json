[
{
"id": 1943,
"title": "Data Sources",
"path": "/datasources/index.html",
"content": " Data Sources Data sources represent the various subjects/topics of information that can be collected by sensors/logs. Data sources also include data components, which identify specific properties/values of a data source relevant to detecting a given ATT&CK technique or sub-technique. ID Name Domain Enterprise Mobile ICS Description DS0026 Active Directory Enterprise A database and set of services that allows administrators to manage permissions, access to network resources, and stored data objects (user, group, application, or devices) DS0015 Application Log Enterprise ICS Events collected by third-party services such as mail servers, web applications, or other appliances (not by the native OS or platform) DS0041 Application Vetting Mobile Application vetting report generated by an external cloud service. DS0039 Asset ICS Data sources with information about the set of devices found within the network, along with their current software and configurations DS0037 Certificate Enterprise A digital document, which highlights information such as the owner's identity, used to instill trust in public keys used while encrypting network communications DS0025 Cloud Service Enterprise Infrastructure, platforms, or software that are hosted on-premise or by third-party providers, made available to users through network connections and/or APIs DS0010 Cloud Storage Enterprise Data object storage infrastructure hosted on-premise or by third-party providers, made available to users through network connections and/or APIs DS0017 Command Enterprise Mobile A directive given to a computer program, acting as an interpreter of some kind, in order to perform a specific task DS0032 Container Enterprise A standard unit of virtualized software that packages up code and all its dependencies so the application runs quickly and reliably from one computing environment to another DS0038 Domain Name Enterprise Information obtained (commonly through registration or activity logs) regarding one or more IP addresses registered with human readable names (ex: mitre.org) DS0016 Drive Enterprise A non-volatile data storage device (hard drive, floppy disk, USB flash drive) with at least one formatted partition, typically mounted to the file system and/or assigned a drive letter DS0027 Driver Enterprise A computer program that operates or controls a particular type of device that is attached to a computer. Provides a software interface to hardware devices, enabling operating systems and other computer programs to access hardware functions without needing to know precise details about the hardware being used DS0022 File Enterprise A computer resource object, managed by the I/O system, for storing data (such as images, text, videos, computer programs, or any wide variety of other media). DS0018 Firewall Enterprise A network security system, running locally on an endpoint or remotely as a service (ex: cloud environment), that monitors and controls incoming/outgoing network traffic based on predefined rules DS0001 Firmware Enterprise Computer software that provides low-level control for the hardware and device(s) of a host, such as BIOS or UEFI/EFI DS0036 Group Enterprise A collection of multiple user accounts that share the same access rights to the computer and/or network resources and have common security rights DS0007 Image Enterprise A single file used to deploy a virtual machine/bootable disk into an on-premise or third-party cloud environment DS0030 Instance Enterprise A virtual server environment which runs workloads, hosted on-premise or by third-party cloud providers DS0035 Internet Scan Enterprise Information obtained (commonly via active network traffic probes or web crawling) regarding various types of resources and servers connected to the public Internet DS0008 Kernel Enterprise A computer program, at the core of a computer OS, that resides in memory and facilitates interactions between hardware and software components DS0028 Logon Session Enterprise Logon occurring on a system or resource (local, domain, or cloud) to which a user/device is gaining access after successful authentication and authorization DS0004 Malware Repository Enterprise Information obtained (via shared or submitted samples) regarding malicious software (droppers, backdoors, etc.) used by adversaries DS0011 Module Enterprise Executable files consisting of one or more shared classes and interfaces, such as portable executable (PE) format binaries/dynamic link libraries (DLL), executable and linkable format (ELF) binaries/shared libraries, and Mach-O format binaries/shared libraries DS0023 Named Pipe Enterprise Mechanisms that allow inter-process communication locally or over the network. A named pipe is usually found as a file and processes attach to it DS0033 Network Share Enterprise A storage resource (typically a folder or drive) made available from one host to others using network protocols, such as Server Message Block (SMB) or Network File System (NFS) DS0029 Network Traffic Enterprise Mobile Data transmitted across a network (ex: Web, DNS, Mail, File, etc.), that is either summarized (ex: Netflow) and/or captured as raw data in an analyzable format (ex: PCAP) DS0040 Operational Databases ICS Operational databases contain information about the status of the operational process and associated devices, including any measurements, events, history, or alarms that have occurred DS0021 Persona Enterprise A malicious online profile representing a user commonly used by adversaries to social engineer or otherwise target victims DS0014 Pod Enterprise A single unit of shared resources within a cluster, comprised of one or more containers DS0009 Process Enterprise Mobile Instances of computer programs that are being executed by at least one thread. Processes have memory space for process executables, loaded modules (DLLs or shared libraries), and allocated memory regions containing everything from user input to application-specific data structures DS0003 Scheduled Job Enterprise Automated tasks that can be executed at a specific time or on a recurring schedule running in the background (ex: Cron daemon, task scheduler, BITS) DS0012 Script Enterprise A file or stream containing a list of commands, allowing them to be launched in sequence DS0013 Sensor Health Enterprise Mobile Information from host telemetry providing insights about system status, errors, or other notable functional activity DS0019 Service Enterprise A computer process that is configured to execute continuously in the background and perform system tasks, in some cases before any user has logged in DS0020 Snapshot Enterprise A point-in-time copy of cloud volumes (files, settings, etc.) that can be created and/or deployed in cloud environments DS0002 User Account Enterprise A profile representing a user, device, service, or application used to authenticate and access resources DS0042 User Interface Mobile Visual activity on the device that could alert the user to potentially malicious behavior. DS0034 Volume Enterprise Block object storage hosted on-premise or by third-party providers, typically made available to resources as virtualized hard drives DS0006 Web Credential Enterprise Credential material, such as session cookies or tokens, used to authenticate to web applications and services DS0024 Windows Registry Enterprise ICS A Windows OS hierarchical database that stores much of the information and settings for software programs, hardware devices, user preferences, and operating-system configurations DS0005 WMI Enterprise The infrastructure for management data and operations that enables local and remote management of Windows personal computers and servers "
},
{
"id": 1944,
"title": "Sensor Health, Data Source DS0013",
"path": "/datasources/DS0013/index.html",
"content": " Sensor Health Information from host telemetry providing insights about system status, errors, or other notable functional activity ID: DS0013 \u24d8 Platforms: Android, Linux, Windows, iOS, macOS \u24d8 Collection Layer: Host Contributors: Center for Threat-Informed Defense (CTID) Version: 1.1 Created: 20 October 2021 Last Modified: 20 April 2023 Version Permalink Live Version Data Components This data source does not have any techniques in the selected domain(s) Sensor Health: Host Status Logging, messaging, and other artifacts highlighting the health of host sensors (ex: metrics, errors, and/or exceptions from logging applications) Sensor Health: Host Status Logging, messaging, and other artifacts highlighting the health of host sensors (ex: metrics, errors, and/or exceptions from logging applications) Domain ID Name Detects Mobile T1398 Boot or Logon Initialization Scripts On Android, Verified Boot can detect unauthorized modifications to the system partition.[1] Android's SafetyNet API provides remote attestation capabilities, which could potentially be used to identify and respond to compromise devices. Samsung Knox provides a similar remote attestation capability on supported Samsung devices. Mobile T1645 Compromise Client Software Binary Verified Boot can detect unauthorized modifications to the system partition.[1] Android\u2019s SafetyNet API provides remote attestation capabilities, which could potentially be used to identify and respond to compromised devices. Samsung Knox provides a similar remote attestation capability on supported Samsung devices. Mobile T1634 Credentials from Password Store Mobile security products can potentially detect jailbroken devices. .001 Keychain Mobile security products can potentially detect jailbroken devices. Mobile T1456 Drive-By Compromise Mobile security products can often alert the user if their device is vulnerable to known exploits. Enterprise T1499 Endpoint Denial of Service Detection of Endpoint DoS can sometimes be achieved before the effect is sufficient to cause significant impact to the availability of the service, but such response time typically requires very aggressive monitoring and responsiveness. Monitor for logging, messaging, and other artifacts highlighting the health of host sensors (ex: metrics, errors, and/or exceptions from logging applications) .001 OS Exhaustion Flood Detection of Endpoint DoS can sometimes be achieved before the effect is sufficient to cause significant impact to the availability of the service, but such response time typically requires very aggressive monitoring and responsiveness. Monitor for logging, messaging, and other artifacts highlighting the health of host sensors (ex: metrics, errors, and/or exceptions from logging applications) .002 Service Exhaustion Flood Detection of Endpoint DoS can sometimes be achieved before the effect is sufficient to cause significant impact to the availability of the service, but such response time typically requires very aggressive monitoring and responsiveness. Monitor for logging, messaging, and other artifacts highlighting the health of host sensors (ex: metrics, errors, and/or exceptions from logging applications) .003 Application Exhaustion Flood Detection of Endpoint DoS can sometimes be achieved before the effect is sufficient to cause significant impact to the availability of the service, but such response time typically requires very aggressive monitoring and responsiveness. Monitor for logging, messaging, and other artifacts highlighting the health of host sensors (ex: metrics, errors, and/or exceptions from logging applications) .004 Application or System Exploitation Detection of Endpoint DoS can sometimes be achieved before the effect is sufficient to cause significant impact to the availability of the service, but such response time typically requires very aggressive monitoring and responsiveness. Monitor for logging, messaging, and other artifacts highlighting the health of host sensors (ex: metrics, errors, and/or exceptions from logging applications) Mobile T1404 Exploitation for Privilege Escalation Mobile security products can potentially utilize device APIs to determine if a device has been rooted or jailbroken. Mobile T1625 Hijack Execution Flow Mobile threat defense agents could detect unauthorized operating system modifications by using attestation. .001 System Runtime API Hijacking Mobile threat defense agents could detect unauthorized operating system modifications by using attestation. Enterprise T1562 Impair Defenses Monitor logging, messaging, and other artifacts highlighting the health of host sensors (ex: metrics, errors, and/or exceptions from logging applications) that may maliciously modify components of a victim environment in order to hinder or disable defensive mechanisms. Lack of log events may be suspicious. .001 Disable or Modify Tools Lack of expected log events may be suspicious. Monitor for telemetry that provides context for modification or deletion of information related to security software processes or services such as Windows Defender definition files in Windows and System log files in Linux. .002 Disable Windows Event Logging Monitor for logging, messaging that may disable Windows event logging to limit data that can be leveraged for detections and audits. For example, adversaries may modify the EventLog file path to a different file name and location.[2] .003 Impair Command History Logging Users checking or changing their HISTCONTROL, HISTFILE, or HISTFILESIZE environment variables may be suspicious. .006 Indicator Blocking Detect lack of reported activity from a host sensor. Different methods of blocking may cause different disruptions in reporting. Systems may suddenly stop reporting all data or only certain kinds of data. Depending on the types of host information collected, an analyst may be able to detect the event that triggered a process to stop or connection to be blocked. For example, Sysmon will log when its configuration state has changed (Event ID 16) and Windows Management Instrumentation (WMI) may be used to subscribe ETW providers that log any provider removal from a specific trace session. [3] .011 Spoof Security Alerting Monitor logging, messaging, and other artifacts highlighting the health of host sensors (e.g., metrics, errors, and/or exceptions from logging applications), especially correlating and comparing centralized telemetry against potentially suspicious notifications presented on individual systems. Mobile T1630 .003 Indicator Removal on Host: Disguise Root/Jailbreak Indicators Mobile security products can use attestation to detect compromised devices. Mobile T1461 Lockscreen Bypass Mobile security products can often alert the user if their device is vulnerable to known exploits. Enterprise T1498 Network Denial of Service Detection of Network DoS can sometimes be achieved before the traffic volume is sufficient to cause impact to the availability of the service, but such response time typically requires very aggressive monitoring and responsiveness or services provided by an upstream network service provider. Monitor for logging, messaging, and other artifacts highlighting the health of host sensors (ex: metrics, errors, and/or exceptions from logging applications) .001 Direct Network Flood Detection of Network DoS can sometimes be achieved before the traffic volume is sufficient to cause impact to the availability of the service, but such response time typically requires very aggressive monitoring and responsiveness or services provided by an upstream network service provider. Monitor for logging, messaging, and other artifacts highlighting the health of host sensors (ex: metrics, errors, and/or exceptions from logging applications) .002 Reflection Amplification Detection of Network DoS can sometimes be achieved before the traffic volume is sufficient to cause impact to the availability of the service, but such response time typically requires very aggressive monitoring and responsiveness or services provided by an upstream network service provider. Monitor for logging, messaging, and other artifacts highlighting the health of host sensors (ex: metrics, errors, and/or exceptions from logging applications) Mobile T1458 Replication Through Removable Media Mobile security products can often alert the user if their device is vulnerable to known exploits. Enterprise T1496 Resource Hijacking Consider monitoring process resource usage to determine anomalous activity associated with malicious hijacking of computer resources such as CPU, memory, and graphics processing resources. Enterprise T1195 Supply Chain Compromise Perform physical inspection of hardware to look for potential tampering. Perform integrity checking on pre-OS boot mechanisms that can be manipulated for malicious purposes and compare against known good baseline behavior. .003 Compromise Hardware Supply Chain Perform physical inspection of hardware to look for potential tampering. Perform integrity checking on pre-OS boot mechanisms that can be manipulated for malicious purposes and and compare against known good baseline behavior. Mobile T1474 .002 Supply Chain Compromise: Compromise Hardware Supply Chain Integrity checking mechanisms can potentially detect unauthorized hardware modifications. .003 Supply Chain Compromise: Compromise Software Supply Chain System partition integrity checking mechanisms can detect unauthorized or malicious code contained in the system partition. Enterprise T1529 System Shutdown/Reboot Monitor for logging, messaging, and other artifacts highlighting the health of host sensors (ex: metrics, errors, and/or exceptions from logging applications) that may suggest the shutting down or rebooting of the system. Windows event logs may also designate activity associated with a shutdown/reboot, ex. Event ID 1074 and 6006. References Android. (n.d.). Verified Boot. Retrieved December 21, 2016. Heiligenstein, L. (n.d.). REP-25: Disable Windows Event Logging. Retrieved April 7, 2022. Palantir. (2018, December 24). Tampering with Windows Event Tracing: Background, Offense, and Defense. Retrieved June 7, 2019. "
},
{
"id": 1945,
"title": "Scheduled Job, Data Source DS0003",
"path": "/datasources/DS0003/index.html",
"content": " Scheduled Job Automated tasks that can be executed at a specific time or on a recurring schedule running in the background (ex: Cron daemon, task scheduler, BITS)[1] ID: DS0003 \u24d8 Platforms: Containers, Linux, Windows, macOS \u24d8 Collection Layers: Container, Host Contributors: Center for Threat-Informed Defense (CTID) Version: 1.0 Created: 20 October 2021 Last Modified: 30 March 2022 Version Permalink Live Version Data Components This data source does not have any techniques in the selected domain(s) Scheduled Job: Scheduled Job Creation Initial construction of a new scheduled job (ex: Windows EID 4698 or /var/log cron logs) Scheduled Job: Scheduled Job Creation Initial construction of a new scheduled job (ex: Windows EID 4698 or /var/log cron logs) Domain ID Name Detects ICS T0849 Masquerading Monitor for newly constructed scheduled jobs that may attempt to manipulate features of their artifacts to make them appear legitimate or benign to users and/or security tools. Enterprise T1053 Scheduled Task/Job Monitor newly constructed scheduled jobs that may abuse task scheduling functionality to facilitate initial or recurring execution of malicious code. .002 At Monitor for newly constructed scheduled jobs. If scheduled tasks are not used for persistence, then the adversary is likely to remove the task when the action is complete. On Windows, enable the \"Microsoft-Windows-TaskScheduler/Operational\" setting within the event logging service where several events will then be logged on scheduled task activity, including:[2] Event ID 106 on Windows 7, Server 2008 R2 - Scheduled task registered Event ID 4698 on Windows 10, Server 2016 - Scheduled task created Event ID 4700 on Windows 10, Server 2016 - Scheduled task enabled Event ID 4701 on Windows 10, Server 2016 - Scheduled task disabled Tools such as Sysinternals Autoruns may also be used to detect system changes that could be attempts at persistence, including listing current scheduled tasks. [3] .003 Cron Monitor for newly constructed scheduled jobs. Legitimate scheduled tasks may be created during installation of new software or through system administration functions. Look for changes to tasks that do not correlate with known software, patch cycles, etc. .005 Scheduled Task Monitor for newly constructed scheduled jobs by enabling the \"Microsoft-Windows-TaskScheduler/Operational\" setting within the event logging service. [2] Several events will then be logged on scheduled task activity, including: Event ID 106 on Windows 7, Server 2008 R2 - Scheduled task registered; Event ID 4698 on Windows 10, Server 2016 - Scheduled task created;Event ID 4700 on Windows 10, Server 2016 - Scheduled task enabled;Event ID 4701 on Windows 10, Server 2016 - Scheduled task disabled Note: Detection of the creation or modification of Scheduled Tasks with a suspicious script, extension or user writable path. Attackers may create or modify Scheduled Tasks for the persistent execution of malicious code. This detection focuses at the same time on EventIDs 4688 and 1 with process creation (SCHTASKS) and EventID 4698, 4702 for Scheduled Task creation/modification event log. Analytic 1 : New schedule tasks whose content includes suspicious scripts, extensions or user writable path suspicious_scheduled_jobs = filter UserName, JobName, JobContent where EventId == \"4698\" AND (JobContent LIKE '%.cmd%' OR JobContent LIKE '%.ps1%' OR JobContent LIKE '%.vbs%' OR JobContent LIKE '%.py%' OR JobContent LIKE '%.js%' OR JobContent LIKE '%.exe%' OR JobContent LIKE '%.bat%' OR JobContent LIKE '%javascript%' OR JobContent LIKE '%powershell%' OR JobContent LIKE '%wmic%' OR JobContent LIKE '%rundll32%' OR JobContent LIKE '%cmd%' OR JobContent LIKE '%cscript%' OR JobContent LIKE '%wscript%' OR JobContent LIKE '%regsvr32%' OR JobContent LIKE '%mshta%' OR JobContent LIKE '%bitsadmin%' OR JobContent LIKE '%certutil%' OR JobContent LIKE '%msiexec%' OR JobContent LIKE '%javaw%' OR JobContent LIKE '%[%]APPDATA[%]%' OR JobContent LIKE '%\\AppData\\Roaming%' OR JobContent LIKE '%[%]PUBLIC[%]%' OR JobContent LIKE '%C:\\Users\\Public%' OR JobContent LIKE '%[%]ProgramData[%]%' OR JobContent LIKE '%C:\\ProgramData%' OR JobContent LIKE '%[%]TEMP[%]%' OR JobContent LIKE '%\\AppData\\Local\\Temp%' OR JobContent LIKE '%\\Windows\\PLA\\System%' OR JobContent LIKE '%\\tasks%' OR JobContent LIKE '%\\Registration\\CRMLog%' OR JobContent LIKE '%\\FxsTmp%' OR JobContent LIKE '%\\spool\\drivers\\color%' OR JobContent LIKE '%\\tracing%') .006 Systemd Timers Suspicious systemd timers can also be identified by comparing results against a trusted system baseline. Malicious systemd timers may be detected by using the systemctl utility to examine system wide timers: systemctl list-timers \u2013all. Analyze the contents of corresponding .service files present on the file system and ensure that they refer to legitimate, expected executables. .007 Container Orchestration Job Monitor for the anomalous creation of scheduled jobs in container orchestration environments. Scheduled Job: Scheduled Job Metadata Contextual data about a scheduled job, which may include information such as name, timing, command(s), etc. Scheduled Job: Scheduled Job Metadata Contextual data about a scheduled job, which may include information such as name, timing, command(s), etc. Domain ID Name Detects Enterprise T1036 Masquerading Monitor for contextual data about a scheduled job, which may include information such as name, timing, command(s), etc. On Windows, Event ID 4698 (Security Log - A scheduled task was created) can be used to alert on the creation of scheduled tasks and provides metadata including the task name and task content (as XML). On Linux, auditing frameworks such as the Linux Auditing System (auditd) can be used to alert on invocations of cron, and provides the metadata included when executing the command. .004 Masquerade Task or Service Monitor for contextual data about a scheduled job, which may include information such as name, timing, command(s), etc. Scheduled Job: Scheduled Job Modification Changes made to a scheduled job, such as modifications to the execution launch (ex: Windows EID 4702 or /var/log cron logs) Scheduled Job: Scheduled Job Modification Changes made to a scheduled job, such as modifications to the execution launch (ex: Windows EID 4702 or /var/log cron logs) Domain ID Name Detects Enterprise T1070 Indicator Removal Monitor for changes made to scheduled jobs that may attempt to remove artifacts on a host system. .009 Clear Persistence Monitor for changes made to scheduled jobs that may attempt to remove artifacts on a host system. Enterprise T1036 Masquerading Monitor for changes made to scheduled jobs that may attempt to manipulate features of their artifacts to make them appear legitimate or benign to users and/or security tools. .004 Masquerade Task or Service Monitor for changes made to scheduled jobs for unexpected modifications to execution launch ICS T0849 Masquerading Monitor for changes made to scheduled jobs that may attempt to manipulate features of their artifacts to make them appear legitimate or benign to users and/or security tools. References Microsoft. (2018, May 31). Tasks. Retrieved September 28, 2021. Satyajit321. (2015, November 3). Scheduled Tasks History Retention settings. Retrieved December 12, 2017. Russinovich, M. (2016, January 4). Autoruns for Windows v13.51. Retrieved June 6, 2016. "
},
{
"id": 1946,
"title": "Named Pipe, Data Source DS0023",
"path": "/datasources/DS0023/index.html",
"content": " Named Pipe Mechanisms that allow inter-process communication locally or over the network. A named pipe is usually found as a file and processes attach to it[1] ID: DS0023 \u24d8 Platforms: Linux, Windows, macOS \u24d8 Collection Layer: Host Contributors: Center for Threat-Informed Defense (CTID) Version: 1.0 Created: 20 October 2021 Last Modified: 30 March 2022 Version Permalink Live Version Data Components This data source does not have any techniques in the selected domain(s) Named Pipe: Named Pipe Metadata Contextual data about a named pipe on a system, including pipe name and creating process (ex: Sysmon EIDs 17-18) Named Pipe: Named Pipe Metadata Contextual data about a named pipe on a system, including pipe name and creating process (ex: Sysmon EIDs 17-18) Domain ID Name Detects Enterprise T1570 Lateral Tool Transfer Monitor for contextual data about named pipes on the system. References Microsoft. (2018, May 31). Named Pipes. Retrieved September 28, 2021. "
},
{
"id": 1947,
"title": "Internet Scan, Data Source DS0035",
"path": "/datasources/DS0035/index.html",
"content": " Internet Scan Information obtained (commonly via active network traffic probes or web crawling) regarding various types of resources and servers connected to the public Internet ID: DS0035 \u24d8 Platform: PRE \u24d8 Collection Layer: OSINT Version: 1.0 Created: 20 October 2021 Last Modified: 20 October 2021 Version Permalink Live Version Data Components This data source does not have any techniques in the selected domain(s) Internet Scan: Response Content Logged network traffic in response to a scan showing both protocol header and body values Internet Scan: Response Content Logged network traffic in response to a scan showing both protocol header and body values Domain ID Name Detects Enterprise T1583 Acquire Infrastructure Once adversaries have provisioned infrastructure (ex: a server for use in command and control), internet scans may help proactively discover adversary acquired infrastructure. Consider looking for identifiable patterns such as services listening, certificates in use, SSL/TLS negotiation features, or other response artifacts associated with adversary C2 software.[1][2][3] Detection efforts may be focused on related stages of the adversary lifecycle, such as during Command and Control. .003 Virtual Private Server Once adversaries have provisioned a VPS (ex: for use as a command and control server), internet scans may reveal servers that adversaries have acquired. Consider looking for identifiable patterns such as services listening, certificates in use, SSL/TLS negotiation features, or other response artifacts associated with adversary C2 software.[1][2][3] Much of this activity will take place outside the visibility of the target organization, making detection of this behavior difficult. Detection efforts may be focused on related stages of the adversary lifecycle, such as during Command and Control. .004 Server Once adversaries have provisioned a server (ex: for use as a command and control server), internet scans may reveal servers that adversaries have acquired. Consider looking for identifiable patterns such as services listening, certificates in use, SSL/TLS negotiation features, or other response artifacts associated with adversary C2 software.[1][2][3] .006 Web Services Once adversaries leverage the web service as infrastructure (ex: for command and control), it may be possible to look for unique characteristics associated with adversary software, if known.[1] Much of this activity will take place outside the visibility of the target organization, making detection of this behavior difficult. Detection efforts may be focused on related stages of the adversary lifecycle, such as during Command and Control (Web Service) or Exfiltration Over Web Service. .007 Serverless Once adversaries leverage serverless functions as infrastructure (ex: for command and control), it may be possible to look for unique characteristics associated with adversary software, if known.[1] Much of this activity will take place outside the visibility of the target organization, making detection of this behavior difficult. Detection efforts may be focused on related stages of the adversary lifecycle. .008 Malvertising If infrastructure or patterns in the malicious web content related to malvertising have been previously identified, internet scanning may uncover when an adversary has staged malicious web content. Much of this activity will take place outside the visibility of the target organization, making detection of this behavior difficult. Detection efforts may be focused on other phases of the adversary lifecycle, such as Drive-by Compromise or Exploitation for Client Execution. Enterprise T1584 Compromise Infrastructure Once adversaries have provisioned compromised infrastructure (ex: a server for use in command and control), internet scans may help proactively discover compromised infrastructure. Consider looking for identifiable patterns such as services listening, certificates in use, SSL/TLS negotiation features, or other response artifacts associated with adversary C2 software.[1][2][3] .003 Virtual Private Server Once adversaries have provisioned software on a compromised VPS (ex: for use as a command and control server), internet scans may reveal VPSs that adversaries have compromised. Consider looking for identifiable patterns such as services listening, certificates in use, SSL/TLS negotiation features, or other response artifacts associated with adversary C2 software.[1][2][3] .004 Server Once adversaries have provisioned software on a compromised server (ex: for use as a command and control server), internet scans may reveal servers that adversaries have compromised. Consider looking for identifiable patterns such as services listening, certificates in use, SSL/TLS negotiation features, or other response artifacts associated with adversary C2 software.[1][2][3] .006 Web Services Once adversaries leverage the abused web service as infrastructure (ex: for command and control), it may be possible to look for unique characteristics associated with adversary software, if known.[1]Much of this activity will take place outside the visibility of the target organization, making detection of this behavior difficult. Detection efforts may be focused on related stages of the adversary lifecycle, such as during Command and Control Web Service or Exfiltration Over Web Service . .007 Serverless Once adversaries leverage serverless functions as infrastructure (ex: for command and control), it may be possible to look for unique characteristics associated with adversary software, if known.[1] Much of this activity will take place outside the visibility of the target organization, making detection of this behavior difficult. Detection efforts may be focused on related stages of the adversary lifecycle. Enterprise T1587 Develop Capabilities Consider use of services that may aid in the tracking of capabilities, such as certificates, in use on sites across the Internet. In some cases it may be possible to pivot on known pieces of information to uncover other adversary infrastructure.[4] Much of this activity will take place outside the visibility of the target organization, making detection of this behavior difficult. Detection efforts may be focused on related stages of the adversary lifecycle, such as during Defense Evasion or Command and Control. .003 Digital Certificates Consider use of services that may aid in the tracking of certificates in use on sites across the Internet. In some cases it may be possible to pivot on known pieces of certificate information to uncover other adversary infrastructure.[4]Detection efforts may be focused on related behaviors, such as Web Protocols , Asymmetric Cryptography , and/or Install Root Certificate . Enterprise T1592 Gather Victim Host Information Internet scanners may be used to look for patterns associated with malicious content designed to collect host information from visitors.[1][5]Much of this activity may have a very high occurrence and associated false positive rate, as well as potentially taking place outside the visibility of the target organization, making detection difficult for defenders. Detection efforts may be focused on related stages of the adversary lifecycle, such as during Initial Access. .001 Hardware Internet scanners may be used to look for patterns associated with malicious content designed to collect host hardware information from visitors.[1][5]Much of this activity may have a very high occurrence and associated false positive rate, as well as potentially taking place outside the visibility of the target organization, making detection difficult for defenders. Detection efforts may be focused on related stages of the adversary lifecycle, such as during Initial Access. .002 Software Internet scanners may be used to look for patterns associated with malicious content designed to collect host software information from visitors.[1][5]Much of this activity may have a very high occurrence and associated false positive rate, as well as potentially taking place outside the visibility of the target organization, making detection difficult for defenders. Detection efforts may be focused on related stages of the adversary lifecycle, such as during Initial Access. .004 Client Configurations Internet scanners may be used to look for patterns associated with malicious content designed to collect client configuration information from visitors.[1][5]Much of this activity may have a very high occurrence and associated false positive rate, as well as potentially taking place outside the visibility of the target organization, making detection difficult for defenders. Detection efforts may be focused on related stages of the adversary lifecycle, such as during Initial Access. Enterprise T1588 Obtain Capabilities Monitor for logged network traffic in response to a scan showing both protocol header and body values that may buy and/or steal capabilities that can be used during targeting. Much of this activity will take place outside the visibility of the target organization, making detection of this behavior difficult. Detection efforts may be focused on related stages of the adversary lifecycle, such as during Defense Evasion or Command and Control. .004 Digital Certificates Monitor for logged network traffic in response to a scan showing both protocol header and body values that may buy and/or steal SSL/TLS certificates that can be used during targeting. Detection efforts may be focused on related behaviors, such as Web Protocols, Asymmetric Cryptography, and/or Install Root Certificate. Enterprise T1608 Stage Capabilities If infrastructure or patterns in malware, tooling, certificates, or malicious web content have been previously identified, internet scanning may uncover when an adversary has staged their capabilities.Much of this activity will take place outside the visibility of the target organization, making detection of this behavior difficult. Detection efforts may be focused on related stages of the adversary lifecycle, such as initial access and post-compromise behaviors. .001 Upload Malware If infrastructure or patterns in malware have been previously identified, internet scanning may uncover when an adversary has staged malware to make it accessible for targeting.Much of this activity will take place outside the visibility of the target organization, making detection of this behavior difficult. Detection efforts may be focused on post-compromise phases of the adversary lifecycle, such as User Execution or Ingress Tool Transfer . .002 Upload Tool If infrastructure or patterns in tooling have been previously identified, internet scanning may uncover when an adversary has staged tools to make them accessible for targeting.Much of this activity will take place outside the visibility of the target organization, making detection of this behavior difficult. Detection efforts may be focused on post-compromise phases of the adversary lifecycle, such as Ingress Tool Transfer. .003 Install Digital Certificate Consider use of services that may aid in the tracking of certificates in use on sites across the Internet. In some cases it may be possible to pivot on known pieces of certificate information to uncover other adversary infrastructure.[4]Detection efforts may be focused on related behaviors, such as Web Protocols or Asymmetric Cryptography. .004 Drive-by Target If infrastructure or patterns in the malicious web content utilized to deliver a Drive-by Compromise have been previously identified, internet scanning may uncover when an adversary has staged web content for use in a strategic web compromise.Much of this activity will take place outside the visibility of the target organization, making detection of this behavior difficult. Detection efforts may be focused on other phases of the adversary lifecycle, such as Drive-by Compromise or Exploitation for Client Execution. .005 Link Target If infrastructure or patterns in malicious web content have been previously identified, internet scanning may uncover when an adversary has staged web content to make it accessible for targeting.Much of this activity will take place outside the visibility of the target organization, making detection of this behavior difficult. Detection efforts may be focused on other phases of the adversary lifecycle, such as during Spearphishing Link , Spearphishing Link , or Malicious Link . .006 SEO Poisoning If infrastructure or patterns in the malicious web content related to SEO poisoning or Drive-by Target have been previously identified, internet scanning may uncover when an adversary has staged web content supporting a strategic web compromise. Much of this activity will take place outside the visibility of the target organization, making detection of this behavior difficult. Detection efforts may be focused on other phases of the adversary lifecycle, such as Drive-by Compromise or Exploitation for Client Execution. Internet Scan: Response Metadata Contextual data about an Internet-facing resource gathered from a scan, such as running services or ports Internet Scan: Response Metadata Contextual data about an Internet-facing resource gathered from a scan, such as running services or ports Domain ID Name Detects Enterprise T1583 Acquire Infrastructure Monitor for contextual data about an Internet-facing resource gathered from a scan, such as running services or ports that may buy, lease, or rent infrastructure that can be used during targeting. Detection efforts may be focused on related stages of the adversary lifecycle, such as during Command and Control. .003 Virtual Private Server Much of this activity will take place outside the visibility of the target organization, making detection of this behavior difficult. Detection efforts may be focused on related stages of the adversary lifecycle, such as during Command and Control. .004 Server Much of this activity will take place outside the visibility of the target organization, making detection of this behavior difficult. Detection efforts may be focused on related stages of the adversary lifecycle, such as during Command and Control. Enterprise T1584 Compromise Infrastructure Monitor for contextual data about an Internet-facing resource gathered from a scan, such as running services or ports that may compromise third-party infrastructure that can be used during targeting. Detection efforts may be focused on related stages of the adversary lifecycle, such as during Command and Control. .003 Virtual Private Server Much of this activity will take place outside the visibility of the target organization, making detection of this behavior difficult. Detection efforts may be focused on related stages of the adversary lifecycle, such as during Command and Control. .004 Server Much of this activity will take place outside the visibility of the target organization, making detection of this behavior difficult. Detection efforts may be focused on related stages of the adversary lifecycle, such as during Command and Control. References ThreatConnect. (2020, December 15). Infrastructure Research and Hunting: Boiling the Domain Ocean. Retrieved October 12, 2021. Stephens, A. (2020, July 13). SCANdalous! (External Detection Using Network Scan Data and Automation). Retrieved October 12, 2021. Koczwara, M. (2021, September 7). Hunting Cobalt Strike C2 with Shodan. Retrieved October 12, 2021. Kovar, R. (2017, December 11). Tall Tales of Hunting with TLS/SSL Certificates. Retrieved October 16, 2020. Blasco, J. (2014, August 28). Scanbox: A Reconnaissance Framework Used with Watering Hole Attacks. Retrieved October 19, 2020. "
},
{
"id": 1948,
"title": "Group, Data Source DS0036",
"path": "/datasources/DS0036/index.html",
"content": " Group A collection of multiple user accounts that share the same access rights to the computer and/or network resources and have common security rights[1] ID: DS0036 \u24d8 Platforms: Azure AD, Google Workspace, IaaS, Office 365, SaaS, Windows \u24d8 Collection Layers: Cloud Control Plane, Host Contributors: Center for Threat-Informed Defense (CTID) Version: 1.0 Created: 20 October 2021 Last Modified: 30 March 2022 Version Permalink Live Version Data Components This data source does not have any techniques in the selected domain(s) Group: Group Enumeration An extracted list of available groups and/or their associated settings (ex: AWS list-groups) Group: Group Enumeration An extracted list of available groups and/or their associated settings (ex: AWS list-groups) Domain ID Name Detects Enterprise T1087 .001 Account Discovery: Local Account Monitor for logging that may suggest a list of available groups and/or their associated settings has been extracted, ex. Windows EID 4798 and 4799. .002 Account Discovery: Domain Account Monitor for logging that may suggest a list of available groups and/or their associated settings has been extracted, ex. Windows EID 4798 and 4799. Enterprise T1069 Permission Groups Discovery Monitor for an extracted list of ACLs of available groups and/or their associated settings. .001 Local Groups Monitor for logging that may suggest a list of available groups and/or their associated settings has been extracted, ex. Windows EID 4798 and 4799. .002 Domain Groups Monitor for logging that may suggest a list of available groups and/or their associated settings has been extracted, ex. Windows EID 4798 and 4799. .003 Cloud Groups Monitor for an extracted list of available groups and/or their associated setting Group: Group Metadata Contextual data about a group which describes group and activity around it, such as name, permissions, or user accounts within the group Group: Group Metadata Contextual data about a group which describes group and activity around it, such as name, permissions, or user accounts within the group Domain ID Name Detects Enterprise T1069 Permission Groups Discovery Monitor for contextual data about a group which describes group and activity around it. .003 Cloud Groups Contextual data about a group which describes group and activity around it that may attempt to find cloud groups and permission settings. Group: Group Modification Changes made to a group, such as membership, name, or permissions (ex: Windows EID 4728 or 4732, AWS IAM UpdateGroup) Group: Group Modification Changes made to a group, such as membership, name, or permissions (ex: Windows EID 4728 or 4732, AWS IAM UpdateGroup) Domain ID Name Detects Enterprise T1098 Account Manipulation Monitor events for changes to account objects and/or permissions on systems and the domain, such as event IDs 4738, 4728 and 4670. .002 Additional Email Delegate Permissions Monitor for unusual Exchange and Office 365 email account permissions changes that may indicate excessively broad permissions (including memberships in privileged groups) being granted to compromised accounts. References Amazon. (n.d.). IAM user groups. Retrieved October 13, 2021. "
},
{
"id": 1949,
"title": "Firewall, Data Source DS0018",
"path": "/datasources/DS0018/index.html",
"content": " Firewall A network security system, running locally on an endpoint or remotely as a service (ex: cloud environment), that monitors and controls incoming/outgoing network traffic based on predefined rules[1] ID: DS0018 \u24d8 Platforms: Azure AD, Google Workspace, IaaS, Linux, Office 365, SaaS, Windows, macOS \u24d8 Collection Layers: Cloud Control Plane, Host Contributors: Center for Threat-Informed Defense (CTID) Version: 1.0 Created: 20 October 2021 Last Modified: 30 March 2022 Version Permalink Live Version Data Components This data source does not have any techniques in the selected domain(s) Firewall: Firewall Disable Deactivation or stoppage of a cloud service (ex: Write/Delete entries within Azure Firewall Activity Logs) Firewall: Firewall Disable Deactivation or stoppage of a cloud service (ex: Write/Delete entries within Azure Firewall Activity Logs) Domain ID Name Detects Enterprise T1562 Impair Defenses Monitor for changes in the status of the system firewall such as Windows Security Auditing events 5025 (The Windows firewall service has been stopped) and 5034 (The Windows firewall driver was stopped). .004 Disable or Modify System Firewall Monitor for changes in the status of the system firewall such as Windows Security Auditing events 5025 (The Windows firewall service has been stopped) and 5034 (The Windows firewall driver was stopped). .007 Disable or Modify Cloud Firewall Monitor for changes in the status of the system firewall such as Windows Security Auditing events 5025 (The Windows firewall service has been stopped) and 5034 (The Windows firewall driver was stopped). Firewall: Firewall Enumeration An extracted list of available firewalls and/or their associated settings/rules (ex: Azure Network Firewall CLI Show commands) Firewall: Firewall Enumeration An extracted list of available firewalls and/or their associated settings/rules (ex: Azure Network Firewall CLI Show commands) Domain ID Name Detects Enterprise T1518 Software Discovery Monitor for an extracted list of available firewalls and/or their associated settings/rules (ex: Azure Network Firewall CLI Show commands) .001 Security Software Discovery Monitor for an extracted list of available firewalls and/or their associated settings/rules (ex: Azure Network Firewall CLI Show commands) Firewall: Firewall Metadata Contextual data about a firewall and activity around it such as name, policy, or status Firewall: Firewall Metadata Contextual data about a firewall and activity around it such as name, policy, or status Domain ID Name Detects Enterprise T1518 Software Discovery Monitor for contextual data about a firewall and activity around it such as name, policy, or status .001 Security Software Discovery Monitor for contextual data about a firewall and activity around it such as name, policy, or status Firewall: Firewall Rule Modification Changes made to a firewall rule, typically to allow/block specific network traffic (ex: Windows EID 4950 or Write/Delete entries within Azure Firewall Rule Collection Activity Logs) Firewall: Firewall Rule Modification Changes made to a firewall rule, typically to allow/block specific network traffic (ex: Windows EID 4950 or Write/Delete entries within Azure Firewall Rule Collection Activity Logs) Domain ID Name Detects Enterprise T1562 Impair Defenses Monitor for changes made to firewall rules for unexpected modifications to allow/block specific network traffic that may maliciously modify components of a victim environment in order to hinder or disable defensive mechanisms. .004 Disable or Modify System Firewall Monitor for changes made to firewall rules that might allow remote communication over protocols such as SMD and RDP. Modification of firewall rules might also consider opening local ports and services for different network profiles such as public and domain. .007 Disable or Modify Cloud Firewall Monitor cloud logs for modification or creation of new security groups or firewall rules. Enterprise T1070 Indicator Removal Monitor for changes made to firewall rules, especially unexpected modifications that may potentially be related to allowing and/or cleaning up previous tampering that enabled malicious network traffic. .007 Clear Network Connection History and Configurations Monitor for changes made to firewall rules, especially unexpected modifications that may potentially be related to allowing and/or cleaning up previous tampering that enabled malicious network traffic. References Amazon. (n.d.). Security groups for your VPC. Retrieved October 13, 2021. "
},
{
"id": 1950,
"title": "Active Directory, Data Source DS0026",
"path": "/datasources/DS0026/index.html",
"content": " Active Directory A database and set of services that allows administrators to manage permissions, access to network resources, and stored data objects (user, group, application, or devices)[1] ID: DS0026 \u24d8 Platforms: Azure AD, Windows \u24d8 Collection Layers: Cloud Control Plane, Host Contributors: Center for Threat-Informed Defense (CTID) Version: 1.0 Created: 20 October 2021 Last Modified: 30 March 2022 Version Permalink Live Version Data Components This data source does not have any techniques in the selected domain(s) Active Directory: Active Directory Credential Request A user requested active directory credentials, such as a ticket or token (ex: Windows EID 4769) Active Directory: Active Directory Credential Request A user requested active directory credentials, such as a ticket or token (ex: Windows EID 4769) Domain ID Name Detects Enterprise T1649 Steal or Forge Authentication Certificates Monitor AD CS certificate requests (ex: EID 4886) as well as issued certificates (ex: EID 4887) for abnormal activity, including unexpected certificate enrollments and signs of abuse within certificate attributes (such as abusable EKUs).[2] Enterprise T1558 Steal or Forge Kerberos Tickets Monitor for anomalous Kerberos activity, such as malformed or blank fields in Windows logon/logoff events (Event ID 4624, 4672, 4634), RC4 encryption within ticket granting tickets (TGTs), and ticket granting service (TGS) requests without preceding TGT requests.[3][4][5]Monitor the lifetime of TGT tickets for values that differ from the default domain duration.[6] Monitor for indications of Pass the Ticket being used to move laterally. .001 Golden Ticket Monitor for anomalous Kerberos activity, such as malformed or blank fields in Windows logon/logoff events (Event ID 4769, 4768), RC4 encryption within TGTs, and TGS requests without preceding TGT requests. Monitor the lifetime of TGT tickets for values that differ from the default domain duration. Monitor for indications of Pass the Ticket being used to move laterally. .003 Kerberoasting Monitor for anomalous Kerberos activity, such as enabling Audit Kerberos Service Ticket Operations to log Kerberos TGS service ticket requests. Particularly investigate irregular patterns of activity (ex: accounts making numerous requests, Event ID 4769, within a small time frame, especially if they also request RC4 encryption [Type 0x17]). .004 AS-REP Roasting Monitor for anomalous activity, such as enabling Audit Kerberos Service Ticket Operations to log Kerberos TGS service ticket requests. Particularly investigate irregular patterns of activity (ex: accounts making numerous requests, Event ID 4768 and 4769, within a small time frame, especially if they also request RC4 encryption [Type 0x17], pre-authentication not required [Type: 0x0]). Enterprise T1550 Use Alternate Authentication Material Monitor requests of new ticket granting ticket or service tickets to a Domain Controller, such as Windows EID 4769 or 4768, that may use alternate authentication material, such as password hashes, Kerberos tickets, and application access tokens, in order to move laterally within an environment and bypass normal system access controls. .002 Pass the Hash Monitor requests of new ticket granting ticket or service tickets to a Domain Controller. Windows Security events such as 4768 (A Kerberos authentication ticket (TGT) was requested) and 4769 (A Kerberos service ticket was requested) combined with logon session creation information may be indicative of an overpass the hash attempt. .003 Pass the Ticket Monitor requests of new ticket granting ticket or service tickets to a Domain Controller. Event ID 4769 is generated on the Domain Controller when using a golden ticket after the KRBTGT password has been reset twice, as mentioned in the mitigation section. The status code 0x1F indicates the action has failed due to \"Integrity check on decrypted field failed\" and indicates misuse by a previously invalidated golden ticket.[5] Active Directory: Active Directory Object Access Opening of an active directory object, typically to collect/read its value (ex: Windows EID 4661) Active Directory: Active Directory Object Access Opening of an active directory object, typically to collect/read its value (ex: Windows EID 4661) Domain ID Name Detects Enterprise T1615 Group Policy Discovery Monitor for abnormal LDAP queries with filters for groupPolicyContainer and high volumes of LDAP traffic to domain controllers. Windows Event ID 4661 can also be used to detect when a directory service has been accessed. Enterprise T1003 OS Credential Dumping Monitor domain controller logs for replication requests and other unscheduled activity possibly associated with DCSync. [7] [8] [9] Note: Domain controllers may not log replication requests originating from the default domain controller account. [10]. Monitor for replication requests [11] from IPs not associated with known domain controllers. [12] .006 DCSync Monitor domain controller logs for replication requests and other unscheduled activity possibly associated with DCSync.[7] [8] [9] Note: Domain controllers may not log replication requests originating from the default domain controller account.[10] Enterprise T1033 System Owner/User Discovery Monitor domain controller logs for replication requests and other unscheduled activity possibly associated with DCSync. [7] [8] [9] Note: Domain controllers may not log replication requests originating from the default domain controller account. [10]. Monitor for replication requests [11] from IPs not associated with known domain controllers. [12] Active Directory: Active Directory Object Creation Initial construction of a new active directory object (ex: Windows EID 5137) Active Directory: Active Directory Object Creation Initial construction of a new active directory object (ex: Windows EID 5137) Domain ID Name Detects Enterprise T1098 .005 Account Manipulation: Device Registration Monitor for the registration or joining of new device objects in Active Directory. Raise alerts when new devices are registered or joined without using MFA.[13] Enterprise T1484 Domain Policy Modification Monitor for newly constructed active directory objects, such as Windows EID 5137. .001 Group Policy Modification Monitor for newly constructed active directory objects, such as Windows EID 5137. .002 Domain Trust Modification Monitor for newly constructed active directory objects, such as Windows EID 5137. Enterprise T1207 Rogue Domain Controller Baseline and periodically analyze the Configuration partition of the AD schema and alert on creation of nTDSDSA objects.[14] Active Directory: Active Directory Object Deletion Removal of an active directory object (ex: Windows EID 5141) Active Directory: Active Directory Object Deletion Removal of an active directory object (ex: Windows EID 5141) Domain ID Name Detects Enterprise T1484 Domain Policy Modification Monitor for unexpected deletion of an active directory object, such as Windows EID 5141. .001 Group Policy Modification Monitor for unexpected deletion of an active directory object, such as Windows EID 5141. Active Directory: Active Directory Object Modification Changes made to an active directory object (ex: Windows EID 5163 or 5136) Active Directory: Active Directory Object Modification Changes made to an active directory object (ex: Windows EID 5163 or 5136) Domain ID Name Detects Enterprise T1134 Access Token Manipulation Monitor for changes made to AD settings that may modify access tokens to operate under a different user or system security context to perform actions and bypass access controls. .005 SID-History Injection Monitor for changes to account management events on Domain Controllers for successful and failed changes to SID-History. [15] [16] Enterprise T1531 Account Access Removal Monitor for changes made to AD settings for unexpected modifications to user accounts, such as deletions or potentially malicious changes to user attributes (credentials, status, etc.). Enterprise T1098 Account Manipulation Monitor for the registration or joining of new device objects in Active Directory. Raise alerts when new devices are registered or joined without using MFA.[13] Enterprise T1037 Boot or Logon Initialization Scripts Monitor for changes made in the Active Directory that may use scripts automatically executed at boot or logon initialization to establish persistence. .003 Network Logon Script Monitor for changes made in the Active Directory that may use network logon scripts automatically executed at logon initialization to establish persistence. Enterprise T1484 Domain Policy Modification Monitor for changes made to AD settings for unexpected modifications to user accounts, such as deletions or potentially malicious changes to user attributes (credentials, status, etc.). .001 Group Policy Modification Monitor for changes made to AD settings for unexpected modifications to user accounts, such as deletions or potentially malicious changes to user attributes (credentials, status, etc.). .002 Domain Trust Modification Monitor for changes made to AD settings for unexpected modifications to domain trust settings, such as when a user or application modifies the federation settings on the domain. Enterprise T1222 File and Directory Permissions Modification Monitor for changes made to ACLs and file/directory ownership. Many of the commands used to modify ACLs and file/directory ownership are built-in system utilities and may generate a high false positive alert rate, so compare against baseline knowledge for how systems are typically used and correlate modification events with other indications of malicious activity where possible. .001 Windows File and Directory Permissions Modification Monitor for changes made to DACLs and file/directory ownership. Many of the commands used to modify DACLs and file/directory ownership are built-in system utilities and may generate a high false positive alert rate, so compare against baseline knowledge for how systems are typically used and correlate modification events with other indications of malicious activity where possible. Enterprise T1556 Modify Authentication Process Monitor for changes made to AD security settings related to MFA logon requirements, such as changes to Azure AD Conditional Access Policies or the registration of new MFA applications. .005 Reversible Encryption Monitor property changes in Group Policy: Computer Configuration\\Windows Settings\\Security Settings\\Account Policies\\Password Policy\\Store passwords using reversible encryption. By default, the property should be set to Disabled. .006 Multi-Factor Authentication Monitor for changes made to AD security settings related to MFA logon requirements, such as changes to Azure AD Conditional Access Policies or the registration of new MFA applications. Enterprise T1207 Rogue Domain Controller Leverage AD directory synchronization (DirSync) to monitor changes to directory state using AD replication cookies.[17] [18] Also consider monitoring and alerting on the replication of AD objects (Audit Detailed Directory Service Replication Events 4928 and 4929). [14] Enterprise T1649 Steal or Forge Authentication Certificates Monitor for changes to CA attributes and settings, such as AD CS certificate template modifications (ex: EID 4899/4900 once a potentially malicious certificate is enrolled).[2] References Foulds, I. et al. (2018, August 7). AD DS Getting Started. Retrieved September 23, 2021. Schroeder, W. & Christensen, L. (2021, June 22). Certified Pre-Owned - Abusing Active Directory Certificate Services. Retrieved August 2, 2022. Metcalf, S. (2015, May 03). Detecting Forged Kerberos Ticket (Golden Ticket & Silver Ticket) Use in Active Directory. Retrieved December 23, 2015. Jeff Warren. (2019, February 19). How to Detect Pass-the-Ticket Attacks. Retrieved February 27, 2020. Abolins, D., Boldea, C., Socha, K., Soria-Machado, M. (2016, April 26). Kerberos Golden Ticket Protection. Retrieved July 13, 2017. Microsoft. (2015, March 24). Kerberos Golden Ticket Check (Updated). Retrieved February 27, 2020. Microsoft. (2017, December 1). MS-DRSR Directory Replication Service (DRS) Remote Protocol. Retrieved December 4, 2017. Microsoft. (n.d.). IDL_DRSGetNCChanges (Opnum 3). Retrieved December 4, 2017. SambaWiki. (n.d.). DRSUAPI. Retrieved December 4, 2017. Schroeder, W. (2015, September 22). Mimikatz and DCSync and ExtraSids, Oh My. Retrieved December 4, 2017. Microsoft. (n.d.). MS-SAMR Security Account Manager (SAM) Remote Protocol (Client-to-Server) - Transport. Retrieved December 4, 2017. Metcalf, S. (2015, September 25). Mimikatz DCSync Usage, Exploitation, and Detection. Retrieved December 4, 2017. Microsoft. (2020, September 16). Azure Active Directory security operations for devices. Retrieved February 21, 2023. Delpy, B. & LE TOUX, V. (n.d.). DCShadow. Retrieved March 20, 2018. Metcalf, S. (2015, September 19). Sneaky Active Directory Persistence #14: SID History. Retrieved November 30, 2017. Microsoft. (n.d.). Using DsAddSidHistory. Retrieved November 30, 2017. Microsoft. (n.d.). Polling for Changes Using the DirSync Control. Retrieved March 30, 2018. Lucand,G. (2018, February 18). Detect DCShadow, impossible?. Retrieved March 30, 2018. "
},
{
"id": 1951,
"title": "Drive, Data Source DS0016",
"path": "/datasources/DS0016/index.html",
"content": " Drive A non-volatile data storage device (hard drive, floppy disk, USB flash drive) with at least one formatted partition, typically mounted to the file system and/or assigned a drive letter[1] ID: DS0016 \u24d8 Platforms: Linux, Windows, macOS \u24d8 Collection Layer: Host Contributors: Center for Threat-Informed Defense (CTID) Version: 1.0 Created: 20 October 2021 Last Modified: 30 March 2022 Version Permalink Live Version Data Components This data source does not have any techniques in the selected domain(s) Drive: Drive Access Opening of a data storage device with an assigned drive letter or mount point Drive: Drive Access Opening of a data storage device with an assigned drive letter or mount point Domain ID Name Detects Enterprise T1092 Communication Through Removable Media Monitor for unexpected file access on removable media Enterprise T1006 Direct Volume Access Monitor handle opens on volumes that are made by processes to determine when they may be directly collecting data from logical drives. [2] Enterprise T1561 Disk Wipe Monitor for newly constructed drive letters or mount points to a data storage device for attempts to write to sensitive locations like the partition boot sector, master boot record, disk partition table, or BIOS parameter block/superblock. .001 Disk Content Wipe Monitor for newly constructed drive letters or mount points to a data storage device for attempts to write to sensitive locations like the partition boot sector, master boot record, disk partition table, or BIOS parameter block/superblock. .002 Disk Structure Wipe Monitor for newly constructed drive letters or mount points to a data storage device for attempts to write to sensitive locations like the partition boot sector, master boot record, disk partition table, or BIOS parameter block/superblock. Drive: Drive Creation Initial construction of a drive letter or mount point to a data storage device Drive: Drive Creation Initial construction of a drive letter or mount point to a data storage device Domain ID Name Detects Enterprise T1092 Communication Through Removable Media Monitor for newly executed processes when removable media is mounted. Enterprise T1052 Exfiltration Over Physical Medium Monitor for newly assigned drive letters or mount points to a data storage device that may attempt to exfiltrate data via a physical medium, such as a removable drive. .001 Exfiltration over USB Monitor for newly assigned drive letters or mount points to a data storage device that may attempt to exfiltrate data over a USB connected physical device. Enterprise T1200 Hardware Additions Monitor for newly constructed drives or other related events associated with computer hardware and other accessories (especially new or unknown) being connected to systems. Endpoint sensors may be able to detect the addition of hardware via USB, Thunderbolt, and other external device communication ports. Enterprise T1091 Replication Through Removable Media Monitor for newly constructed drive letters or mount points to removable media ICS T0847 Replication Through Removable Media Monitor for newly constructed drive letters or mount points to removable media. Drive: Drive Modification Changes made to a drive letter or mount point of a data storage device Drive: Drive Modification Changes made to a drive letter or mount point of a data storage device Domain ID Name Detects Enterprise T1561 Disk Wipe Monitor for changes made to drive letters or mount points of data storage devices for attempts to read to sensitive locations like the partition boot sector, master boot record, disk partition table, or BIOS parameter block/superblock. .001 Disk Content Wipe Monitor for changes made to drive letters or mount points of data storage devices for attempts to read to sensitive locations like the partition boot sector, master boot record, disk partition table, or BIOS parameter block/superblock. .002 Disk Structure Wipe Monitor for changes made to drive letters or mount points of data storage devices for attempts to read to sensitive locations like the partition boot sector, master boot record, disk partition table, or BIOS parameter block/superblock. Enterprise T1542 Pre-OS Boot Monitor for changes to MBR and VBR as they occur for indicators for suspicious activity and further analysis. Take snapshots of MBR and VBR and compare against known good samples. .003 Bootkit Monitor for changes to MBR and VBR as they occur for indicators for suspicious activity and further analysis. Take snapshots of MBR and VBR and compare against known good samples. Enterprise T1014 Rootkit Monitor for changes made to drive letters or mount points of data storage devices for unexpected modifications that may be used by rootkits to hide the presence of programs, files, network connections, services, drivers, and other system components. References Russinovich, R. & Garnier, T. (2021, August 18). Sysmon Event ID 9. Retrieved September 24, 2021. Bialek, J. (2015, December 16). Invoke-NinjaCopy.ps1. Retrieved June 2, 2016. "
},
{
"id": 1952,
"title": "Persona, Data Source DS0021",
"path": "/datasources/DS0021/index.html",
"content": " Persona A malicious online profile representing a user commonly used by adversaries to social engineer or otherwise target victims ID: DS0021 \u24d8 Platform: PRE \u24d8 Collection Layer: OSINT Version: 1.0 Created: 20 October 2021 Last Modified: 20 October 2021 Version Permalink Live Version Data Components This data source does not have any techniques in the selected domain(s) Persona: Social Media Established, compromised, or otherwise acquired social media personas Persona: Social Media Established, compromised, or otherwise acquired social media personas Domain ID Name Detects Enterprise T1586 Compromise Accounts Consider monitoring social media activity related to your organization. Suspicious activity may include personas claiming to work for your organization or recently modified accounts making numerous connection requests to accounts affiliated with your organization.Much of this activity will take place outside the visibility of the target organization, making detection of this behavior difficult. Detection efforts may be focused on related stages of the adversary lifecycle, such as during Initial Access (ex: Phishing). .001 Social Media Accounts Consider monitoring social media activity related to your organization. Suspicious activity may include personas claiming to work for your organization or recently modified accounts making numerous connection requests to accounts affiliated with your organization.Detection efforts may be focused on related stages of the adversary lifecycle, such as during Initial Access (ex: Spearphishing via Service). Enterprise T1585 Establish Accounts Consider monitoring social media activity related to your organization. Suspicious activity may include personas claiming to work for your organization or recently created/modified accounts making numerous connection requests to accounts affiliated with your organization.Much of this activity will take place outside the visibility of the target organization, making detection of this behavior difficult. Detection efforts may be focused on related stages of the adversary lifecycle, such as during Initial Access (ex: Phishing). .001 Social Media Accounts Consider monitoring social media activity related to your organization. Suspicious activity may include personas claiming to work for your organization or recently created/modified accounts making numerous connection requests to accounts affiliated with your organization.Detection efforts may be focused on related stages of the adversary lifecycle, such as during Initial Access (ex: Spearphishing via Service). "
},
{
"id": 1953,
"title": "Network Share, Data Source DS0033",
"path": "/datasources/DS0033/index.html",
"content": " Network Share A storage resource (typically a folder or drive) made available from one host to others using network protocols, such as Server Message Block (SMB) or Network File System (NFS)[1] ID: DS0033 \u24d8 Platforms: Linux, Windows, macOS \u24d8 Collection Layer: Host Contributors: Center for Threat-Informed Defense (CTID) Version: 1.0 Created: 20 October 2021 Last Modified: 30 March 2022 Version Permalink Live Version Data Components This data source does not have any techniques in the selected domain(s) Network Share: Network Share Access Opening a network share, which makes the contents available to the requestor (ex: Windows EID 5140 or 5145) Network Share: Network Share Access Opening a network share, which makes the contents available to the requestor (ex: Windows EID 5140 or 5145) Domain ID Name Detects Enterprise T1486 Data Encrypted for Impact Monitor for unexpected network shares being accessed on target systems or on large numbers of systems. ICS T0811 Data from Information Repositories In the case of detecting collection from shared network drives monitor for unexpected and abnormal accesses to network shares. Enterprise T1039 Data from Network Shared Drive Monitor for unexpected and abnormal accesses to network shares. Enterprise T1570 Lateral Tool Transfer Monitor for unexpected network share access, such as files transferred between shares within a network using protocols such as SMB. ICS T0867 Lateral Tool Transfer Monitor for unexpected network share access, such as files transferred between shares within a network using protocols such as Server Message Block (SMB). Enterprise T1021 Remote Services Monitor interactions with network shares, such as reads or file transfers, using remote services such as Server Message Block (SMB). .002 SMB/Windows Admin Shares Monitor interactions with network shares, such as reads or file transfers, using Server Message Block (SMB). ICS T0886 Remote Services Monitor interactions with network shares, such as reads or file transfers, using remote services such as Server Message Block (SMB). For added context on adversary procedures and background see Remote Services and applicable sub-techniques. Enterprise T1080 Taint Shared Content Monitor for unexpected and abnormal accesses to network shares, especially those also associated with file activity. References Microsoft. (2018, July 9). Network File System overview. Retrieved September 28, 2021. "
},
{
"id": 1954,
"title": "WMI, Data Source DS0005",
"path": "/datasources/DS0005/index.html",
"content": " WMI The infrastructure for management data and operations that enables local and remote management of Windows personal computers and servers[1][2] ID: DS0005 \u24d8 Platform: Windows \u24d8 Collection Layer: Host Contributors: Center for Threat-Informed Defense (CTID) Version: 1.0 Created: 20 October 2021 Last Modified: 10 November 2021 Version Permalink Live Version Data Components This data source does not have any techniques in the selected domain(s) WMI: WMI Creation Initial construction of a WMI object, such as a filter, consumer, subscription, binding, or provider (ex: Sysmon EIDs 19-21) WMI: WMI Creation Initial construction of a WMI object, such as a filter, consumer, subscription, binding, or provider (ex: Sysmon EIDs 19-21) Domain ID Name Detects Enterprise T1546 Event Triggered Execution Monitor for newly constructed WMI Objects that may establish persistence and/or elevate privileges using system mechanisms that trigger execution based on specific events. .003 Windows Management Instrumentation Event Subscription Monitor WMI event subscription entries, comparing current WMI event subscriptions to known good subscriptions for each host. Tools such as Sysinternals Autoruns may also be used to detect WMI changes that could be attempts at persistence. [3] [4] Monitor for the creation of new WMI EventFilter, EventConsumer, and FilterToConsumerBinding events. Event ID 5861 is logged on Windows 10 systems when new EventFilterToConsumerBinding events are created.[5] Enterprise T1027 Obfuscated Files or Information Monitor for the creation of WMI Objects and values that may highlight storage of malicious data such as commands or payloads. .011 Fileless Storage Monitor for the creation of WMI Objects and values that may highlight storage of malicious data such as commands or payloads. Enterprise T1021 Remote Services Monitor for newly constructed WMI objects that is often used to log into a service that accepts remote connects. Enterprise T1047 Windows Management Instrumentation Monitor for newly constructed WMI objects that will execute malicious commands and payloads. References Microsoft. (2018, May 31). WMI System Classes. Retrieved September 29, 2021. Microsoft. (2018, May 31). WMI Architecture. Retrieved September 29, 2021. Russinovich, M. (2016, January 4). Autoruns for Windows v13.51. Retrieved June 6, 2016. French, D. (2018, October 9). Detecting & Removing an Attacker\u2019s WMI Persistence. Retrieved October 11, 2019. French, D., Murphy, B. (2020, March 24). Adversary tradecraft 101: Hunting for persistence using Elastic Security (Part 1). Retrieved December 21, 2020. "
},
{
"id": 1955,
"title": "Web Credential, Data Source DS0006",
"path": "/datasources/DS0006/index.html",
"content": " Web Credential Credential material, such as session cookies or tokens, used to authenticate to web applications and services[1][2] ID: DS0006 \u24d8 Platforms: Azure AD, Google Workspace, Linux, Office 365, SaaS, Windows, macOS \u24d8 Collection Layers: Cloud Control Plane, Host Version: 1.0 Created: 20 October 2021 Last Modified: 30 March 2022 Version Permalink Live Version Data Components This data source does not have any techniques in the selected domain(s) Web Credential: Web Credential Creation Initial construction of new web credential material (ex: Windows EID 1200 or 4769) Web Credential: Web Credential Creation Initial construction of new web credential material (ex: Windows EID 1200 or 4769) Domain ID Name Detects Enterprise T1606 Forge Web Credentials Monitor for creation of access tokens using SAML tokens which do not have corresponding 4769 and 1200 events in the domain.[3] Additionally, detect on unusual API calls to generate access tokens, such as sts:GetFederationToken in AWS.[4] .002 SAML Tokens Monitor for creation of access tokens using SAML tokens which do not have corresponding 4769 and 1200 events in the domain.[3] Web Credential: Web Credential Usage An attempt by a user to gain access to a network or computing resource by providing web credentials (ex: Windows EID 1202) Web Credential: Web Credential Usage An attempt by a user to gain access to a network or computing resource by providing web credentials (ex: Windows EID 1202) Domain ID Name Detects Enterprise T1606 Forge Web Credentials Monitor for the use of Access Tokens to access services such as Email that were created using SAML tokens which do not have corresponding 1202 events in the domain.[3] .001 Web Cookies Monitor for the usage of unexpected or unusual cookies to access resources and services. Forged web cookies may be associated with unknown accounts and could be the result of compromised secrets such as passwords or Private Keys. .002 SAML Tokens Monitor for the use of access tokens to access services such as email that were created using SAML tokens which do not have corresponding 1202 events (i.e. \"The Federation Service validated a new credential\") in the domain.[3] Enterprise T1550 Use Alternate Authentication Material Monitor for an attempt by a user to gain access to a network or computing resource by providing web credentials (ex: Windows EID 1202) that may use alternate authentication material, such as password hashes, Kerberos tickets, and application access tokens, in order to move laterally within an environment and bypass normal system access controls. .001 Application Access Token Monitor the use of application access tokens to interact with resources or services that do not fit the organization baseline. For example, an application that is not meant to read emails accessing users\u2019 mail boxes and potentially exfiltrating sensitive data, or a token associated with a cloud service account being used to make API calls from an IP address outside of the cloud environment.[5] .004 Web Session Cookie Monitor for anomalous access of websites and cloud-based applications by the same user in different locations or by different systems that do not match expected configurations. References Hsu, S. (2018, June 30). Session vs Token Based Authentication. Retrieved September 29, 2021. Auth0. (n.d.). Access Tokens. Retrieved September 29, 2021. Sygnia. (2020, December). Detection and Hunting of Golden SAML Attack. Retrieved January 6, 2021. Vaishnav Murthy and Joel Eng. (2023, January 30). How Adversaries Can Persist with AWS User Federation. Retrieved March 10, 2023. Dror Alon. (2022, December 8). Compromised Cloud Compute Credentials: Case Studies From the Wild. Retrieved March 9, 2023. "
},
{
"id": 1956,
"title": "Cloud Storage, Data Source DS0010",
"path": "/datasources/DS0010/index.html",
"content": " Cloud Storage Data object storage infrastructure hosted on-premise or by third-party providers, made available to users through network connections and/or APIs[1][2][3] ID: DS0010 \u24d8 Platform: IaaS \u24d8 Collection Layer: Cloud Control Plane Contributors: Center for Threat-Informed Defense (CTID) Version: 1.0 Created: 20 October 2021 Last Modified: 10 November 2021 Version Permalink Live Version Data Components This data source does not have any techniques in the selected domain(s) Cloud Storage: Cloud Storage Access Opening of a cloud storage infrastructure, typically to collect/read its value (ex: AWS S3 GetObject) Cloud Storage: Cloud Storage Access Opening of a cloud storage infrastructure, typically to collect/read its value (ex: AWS S3 GetObject) Domain ID Name Detects Enterprise T1619 Cloud Storage Object Discovery Monitor for unusual queries to the cloud provider's storage service. Activity originating from unexpected sources may indicate improper permissions are set that is allowing access to data. Additionally, detecting failed attempts by a user for a certain object, followed by escalation of privileges by the same user, and access to the same object may be an indication of suspicious activity. Enterprise T1530 Data from Cloud Storage Monitor for unusual queries to the cloud provider's storage service. Activity originating from unexpected sources may indicate improper permissions are set and are allowing access to data. Additionally, detecting failed attempts by a user for a certain object, followed by escalation of privileges by the same user, and access to the same object may be an indication of suspicious activity. Enterprise T1048 Exfiltration Over Alternative Protocol Monitor for unusual queries to the cloud provider's storage service. Activity originating from unexpected sources may indicate improper permissions are set and are allowing access to data. Additionally, detecting failed attempts by a user for a certain object, followed by escalation of privileges by the same user, and access to the same object may be an indication of suspicious activity. Cloud Storage: Cloud Storage Creation Initial construction of new cloud storage infrastructure (ex: AWS S3 CreateBucket) Cloud Storage: Cloud Storage Creation Initial construction of new cloud storage infrastructure (ex: AWS S3 CreateBucket) Domain ID Name Detects Enterprise T1537 Transfer Data to Cloud Account Monitor account activity for attempts to create and share data, such as snapshots or backups, with untrusted or unusual accounts. Cloud Storage: Cloud Storage Deletion Removal of cloud storage infrastructure (ex: AWS S3 DeleteBucket) Cloud Storage: Cloud Storage Deletion Removal of cloud storage infrastructure (ex: AWS S3 DeleteBucket) Domain ID Name Detects Enterprise T1485 Data Destruction Monitor for unexpected deletion of a cloud storage infrastructure, such as the DeleteDBCluster and DeleteGlobalCluster events in AWS, or a high quantity of data deletion events, such as DeleteBucket. Many of these events within a short period of time may indicate malicious activity. Enterprise T1490 Inhibit System Recovery Monitor for unexpected deletion of a cloud storage objects (ex: AWS delete-object), especially those associated with cloud backups. Cloud Storage: Cloud Storage Enumeration An extracted list of cloud storage infrastructure (ex: AWS S3 ListBuckets or ListObjects) Cloud Storage: Cloud Storage Enumeration An extracted list of cloud storage infrastructure (ex: AWS S3 ListBuckets or ListObjects) Domain ID Name Detects Enterprise T1580 Cloud Infrastructure Discovery Monitor cloud logs for API calls and other potentially unusual activity related to cloud data object storage enumeration. Discovery techniques normally occur throughout an operation as an adversary learns the environment. Data and events should not be viewed in isolation, but as part of a chain of behavior that could lead to other activities, such as Collection and Exfiltration, based on the information obtained. Enterprise T1619 Cloud Storage Object Discovery Monitor cloud logs for API calls used for file or object enumeration for unusual activity. System and network discovery techniques normally occur throughout an operation as an adversary learns the environment. Data and events should not be viewed in isolation, but as part of a chain of behavior that could lead to other activities, such as Collection and Exfiltration, based on the information obtained. Cloud Storage: Cloud Storage Metadata Contextual data about cloud storage infrastructure and activity around it such as name, size, or owner Cloud Storage: Cloud Storage Metadata Contextual data about cloud storage infrastructure and activity around it such as name, size, or owner Domain ID Name Detects Enterprise T1537 Transfer Data to Cloud Account Periodically baseline cloud storage infrastructure to identify malicious modifications or additions. Cloud Storage: Cloud Storage Modification Changes made to cloud storage infrastructure, including its settings and/or data (ex: AWS S3 PutObject or PutObjectAcl) Cloud Storage: Cloud Storage Modification Changes made to cloud storage infrastructure, including its settings and/or data (ex: AWS S3 PutObject or PutObjectAcl) Domain ID Name Detects Enterprise T1486 Data Encrypted for Impact Monitor for changes made in cloud environments for events that indicate storage objects have been anomalously modified. Enterprise T1537 Transfer Data to Cloud Account Monitor for anomalous file transfer activity between accounts and/or to untrusted/unexpected VPCs. References Amazon. (n.d.). Amazon S3. Retrieved October 13, 2021. Microsoft. (n.d.). Azure Blob Storage. Retrieved October 13, 2021. Google. (n.d.). Cloud Storage. Retrieved October 13, 2021. "
},
{
"id": 1957,
"title": "Cloud Service, Data Source DS0025",
"path": "/datasources/DS0025/index.html",
"content": " Cloud Service Infrastructure, platforms, or software that are hosted on-premise or by third-party providers, made available to users through network connections and/or APIs[1][2] ID: DS0025 \u24d8 Platforms: Azure AD, Google Workspace, IaaS, Office 365, SaaS \u24d8 Collection Layer: Cloud Control Plane Contributors: Center for Threat-Informed Defense (CTID) Version: 1.0 Created: 20 October 2021 Last Modified: 30 March 2022 Version Permalink Live Version Data Components This data source does not have any techniques in the selected domain(s) Cloud Service: Cloud Service Disable Deactivation or stoppage of a cloud service (ex: AWS Cloudtrail StopLogging) Cloud Service: Cloud Service Disable Deactivation or stoppage of a cloud service (ex: AWS Cloudtrail StopLogging) Domain ID Name Detects Enterprise T1562 Impair Defenses Monitor logs for API calls to disable logging. In AWS, monitor for: StopLogging and DeleteTrail.[3] In GCP, monitor for: google.logging.v2.ConfigServiceV2.UpdateSink.[4] In Azure, monitor for az monitor diagnostic-settings delete.[5] Additionally, a sudden loss of a log source may indicate that it has been disabled. .008 Disable or Modify Cloud Logs Monitor logs for API calls to disable logging. In AWS, monitor for: StopLogging, UpdateTrail DeleteTrail.[3] In GCP, monitor for: google.logging.v2.ConfigServiceV2.UpdateSink and google.logging.v2.ConfigServiceV2.DeleteSink.[4] In Azure, monitor for az monitor diagnostic-settings update and az monitor diagnostic-settings delete.[5] Additionally, a sudden loss of a log source may indicate that it has been disabled. Cloud Service: Cloud Service Enumeration An extracted list of cloud services (ex: AWS ECS ListServices) Cloud Service: Cloud Service Enumeration An extracted list of cloud services (ex: AWS ECS ListServices) Domain ID Name Detects Enterprise T1526 Cloud Service Discovery Cloud service discovery techniques will likely occur throughout an operation where an adversary is targeting cloud-based systems and services. Data and events should not be viewed in isolation, but as part of a chain of behavior that could lead to other activities based on the information obtained.Normal, benign system and network events that look like cloud service discovery may be uncommon, depending on the environment and how they are used. Monitor cloud service usage for anomalous behavior that may indicate adversarial presence within the environment. Enterprise T1555 Credentials from Password Stores Monitor for API calls and CLI commands that attempt to enumerate and fetch credential material from cloud secrets managers, such as get-secret-value in AWS, gcloud secrets describe in GCP, and az key vault secret show in Azure. Alert on any suspicious usages of these commands, such as an account or service generating an unusually high number of secret requests. .006 Cloud Secrets Management Stores Monitor for API calls and CLI commands that attempt to enumerate and fetch credential material from the secrets manager, such as get-secret-value in AWS, gcloud secrets describe in GCP, and az key vault secret show in Azure. Alert on any suspicious usages of these commands, such as an account or service generating an unusually high number of secret requests. Enterprise T1046 Network Service Discovery Cloud service discovery techniques will likely occur throughout an operation where an adversary is targeting cloud-based systems and services. Data and events should not be viewed in isolation, but as part of a chain of behavior that could lead to other activities based on the information obtained.Normal, benign system and network events that look like cloud service discovery may be uncommon, depending on the environment and how they are used. Monitor cloud service usage for anomalous behavior that may indicate adversarial presence within the environment. Cloud Service: Cloud Service Metadata Contextual data about a cloud service and activity around it such as name, type, or purpose/function Cloud Service: Cloud Service Metadata Contextual data about a cloud service and activity around it such as name, type, or purpose/function Domain ID Name Detects Enterprise T1578 Modify Cloud Compute Infrastructure Monitor for quota increases across all regions, especially multiple quota increases in a short period of time or quota increases in unused regions. Monitor for changes to tenant-level settings such as subscriptions and enabled regions.[6] Cloud Service: Cloud Service Modification Changes made to a cloud service, including its settings and/or data (ex: AWS CloudTrail DeleteTrail or DeleteConfigRule) Cloud Service: Cloud Service Modification Changes made to a cloud service, including its settings and/or data (ex: AWS CloudTrail DeleteTrail or DeleteConfigRule) Domain ID Name Detects Enterprise T1546 Event Triggered Execution Monitor the creation and modification of cloud resources that may be abused for persistence, such as functions and workflows monitoring cloud events. Enterprise T1562 Impair Defenses Monitor changes made to cloud services for unexpected modifications to settings and/or data. .008 Disable or Modify Cloud Logs Monitor changes made to cloud services for unexpected modifications to settings and/or data Enterprise T1578 .005 Modify Cloud Compute Infrastructure: Modify Cloud Compute Configurations Monitor for quota increases across all regions, especially multiple quota increases in a short period of time or quota increases in unused regions. Monitor for changes to tenant-level settings such as subscriptions and enabled regions.[6] Enterprise T1648 Serverless Execution Monitor the creation and modification of serverless resources such as functions and workflows. References Amazon. (n.d.). Start Building on AWS Today. Retrieved October 13, 2021. Microsoft. (n.d.). Azure products. Retrieved October 13, 2021. Amazon Web Services. (n.d.). Stopping CloudTrail from Sending Events to CloudWatch Logs. Retrieved October 16, 2020. Google. (n.d.). Configuring Data Access audit logs. Retrieved October 16, 2020. Microsoft. (n.d.). az monitor diagnostic-settings. Retrieved October 16, 2020. Microsoft Threat Intelligence. (2023, July 25). Cryptojacking: Understanding and defending against cloud compute resource abuse. Retrieved September 5, 2023. "
},
{
"id": 1958,
"title": "Service, Data Source DS0019",
"path": "/datasources/DS0019/index.html",
"content": " Service A computer process that is configured to execute continuously in the background and perform system tasks, in some cases before any user has logged in[1][2] ID: DS0019 \u24d8 Platforms: Linux, Windows, macOS \u24d8 Collection Layer: Host Contributors: Center for Threat-Informed Defense (CTID) Version: 1.0 Created: 20 October 2021 Last Modified: 30 March 2022 Version Permalink Live Version Data Components This data source does not have any techniques in the selected domain(s) Service: Service Creation Initial construction of a new service/daemon (ex: Windows EID 4697 or /var/log daemon logs) Service: Service Creation Initial construction of a new service/daemon (ex: Windows EID 4697 or /var/log daemon logs) Domain ID Name Detects Enterprise T1557 Adversary-in-the-Middle Monitor for newly constructed services/daemons through Windows event logs for event IDs 4697 and 7045. Data and events should not be viewed in isolation, but as part of a chain of behavior that could lead to other activities, such as remote logins or process creation events. .001 LLMNR/NBT-NS Poisoning and SMB Relay Monitor for newly constructed services/daemons through Windows event logs for event IDs 4697 and 7045. [3] Deploy an LLMNR/NBT-NS spoofing detection tool.[4] ICS T0830 Adversary-in-the-Middle Monitor for newly constructed services/daemons through Windows event logs for event IDs 4697 and 7045. Enterprise T1543 Create or Modify System Process Monitor for newly constructed services/daemons that may create or modify system-level processes to repeatedly execute malicious payloads as part of persistence. .001 Launch Agent Monitor Launch Agent creation through additional plist files and utilities such as Objective-See\u2019s KnockKnock application. .002 Systemd Service Monitor for new constructed systemd services to repeatedly execute malicious payloads as part of persistence. .003 Windows Service Creation of new services may generate an alterable event (ex: Event ID 4697 and/or 7045 [5][6]), especially those associated with unknown/abnormal drivers. New, benign services may be created during installation of new software. Analytic 1 : Creation of new services with unusual directory paths such as temporal files in APPDATA suspicious_services = filter ServiceName, ServiceFilePath, ServiceType, ServiceStartType, ServiceAccountName where (event_id == \"7045\" OR event_id == \"4697\") AND (ServiceFilePath LIKE '%APPDATA%' OR ServiceImagePath LIKE '%PUBLIC%') .004 Launch Daemon Monitor for newly constructed services may create or modify Launch Daemons to execute malicious payloads as part of persistence. Enterprise T1564 Hide Artifacts Monitor for newly constructed services/daemons that may attempt to hide artifacts associated with their behaviors to evade detection. .006 Run Virtual Instance Monitor for newly constructed services/daemons that may carry out malicious operations using a virtual instance to avoid detection. Consider monitoring for new Windows Service, with respect to virtualization software. Enterprise T1036 Masquerading Monitor for newly constructed services/daemons that may attempt to manipulate features of their artifacts to make them appear legitimate or benign to users and/or security tools. .004 Masquerade Task or Service Monitor for newly constructed services/daemons. Data and events should not be viewed in isolation, but as part of a chain of behavior that could lead to other activities, such as network connections made for Command and Control, learning details about the environment through Discovery, and Lateral Movement. ICS T0849 Masquerading Monitor for newly constructed services/daemons that may attempt to manipulate features of their artifacts to make them appear legitimate or benign to users and/or security tools. Enterprise T1569 System Services Monitor for newly constructed services/daemons to execute commands or programs. .001 Launchctl Monitor for newly constructed services/daemons to execute commands or programs. .002 Service Execution Monitor newly constructed services that abuse control manager to execute malicious commands or payloads. Service: Service Metadata Contextual data about a service/daemon, which may include information such as name, service executable, start type, etc. Service: Service Metadata Contextual data about a service/daemon, which may include information such as name, service executable, start type, etc. Domain ID Name Detects Enterprise T1197 BITS Jobs BITS runs as a service and its status can be checked with the Sc query utility (sc query bits).[7] Enterprise T1574 Hijack Execution Flow Look for changes to binaries and service executables that may normally occur during software updates. If an executable is written, renamed, and/or moved to match an existing service executable, it could be detected and correlated with other suspicious behavior. Hashing of binaries and service executables could be used to detect replacement against historical data. .005 Executable Installer File Permissions Weakness Monitor for abnormal process call trees from typical processes and services and for execution of other commands that could relate to Discovery or other adversary techniques. .010 Services File Permissions Weakness Hashing of binaries and service executables could be used to detect replacement against historical data. Enterprise T1562 Impair Defenses Monitor contextual data about a service/daemon, which may include information such as name, service executable, start type that that may maliciously modify components of a victim environment in order to hinder or disable defensive mechanisms. .001 Disable or Modify Tools Monitor for telemetry that provides context of security software services being disabled or modified. In cloud environments, monitor virtual machine logs for the status of cloud security agents. Spyware and malware remain a serious problem and Microsoft developed security services, Windows Defender and Windows Firewall, to combat this threat. In the event Windows Defender or Windows Firewall is turned off, administrators should correct the issue immediately to prevent the possibility of infection or further infection and investigate to determine if caused by crash or user manipulation.Note: Stopping services events are Windows Event Code 7036. Analytic 1 - User Activity from Stopping Windows Defensive Services log_name == \"System\" ANDevent_code == \"7036\"param1 in [\"Windows Defender\", \"Windows Firewall\"] ANDparam2 == \"stopped\" Enterprise T1490 Inhibit System Recovery Monitor the status of services involved in system recovery. Note: For Windows, Event ID 7040 can be used to alert on changes to the start type of a service (e.g., going from enabled at startup to disabled) associated with system recovery. Enterprise T1036 Masquerading Monitor for contextual data about a service/daemon, which may include information such as name, service executable, start type, etc. .004 Masquerade Task or Service Monitor for changes made to services for unexpected modifications to names, descriptions, and/or start types Enterprise T1021 .006 Remote Services: Windows Remote Management Monitor use of WinRM within an environment by tracking service execution. If it is not normally used or is disabled, then this may be an indicator of suspicious behavior. Enterprise T1489 Service Stop Alterations to the service binary path or the service startup type changed to disabled may be suspicious. ICS T0881 Service Stop Alterations to the service binary path or the service startup type changed to disabled may be suspicious. Service: Service Modification Changes made to a service/daemon, such as changes to name, description, and/or start type (ex: Windows EID 7040 or /var/log daemon logs) Service: Service Modification Changes made to a service/daemon, such as changes to name, description, and/or start type (ex: Windows EID 7040 or /var/log daemon logs) Domain ID Name Detects Enterprise T1543 Create or Modify System Process Monitor for changes to system processes that do not correlate with known software, patch cycles, etc., including by comparing results against a trusted system baseline. .001 Launch Agent Monitor for changes made to launch agents to repeatedly execute malicious payloads as part of persistence. .002 Systemd Service Analyze the contents of .service files present on the file system and ensure that they refer to legitimate, expected executables. .003 Windows Service Monitor for changes made to Windows services to repeatedly execute malicious payloads as part of persistence. Analytic 1 : System services via registry modifications suspicious_processes = filter ProcessGuid, ProcessFilePath, RegistryKeyPath, UserName where event_id == \"13\" AND EventType == \"SetValue\" AND RegistryKeyPath LIKE '%HKLM\\System\\CurrentControlSet\\Services\\%' AND (RegistryKeyPath LIKE '%ImagePath%' OR RegistryKeyPath LIKE '%Type%' OR RegistryKeyPath LIKE '%DisplayName%' OR RegistryKeyPath LIKE '%Objectname%') .004 Launch Daemon Monitor services for changes made to Launch Daemons to execute malicious payloads as part of persistence. Enterprise T1574 .011 Hijack Execution Flow: Services Registry Permissions Weakness Modification to existing services should not occur frequently. If a service binary path or failure parameters are changed to values that are not typical for that service and does not correlate with software updates, then it may be due to malicious activity. ICS T0849 Masquerading Monitor for changes made to services that may attempt to manipulate features of their artifacts to make them appear legitimate or benign to users and/or security tools. References Microsoft. (2017, March 30). Introduction to Windows Service Applications. Retrieved September 28, 2021. The Linux Foundation. (2006, January 11). An introduction to services, runlevels, and rc.d scripts. Retrieved September 28, 2021. Kuehn, E. (2018, April 11). Ever Run a Relay? Why SMB Relays Should Be On Your Mind. Retrieved February 7, 2019. Robertson, K. (2016, August 28). Conveigh. Retrieved November 17, 2017. Miroshnikov, A. & Hall, J. (2017, April 18). 4697(S): A service was installed in the system. Retrieved August 7, 2018. Hardy, T. & Hall, J. (2018, February 15). Use Windows Event Forwarding to help with intrusion detection. Retrieved August 7, 2018. Microsoft. (2011, July 19). Issues with BITS. Retrieved January 12, 2018. "
},
{
"id": 1959,
"title": "Command, Data Source DS0017",
"path": "/datasources/DS0017/index.html",
"content": " Command A directive given to a computer program, acting as an interpreter of some kind, in order to perform a specific task[1][2] ID: DS0017 \u24d8 Platforms: Android, Containers, Linux, Network, Windows, iOS, macOS \u24d8 Collection Layers: Container, Host Contributors: Center for Threat-Informed Defense (CTID); Austin Clark, @c2defense Version: 1.1 Created: 20 October 2021 Last Modified: 20 April 2023 Version Permalink Live Version Data Components This data source does not have any techniques in the selected domain(s) Command: Command Execution The execution of a line of text, potentially with arguments, created from program code (e.g. a cmdlet executed via powershell.exe, interactive commands like >dir, shell executions, etc. ) Command: Command Execution The execution of a line of text, potentially with arguments, created from program code (e.g. a cmdlet executed via powershell.exe, interactive commands like >dir, shell executions, etc. ) Domain ID Name Detects Enterprise T1548 Abuse Elevation Control Mechanism Monitor executed commands and arguments that may circumvent mechanisms designed to control elevate privileges to gain higher-level permissions. .001 Setuid and Setgid Monitor for execution of utilities, like chmod, and their command-line arguments to look for setuid or setguid bits being set. .002 Bypass User Account Control Monitor executed commands and arguments that may bypass UAC mechanisms to elevate process privileges on system. .003 Sudo and Sudo Caching Monitor executed commands and arguments that may perform sudo caching and/or use the suoders file to elevate privileges, such as the sudo command. Enterprise T1134 Access Token Manipulation Monitor executed commands and arguments for token manipulation by auditing command-line activity. Specifically, analysts should look for use of the runas command. Detailed command-line logging is not enabled by default in Windows.[3] .001 Token Impersonation/Theft Monitor executed commands and arguments to detect token manipulation by auditing command-line activity. Specifically, analysts should look for use of the runas command. Detailed command-line logging is not enabled by default in Windows.[3] .002 Create Process with Token Monitor executed commands and arguments to detect token manipulation by auditing command-line activity. Specifically, analysts should look for use of the runas command or similar artifacts. Detailed command-line logging is not enabled by default in Windows.[3] .003 Make and Impersonate Token Monitor executed commands and arguments to detect token manipulation by auditing command-line activity. Specifically, analysts should look for use of the runas command or similar artifacts. Detailed command-line logging is not enabled by default in Windows.[3] Enterprise T1087 Account Discovery Monitor logs and other sources of command execution history for actions that could be taken to gather information about accounts, including the use of calls to cloud APIs that perform account discovery. System and network discovery techniques normally occur throughout an operation as an adversary learns the environment, and also to an extent in normal network operations. Therefore discovery data and events should not be viewed in isolation, but as part of a chain of behavior that could lead to other activities, such as Lateral Movement, based on the information obtained. .001 Local Account Monitor for execution of commands and arguments associated with enumeration or information gathering of local accounts and groups such as net user, net account, net localgroup, Get-LocalUser, and dscl. System and network discovery techniques normally occur throughout an operation as an adversary learns the environment, and also to an extent in normal network operations. Therefore discovery data and events should not be viewed in isolation, but as part of a chain of behavior that could lead to other activities, such as Lateral Movement, based on the information obtained. .002 Domain Account Monitor for execution of commands and arguments associated with enumeration or information gathering of domain accounts and groups, such as net user /domain and net group /domain, dscacheutil -q groupon macOS, and ldapsearch on Linux. System and network discovery techniques normally occur throughout an operation as an adversary learns the environment, and also to an extent in normal network operations. Therefore discovery data and events should not be viewed in isolation, but as part of a chain of behavior that could lead to other activities, such as Lateral Movement, based on the information obtained. .003 Email Account Monitor for execution of commands and arguments associated with enumeration or information gathering of email addresses and accounts such as Get-AddressList, Get-GlobalAddressList, and Get-OfflineAddressBook. .004 Cloud Account Monitor logs for actions that could be taken to gather information about cloud accounts, including the use of calls to cloud APIs that perform account discovery. System and network discovery techniques normally occur throughout an operation as an adversary learns the environment, and also to an extent in normal network operations. Therefore discovery data and events should not be viewed in isolation, but as part of a chain of behavior that could lead to other activities, such as Lateral Movement, based on the information obtained. Enterprise T1098 Account Manipulation Monitor executed commands and arguments for suspicious commands to modify accounts or account settings (including files such as the authorized_keys or /etc/ssh/sshd_config). Monitor executed commands and arguments of suspicious commands (such as Add-MailboxPermission) that may be indicative of modifying the permissions of Exchange and other related service settings. .004 SSH Authorized Keys Monitor executed commands and arguments to modify the authorized_keys or /etc/ssh/sshd_config files. Enterprise T1010 Application Window Discovery Monitor executed commands and arguments for actions that could be taken to gather system and network information. Information may also be acquired through Windows system management tools such as Windows Management Instrumentation and PowerShell. Note: Commands can also be obtained from Payload event field for PowerShell event id 4103. For PowerShell Module logging event id 4103, enable logging for module Microsoft.PowerShell.Management. Analytic 1 - Suspicious Commands suspicious_commands = filter commands where event_id == \"4103\" AND ((command_line LIKE '%Get-Process%' AND command_line_parameter LIKE '%mainWindowTitle%')) Enterprise T1560 Archive Collected Data Monitor executed commands and arguments for actions that will aid in compression or encrypting data that is collected prior to exfiltration, such as tar. .001 Archive via Utility Monitor executed commands and arguments for actions that will aid in compression or encrypting data that is collected prior to exfiltration, such as tar. Enterprise T1123 Audio Capture Monitor executed commands and arguments for actions that can leverage a computer\u2019s peripheral devices (e.g., microphones and webcams) or applications (e.g., voice and video call services) to capture audio recordings for the purpose of listening into sensitive conversations to gather information. Enterprise T1119 Automated Collection Monitor executed commands and arguments for actions that could be taken to collect internal data. ICS T0802 Automated Collection Monitor executed commands and arguments for actions that could be taken to collect internal data. Enterprise T1020 Automated Exfiltration Monitor executed commands and arguments that may exfiltrate data, such as sensitive documents, through the use of automated processing after being gathered during Collection Enterprise T1197 BITS Jobs Monitor executed commands and arguments from the BITSAdmin tool (especially the \u2018Transfer\u2019, 'Create', 'AddFile', 'SetNotifyFlags', 'SetNotifyCmdLine', 'SetMinRetryDelay', 'SetCustomHeaders', and 'Resume' command options)[4] Admin logs, PowerShell logs, and the Windows Event log for BITS activity.[5] Also consider investigating more detailed information about jobs by parsing the BITS job database.[6] Enterprise T1547 Boot or Logon Autostart Execution Monitor executed commands and arguments that may configure system settings to automatically execute a program during system boot or logon to maintain persistence or gain higher-level privileges on compromised systems. .001 Registry Run Keys / Startup Folder Monitor executed commands and arguments that may achieve persistence by adding a program to a startup folder or referencing it with a Registry run key. .002 Authentication Package Monitor executed commands and arguments that may abuse authentication packages to execute DLLs when the system boots. .003 Time Providers Monitor executed commands and arguments that may abuse time providers to execute DLLs when the system boots. .004 Winlogon Helper DLL Monitor executed commands and arguments that may abuse features of Winlogon to execute DLLs and/or executables when a user logs in. Analytic 1 - Modification of the Winlogon Registry Key suspicious_processes = filter processes where (event_id == \"1\" OR event_id == \"4688\") AND (ProcessCommandLine LIKE '%Microsoft\\Windows NT\\CurrentVersion\\Winlogon%' AND (ProcessCommandLine LIKE '%Userinit%' OR ProcessCommandLine LIKE '%Shell%' OR ProcessCommandLine LIKE '%Notify%')) AND (ProcessCommandLine LIKE '%reg%' OR ProcessCommandLine LIKE '%add%' OR ProcessCommandLine LIKE '%/d%' OR ProcessCommandLine LIKE '%Set-ItemProperty%' OR ProcessCommandLine LIKE '%New-ItemProperty%' ProcessCommandLine LIKE '%-value%') .005 Security Support Provider Monitor executed commands and arguments that may abuse security support providers (SSPs) to execute DLLs when the system boots. .006 Kernel Modules and Extensions Loading, unloading, and manipulating modules on Linux systems can be detected by monitoring for the following commands: modprobe, insmod, lsmod, rmmod, or modinfo [7] Adversaries may run commands on the target system before loading a malicious module in order to ensure that it is properly compiled. [8] Adversaries may also execute commands to identify the exact version of the running Linux kernel and/or download multiple versions of the same .ko (kernel object) files to use the one appropriate for the running system.[9] Many LKMs require Linux headers (specific to the target kernel) in order to compile properly. These are typically obtained through the operating systems package manager and installed like a normal package. On macOS, monitor for execution of kextload commands and user installed kernel extensions performing abnormal and/or potentially malicious activity (such as creating network connections). Monitor for new rows added in the kext_policy table. KextPolicy stores a list of user approved (non Apple) kernel extensions and a partial history of loaded kernel modules in a SQLite database, /var/db/SystemPolicyConfiguration/KextPolicy.[10][11][12] .007 Re-opened Applications Monitor executed commands and arguments that may modify plist files to automatically run an application when a user logs in. .013 XDG Autostart Entries Monitor executed commands and arguments that may modify XDG autostart entries to execute programs or commands during system boot. .014 Active Setup Monitor executed commands and arguments that may achieve persistence by adding a Registry key to the Active Setup of the local machine. Enterprise T1037 Boot or Logon Initialization Scripts Monitor executed commands and arguments that may consist of logon scripts for unusual access by abnormal users or at abnormal times. .001 Logon Script (Windows) Monitor executed commands and arguments for logon scripts .002 Login Hook Monitor executed commands with arguments to install or modify login hooks. .003 Network Logon Script Monitor executed commands and arguments for logon scripts .004 RC Scripts Monitor executed commands and arguments resulting from RC scripts for unusual or unknown applications or behavior .005 Startup Items Monitor executed commands and arguments for logon scripts Enterprise T1176 Browser Extensions Monitor executed commands and arguments for usage of the profiles tool, such as profiles install -type=configuration. Enterprise T1217 Browser Information Discovery Monitor executed commands and arguments for actions that could be taken to gather browser information, such as local files and databases (e.g., %APPDATA%/Google/Chrome).[13] Remote access tools with built-in features may interact directly using APIs to gather information. Information may also be acquired through system management tools such as Windows Management Instrumentation and PowerShell. Enterprise T1110 Brute Force Monitor executed commands and arguments that may use brute force techniques to gain access to accounts when passwords are unknown or when password hashes are obtained. Enterprise T1115 Clipboard Data Monitor executed commands and arguments to collect data stored in the clipboard from users copying information within or between applications. Enterprise T1651 Cloud Administration Command Monitor commands and scripts executed on virtual machines. In Azure, usage of Azure RunCommand can be identified via the Azure Activity Logs, and additional details on the result of executed jobs are available in the C:\\Packages\\Plugins\\Microsoft.CPlat.Core.RunCommandWindows directory on Windows virtual machines.[14] Enterprise T1059 Command and Scripting Interpreter Monitor command-line arguments for script execution and subsequent behavior. Actions may be related to network and system information Discovery, Collection, or other scriptable post-compromise behaviors and could be used as indicators of detection leading back to the source script. Scripts are likely to perform actions with various effects on a system that may generate events, depending on the types of monitoring used. .001 PowerShell If proper execution policy is set, adversaries will likely be able to define their own execution policy if they obtain administrator or system access, either through the Registry or at the command line. This change in policy on a system may be a way to detect malicious use of PowerShell. If PowerShell is not used in an environment, then simply looking for PowerShell execution may detect malicious activity. It is also beneficial to turn on PowerShell logging to gain increased fidelity in what occurs during execution (which is applied to .NET invocations). [15] PowerShell 5.0 introduced enhanced logging capabilities, and some of those features have since been added to PowerShell 4.0. Earlier versions of PowerShell do not have many logging features.[16] An organization can gather PowerShell execution details in a data analytic platform to supplement it with other data. .002 AppleScript Monitor executed commands and arguments that may abuse AppleScript for execution. Scripts are likely to perform actions with various effects on a system that may generate events, depending on the types of monitoring used. Actions may be related to network and system information Discovery, Collection, or other scriptable post-compromise behaviors and could be used as indicators of detection leading back to the source script. .003 Windows Command Shell Monitor executed commands and arguments that may abuse the Windows command shell for execution. Usage of the Windows command shell may be common on administrator, developer, or power user systems depending on job function. If scripting is restricted for normal users, then any attempt to enable scripts running on a system would be considered suspicious. If scripts are not commonly used on a system, but enabled, scripts running out of cycle from patching or other administrator functions are suspicious. Scripts should be captured from the file system when possible to determine their actions and intent. .004 Unix Shell Monitor executed commands and arguments that may abuse Unix shell commands and scripts for execution. Unix shell usage may be common on administrator, developer, or power user systems, depending on job function. If scripting is restricted for normal users, then any attempt to enable scripts running on a system would be considered suspicious. If scripts are not commonly used on a system, but enabled, scripts running out of cycle from patching or other administrator functions are suspicious. Scripts should be captured from the file system when possible to determine their actions and intent. .005 Visual Basic Monitor executed commands and arguments that may abuse Visual Basic (VB) for execution. .006 Python Monitor systems for abnormal Python usage and python.exe behavior, which could be an indicator of malicious activity. Understanding standard usage patterns is important to avoid a high number of false positives. If scripting is restricted for normal users, then any attempts to enable scripts running on a system would be considered suspicious. If scripts are not commonly used on a system, but enabled, scripts running out of cycle from patching or other administrator functions are suspicious. Scripts should be captured from the file system when possible to determine their actions and intent. Scripts are likely to perform actions with various effects on a system that may generate events, depending on the types of monitoring used. Monitor executed commands and arguments that may abuse Python commands and scripts for execution. .007 JavaScript Scripting execution is likely to perform actions with various effects on a system that may generate events, depending on the types of monitoring used. Monitor processes and command-line arguments for execution and subsequent behavior. Actions may be related to network and system information Discovery, Collection, or other programmable post-compromise behaviors and could be used as indicators of detection leading back to the source. Monitor for execution of JXA through osascript and usage of OSAScript API that may be related to other suspicious behavior occurring on the system. .008 Network Device CLI Consider reviewing command history in either the console or as part of the running memory to determine if unauthorized or suspicious commands were used to modify device configuration. [17] Consider comparing a copy of the network device configuration against a known-good version to discover unauthorized changes to the command interpreter. The same process can be accomplished through a comparison of the run-time memory, though this is non-trivial and may require assistance from the vendor. .009 Cloud API Consider reviewing command history in either host machines or cloud audit logs to determine if unauthorized or suspicious commands were executed. Cloud API activity logging is typically enabled by default and may be reviewed in sources like the Microsoft Unified Audit Log, AWS CloudTrail, and GCP Admin Acitivty logs. Review these sources for history of executed API commands. Host logs may also be reviewed to capture CLI commands or PowerShell module usage to invoke Cloud API functions. Mobile T1623 Command and Scripting Interpreter Command-line activities can potentially be detected through Mobile Threat Defense (MTD) integrations with lower-level OS APIs. This could grant the MTD agents access to running processes and their parameters, potentially detecting unwanted or malicious shells. .001 Unix Shell Command-line activities can potentially be detected through Mobile Threat Defense (MTD) integrations with lower-level OS APIs. This could grant the MTD agents access to running processes and their parameters, potentially detecting unwanted or malicious shells. ICS T0807 Command-Line Interface On Windows and Unix systems monitor executed commands and arguments that may use shell commands for execution. Shells may be common on administrator, developer, or power user systems depending on job function. On network device and embedded system CLIs consider reviewing command history if unauthorized or suspicious commands were used to modify device configuration. Enterprise T1609 Container Administration Command Monitor commands and arguments executed by container services. In Docker, the daemon log provides insight into events at the daemon and container service level. Kubernetes system component logs may also detect activities running in and out of containers in the cluster. Enterprise T1136 Create Account Monitor executed commands and arguments for actions that are associated with account creation, such as net user or useradd .001 Local Account Monitor executed commands and arguments for actions that are associated with local account creation, such as net user /add, useradd, dscl -create, and kubectl create serviceaccount. .002 Domain Account Monitor executed commands and arguments for actions that are associated with local account creation, such as net user /add /domain. Enterprise T1543 Create or Modify System Process Command-line invocation of tools capable of modifying services may be unusual, depending on how systems are typically used in a particular environment. Look for abnormal process call trees from known services and for execution of other commands that could relate to Discovery or other adversary techniques. .001 Launch Agent Ensure Launch Agent's ProgramArguments key pointing to executables located in the /tmp or /shared folders are in alignment with enterprise policy. Ensure all Launch Agents with the RunAtLoad key set to true are in alignment with policy. .002 Systemd Service Suspicious systemd services can also be identified by comparing results against a trusted system baseline. Malicious systemd services may be detected by using the systemctl utility to examine system wide services: systemctl list-units -\u2013type=service \u2013all. Auditing the execution and command-line arguments of the 'systemctl' utility, as well related utilities such as /usr/sbin/service may reveal malicious systemd service execution. .003 Windows Service Monitor processes and command-line arguments for actions that could create or modify services. Command-line invocation of tools capable of adding or modifying services may be unusual, depending on how systems are typically used in a particular environment. Services may also be modified through Windows system management tools such as Windows Management Instrumentation and PowerShell, so additional logging may need to be configured to gather the appropriate data. Also collect service utility execution and service binary path arguments used for analysis. Service binary paths may even be changed to execute commands or scripts. .004 Launch Daemon Some legitimate LaunchDaemons point to unsigned code that could be exploited. For Launch Daemons with the RunAtLoad parameter set to true, ensure the Program parameter points to signed code or executables are in alignment with enterprise policy. Some parameters are interchangeable with others, such as Program and ProgramArguments parameters but one must be present. [18] Enterprise T1555 Credentials from Password Stores Monitor executed commands and arguments that may search for common password storage locations to obtain user credentials. .001 Keychain Monitor executed commands with arguments that may be used to collect Keychain data from a system to acquire credentials. .002 Securityd Memory Monitor executed commands and arguments that may obtain root access (allowing them to read securityd\u2019s memory), then they can scan through memory to find the correct sequence of keys in relatively few tries to decrypt the user\u2019s logon keychain. .003 Credentials from Web Browsers Monitor executed commands and arguments that may acquire credentials from web browsers by reading files specific to the target browser.[19] .004 Windows Credential Manager Monitor executed commands and arguments for suspicious activity listing credentials from the Windows Credentials locker (e.g. vaultcmd /listcreds:\"Windows Credentials\").[20] .005 Password Managers Monitor executed commands and arguments that may acquire user credentials from third-party password managers. [21] Enterprise T1485 Data Destruction Monitor executed commands and arguments for binaries that could be involved in data destruction activity, such as SDelete. Mobile T1662 Data Destruction Command-line activities can potentially be detected through Mobile Threat Defense (MTD) integrations with lower-level OS APIs. This could grant the MTD agents access to running processes and their parameters, potentially detecting file deletion processes. ICS T0809 Data Destruction Monitor executed commands and arguments for binaries that could be involved in data destruction activity, such as SDelete. Enterprise T1486 Data Encrypted for Impact Monitor executed commands and arguments for actions involved in data destruction activity, such as vssadmin, wbadmin, and bcdedit Enterprise T1005 Data from Local System Monitor executed commands and arguments that may search and collect local system sources, such as file systems or local databases, to find files of interest and sensitive data prior to Exfiltration. Remote access tools with built-in features may interact directly with the Windows API to gather data. Data may also be acquired through Windows system management tools such as Windows Management Instrumentation and PowerShell. For network devices, monitor executed commands in AAA logs, especially those run by unexpected or unauthorized users. ICS T0893 Data from Local System Monitor executed commands and arguments that may search and collect local system sources, such as file systems or local databases, to find files of interest and sensitive data. Remote access tools with built-in features may interact directly with the Windows API to gather data. Data may also be acquired through Windows system management tools such as Windows Management Instrumentation and PowerShell. Enterprise T1039 Data from Network Shared Drive Monitor executed commands and arguments for actions that could be taken to collect files from a network share. Remote access tools with built-in features may interact directly with the Windows API to gather and copy to a location. Data may also be acquired and staged through Windows system management tools such as Windows Management Instrumentation and PowerShell. Enterprise T1025 Data from Removable Media Monitor executed commands and arguments for actions that could be taken to collect files from a system's connected removable media. For example, data may be acquired through Windows system management tools such as Windows Management Instrumentation and PowerShell. Enterprise T1074 Data Staged Monitor executed commands and arguments arguments for actions that could be taken to collect and combine files. Remote access tools with built-in features may interact directly with the Windows API to gather and copy to a location. Data may also be acquired and staged through Windows system management tools such as Windows Management Instrumentation and PowerShell. .001 Local Data Staging Monitor executed commands and arguments arguments for actions that could be taken to collect and combine files. Remote access tools with built-in features may interact directly with the Windows API to gather and copy to a location. Data may also be acquired and staged through Windows system management tools such as Windows Management Instrumentation and PowerShell. .002 Remote Data Staging Monitor executed commands and arguments arguments for actions that could be taken to collect and combine files. Remote access tools with built-in features may interact directly with the Windows API to gather and copy to a location. Data may also be acquired and staged through Windows system management tools such as Windows Management Instrumentation and PowerShell. Enterprise T1622 Debugger Evasion Monitor executed commands and arguments that may employ various means to detect and avoid debugged environments. Detecting actions related to debugger identification may be difficult depending on the adversary's implementation and monitoring required. Enterprise T1652 Device Driver Discovery Monitor executed commands (lsmod, driverquery, etc.) with arguments highlighting potentially malicious attempts to enumerate device drivers. Enterprise T1006 Direct Volume Access Monitor executed commands and arguments that could be taken to copy files from the logical drive and evade common file system protections. Since this technique may also be used through PowerShell, additional logging of PowerShell scripts is recommended. Enterprise T1561 Disk Wipe Monitor for direct access read/write attempts using the \\\\.\\ notation.[22] Monitor for unusual kernel driver installation activity. .001 Disk Content Wipe Monitor executed commands and arguments that may erase the contents of storage devices on specific systems or in large numbers in a network to interrupt availability to system and network resources. .002 Disk Structure Wipe Monitor executed commands and arguments that may corrupt or wipe the disk data structures on a hard drive necessary to boot a system; targeting specific critical systems or in large numbers in a network to interrupt availability to system and network resources. Enterprise T1484 Domain Policy Modification Monitor executed commands and arguments for modifications to domain trust settings, such as when a user or application modifies the federation settings on the domain or updates domain authentication from Managed to Federated via ActionTypes Set federation settings on domain and Set domain authentication.[23][24] .001 Group Policy Modification Monitor executed commands and arguments that may modify Group Policy Objects (GPOs) to subvert the intended discretionary access controls for a domain, usually with the intention of escalating privileges on the domain. .002 Domain Trust Modification Monitor executed commands and arguments that updates domain authentication from Managed to Federated via ActionTypes Set federation settings on domain and Set domain authentication.[23] Monitor for PowerShell commands such as: Update-MSOLFederatedDomain \u2013DomainName: \"Federated Domain Name\", or Update-MSOLFederatedDomain \u2013DomainName: \"Federated Domain Name\" \u2013supportmultipledomain.[25] Enterprise T1482 Domain Trust Discovery Monitor executed commands and arguments for actions that could be taken to gather system and network information, such as nltest /domain_trusts. Remote access tools with built-in features may interact directly with the Windows API to gather information. Enterprise T1114 Email Collection Monitor executed processes and command-line arguments for actions that could be taken to gather local email files. Remote access tools with built-in features may interact directly with the Windows API to gather information. Information may also be acquired through Windows system management tools such as Windows Management Instrumentation and PowerShell. On Windows systems, monitor for creation of suspicious inbox rules through the use of the New-InboxRule, Set-InboxRule, New-TransportRule, and Set-TransportRule PowerShell cmdlets.[26][27] .001 Local Email Collection Monitor executed commands and arguments for actions that could be taken to gather local email files. Remote access tools with built-in features may interact directly with the Windows API to gather information. Information may also be acquired through Windows system management tools such as Windows Management Instrumentation and PowerShell. .002 Remote Email Collection Monitor executed commands and arguments for actions that may target an Exchange server, Office 365, or Google Workspace to collect sensitive information. .003 Email Forwarding Rule On Windows systems, monitor for creation of suspicious inbox rules through the use of the New-InboxRule, Set-InboxRule, New-TransportRule, and Set-TransportRule PowerShell cmdlets.[26][27] Enterprise T1546 Event Triggered Execution Monitor executed commands and arguments that may establish persistence and/or elevate privileges using system mechanisms that trigger execution based on specific events. .001 Change Default File Association Monitor executed commands and arguments that may establish persistence by executing malicious content triggered by a file type association. .002 Screensaver Monitor executed commands and arguments of .scr files. Analytic 1 - Modify the HKCU\\Control Panel\\Desktop registry key suspicious_processes = filter processes where (event_id == \"1\" OR event_id == \"4688\") AND (ProcessCommandLine LIKE '%reg%' AND ProcessCommandLine LIKE '%add%' AND ProcessCommandLine LIKE '%HKCU\\Control Panel\\Desktop\\%') .003 Windows Management Instrumentation Event Subscription Monitor executed commands and arguments that can be used to register WMI persistence, such as the Register-WmiEvent PowerShell cmdlet [28] .004 Unix Shell Configuration Modification Monitor executed commands and arguments that may establish persistence through executing malicious commands triggered by a user\u2019s shell. .005 Trap Monitor executed commands and arguments that may establish persistence by executing malicious content triggered by an interrupt signal. .006 LC_LOAD_DYLIB Addition Monitor executed commands and arguments that may establish persistence by executing malicious content triggered by the execution of tainted binaries. .007 Netsh Helper DLL Monitor executed commands and arguments that may establish persistence by executing malicious content triggered by Netsh Helper DLLs. .008 Accessibility Features Monitor executed commands and arguments that may establish persistence and/or elevate privileges by executing malicious content triggered by accessibility features. Command line invocation of tools capable of modifying the Registry for associated keys are also suspicious. Utility arguments and the binaries themselves should be monitored for changes. Note: Event ID 4104 (from the Microsoft-Windows-Powershell/Operational log) captures Powershell script blocks, which can be analyzed and used to detect on abuse of Accessibility Features. .009 AppCert DLLs Monitor executed commands and arguments that may establish persistence and/or elevate privileges by executing malicious content triggered by AppCert DLLs loaded into processes. .010 AppInit DLLs Monitor executed commands and arguments that may establish persistence and/or elevate privileges by executing malicious content triggered by AppInit DLLs loaded into processes. .011 Application Shimming Monitor executed commands and arguments for sdbinst.exe for potential indications of application shim abuse. .012 Image File Execution Options Injection Monitor executed commands and arguments that may establish persistence and/or elevate privileges by executing malicious content triggered by Image File Execution Options (IFEO) debuggers. .013 PowerShell Profile Monitor abnormal PowerShell commands, unusual loading of PowerShell drives or modules. .014 Emond Monitor executed commands and arguments that may gain persistence and elevate privileges by executing malicious content triggered by the Event Monitor Daemon (emond). .015 Component Object Model Hijacking Monitor executed commands and arguments that may establish persistence by executing malicious content triggered by hijacked references to Component Object Model (COM) objects. Note: Event ID 4104 (from the Microsoft-Windows-Powershell/Operational log) captures Powershell script blocks, which can be analyzed and used to detect on changes to COM registry keys, including HKCU\\Software\\Classes\\CLSID*. .016 Installer Packages Monitor executed commands and arguments that may be related to abuse of installer packages, including malicious commands triggered by application installations. Enterprise T1480 Execution Guardrails Monitor executed commands and arguments that may gather information about the victim's business relationships that can be used during targeting. Detecting the use of guardrails may be difficult depending on the implementation. .001 Environmental Keying Monitor executed commands and arguments that may gather the victim's physical location(s) that can be used during targeting. Detecting the use of environmental keying may be difficult depending on the implementation. Enterprise T1048 Exfiltration Over Alternative Protocol Monitor executed commands and arguments that may steal data by exfiltrating it over a different protocol than that of the existing command and control channel. .001 Exfiltration Over Symmetric Encrypted Non-C2 Protocol Monitor executed commands and arguments that may steal data by exfiltrating it over a symmetrically encrypted network protocol other than that of the existing command and control channel. .002 Exfiltration Over Asymmetric Encrypted Non-C2 Protocol Monitor executed commands and arguments that may steal data by exfiltrating it over a symmetrically encrypted network protocol other than that of the existing command and control channel. .003 Exfiltration Over Unencrypted Non-C2 Protocol Monitor executed commands and arguments that may steal data by exfiltrating it over a symmetrically encrypted network protocol other than that of the existing command and control channel. Enterprise T1041 Exfiltration Over C2 Channel Monitor executed commands and arguments that may steal data by exfiltrating it over an existing command and control channel. Enterprise T1011 Exfiltration Over Other Network Medium Monitor executed commands and arguments that may attempt to exfiltrate data over a different network medium than the command and control channel .001 Exfiltration Over Bluetooth Monitor executed commands and arguments that may attempt to exfiltrate data over Bluetooth rather than the command and control channel. Enterprise T1052 Exfiltration Over Physical Medium Monitor executed commands and arguments that may attempt to exfiltrate data via a physical medium, such as a removable drive. .001 Exfiltration over USB Monitor executed commands and arguments that may attempt to exfiltrate data over a USB connected physical device. Enterprise T1567 Exfiltration Over Web Service Monitor executed commands and arguments that may use an existing, legitimate external Web service to exfiltrate data rather than their primary command and control channel. .001 Exfiltration to Code Repository Monitor executed command and arguments that may exfiltrate data to a code repository rather than over their primary command and control channel. .002 Exfiltration to Cloud Storage Monitor executed commands and arguments that may exfiltrate data to a cloud storage service rather than over their primary command and control channel. .004 Exfiltration Over Webhook Monitor executed commands and arguments that may exfiltrate data to a webhook as a malicious command and control channel. Additionally, monitor commands that may create new webhook configurations in SaaS services - for example, gh webhook forward in Github or mgc subscriptions create in Office 365.[29][30] Enterprise T1083 File and Directory Discovery Monitor executed commands and arguments that may enumerate files and directories or may search in specific locations of a host or network share for certain information within a file system. For network devices, monitor executed commands in AAA logs, especially those run by unexpected or unauthorized users. Enterprise T1222 File and Directory Permissions Modification Many of the commands used to modify ACLs and file/directory ownership are built-in system utilities and may generate a high false positive alert rate, so compare against baseline knowledge for how systems are typically used and correlate modification events with other indications of malicious activity where possible. .001 Windows File and Directory Permissions Modification Monitor for executed commands and arguments for PowerShell cmdlets that can be used to retrieve or modify file and directory DACLs. .002 Linux and Mac File and Directory Permissions Modification Many of the commands used to modify ACLs and file/directory ownership are built-in system utilities and may generate a high false positive alert rate, so compare against baseline knowledge for how systems are typically used and correlate modification events with other indications of malicious activity where possible. Commonly abused command arguments include chmod +x, chmod -R 755, and chmod 777.[31] ICS T0823 Graphical User Interface Monitor executed commands and arguments related to services specifically designed to accept remote graphical connections, such as RDP and VNC. Remote Services and Valid Accounts may be used to access a host\u2019s GUI. Enterprise T1615 Group Policy Discovery Monitor for suspicious use of gpresult. Monitor for the use of PowerShell functions such as Get-DomainGPO and Get-DomainGPOLocalGroup and processes spawning with command-line arguments containing GPOLocalGroup. Enterprise T1564 Hide Artifacts Monitor executed commands and arguments that may attempt to hide artifacts associated with their behaviors to evade detection. .001 Hidden Files and Directories Monitor the file system and shell commands for files being created with a leading \".\" and the Windows command-line use of attrib.exe to add the hidden attribute. .002 Hidden Users Monitor executed commands and arguments that could be taken to add a new user and subsequently hide it from login screens. .003 Hidden Window Monitor executed commands and arguments that may use hidden windows to conceal malicious activity from the plain sight of users. In Windows, enable and configure event logging and PowerShell logging to check for the hidden window style. .004 NTFS File Attributes The Streams tool of Sysinternals can be used to uncover files with ADSs. The dir /r command can also be used to display ADSs. [32] Many PowerShell commands (such as Get-Item, Set-Item, Remove-Item, and Get-ChildItem) can also accept a -stream parameter to interact with ADSs. [33] [34] Analytic 1 - NTFS Alternate Data Stream Execution : System Utilities (Powershell) ads_processes = filter processes where (event_id = 1 exe = \"C:\\Windows\\\\powershell.exe\" AND command_line = \"Invoke-CimMethod\\s+-ClassName\\s+Win32_Process\\s+-MethodName\\s+Create.\\b(\\w+(.\\w+)?):(\\w+(.\\w+)?)|-ep bypass\\s+-\\s+<.\\b(\\w+(.\\w+)?):(\\w+(.\\w+)?)|-command.Get-Content.-Stream.Set-Content.start-process .(\\w+(.\\w+)?)\" Analytic 2 - NTFS Alternate Data Stream Execution : System Utilities (WMIC) ads_processes = filter processes where (event_id = 1 exe = \"C:\\Windows\\\\wmic.exe\" AND command_line = \"process call create.\\\"(\\w+(.\\w+)?):(\\w+(.\\w+)?)\" Analytic 3 - NTFS Alternate Data Stream Execution : System Utilities (rundll32) ads_processes = filter processes where (event_id = 1 exe = \"C:\\Windows\\\\rundll32.exe\" AND command_line = \"\\\"?(\\w+(.\\w+)?):(\\w+(.\\w+)?)?\\\"?,\\w+\\|(advpack.dll\\|ieadvpack.dll),RegisterOCX\\s+(\\w+.\\w+):(\\w+(.\\w+)?)\\|(shdocvw.dll\\|ieframe.dll),OpenURL.(\\w+.\\w+):(\\w+(.\\w+)?)\" Analytic 4 - NTFS Alternate Data Stream Execution : System Utilities (wscript/cscript) ads_processes = filter processes where (event_id = 1 exe = \"C:\\Windows\\\\wscript.exe\" OR exe = \"C:\\Windows\\\\cscript.exe)\" AND command_line = \"(?<!\\/)\\b\\w+(.\\w+)?:\\w+(.\\w+)?$\" .006 Run Virtual Instance Consider monitoring for commands and arguments that may be atypical for benign use of virtualization software. Usage of virtualization binaries or command-line arguments associated with running a silent installation may be especially suspect (ex. -silent, -ignore-reboot), as well as those associated with running a headless (in the background with no UI) virtual instance (ex. VBoxManage startvm $VM --type headless).[35] Similarly, monitoring command line arguments which suppress notifications may highlight potentially malicious activity (ex. VBoxManage.exe setextradata global GUI/SuppressMessages \"all\"). Monitor for commands which enable hypervisors such as Hyper-V. .008 Email Hiding Rules On Windows and Exchange systems, monitor for creation or modification of suspicious inbox rules through the use of the New-InboxRule, Set-InboxRule, New-TransportRule, and Set-TransportRule PowerShell cmdlets.[26][27][36] .009 Resource Forking Monitor executed commands and arguments that are leveraging the use of resource forks, especially those immediately followed by potentially malicious activity such as creating network connections. .011 Ignore Process Interrupts Monitor executed commands and arguments, such as nohup, that may attempt to hide processes from interrupt signals. Enterprise T1574 Hijack Execution Flow Monitor executed commands and arguments that may execute their own malicious payloads by hijacking the way operating systems run programs. .006 Dynamic Linker Hijacking Monitor executed commands and arguments associated with modifications to variables and files associated with loading shared libraries such as LD_PRELOAD on Linux and DYLD_INSERT_LIBRARIES on macOS. .011 Services Registry Permissions Weakness Monitor for the execution of commands and arguments that can be used for adversaries to modify services' registry keys and values through applications such as Windows Management Instrumentation and PowerShell. Additional logging may need to be configured to gather the appropriate data. .012 COR_PROFILER Extra scrutiny should be placed on suspicious modification of Registry keys such as COR_ENABLE_PROFILING, COR_PROFILER, and COR_PROFILER_PATH by command line tools like wmic.exe, setx.exe, and Reg. Monitoring for command-line arguments indicating a change to COR_PROFILER variables may aid in detection. Enterprise T1562 Impair Defenses Monitor executed commands and arguments that may maliciously modify components of a victim environment in order to hinder or disable defensive mechanisms. .001 Disable or Modify Tools Monitor for the execution of commands and arguments associated with disabling or modification of security software processes or services such as Set-MpPreference-DisableScriptScanning 1 in Windows,sudo spctl --master-disable in macOS, and setenforce 0 in Linux. Furthermore, on Windows monitor for the execution of taskkill.exe or Net Stop commands which may deactivate antivirus software and other security systems. .002 Disable Windows Event Logging Monitor executed commands and arguments for commands that can be used to disable logging. For example, Wevtutil, auditpol, sc stop EventLog, reg add, Set- or Stop-Service, Set- or New-ItemProperty, sc config, and offensive tooling (such as Mimikatz and Invoke-Phant0m) may be used to clear logs and/or change the EventLog/audit policy.[37][38][39] .003 Impair Command History Logging Correlating a user session with a distinct lack of new commands in their .bash_history can be a clue to suspicious behavior. Monitor for modification of PowerShell command history settings through processes being created with -HistorySaveStyle SaveNothing command-line arguments and use of the PowerShell commands Set-PSReadlineOption -HistorySaveStyle SaveNothing and Set-PSReadLineOption -HistorySavePath {File Path}. For network devices, monitor for missing or inconsistencies in Network Device CLI logging present in AAA logs as well as in specific RADIUS and TACAS+ logs. .004 Disable or Modify System Firewall Monitor executed commands and arguments associated with disabling or the modification of system firewalls such as netsh advfirewall firewall set rule group=\"file and printer sharing\" new enable=Yes,ufw disable, and ufw logging off. .006 Indicator Blocking Monitor executed commands and arguments that may attempt to block indicators or events typically captured by sensors from being gathered and analyzed. Adversaries may attempt to evade system defenses by unloading minifilter drivers used by host-based sensors such as Sysmon through the use of the fltmc command-line utility. Accordingly, this analytic looks for command-line invocations of this utility when used to unload minifilter drivers. Analytic 1 - Indicator Blocking - Driver Unloaded fltmc_processes = filter processes where (exe = \"fltmc.exe\" AND command_line = \"unload\") .009 Safe Mode Boot Monitor executed commands and arguments associated with making configuration changes to boot settings, such as bcdedit.exe and bootcfg.exe.[40][41][42] .010 Downgrade Attack Monitor for commands or other activity that may be indicative of attempts to abuse older or deprecated technologies (ex: powershell \u2013v 2). .012 Disable or Modify Linux Audit System Command-line invocation of the auditctl utility may be unusual, depending on how systems are typically used in a particular environment. At runtime, look for commands to modify or create rules using the auditctl utility. Enterprise T1070 Indicator Removal Monitor executed commands and arguments that may delete or alter generated artifacts on a host system, including logs or captured files such as quarantined malware. .001 Clear Windows Event Logs Monitor executed commands and arguments for actions that would delete Windows event logs (via PowerShell) such as Remove-EventLog -LogName Security. Note: Event ID 4104 (from the Microsoft-Windows-Powershell/Operational log) captures Powershell script blocks, which can be analyzed and used to detect on attempts to Clear Windows Event Logs. In particular, Powershell has a built-in Clear-EventLog cmdlet that allows for a specified log to be cleared. .002 Clear Linux or Mac System Logs Monitor executed commands and arguments for actions that could be taken to remove or overwrite system logs. .003 Clear Command History Monitor executed commands and arguments for actions that could be taken to clear command history, such as Clear-History on Windows or clear logging / clear history via a Network Device CLI in AAA logs, or to disable writing command history, such as history -c in bash/zsh . Analytic 1 : Clear Powershell Console Command History suspicious_commands = filter ProcessId, ProcessFilePath, command_line where (event_id == \"1\" OR event_id == \"4688\") AND (command_line LIKE '%rm (Get-PSReadlineOption).HistorySavePath%' OR command_line LIKE '%del (Get-PSReadlineOption).HistorySavePath%' OR command_line LIKE '%Set-PSReadlineOption \u2013HistorySaveStyle SaveNothing%\u2019 OR command_line LIKE '%Remove-Item (Get-PSReadlineOption).HistorySavePath%' OR (command_line LIKE '%del%' AND command_line LIKE '%Microsoft\\Windows\\Powershell\\PSReadline\\ConsoleHost_history.txt%')) Analytic 2 : Powershell Commands suspicious_commands = filter CommandName, CommandType where event_id == \"4103\" AND (CommandName LIKE '%Clear-History%' OR (CommandName LIKE '%Remove-Item%' AND CommandParameterValue LIKE '%ConsoleHost_history.text%')) .004 File Deletion Monitor executed commands and arguments for actions that could be utilized to unlink, rename, or delete files. .005 Network Share Connection Removal Monitor executed commands and arguments of net use commands associated with establishing and removing remote shares over SMB, including following best practices for detection of Windows Admin Shares. .007 Clear Network Connection History and Configurations Monitor executed commands and arguments that may delete or alter malicious network configuration settings as well as generated artifacts on a host system, including logs and files such as Default.rdp or /var/log/. .008 Clear Mailbox Data Monitor executed commands and arguments that may delete or alter generated artifacts on a host system, including logs or captured files such as quarantined emails. In Exchange environments, monitor for PowerShell cmdlets that may create or alter transport rules, such as New-TransportRule and Set-TransportRule.[27] .009 Clear Persistence Monitor executed commands and arguments that may delete or alter generated artifacts associated with persistence on a host system. ICS T0872 Indicator Removal on Host Monitor executed commands and arguments that may delete or alter generated artifacts on a host system, including logs or captured files such as quarantined malware. Enterprise T1202 Indirect Command Execution Monitor executed commands and arguments to bypass security restrictions that limit the use of command-line interpreters. Enterprise T1105 Ingress Tool Transfer Monitor executed commands and arguments for suspicious activity associated with downloading external content. Enterprise T1490 Inhibit System Recovery Use process monitoring to monitor the execution and command line parameters of binaries involved in inhibiting system recovery, such as vssadmin, wbadmin, and bcdedit. Enterprise T1056 .002 Input Capture: GUI Input Capture Monitor executed commands and arguments, such as requests for credentials and/or strings related to creating password prompts that may be malicious.[43] Enterprise T1570 Lateral Tool Transfer Monitor executed commands and arguments for actions for abnormal usage of utilities and command-line arguments that may be used in support of remote transfer of files ICS T0867 Lateral Tool Transfer Monitor executed commands and arguments for abnormal usage of utilities and command-line arguments that may be used in support of remote transfer of files. Enterprise T1654 Log Enumeration Monitor for the use of commands and arguments of utilities and other tools used to access and export logs. Enterprise T1036 Masquerading Monitor executed commands and arguments that may attempt to manipulate features of their artifacts to make them appear legitimate or benign to users and/or security tools. [44] Note: For Windows, Event ID 4104 (from the Microsoft-Windows-Powershell/Operational log) captures Powershell script blocks, which can be analyzed and used to detect on potential Masquerading. .003 Rename System Utilities Monitor executed commands and arguments that may rename legitimate system utilities to try to evade security mechanisms concerning the usage of those utilities. .004 Masquerade Task or Service Monitor executed commands and arguments that may attempt to manipulate the name of a task or service to make it appear legitimate or benign. .008 Masquerade File Type Monitor for abnormal command execution from otherwise non-executable file types (such as .txt and .jpg). ICS T0849 Masquerading Monitor executed commands and arguments that may attempt to manipulate features of their artifacts to make them appear legitimate or benign to users and/or security tools.[44] Enterprise T1556 .005 Modify Authentication Process: Reversible Encryption Monitor command-line usage for -AllowReversiblePasswordEncryption $true or other actions that could be related to malicious tampering of user settings (i.e. Group Policy Modification). Enterprise T1112 Modify Registry Monitor executed commands and arguments for actions that could be taken to change, conceal, and/or delete information in the Registry. The Registry may also be modified through Windows system management tools such as Windows Management Instrumentation and PowerShell, which may require additional logging features to be configured in the operating system to collect necessary information for analysis. ICS T0840 Network Connection Enumeration Monitor executed commands and arguments that may look for details about the network configuration and settings, such as IP and/or MAC addresses, of systems they access or through information discovery of remote systems. Also monitor executed commands and arguments that may attempt to get a listing of network connections to or from the compromised system they are currently accessing or from remote systems by querying for information over the network. Information may also be acquired through Windows system management tools such as Windows Management Instrumentation and PowerShell. Enterprise T1046 Network Service Discovery Monitor executed commands and arguments that may attempt to get a listing of services running on remote hosts, including those that may be vulnerable to remote software exploitation. Enterprise T1135 Network Share Discovery Monitor executed commands and arguments that may look for folders and drives shared on remote systems as a means of identifying sources of information to gather as a precursor for Collection and to identify potential systems of interest for Lateral Movement. Enterprise T1040 Network Sniffing Monitor executed commands and arguments for actions that aid in sniffing network traffic to capture information about an environment, including authentication material passed over the network ICS T0842 Network Sniffing Monitor executed commands and arguments for actions that aid in sniffing network traffic to capture information about an environment. Enterprise T1027 Obfuscated Files or Information Monitor executed commands and arguments for indicators of obfuscation and potentially suspicious syntax such as uninterpreted escape characters (e.g., ^). Also monitor command-lines for syntax-specific signs of obfuscation, such as variations of arguments associated with encoding. .004 Compile After Delivery Monitor executed commands and arguments for actions that could be taken to gather common compilers, such as csc.exe and GCC/MinGW, and correlate with other suspicious behavior to reduce false positives from normal user and administrator behavior. .010 Command Obfuscation Monitor executed commands and arguments for indicators of obfuscation and potentially suspicious syntax such as uninterpreted escape characters (e.g., ^). Also monitor command-lines for syntax-specific signs of obfuscation, such as variations of arguments associated with encoding. Enterprise T1137 Office Application Startup Monitor executed commands and arguments that may leverage Microsoft Office-based applications for persistence between startups. Microsoft has released a PowerShell script to safely gather mail forwarding rules and custom forms in your mail environment as well as steps to interpret the output.[45] SensePost, whose tool Ruler can be used to carry out malicious rules, forms, and Home Page attacks, has released a tool to detect Ruler usage.[46] .001 Office Template Macros Monitor executed commands and arguments that may abuse Microsoft Office templates to obtain persistence on a compromised system. .002 Office Test Monitor executed commands and arguments that may abuse the Microsoft Office \"Office Test\" Registry key to obtain persistence on a compromised system. .003 Outlook Forms Monitor executed commands and arguments that may abuse Microsoft Outlook forms to obtain persistence on a compromised system. Microsoft has released a PowerShell script to safely gather mail forwarding rules and custom forms in your mail environment as well as steps to interpret the output.[45] .004 Outlook Home Page Monitor executed commands and arguments that may abuse Microsoft Outlook's Home Page feature to obtain persistence on a compromised system. Microsoft has released a PowerShell script to safely gather mail forwarding rules and custom forms in your mail environment as well as steps to interpret the output.[45] .005 Outlook Rules Monitor executed commands and arguments that may abuse Microsoft Outlook rules to obtain persistence on a compromised system. Microsoft has released a PowerShell script to safely gather mail forwarding rules and custom forms in your mail environment as well as steps to interpret the output.[45] This PowerShell script is ineffective in gathering rules with modified PR_RULE_MSG_NAME and PR_RULE_MSG_PROVIDER properties caused by adversaries using a Microsoft Exchange Server Messaging API Editor (MAPI Editor), so only examination with the Exchange Administration tool MFCMapi can reveal these mail forwarding rules.[47] .006 Add-ins Monitor executed commands and arguments that may abuse Microsoft Office add-ins to obtain persistence on a compromised system. Enterprise T1003 OS Credential Dumping Monitor executed commands and arguments that may attempt to dump credentials to obtain account login and credential material, normally in the form of a hash or a clear text password, from the operating system and software. Look for command-lines that invoke AuditD or the Security Accounts Manager (SAM). Remote access tools may contain built-in features or incorporate existing tools like Mimikatz. PowerShell scripts also exist that contain credential dumping functionality, such as PowerSploit's Invoke-Mimikatz module, [48] which may require additional logging features to be configured in the operating system to collect necessary information for analysis. .001 LSASS Memory Monitor executed commands and arguments that may attempt to access credential material stored in the process memory of the Local Security Authority Subsystem Service (LSASS). Remote access tools may contain built-in features or incorporate existing tools like Mimikatz. PowerShell scripts also exist that contain credential dumping functionality, such as PowerSploit's Invoke-Mimikatz module,[48] which may require additional logging features to be configured in the operating system to collect necessary information for analysis. Note: Event ID 4104 from the \"Microsoft-Windows-PowerShell/Operational\" log captures Powershell script blocks, whose contents can be further analyzed to determine if they\u2019re performing LSASS dumping. .002 Security Account Manager Monitor executed commands and arguments that may attempt to extract credential material from the Security Account Manager (SAM) database either through in-memory techniques or through the Windows Registry where the SAM database is stored. .003 NTDS Monitor executed commands and arguments that may attempt to access or create a copy of the Active Directory domain database in order to steal credential information, as well as obtain other information about domain members such as devices, users, and access rights. Look for command-lines that invoke attempts to access or copy the NTDS.dit. Note: Events 4688 (Microsoft Windows Security Auditing) and 1 (Microsoft Windows Sysmon) provide context of commands and parameters being executed via creation of a new process. Event 800 (PowerShell) provides context of commands and parameters being executed via PowerShell. This detection is based on known Windows utilities commands and parameters that can be used to copy the ntds.dit file. It is recommended to keep the list of commands and parameters up to date. Analytic 1 - Command line attempt to access or create a copy of ntds.dit file suspicious_command = filter command_execution where ((event_id = \"4688\" OR event_id = \"1\" OR event_id = \"800\") AND ((command_line = \"ntds\" AND command_line = \"ntdsutil\" AND command_line = \"create\") OR (command_line = \"vssadmin\" AND command_line = \"create\" AMD command_line = \"shadow\") OR (command_line = \"copy\" AND command_line = \"ntds.dit\")) .004 LSA Secrets Monitor executed commands and arguments that may access to a host may attempt to access Local Security Authority (LSA) secrets. Remote access tools may contain built-in features or incorporate existing tools like Mimikatz. PowerShell scripts also exist that contain credential dumping functionality, such as PowerSploit's Invoke-Mimikatz module,[48] which may require additional logging features to be configured in the operating system to collect necessary information for analysis. .005 Cached Domain Credentials Monitor executed commands and arguments that may attempt to access cached domain credentials used to allow authentication to occur in the event a domain controller is unavailable.[49]. Remote access tools may contain built-in features or incorporate existing tools like Mimikatz. PowerShell scripts also exist that contain credential dumping functionality, such as PowerSploit's Invoke-Mimikatz module,[48] which may require additional logging features to be configured in the operating system to collect necessary information for analysis.Detection of compromised Valid Accounts in-use by adversaries may help as well. .007 Proc Filesystem Monitor executed commands and arguments that may gather credentials from information stored in the Proc filesystem or /proc. .008 /etc/passwd and /etc/shadow Monitor executed commands and arguments that may attempt to dump the contents of /etc/passwd and /etc/shadow to enable offline password cracking. Enterprise T1201 Password Policy Discovery Monitor executed commands and arguments for actions that may attempt to access detailed information about the password policy used within an enterprise network or cloud environment. For network devices, monitor executed commands in AAA logs, especially those run by unexpected or unauthorized users. Enterprise T1120 Peripheral Device Discovery Monitor executed commands and arguments that may attempt to gather information about attached peripheral devices and components connected to a computer system. Enterprise T1069 Permission Groups Discovery Monitor executed commands and arguments acquired through Windows system management tools such as Windows Management Instrumentation and PowerShell. .001 Local Groups Monitor for executed commands and arguments that may attempt to find local system groups and permission settings. .002 Domain Groups Monitor for executed commands and arguments that may attempt to find domain-level groups and permission settings. .003 Cloud Groups Monitor for executed commands and arguments that may attempt to find cloud groups and permission settings. Enterprise T1647 Plist File Modification Monitor for commands with arguments (such as opening common command-line editors) used to modify plist files, especially commonly abused files such as those in \\~/LaunchAgents, \\~/Library/Application Support/com.apple.backgroundtaskmanagementagent/backgrounditems.btm, and an application's Info.plist. Enterprise T1653 Power Settings Monitor and inspect commands and arguments associated with manipulating the power settings of a system. Enterprise T1542 Pre-OS Boot Monitor executed commands and arguments in command history in either the console or as part of the running memory to determine if unauthorized or suspicious commands were used to modify device configuration. .005 TFTP Boot Monitor executed commands and arguments in command history in either the console or as part of the running memory to determine if unauthorized or suspicious commands were used to modify device configuration. Enterprise T1057 Process Discovery Monitor executed commands and arguments for actions that may attempt to get information about running processes on a system. Enterprise T1012 Query Registry Monitor executed commands and arguments for actions that may interact with the Windows Registry to gather information about the system, configuration, and installed software. Note: For PowerShell Module logging event id 4103, enable logging for module Microsoft.PowerShell.Management. The New-PSDrive PowerShell cmdlet creates temporary and persistent drives that are mapped to or associated with a location in a data store, such a registry key (PSProvider \"Registry\"). The the Get-ChildItem gets the items in one or more specified locations. By using both, you can enumerate COM objects in one or more specified locations. Analytic 1 - Suspicious Commands suspicious_commands = filter command_line where EventId == \"4103\" AND (CommandName LIKE '%New-PSDrive%' AND (CommandParameterValue LIKE \u2018%Registry%\u2019 OR CommandParameterValue LIKE '%HKEY_CLASSES_ROOT%' OR CommandParameterValue LIKE '%HKCR%')) Enterprise T1563 Remote Service Session Hijacking Monitor executed commands and arguments that may take control of preexisting sessions with remote services to move laterally in an environment. .001 SSH Hijacking Monitor executed commands and arguments that may hijack a legitimate user's SSH session to move laterally within an environment. .002 RDP Hijacking monitor service creation that uses cmd.exe /k or cmd.exe /c in its arguments to detect RDP session hijacking. Windows PowerShell log Event ID 4104 (PS script execution) can be used to capture PowerShell script block contents which may contain commands used as a precursor to RDP hijacking. For example, the following command in a PowerShell script block may be used to enumerate the systems on a network which have RDP access: Find-DomainLocalGroupMember -GroupName \"Remote Desktop Users\" | select -expand ComputerName. Enterprise T1021 Remote Services Monitor executed commands and arguments that may use Valid Accounts to log into a service specifically designed to accept remote connections, such as telnet, SSH, and VNC. The adversary may then perform actions as the logged-on user. Malicious actors may rename built-in commands or external tools, such as those provided by SysInternals, to better blend in with the environment. In those cases, the file path name is arbitrary and may blend in well with the background. If the arguments are closely inspected, it may be possible to infer what tools are running and understand what an adversary is doing. When any legitimate software shares the same command lines, it must be whitelisted according to the expected parameters. Any tool of interest with commonly known command line usage can be detecting by command line analysis. Known substrings of command lines include PuTTY port forwarding -R * -pw secure copy (scp) -pw * * @ mimikatz sekurlsa:: RAR -hp Archive* a * Additionally, it may be useful to find IP addresses in the command line \\d{1,3}.\\d{1,3}.\\d{1,3}.\\d{1,3} Analytic 1 - Suspicious Arguments port_fwd = filter process where (command_line match \"-R . -pw\")scp = filter process where (command_line match \"-pw . . .@.\"mimikatz = filter process where (command_line match \"sekurlsa\")rar = filter process where (command_line match \" -hp \")archive = filter process where (command_line match \". a .*\")ip_addr = filter process where (command_line match \\d{1,3}.\\d{1,3}.\\d{1,3}.\\d{1,3}) .002 SMB/Windows Admin Shares Monitor executed commands and arguments that connect to remote shares, such as Net, on the command-line interface and Discovery techniques that could be used to find remotely accessible systems.[50] Note: Event ID 4104 (from the Microsoft-Windows-Powershell/Operational log) captures Powershell script blocks, which can be analyzed and used to detect on potential connections and writing to remote shares. .006 Windows Remote Management Monitor executed commands and arguments that may invoke a WinRM script to correlate it with other related events.[51] ICS T0886 Remote Services Monitor executed commands and arguments to services specifically designed to accept remote connections, such as RDP, Telnet, SSH, and VNC. The adversary may then perform these actions using Valid Accounts. Enterprise T1018 Remote System Discovery Monitor executed commands and arguments that may attempt to get a listing of other systems by IP address, hostname, or other logical identifier on a network that may be used for Lateral Movement from the current system. For network devices, monitor executed commands in AAA logs, especially those run by unexpected or unauthorized users. Windows PowerShell log Event ID 4104 (PS script execution) can be used to capture PowerShell script block contents which may contain commands used as a precursor to RDP Hijacking. For example, the following command in a PowerShell script block may be used to enumerate the systems on a network which have RDP access: Find-DomainLocalGroupMember -GroupName \"Remote Desktop Users\" | select -expand ComputerName. Enterprise T1496 Resource Hijacking Monitor executed commands and arguments that may indicate common cryptomining or proxyware functionality. Enterprise T1053 Scheduled Task/Job Monitor executed commands and arguments that may abuse task scheduling functionality to facilitate initial or recurring execution of malicious code. .002 At Monitor executed commands and arguments for actions that could be taken to create/modify tasks. Tasks may also be created through Windows system management tools such as Windows Management Instrumentation and PowerShell, so additional logging may need to be configured to gather the appropriate data. .003 Cron Monitor executed atq command and ensure IP addresses stored in the SSH_CONNECTION and SSH_CLIENT variables, machines that created the jobs, are trusted hosts. All at jobs are stored in /var/spool/cron/atjobs/. .005 Scheduled Task Monitor executed commands and arguments for actions that could be taken to gather tasks may also be created through Windows system management tools such as Windows Management Instrumentation and PowerShell, so additional logging may need to be configured to gather the appropriate data. Analytic 1 : New processes whose command line includes commands that create or modify scheduled tasks with a suspicious script, extension or user writable path suspicious_processes = filter ProcessId, ProcessFilePath, command_line, ProcessParentFilePath,ProcessParentCommandLine where (EventId == \"1\" OR EventId == \"4688\") AND command_line LIKE '%SCHTASKS%' AND (command_line LIKE '%/CREATE%' OR command_line LIKE '%/CHANGE%') AND (command_line LIKE '%.cmd%' OR command_line LIKE '%.ps1%' OR command_line LIKE '%.vbs%' OR command_line LIKE '%.py%' OR command_line LIKE '%.js%' OR command_line LIKE '%.exe%' OR command_line LIKE '%.bat%' OR command_line LIKE '%javascript%' OR command_line LIKE '%powershell%' OR command_line LIKE '%rundll32%' OR command_line LIKE '%wmic%' OR command_line LIKE '%cmd%' OR command_line LIKE '%cscript%' OR command_line LIKE '%wscript%' OR command_line LIKE '%regsvr32%' OR command_line LIKE '%mshta%' OR command_line LIKE '%bitsadmin%' OR command_line LIKE '%certutil%' OR command_line LIKE '%msiexec%' OR command_line LIKE '%javaw%' OR command_line LIKE '%[%]APPDATA[%]%' OR command_line LIKE '%\\AppData\\Roaming%' OR command_line LIKE '%[%]PUBLIC[%]%' OR command_line LIKE '%C:\\Users\\Public%' OR command_line LIKE '%[%]ProgramData[%]%' OR command_line LIKE '%C:\\ProgramData%' OR command_line LIKE '%[%]TEMP[%]%' OR command_line LIKE '%\\AppData\\Local\\Temp%' OR command_line LIKE '%\\Windows\\PLA\\System%' OR command_line LIKE '%\\tasks%' OR command_line LIKE '%\\Registration\\CRMLog%' OR command_line LIKE '%\\FxsTmp%' OR command_line LIKE '%\\spool\\drivers\\color%' OR command_line LIKE '%\\tracing%' OR) .006 Systemd Timers Monitor executed commands and arguments the 'systemd-run' utility as it may be used to create timers Enterprise T1113 Screen Capture Monitor executed commands and arguments that may attempt to take screen captures of the desktop to gather information over the course of an operation. ICS T0852 Screen Capture Monitor executed commands and arguments that may attempt to take screen captures of the desktop to gather information over the course of an operation. ICS T0853 Scripting Monitor command-line arguments for script execution and subsequent behavior. Actions may be related to network and system information Discovery, Collection, or other scriptable post-compromise behaviors and could be used as indicators of detection leading back to the source script. Scripts are likely to perform actions with various effects on a system that may generate events, depending on the types of monitoring used. Enterprise T1505 .004 Server Software Component: IIS Components Monitor execution and command-line arguments of AppCmd.exe, which may be abused to install malicious IIS modules.[52][53][54] .005 Server Software Component: Terminal Services DLL Monitor executed commands and arguments for potential adversary actions to modify Registry values (ex: reg.exe) or modify/replace the legitimate termsrv.dll. Enterprise T1489 Service Stop Monitor executed commands and arguments that may stop or disable services on a system to render those services unavailable to legitimate users. ICS T0881 Service Stop Monitor executed commands and arguments that may stop or disable services on a system to render those services unavailable to legitimate users. Enterprise T1518 Software Discovery Monitor executed commands and arguments that may attempt to get a listing of software and software versions that are installed on a system or in a cloud environment. .001 Security Software Discovery Monitor executed commands and arguments that may attempt to get a listing of security software, configurations, defensive tools, and sensors that are installed on a system or in a cloud environment. Note: For Windows, Event ID 4104 (from the Microsoft-Windows-Powershell/Operational log) captures Powershell script blocks, which can be analyzed and used to detect on potential Security Software Discovery. Enterprise T1649 Steal or Forge Authentication Certificates Monitor for the execution of commands and other utilities abused to forge and/or steal certificates and related private keys.[55] Enterprise T1558 Steal or Forge Kerberos Tickets Monitor executed commands and arguments that may attempt to subvert Kerberos authentication by stealing or forging Kerberos tickets to enable Pass the Ticket. Enterprise T1553 Subvert Trust Controls Command monitoring may reveal malicious attempts to modify trust settings, such as the installation of root certificates or modifications to trust attributes/policies applied to files. .001 Gatekeeper Bypass Monitor and investigate attempts to modify extended file attributes with utilities such as xattr. Built-in system utilities may generate high false positive alerts, so compare against baseline knowledge for how systems are typically used and correlate modification events with other indications of malicious activity where possible. .004 Install Root Certificate Monitor for commands, such as security add-trusted-cert (macOS) or certutil -addstore (Windows), that can be used to install root certificates. A system's root certificates are unlikely to change frequently. Monitor new certificates installed on a system that could be due to malicious activity. [56] Check pre-installed certificates on new systems to ensure unnecessary or suspicious certificates are not present. Microsoft provides a list of trustworthy root certificates online and through authroot.stl. [56] The Sysinternals Sigcheck utility can also be used (sigcheck[64].exe -tuv) to dump the contents of the certificate store and list valid certificates not rooted to the Microsoft Certificate Trust List. [57] .006 Code Signing Policy Modification Monitor for the execution of commands that could modify the code signing policy of a system, such as bcdedit.exe -set TESTSIGNING ON. [58] Enterprise T1218 System Binary Proxy Execution Monitor executed commands and arguments that may forge credential materials that can be used to gain access to web applications or Internet services. .001 Compiled HTML File Monitor executed commands and arguments that may forge SAML tokens with any permissions claims and lifetimes if they possess a valid SAML token-signing certificate.[59] .002 Control Panel When executed from the command line or clicked, control.exe will execute the CPL file (ex: control.exe file.cpl) before Rundll32 is used to call the CPL's API functions (ex: rundll32.exe shell32.dll,Control_RunDLL file.cpl). CPL files can be executed directly via the CPL API function with just the latter Rundll32 command, which may bypass detections and/or execution filters for control.exe.[60] .003 CMSTP Monitor executed commands and arguments that may gather information about the victim's hosts that can be used during targeting. Note: Event ID 4104 (from the Microsoft-Windows-Powershell/Operational log) captures Powershell script blocks, which can be analyzed and used to detect on abuse of CMSTP. .004 InstallUtil Monitor executed commands and arguments used before and after the InstallUtil.exe invocation may also be useful in determining the origin and purpose of the binary being executed. .005 Mshta Look for mshta.exe executing raw or obfuscated script within the command-line. Compare recent invocations of mshta.exe with prior history of known good arguments and executed .hta files to determine anomalous and potentially adversarial activity. Command arguments used before and after the mshta.exe invocation may also be useful in determining the origin and purpose of the .hta file being executed. .007 Msiexec Command arguments used before and after the invocation of msiexec.exe may also be useful in determining the origin and purpose of the MSI files or DLLs being executed. .008 Odbcconf Command arguments used before and after the invocation of odbcconf.exe may also be useful in determining the origin and purpose of the DLL being loaded. .009 Regsvcs/Regasm Command arguments used before and after Regsvcs.exe or Regasm.exe invocation may also be useful in determining the origin and purpose of the binary being executed. .010 Regsvr32 Command arguments used before and after the regsvr32.exe invocation may also be useful in determining the origin and purpose of the script or DLL being loaded. [61] .011 Rundll32 Command arguments used with the rundll32.exe invocation may also be useful in determining the origin and purpose of the DLL being loaded. Typical command-line usage of rundll32.exe is \"rundll32.exe DllFile,EntryPoint\" where DllFile is the name of the DLL file being called and EntryPoint the name of the entry point in the DLL file. DLLs stored on SMB shares can similarly be called using the syntax of \"rundll32.exe \\\\DllFile,EntryPoint\" where is the IPv4 address of the host of the SMB share. Rundll32 can also be used to execute arbitrary Javascript using the syntax \"rundll32.exe javascript:<code_block>\"where <code_block> is a string defining the Javascript code to be executed. .012 Verclsid Command arguments used before and after the invocation of verclsid.exe may also be useful in determining the origin and purpose of the payload being executed. .013 Mavinject Adversaries may rename abusable binaries to evade detections, but the argument INJECTRUNNING is required for mavinject.exe to perform Dynamic-link Library Injection and may therefore be monitored to alert malicious activity. .014 MMC Monitor executed commands and arguments that may gather information about the victim's DNS that can be used during targeting. Enterprise T1082 System Information Discovery Monitor executed commands and arguments that may attempt to get detailed information about the operating system and hardware, including version, patches, hotfixes, service packs, and architecture. For network devices, monitor executed commands in AAA logs, especially those run by unexpected or unauthorized users. Enterprise T1614 System Location Discovery Monitor executed commands and arguments that may gather information in an attempt to calculate the geographical location of a victim host. .001 System Language Discovery Monitor executed commands and arguments that may attempt to gather information about the system language of a victim in order to infer the geographical location of that host. Enterprise T1016 System Network Configuration Discovery Monitor executed commands and arguments that may look for details about the network configuration and settings, such as IP and/or MAC addresses, of systems they access or through information discovery of remote systems. For network devices, monitor executed commands in AAA logs, especially those run by unexpected or unauthorized users. .001 Internet Connection Discovery Monitor executed commands and arguments that may check for Internet connectivity on compromised systems. .002 Wi-Fi Discovery Monitor executed commands and arguments that may collect Wi-Fi information on compromised systems. Enterprise T1049 System Network Connections Discovery Monitor executed commands and arguments that may attempt to get a listing of network connections to or from the compromised system they are currently accessing or from remote systems by querying for information over the network. Information may also be acquired through Windows system management tools such as Windows Management Instrumentation and PowerShell. For network devices, monitor executed commands in AAA logs, especially those run by unexpected or unauthorized users. Enterprise T1033 System Owner/User Discovery Monitor executed commands and arguments that may attempt to dump credentials to obtain account login and credential material, normally in the form of a hash or a clear text password, from the operating system and software. Look for command-lines that invoke AuditD or the Security Accounts Manager (SAM). Remote access tools may contain built-in features or incorporate existing tools like Mimikatz. PowerShell scripts also exist that contain credential dumping functionality, such as PowerSploit's Invoke-Mimikatz module, [48] which may require additional logging features to be configured in the operating system to collect necessary information for analysis. Note: Event ID 4104 (from the Microsoft-Windows-Powershell/Operational log) captures Powershell script blocks, which can be analyzed and used to detect on abuse of CMSTP. Enterprise T1216 System Script Proxy Execution Monitor executed commands and arguments for scripts like PubPrn.vbs that may be used to proxy execution of malicious files. .001 PubPrn Monitor executed commands and arguments for scripts like PubPrn.vbs that may be used to proxy execution of malicious files. Enterprise T1007 System Service Discovery Monitor executed commands and arguments that could be taken to gather system information related to services. Remote access tools with built-in features may interact directly with the Windows API to gather information. Information may also be acquired through Windows system management tools such as Windows Management Instrumentation and PowerShell. Enterprise T1569 System Services Monitor for command line invocations of tools capable of modifying services that doesn\u2019t correspond to normal usage patterns and known software, patch cycles, etc. .001 Launchctl Monitor command-line execution of the launchctl command immediately followed by abnormal network connections. .002 Service Execution Monitor executed commands and arguments that may abuse the Windows service control manager to execute malicious commands or payloads. Enterprise T1529 System Shutdown/Reboot Monitor executed commands and arguments of binaries involved in shutting down or rebooting systems. For network devices, monitor executed commands in AAA logs, especially those run by unexpected or unauthorized users. Enterprise T1124 System Time Discovery Monitor executed commands and arguments for actions that may gather the system time and/or time zone from a local or remote system. Enterprise T1127 Trusted Developer Utilities Proxy Execution Monitor executed commands and arguments used before and after invocation of the utilities may also be useful in determining the origin and purpose of the binary being executed. .001 MSBuild Monitor executed commands and arguments used before and after invocation of the utilities may also be useful in determining the origin and purpose of the binary being executed. Enterprise T1552 Unsecured Credentials While detecting adversaries accessing credentials may be difficult without knowing they exist in the environment, it may be possible to detect adversary use of credentials they have obtained. Monitor the command-line arguments of executing processes for suspicious words or regular expressions that may indicate searching for a password (for example: password, pwd, login, secure, or credentials). See Valid Accounts for more information. .001 Credentials In Files While detecting adversaries accessing these files may be difficult without knowing they exist in the first place, it may be possible to detect adversary use of credentials they have obtained. Monitor executed commands and arguments of executing processes for suspicious words or regular expressions that may indicate searching for a password (for example: password, pwd, login, secure, or credentials). See Valid Accounts for more information. .002 Credentials in Registry Monitor executed commands and arguments that may search the Registry on compromised systems for insecurely stored credentials. .003 Bash History While users do typically rely on their history of commands, they often access this history through other utilities like \"history\" instead of commands like cat ~/.bash_history. .004 Private Keys Monitor executed commands and arguments that may search for private key certificate files on compromised systems for insecurely stored credentials. .006 Group Policy Preferences Monitor executed commands and arguments that may search for SYSVOL data and/or GPP XML files, especially on compromised domain controllers. .007 Container API Establish centralized logging for the activity of container and Kubernetes cluster components. Monitor logs for actions that could be taken to gather credentials to container and cloud infrastructure, including the use of discovery API calls by new or unexpected users and APIs that access Docker logs. Enterprise T1204 User Execution Monitor the execution of and command-line arguments for applications that may be used by an adversary to gain Initial Access that require user interaction. This includes compression applications, such as those for zip files, that can be used to Deobfuscate/Decode Files or Information in payloads. .003 Malicious Image Monitor executed commands and arguments that may attempt to take advantage of a weakness in an Internet-facing computer or program using software, data, or commands in order to cause unintended or unanticipated behavior. ICS T0863 User Execution Monitor for newly executed processes that depend on user interaction, especially for applications that can embed programmatic capabilities (e.g., Microsoft Office products with scripts, installers, zip files). This includes compression applications, such as those for zip files, that can be used to Deobfuscate/Decode Files or Information in payloads. For added context on adversary procedures and background see User Execution and applicable sub-techniques. Enterprise T1125 Video Capture Monitor executed commands and arguments that can leverage a computer's peripheral devices (e.g., integrated cameras or webcams) or applications (e.g., video call services) to capture video recordings for the purpose of gathering information. Enterprise T1497 Virtualization/Sandbox Evasion Monitor executed commands and arguments that may employ various means to detect and avoid virtualization and analysis environments. Detecting actions related to virtualization and sandbox identification may be difficult depending on the adversary's implementation and monitoring required. .001 System Checks Monitor executed commands and arguments that may employ various means to detect and avoid virtualization and analysis environments. Detecting actions related to virtualization and sandbox identification may be difficult depending on the adversary's implementation and monitoring required. .002 User Activity Based Checks Monitor executed commands and arguments that may employ various means to detect and avoid virtualization and analysis environments. Detecting actions related to virtualization and sandbox identification may be difficult depending on the adversary's implementation and monitoring required. .003 Time Based Evasion Monitor executed commands and arguments that may employ various time-based methods to detect and avoid virtualization and analysis environments. Detecting actions related to virtualization and sandbox identification may be difficult depending on the adversary's implementation and monitoring required. Enterprise T1047 Windows Management Instrumentation Monitor executed commands and arguments for actions that are used to perform remote behavior References Confluence Support. (2021, September 8). How to enable command line audit logging in linux. Retrieved September 23, 2021. Gagliardi, R. (n.d.). Audit in a OS X System. Retrieved September 23, 2021. Mathers, B. (2017, March 7). Command line process auditing. Retrieved April 21, 2017. Microsoft. (n.d.). Background Intelligent Transfer Service. Retrieved January 12, 2018. French, D., Murphy, B. (2020, March 24). Adversary tradecraft 101: Hunting for persistence using Elastic Security (Part 1). Retrieved December 21, 2020. Counter Threat Unit Research Team. (2016, June 6). Malware Lingers with BITS. Retrieved January 12, 2018. Henderson, B. (2006, September 24). How To Insert And Remove LKMs. Retrieved April 9, 2018. Chuvakin, A. (2003, February). An Overview of Rootkits. Retrieved April 6, 2018. Remillano, A., Urbanec, J. (2019, September 19). Skidmap Linux Malware Uses Rootkit Capabilities to Hide Cryptocurrency-Mining Payload. Retrieved June 4, 2020. Pikeralpha. (2017, August 29). User Approved Kernel Extension Loading\u2026. Retrieved September 23, 2021. Richard Purves. (2017, November 9). MDM and the Kextpocalypse . Retrieved September 23, 2021. Apple. (2019, May 3). Configuration Profile Reference. Retrieved September 23, 2021. Chrome Enterprise and Education Help. (n.d.). Use Chrome Browser with Roaming User Profiles. Retrieved March 28, 2023. Adrien Bataille, Anders Vejlby, Jared Scott Wilson, and Nader Zaveri. (2021, December 14). Azure Run Command for Dummies. Retrieved March 13, 2023. Malware Archaeology. (2016, June). WINDOWS POWERSHELL LOGGING CHEAT SHEET - Win 7/Win 2008 or later. Retrieved June 24, 2016. Dunwoody, M. (2016, February 11). GREATER VISIBILITY THROUGH POWERSHELL LOGGING. Retrieved February 16, 2016. Cisco. (n.d.). Cisco IOS Software Integrity Assurance - Command History. Retrieved October 21, 2020. Dennis German. (2020, November 20). launchd Keywords for plists. Retrieved October 7, 2021. Mercer, W. and Rascagneres, P. (2018, February 12). Olympic Destroyer Takes Aim At Winter Olympics. Retrieved March 14, 2019. Arntz, P. (2016, March 30). The Windows Vault . Retrieved November 23, 2020. ise. (2019, February 19). Password Managers: Under the Hood of Secrets Management. Retrieved January 22, 2021. Russinovich, M. & Garnier, T. (2017, May 22). Sysmon v6.20. Retrieved December 13, 2017. Microsoft. (2020, December). Azure Sentinel Detections. Retrieved December 30, 2020. Microsoft 365 Defender Team. (2020, December 28). Using Microsoft 365 Defender to protect against Solorigate. Retrieved January 7, 2021. Microsoft. (2020, September 14). Update or repair the settings of a federated domain in Office 365, Azure, or Intune. Retrieved December 30, 2020. Carr, N., Sellmer, S. (2021, June 14). Behind the scenes of business email compromise: Using cross-domain threat data to disrupt a large BEC campaign. Retrieved June 15, 2021. Microsoft. (2023, February 22). Manage mail flow rules in Exchange Online. Retrieved March 13, 2023. Microsoft. (n.d.). Retrieved January 24, 2020. Github. (n.d.). Receiving webhooks with the GitHub CLI. Retrieved August 4, 2023. Microsoft . (n.d.). Create subscription. Retrieved August 4, 2023. Phil Stokes. (2021, February 16). 20 Common Tools & Techniques Used by macOS Threat Actors & Malware. Retrieved August 23, 2021. Pravs. (2009, May 25). What you need to know about alternate data streams in windows? Is your Data secure? Can you restore that?. Retrieved March 21, 2018. Arntz, P. (2015, July 22). Introduction to Alternate Data Streams. Retrieved March 21, 2018. Marlin, J. (2013, March 24). Alternate Data Streams in NTFS. Retrieved March 21, 2018. Johann Rehberger. (2020, September 23). Beware of the Shadowbunny - Using virtual machines to persist and evade detections. Retrieved September 22, 2021. Pany, D. & Hanley, C. (2023, May 3). Cloudy with a Chance of Bad Logs: Cloud Platform Log Configurations to Consider in Investigations. Retrieved October 16, 2023. Chandel, R. (2021, April 22). Defense Evasion: Windows Event Logging (T1562.002). Retrieved September 14, 2021. svch0st. (2020, September 30). Event Log Tampering Part 1: Disrupting the EventLog Service. Retrieved September 14, 2021. Heiligenstein, L. (n.d.). REP-25: Disable Windows Event Logging. Retrieved April 7, 2022. Microsoft. (2021, May 27). bcdedit. Retrieved June 23, 2021. Gerend, J. et al. (2017, October 16). bootcfg. Retrieved August 30, 2021. Sophos. (2019, December 9). Snatch ransomware reboots PCs into Safe Mode to bypass protection. Retrieved June 23, 2021. Johann Rehberger. (2021, April 18). Spoofing credential dialogs on macOS Linux and Windows. Retrieved August 19, 2021. Carr, N.. (2018, October 25). Nick Carr Status Update Masquerading. Retrieved April 22, 2019. Fox, C., Vangel, D. (2018, April 22). Detect and Remediate Outlook Rules and Custom Forms Injections Attacks in Office 365. Retrieved February 4, 2019. SensePost. (2017, September 21). NotRuler - The opposite of Ruler, provides blue teams with the ability to detect Ruler usage against Exchange. Retrieved February 4, 2019. Damian Pfammatter. (2018, September 17). Hidden Inbox Rules in Microsoft Exchange. Retrieved October 12, 2021. PowerSploit. (n.d.). Retrieved December 4, 2014. Microsoft. (2016, August 21). Cached and Stored Credentials Technical Overview. Retrieved February 21, 2020. French, D. (2018, October 9). Detecting & Removing an Attacker\u2019s WMI Persistence. Retrieved October 11, 2019. French, D. (2018, September 30). Detecting Lateral Movement Using Sysmon and Splunk. Retrieved October 11, 2019. Microsoft. (2007, November 24). IIS Modules Overview. Retrieved June 17, 2021. Falcone, R. (2018, January 25). OilRig uses RGDoor IIS Backdoor on Targets in the Middle East. Retrieved July 6, 2018. Hromcov\u00e1, Z., Cherepanov, A. (2021). Anatomy of Native IIS Malware. Retrieved September 9, 2021. Schroeder, W. & Christensen, L. (2021, June 22). Certified Pre-Owned - Abusing Active Directory Certificate Services. Retrieved August 2, 2022. Graeber, M. (2017, December 22). Code Signing Certificate Cloning Attacks and Defenses. Retrieved April 3, 2018. Russinovich, M. et al.. (2017, May 22). Sigcheck. Retrieved April 3, 2018. Microsoft. (2021, February 15). Enable Loading of Test Signed Drivers. Retrieved April 22, 2021. Lambert, J. (2020, December 13). Important steps for customers to protect themselves from recent nation-state cyberattacks. Retrieved December 17, 2020. Merc\u00eas, F. (2014, January 27). CPL Malware - Malicious Control Panel Items. Retrieved January 18, 2018. Nolen, R. et al.. (2016, April 28). Threat Advisory: \u201cSquiblydoo\u201d Continues Trend of Attackers Using Native OS Tools to \u201cLive off the Land\u201d. Retrieved April 9, 2018. "
},
{
"id": 1960,
"title": "Windows Registry, Data Source DS0024",
"path": "/datasources/DS0024/index.html",
"content": " Windows Registry A Windows OS hierarchical database that stores much of the information and settings for software programs, hardware devices, user preferences, and operating-system configurations[1] ID: DS0024 \u24d8 Platform: Windows \u24d8 Collection Layer: Host Version: 1.0 Created: 20 October 2021 Last Modified: 11 May 2022 Version Permalink Live Version Data Components This data source does not have any techniques in the selected domain(s) Windows Registry: Windows Registry Key Access Opening a Registry Key, typically to read the associated value (ex: Windows EID 4656) Windows Registry: Windows Registry Key Access Opening a Registry Key, typically to read the associated value (ex: Windows EID 4656) Domain ID Name Detects Enterprise T1652 Device Driver Discovery Monitor for attempts to access information stored in the Registry about devices and their associated drivers, such as values under HKLM\\SYSTEM\\CurrentControlSet\\Services and HKLM\\SYSTEM\\CurrentControlSet\\HardwareProfiles.[2] Enterprise T1003 OS Credential Dumping Monitor for the SAM registry key being accessed that may attempt to dump credentials to obtain account login and credential material, normally in the form of a hash or a clear text password, from the operating system and software. .002 Security Account Manager Monitor for the SAM registry key dump being created to access stored account password hashes. Some hash dumpers will open the local file system as a device and parse to the SAM table to avoid file access defenses. Others will make an in-memory copy of the SAM table before reading hashes. Detection of compromised Valid Accounts in-use by adversaries may help as well. .004 LSA Secrets Monitor for the LSA secrets are stored in the registry at HKEY_LOCAL_MACHINE\\SECURITY\\Policy\\Secrets being accessed Enterprise T1012 Query Registry Monitor for unexpected process interactions with the Windows Registry (i.e. reads) that may be related to gathering information. Note: For Security Auditing event ids 4656 and 4663, a System Access Control List (SACL) that controls the use of specific access rights such as Enumerate sub-keys and Query key value is required for event generation. Depending on the Registry key you are monitoring, the implementation of a new System Access Control List (SACL) might be required. Depending of Registry key used for the creation of a System Access Control List (SACL), the generation of event ids 4656 and 4663 might be noisy. Analytic 1 - Suspicious Registry suspicious_registry = filter registry where (event_id == \"4663\" OR event_id == \"4656\") AND ObjectType == \"Key\" AND RegistryKeyPath LIKE '%SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Uninstall%' AND (UserAccessList LIKE '%4435%' OR UserAccessList LIKE '%Enumerate sub-keys%' OR UserAccessList LIKE '%4432%' OR UserAccessList LIKE '%Query key value%') AND ProcessFilePath NOT IN ('FilePathToExpectedProcess01.exe','FilePathToExpectedProcess02.exe') Enterprise T1649 Steal or Forge Authentication Certificates Monitor for attempts to access information stored in the Registry about certificates and their associated private keys. For example, user certificates are commonly stored under HKEY_CURRENT_USER\\SOFTWARE\\Microsoft\\SystemCertificates.[3][4] Enterprise T1614 .001 System Location Discovery: System Language Discovery Monitor for access to windows registry keys that may attempt to gather information about the system language of a victim in order to infer the geographical location of that host. Enterprise T1033 System Owner/User Discovery Monitor for the SAM registry key being accessed that may attempt to dump credentials to obtain account login and credential material, normally in the form of a hash or a clear text password, from the operating system and software. Enterprise T1552 Unsecured Credentials Monitor for unexpected windows registry key being accessed that may search compromised systems to find and obtain insecurely stored credentials. .002 Credentials in Registry Monitor for unexpected windows registry key being accessed that may search the Registry on compromised systems for insecurely stored credentials. Windows Registry: Windows Registry Key Creation Initial construction of a new Registry Key (ex: Windows EID 4656 or Sysmon EID 12) Windows Registry: Windows Registry Key Creation Initial construction of a new Registry Key (ex: Windows EID 4656 or Sysmon EID 12) Domain ID Name Detects Enterprise T1547 Boot or Logon Autostart Execution Monitor for additions of mechanisms that could be used to trigger autostart execution, such as relevant additions to the Registry. .001 Registry Run Keys / Startup Folder Monitor for newly created windows registry keys that may achieve persistence by adding a program to a startup folder or referencing it with a Registry run key. .014 Active Setup Monitor Registry key additions to HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Active Setup\\Installed Components\\.Tools such as Sysinternals Autoruns may also be used to detect system changes that could be attempts at persistence, including listing the Active Setup Registry locations and startup folders.[5] Suspicious program execution as startup programs may show up as outlier processes that have not been seen before when compared against historical data. Enterprise T1037 Boot or Logon Initialization Scripts Monitor for newly constructed windows registry keys that may use scripts automatically executed at boot or logon initialization to establish persistence. .001 Logon Script (Windows) Monitor for the creation/modification to Registry keys associated with Windows logon scrips, nameley HKCU\\Environment\\UserInitMprLogonScript. Enterprise T1176 Browser Extensions Monitor for any new items written to the Registry or PE files written to disk. That may correlate with browser extension installation. Enterprise T1543 Create or Modify System Process Monitor for newly constructed windows registry keys that may create or modify system-level processes to repeatedly execute malicious payloads as part of persistence. .003 Windows Service Monitor for new constructed windows registry keys that may create or modify Windows services to repeatedly execute malicious payloads as part of persistence. Analytic 1 : Creation of the HKLM\\System\\CurrentControlSet\\Services Registry key suspicious_processes = filter ProcessGuid, ProcessFilePath, RegistryKeyPath, UserName where event_id == \"12\" AND RegistryKeyPath LIKE '%HKLM\\System\\CurrentControlSet\\Services\\%' Enterprise T1562 .002 Impair Defenses: Disable Windows Event Logging Monitor the addition of the MiniNT registry key in HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control, which may disable Event Viewer.[6][7] .009 Impair Defenses: Safe Mode Boot Monitor Registry creation for services that may start on safe mode. For example, a program can be forced to start on safe mode boot by adding a * in front of the \"Startup\" value name: HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Run[\"*Startup\"=\"{Path}\"] or by adding a key to HKLM\\SYSTEM\\CurrentControlSet\\Control\\SafeBoot\\Minimal.[8][9] Enterprise T1556 Modify Authentication Process Monitor for the addition of network provider Registry keys (e.g., HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\<NetworkProviderName>\\NetworkProvider). .008 Network Provider DLL Monitor for the addition of network provider Registry keys (e.g., HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\<NetworkProviderName>\\NetworkProvider). Enterprise T1112 Modify Registry Monitor for newly constructed registry keys or values to aid in persistence and execution. Detection of creation of registry key HKEY_LOCAL_MACHINE\\System\\CurrentControlSet\\Control\\Session Manager\\SafeDllSearchMode. The key SafeDllSearchMode, if set to 0, will block the Windows mechanism for the search DLL order and adversaries may execute their own malicious dll. Analytic 1 - Registry Edit with Creation of SafeDllSearchMode Key Set to 0 safe_dll_search_processes = filter processes where command_line CONTAINS(\"SafeDllSearchMode\") AND ((command_line CONTAINS(\"reg\") AND command_line CONTAINS(\"add\") AND command_line CONTAINS(\"/d\")) OR (command_line CONTAINS(\"Set-ItemProperty\") AND command_line CONTAINS(-value)) OR ((command_line CONTAINS(\"00000000\") AND command_line CONTAINS(0)))reg_keys = search Registry:value_editsafe_dll_reg_keys = filter reg_keys where value=\"SafeDllSearchMode\" AND value_data=\"0\" Enterprise T1027 Obfuscated Files or Information Monitor for the creation of Registry values that may highlight storage of malicious data such as commands or payloads. .011 Fileless Storage Monitor for the creation of Registry values that may highlight storage of malicious data such as commands or payloads. Enterprise T1137 Office Application Startup Many Office-related persistence mechanisms require changes to the Registry and for binaries, files, or scripts to be written to disk or existing files modified to include malicious scripts. Collect events related to Registry key creation and modification for keys that could be used for Office-based persistence.[10][11] .001 Office Template Macros Collect events related to Registry key creation for keys that could be used for Office-based persistence.[10][11] .002 Office Test Monitor for the creation of the Office Test Registry key. Collect events related to Registry key creation for keys that could be used for Office-based persistence. Since v13.52, Autoruns can detect tasks set up using the Office Test Registry key.[12] .006 Add-ins Audit the Registry entries relevant for enabling add-ins.[13][14] Enterprise T1053 .005 Scheduled Task/Job: Scheduled Task Monitor for newly constructed registry keys upon creation of new task. Deletion of values/keys in the registry may further indicate malicious activity. Note: Sysmon event id 12 is used in the analytic Analytic 1 : Suspicious Creations under Schedule Registry Key suspicious_processes = filter ProcessGuid, ProcessFilePath, RegistryKeyPath, UserName where event_id == \"12\" AND (RegistryKeyPath LIKE '%HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Schedule\\TaskCache\\Tasks%' OR RegistryKeyPath LIKE '%HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Schedule\\TaskCache\\Tree%') Enterprise T1553 Subvert Trust Controls Monitoring the creation of (sub)keys within the Windows Registry may reveal malicious attempts to modify trust settings, such as the installation of root certificates. Installed root certificates are located in the Registry under HKLM\\SOFTWARE\\Microsoft\\EnterpriseCertificates\\Root\\Certificates\\ and [HKLM or HKCU]\\Software[\\Policies]\\Microsoft\\SystemCertificates\\Root\\Certificates\\. There are a subset of root certificates that are consistent across Windows systems and can be used for comparison: [15]* 18F7C1FCC3090203FD5BAA2F861A754976C8DD25* 245C97DF7514E7CF2DF8BE72AE957B9E04741E85* 3B1EFD3A66EA28B16697394703A72CA340A05BD5* 7F88CD7223F3C813818C994614A89C99FA3B5247* 8F43288AD272F3103B6FB1428485EA3014C0BCFE* A43489159A520F0D93D032CCAF37E7FE20A8B419* BE36A4562FB2EE05DBB3D32323ADF445084ED656* CDD4EEAE6000AC7F40C3802C171E30148030C072 .004 Install Root Certificate Monitoring the creation of (sub)keys within the Windows Registry may reveal malicious root certificate installation. Installed root certificates are located in the Registry under HKLM\\SOFTWARE\\Microsoft\\EnterpriseCertificates\\Root\\Certificates\\ and [HKLM or HKCU]\\Software[\\Policies]\\Microsoft\\SystemCertificates\\Root\\Certificates\\. There are a subset of root certificates that are consistent across Windows systems and can be used for comparison: [15]* 18F7C1FCC3090203FD5BAA2F861A754976C8DD25* 245C97DF7514E7CF2DF8BE72AE957B9E04741E85* 3B1EFD3A66EA28B16697394703A72CA340A05BD5* 7F88CD7223F3C813818C994614A89C99FA3B5247* 8F43288AD272F3103B6FB1428485EA3014C0BCFE* A43489159A520F0D93D032CCAF37E7FE20A8B419* BE36A4562FB2EE05DBB3D32323ADF445084ED656* CDD4EEAE6000AC7F40C3802C171E30148030C072 Windows Registry: Windows Registry Key Deletion Removal of a Registry Key (ex: Windows EID 4658 or Sysmon EID 12) Windows Registry: Windows Registry Key Deletion Removal of a Registry Key (ex: Windows EID 4658 or Sysmon EID 12) Domain ID Name Detects Enterprise T1562 Impair Defenses Monitor for unexpected deletion of windows registry keys that that may maliciously modify components of a victim environment in order to hinder or disable defensive mechanisms. .001 Disable or Modify Tools Monitor for deletion of Windows Registry keys and/or values related to services and startup programs that correspond to security tools such as HKLM:\\SOFTWARE\\Microsoft\\AMSI\\Providers. Enterprise T1070 Indicator Removal Monitor windows registry keys that may be deleted or alter generated artifacts on a host system, including logs or captured files such as quarantined malware. .009 Clear Persistence Monitor windows registry keys that may be deleted or alter generated artifacts associated with persistence on a host system. ICS T0872 Indicator Removal on Host Monitor Windows registry keys that may be deleted or alter generated artifacts on a host system, including logs or captured files such as quarantined malware. For added context on adversary procedures and background see Indicator Removal and applicable sub-techniques. Enterprise T1112 Modify Registry Monitor for unexpected deletion of windows registry keys to hide configuration information, remove information as part of cleaning up, or as part of other techniques to aid in persistence and execution. Windows Registry: Windows Registry Key Modification Changes made to a Registry Key and/or Key value (ex: Windows EID 4657 or Sysmon EID 13|14) Windows Registry: Windows Registry Key Modification Changes made to a Registry Key and/or Key value (ex: Windows EID 4657 or Sysmon EID 13|14) Domain ID Name Detects Enterprise T1548 Abuse Elevation Control Mechanism There are many ways to perform UAC bypasses when a user is in the local administrator group on a system, so it may be difficult to target detection on all variations. Efforts should likely be placed on mitigation and collecting enough information on process launches and actions that could be performed before and after a UAC bypass is performed. Some UAC bypass methods rely on modifying specific, user-accessible Registry settings. Analysts should monitor Registry settings for unauthorized changes. .002 Bypass User Account Control Some UAC bypass methods rely on modifying specific, user-accessible Registry settings. For example:* The eventvwr.exe bypass uses the [HKEY_CURRENT_USER]\\Software\\Classes\\mscfile\\shell\\open\\command Registry key.[16]* The sdclt.exe bypass uses the [HKEY_CURRENT_USER]\\Software\\Microsoft\\Windows\\CurrentVersion\\App Paths\\control.exe and [HKEY_CURRENT_USER]\\Software\\Classes\\exefile\\shell\\runas\\command\\isolatedCommand Registry keys.[17][18]Analysts should monitor these Registry settings for unauthorized changes. UAC Bypass is an interesting technique in that new implementations are regularly found and existing implementations may be fixed (i.e., patched) by Microsoft in new builds of Windows. Therefore, it is important to validate than detections for UAC Bypass are still relevant (i.e., they target non-patched implementations). Note: Sysmon Event ID 12 (Registry Key Create/Delete), Sysmon Event ID 13 (Registry Value Set), and Sysmon Event ID 14 (Registry Key and Value Rename) are useful for creating detections around Registry Key Modification in the context of UAC Bypass. Enterprise T1557 Adversary-in-the-Middle Monitor HKLM\\Software\\Policies\\Microsoft\\Windows NT\\DNSClient for changes to the \"EnableMulticast\" DWORD value. A value of \"0\" indicates LLMNR is disabled. .001 LLMNR/NBT-NS Poisoning and SMB Relay Monitor HKLM\\Software\\Policies\\Microsoft\\Windows NT\\DNSClient for changes to the \"EnableMulticast\" DWORD value. A value of \"0\" indicates LLMNR is disabled. ICS T0830 Adversary-in-the-Middle Monitor HKLM\\Software\\Policies\\Microsoft\\Windows NT\\DNSClient for changes to the \"EnableMulticast\" DWORD value. A value of \"0\" indicates LLMNR is disabled. Enterprise T1547 Boot or Logon Autostart Execution Monitor for modifications of mechanisms that could be used to trigger autostart execution, such as relevant additions to the Registry. .001 Registry Run Keys / Startup Folder Monitor Registry for changes to run keys that do not correlate with known software, patch cycles, etc. Tools such as Sysinternals Autoruns may also be used to detect system changes that could be attempts at persistence, including listing the run keys' Registry locations. [5] Detection of the modification of the registry key Common Startup located in HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Explorer\\User Shell Folders\\ and HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Explorer\\User Shell Folders. When a user logs on, any files located in the Startup Folder are launched. Attackers may modify these folders with other files in order to evade detection set on these default folders. This detection focuses on EventIDs 4688 and 1 for process creation and EventID 4657 for the modification of the Registry Keys. Analytic 1 - Modification of Default Startup Folder in the Registry Key \u2018Common Startup\u2019 logon_reg_processes = filter processes where (command_line CONTAINS(\"reg\") AND command_line CONTAINS(\"add\") AND command_line CONTAINS(\"/d\") OR (command_line CONTAINS(\"Set-ItemProperty\") AND command_line CONTAINS(\"-value\")) AND command_line CONTAINS(\"Common Startup\"))reg_keys = search Registry:value_editlogon_reg_keys = filter reg_keys where value=\"Common Startup\" .002 Authentication Package Monitor the Registry for changes to the LSA Registry keys. Windows 8.1 and Windows Server 2012 R2 may generate events when unsigned DLLs try to load into the LSA by setting the Registry key HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options\\LSASS.exe with AuditLevel = 8. [19] [20] .003 Time Providers Monitor for changes made to windows registry keys and/or values modifying W32Time information in the Registry. .004 Winlogon Helper DLL Monitor for changes to Registry entries associated with Winlogon that do not correlate with known software, patch cycles, etc. Tools such as Sysinternals Autoruns may also be used to detect system changes that could be attempts at persistence, including listing current Winlogon helper values. [5] Analytic 1 - Modification of the Winlogon Registry Key suspicious_processes = filter registry where event_id == \"13\" AND (RegistryKeyPath LIKE '%Userinit%' OR RegistryKeyPath LIKE '%Shell%' OR RegistryKeyPath LIKE '%Notify%') .005 Security Support Provider Monitor the Registry for changes to the SSP Registry keys. Windows 8.1 and Windows Server 2012 R2 may generate events when unsigned SSP DLLs try to load into the LSA by setting the Registry key HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options\\LSASS.exe with AuditLevel = 8. [19] [20] .010 Port Monitors Monitor Registry writes to HKLM\\SYSTEM\\CurrentControlSet\\Control\\Print\\Monitors. Run the Autoruns utility, which checks for this Registry key as a persistence mechanism [5] .012 Print Processors Monitor Registry writes to HKLM\\SYSTEM\\ControlSet001\\Control\\Print\\Environments\\[Windows architecture]\\Print Processors\\[user defined]\\Driver or HKLM\\SYSTEM\\CurrentControlSet\\Control\\Print\\Environments\\[Windows architecture]\\Print Processors\\[user defined]\\Driver as they pertain to print processor installations. .014 Active Setup Monitor Registry key modifications to HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Active Setup\\Installed Components\\.Tools such as Sysinternals Autoruns may also be used to detect system changes that could be attempts at persistence, including listing the Active Setup Registry locations and startup folders.[5] Suspicious program execution as startup programs may show up as outlier processes that have not been seen before when compared against historical data. Enterprise T1543 Create or Modify System Process Monitor for changes to windows registry keys and/or values that may create or modify system-level processes to repeatedly execute malicious payloads as part of persistence. .003 Windows Service Look for changes to service Registry entries that do not correlate with known software, patch cycles, etc. Service information is stored in the Registry at HKLM\\SYSTEM\\CurrentControlSet\\Services. Changes to the binary path and the service startup type changed from manual or disabled to automatic, if it does not typically do so, may be suspicious. Tools such as Sysinternals Autoruns may also be used to detect system service changes that could be attempts at persistence.[5] Analytic 1 : Modification of the HKLM\\System\\CurrentControlSet\\Services Registry key suspicious_registry = filter ProcessGuid, ProcessFilePath, RegistryKeyPath, UserName where (event_id == \"13\" event_id == \"14\") AND RegistryKeyPath LIKE '%HKLM\\System\\CurrentControlSet\\Services\\%' Enterprise T1074 Data Staged Consider monitoring accesses and modifications to local storage repositories (such as the Windows Registry), especially from suspicious processes that could be related to malicious data collection. .001 Local Data Staging Consider monitoring accesses and modifications to local storage repositories (such as the Windows Registry), especially from suspicious processes that could be related to malicious data collection. Enterprise T1546 Event Triggered Execution Monitor for changes made to windows registry keys and/or values that may establish persistence and/or elevate privileges using system mechanisms that trigger execution based on specific events. .001 Change Default File Association Collect and analyze changes to Registry keys that associate file extensions to default applications for execution and correlate with unknown process launch activity or unusual file types for that process. User file association preferences are stored under [HKEY_CURRENT_USER]\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\FileExts and override associations configured under [HKEY_CLASSES_ROOT]. Changes to a user's preference will occur under this entry's subkeys. .002 Screensaver Monitor changes to screensaver configuration changes in the Registry that may not correlate with typical user behavior. Tools such as Sysinternals Autoruns can be used to detect changes to the screensaver binary path in the Registry. Default screen saver files are stored in C:\\Windows\\System32. Use these files as a reference when defining list of not suspicious screen saver files. Analytic 1 : Registry Edit from Screensaver scr_reg_events = filter processes where ( event_id == \"13\" AND key=\"*\\Software\\Policies\\Microsoft\\Windows\\Control Panel\\Desktop\\SCRNSAVE.EXE\" AND RegistryKeyValueData NOT IN ('PathToScreenSaverFile1','PathToScreenSaverFile2')) .007 Netsh Helper DLL Monitor the HKLM\\SOFTWARE\\Microsoft\\Netsh registry key for any new or suspicious entries that do not correlate with known system files or benign software. [21] .008 Accessibility Features Monitor Registry keys within HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options. .009 AppCert DLLs Monitor the AppCertDLLs Registry value for modifications that do not correlate with known software, patch cycles, etc. .010 AppInit DLLs Monitor the AppInit_DLLs Registry values for modifications that do not correlate with known software, patch cycles, etc. Adversaries may establish persistence and/or elevate privileges by executing malicious content triggered by AppInit DLLs loaded into processes. Dynamic-link libraries (DLLs) that are specified in the AppInit_DLLs value in the Registry keys HKEY_LOCAL_MACHINE\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Windows or HKEY_LOCAL_MACHINE\\Software\\Wow6432Node\\Microsoft\\Windows NT\\CurrentVersion\\Windows are loaded by user32.dll into every process that loads user32.dll. These values can be abused to obtain elevated privileges by causing a malicious DLL to be loaded and run in the context of separate processes. Accordingly, this analytic looks for modifications to these registry keys that may be indicative of this type of abuse. Analytic 1 : AppInit DLLs appinit_keys = filter registry_keys where ((event_id == \"12\" OR event_id == \"13\" event_id == \"14\") AND key = \"\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Windows\\Appinit_Dlls*\" OR key = \"\\SOFTWARE\\Wow6432Node\\Microsoft\\Windows NT\\CurrentVersion\\Windows\\Appinit_Dlls*\"\") .011 Application Shimming Monitor for changes to windows registry keys and/or values that may establish persistence and/or elevate privileges by executing malicious content triggered by application shims. .012 Image File Execution Options Injection Monitor Registry values associated with IFEOs, as well as silent process exit monitoring, for modifications that do not correlate with known software, patch cycles, etc. .015 Component Object Model Hijacking There are opportunities to detect COM hijacking by searching for Registry references that have been replaced and through Registry operations (ex: Reg) replacing known binary paths with unknown paths or otherwise malicious content. Even though some third-party applications define user COM objects, the presence of objects within HKEY_CURRENT_USER\\Software\\Classes\\CLSID\\ may be anomalous and should be investigated since user objects will be loaded prior to machine objects in HKEY_LOCAL_MACHINE\\SOFTWARE\\Classes\\CLSID.[22] Registry entries for existing COM objects may change infrequently. When an entry with a known good path and binary is replaced or changed to an unusual value to point to an unknown binary in a new location, then it may indicate suspicious behavior and should be investigated. Analytic 1 : Component Object Model Hijacking clsid_keys = filter registry_keys where ((event_id == \"12\" OR event_id == \"13\" event_id == \"14\") AND key = \"*\\Software\\Classes\\CLSID*\") Enterprise T1564 Hide Artifacts Monitor for changes made to windows registry keys and/or values that may attempt to hide artifacts associated with their behaviors to evade detection. .002 Hidden Users Monitor for changes made to windows registry key or values for unexpected modifications of the HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\SpecialAccounts\\UserList key. .005 Hidden File System Monitor for changes made to windows registry keys and/or values that may use a hidden file system to conceal malicious activity from users and security tools. .006 Run Virtual Instance Monitor for changes made to Windows Registry keys and/or values that may be the result of using a virtual instance to avoid detection. For example, if virtualization software is installed by the adversary the Registry may provide detection opportunities. Enterprise T1574 Hijack Execution Flow Monitor for changes made to windows registry keys and/or values that may execute their own malicious payloads by hijacking the way operating systems run programs. .007 Path Interception by PATH Environment Variable Monitor for modifications of PATH environment variable Registry keys such as HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\Session Manager\\Environment\\Path. An adversary can add a new directory or list of directories before other locations where programs can be executed from. .011 Services Registry Permissions Weakness Monitor for modification of Registry keys and values used by services such as HKLM\\SYSTEM\\CurrentControlSet\\Services that may allow adversaries to launch their own code when a service starts. .012 COR_PROFILER For detecting system and user scope abuse of the COR_PROFILER variable, monitor the Registry for changes to COR_ENABLE_PROFILING, COR_PROFILER, and COR_PROFILER_PATH that correspond to system and user environment variables that do not correlate to known developer tools. Enterprise T1562 Impair Defenses Monitor Registry edits for modifications to services and startup programs that correspond to security tools. .001 Disable or Modify Tools Monitor for changes made to Windows Registry keys and/or values related to services and startup programs that correspond to security tools such as HKLM:\\SOFTWARE\\Policies\\Microsoft\\Windows Defender. .002 Disable Windows Event Logging Monitor the addition of the MiniNT registry key in HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control, which may disable Event Viewer.[6] Adversaries may disable Windows event logging to limit data that can be leveraged for detections and audits. There are different ways to perform this attack.1. The first one is to create the Registry Key HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\MiniNt. This action will not generate Security EventLog 4657 or Sysmon EventLog 13 because the value of the key remains empty. However, if an attacker uses powershell to perform this attack (and not cmd), a Security EventLog 4663 will be generated (but 4663 generates a lot of noise).2. The second way is to disable the service EventLog (display name Windows Event Log). After disabed, attacker must reboot the system. The action of disabling or put in manual the service will modify the Registry Key value HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\EventLog\\start, therefore Security EventLog 4657 or Sysmon EventLog 13 will be generated on the system.3. The third way is linked with the second. By default, the EventLog service cannot be stopped. If an attacker tries to stop the service, this one will restart immediately. Why ? Because to stop completely, this service must stop others, one in particular called netprofm (display name Network List Service). This service remains running until it is disabled. So Attacker must either disable EventLog and after to stop it or disable netprofm and after stop EventLog. Only stopping the service (even as admin) will not have an effect on the EventLog service because of the link with netprofm. Security EventLog 1100 will log the stop of the EventLog service (but also generates a lot of noise because it will generate a log everytime the system shutdown).4. The fourth way is to use auditpol.exe to modify the audit configuration and disable/modify important parameters that will lead to disable the creation of EventLog.5. The last one is to modify the Registry Key value HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\EventLog\\Security\\file (or other kind of log) to modify the path where the EventLog are stocked. Importantly, with this technique, the EventViewer will use the value of the Registry Key \"file\" to know where to find the Log. Thus, using the EventViewer will always show the current event logs, but the old one will be stocked in another evtx. Also, the path must be in a folder that the Eventlog process has access (like it doesn\u2019t work if attacker set up the new path in the Desktop). Attacker can also decrease the maxsize value of the Log to force the system to rewrite on the older EventLog (but the minimum cannot be less than 1028 KB). As the Registry key is modified, Security EventLog 4657 or Sysmon EventLog 13 will be generated on the system. All of these attacks required administrative right. Attacks number three, four and five do not require a system reboot to be effective immediately. Analytic 1 - Disable Windows Event Logging event_log_reg_keys = filter reg_keys where Key=\"EventLog\" AND (value=\"Start\" OR value=\"File\" OR value=\"MaxSize\") .004 Disable or Modify System Firewall Monitor for changes made to windows Registry keys and/or values that adversaries might use to disable or modify System Firewall settings such as HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\SharedAccess\\Parameters\\FirewallPolicy. .006 Indicator Blocking To detect changes in ETW you can also monitor the registry key which contains configurations for all ETW event providers: HKLM\\SYSTEM\\CurrentControlSet\\Control\\WMI\\Autologger\\AUTOLOGGER_NAME{PROVIDER_GUID} .009 Safe Mode Boot Monitor modifications to Registry data associated with enabling safe mode. For example, a service can be forced to start on safe mode boot by adding a * in front of the \"Startup\" value name: HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Run[\"*Startup\"=\"{Path}\"] or by adding a key to HKLM\\SYSTEM\\CurrentControlSet\\Control\\SafeBoot\\Minimal.[8][9] Enterprise T1070 Indicator Removal Monitor for changes made to windows registry keys or values that may delete or alter generated artifacts on a host system, including logs or captured files such as quarantined malware. .007 Clear Network Connection History and Configurations Monitor for changes to Registry keys (ex: HKEY_CURRENT_USER\\Software\\Microsoft\\Terminal Server Client\\Default) and associated values that may be malicious attempts to conceal adversary network connection history. .009 Clear Persistence Monitor for changes made to windows registry keys or values that may delete or alter generated artifacts associated with persistence on a host system. ICS T0872 Indicator Removal on Host Monitor for changes made to Windows Registry keys or values that may delete or alter generated artifacts on a host system, including logs or captured files such as quarantined malware. For added context on adversary procedures and background see Indicator Removal and applicable sub-techniques. Enterprise T1490 Inhibit System Recovery Monitor the registry for changes associated with system recovery features (ex: the creation of HKEY_CURRENT_USER\\Software\\Policies\\Microsoft\\PreviousVersions\\DisableLocalPage). Enterprise T1056 Input Capture Monitor for changes made to windows registry keys or values for unexpected modifications .001 Keylogging Monitor for changes made to windows registry keys or values for unexpected modifications Enterprise T1556 Modify Authentication Process Monitor for changes to Registry entries for password filters (ex: HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\Lsa\\Notification Packages) and correlate then investigate the DLL files these files reference. Monitor for changes to Registry entries for network providers (e.g., HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\NetworkProvider\\Order) and correlate then investigate the DLL files these values reference. .002 Password Filter DLL Monitor for changes to Registry entries for password filters (ex: HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\Lsa\\Notification Packages) and correlate then investigate the DLL files these files reference. .008 Network Provider DLL Monitor for changes to Registry entries for network providers (e.g., HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\NetworkProvider\\Order) and correlate then investigate the DLL files these values reference. Enterprise T1112 Modify Registry Monitor for changes made to windows registry keys or values. Consider enabling Registry Auditing on specific keys to produce an alertable event (Event ID 4657) whenever a value is changed (though this may not trigger when values are created with Reghide or other evasive methods). [23] Changes to Registry entries that load software on Windows startup that do not correlate with known software, patch cycles, etc., are suspicious, as are additions or changes to files within the startup folder. Changes could also include new services and modification of existing binary paths to point to malicious files. If a change to a service-related entry occurs, then it will likely be followed by a local or remote service start or restart to execute the file. Detection of modification of the registry key values of Notify, Userinit, and Shell located in HKEY_LOCAL_MACHINE\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\ and HKEY_LOCAL_USER\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon. When a user logs on, the Registry key values of Notify, Userinit and Shell are used to load dedicated Windows component. Attackers may insert malicious payload following the legitimate value to launch a malicious payload. Detection of the modification of the registry key Common Startup located in HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Explorer\\User Shell Folders\\ and HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Explorer\\User Shell Folders. When a user logs on, any files located in the Startup Folder are launched. Attackers may modify these folders with other files in order to evade detection set on these default folders. This detection focuses on EventIDs 4688 and 1 for process creation and EventID 4657 for the modification of the Registry Keys. Analytic 1 - Registry Edit with Modification of Userinit, Shell or Notify logon_reg_processes = filter processes where command_line CONTAINS(\"\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\") AND (command_line CONTAINS(\"Userinit\") OR command_line CONTAINS(\"Shell\") OR command_line CONTAINS(\"Notify\")) AND (((command_line CONTAINS(\"reg\") OR command_line CONTAINS(\"add\") OR command_line CONTAINS(\"/d\")) OR (command_line CONTAINS(\"Set-ItemProperty\") OR command_line CONTAINS(\"New-ItemProperty\") OR command_line CONTAINS(\"-value\"))))reg_keys = search Registry:value_editlogon_reg_keys = filter reg_keys where (value=\"Userinit\" OR value=\"Shell\" OR value=\"Notify\") Analytic 2 - Modification of Default Startup Folder in the Registry Key \u2018Common Startup\u2019 logon_reg_processes = filter processes where (command_line CONTAINS(\"reg\") AND command_line CONTAINS(\"add\") AND command_line CONTAINS(\"/d\") OR (command_line CONTAINS(\"Set-ItemProperty\") AND command_line CONTAINS(\"-value\")) AND command_line CONTAINS(\"Common Startup\"))reg_keys = search Registry:value_editlogon_reg_keys = filter reg_keys where value=\"Common Startup\" Enterprise T1111 Multi-Factor Authentication Interception Monitor for changes to windows registry keys or values that may target multi-factor authentication mechanisms, such as smart cards, to gain access to credentials that can be used to access systems, services, and network resources. Enterprise T1137 Office Application Startup Many Office-related persistence mechanisms require changes to the Registry and for binaries, files, or scripts to be written to disk or existing files modified to include malicious scripts. Collect events related to Registry key creation and modification for keys that could be used for Office-based persistence.[10][11] .001 Office Template Macros Collect events related to Registry key modification for keys that could be used for Office-based persistence.[10][11] .002 Office Test Monitor for changes made to the Office Test Registry key. Collect events related to Registry key modification for keys that could be used for Office-based persistence. Since v13.52, Autoruns can detect tasks set up using the Office Test Registry key.[12] .006 Add-ins Audit the Registry entries relevant for enabling add-ins.[13][14] Enterprise T1003 .001 OS Credential Dumping: LSASS Memory Monitor for changes to Registry entries associated with credential access that is stored in the process memory of the LSASS. For example, the adversary can modify the SAM and SYSTEM files. Enterprise T1505 .005 Server Software Component: Terminal Services DLL Monitor for changes to Registry keys associated with ServiceDll and other subkey values under HKLM\\System\\CurrentControlSet\\services\\TermService\\Parameters\\. Enterprise T1489 Service Stop Monitor for changes made to windows registry keys and/or values that may stop or disable services on a system to render those services unavailable to legitimate users. ICS T0881 Service Stop Monitor for changes made to Windows registry keys and/or values that may stop or disable services on a system to render those services unavailable to legitimate users. ICS T0856 Spoof Reporting Message Various techniques enable spoofing a reporting message. Monitor for LLMNR/NBT-NS poisoning via new services/daemons which may be used to enable this technique. For added context on adversary procedures and background see LLMNR/NBT-NS Poisoning and SMB Relay. Enterprise T1553 Subvert Trust Controls Monitoring changes to the Windows Registry may reveal malicious attempts to modify trust settings, such as the installation of root certificates. Installed root certificates are located in the Registry under HKLM\\SOFTWARE\\Microsoft\\EnterpriseCertificates\\Root\\Certificates\\ and [HKLM or HKCU]\\Software[\\Policies]\\Microsoft\\SystemCertificates\\Root\\Certificates\\. There are a subset of root certificates that are consistent across Windows systems and can be used for comparison: [15] Also consider enabling the Registry Global Object Access Auditing [24] setting in the Advanced Security Audit policy to apply a global system access control list (SACL) and event auditing on modifications to Registry values (sub)keys related to SIPs and trust providers:[25] .003 SIP and Trust Provider Hijacking Enable the Registry Global Object Access Auditing [24] setting in the Advanced Security Audit policy to apply a global system access control list (SACL) and event auditing on modifications to Registry values (sub)keys related to SIPs and trust providers:[25]* HKLM\\SOFTWARE\\Microsoft\\Cryptography\\OID* HKLM\\SOFTWARE\\WOW6432Node\\Microsoft\\Cryptography\\OID* HKLM\\SOFTWARE\\Microsoft\\Cryptography\\Providers\\Trust* HKLM\\SOFTWARE\\WOW6432Node\\Microsoft\\Cryptography\\Providers\\Trust Note: As part of this technique, adversaries may attempt to manually edit these Registry keys (ex: Regedit) or utilize the legitimate registration process using Regsvr32.[26] Periodically baseline registered SIPs and trust providers (Registry entries and files on disk), specifically looking for new, modified, or non-Microsoft entries.[26] .004 Install Root Certificate Monitoring changes to the Windows Registry may reveal malicious root certificate installation. Installed root certificates are located in the Registry under HKLM\\SOFTWARE\\Microsoft\\EnterpriseCertificates\\Root\\Certificates\\ and [HKLM or HKCU]\\Software[\\Policies]\\Microsoft\\SystemCertificates\\Root\\Certificates\\. There are a subset of root certificates that are consistent across Windows systems and can be used for comparison: [15]* 18F7C1FCC3090203FD5BAA2F861A754976C8DD25* 245C97DF7514E7CF2DF8BE72AE957B9E04741E85* 3B1EFD3A66EA28B16697394703A72CA340A05BD5* 7F88CD7223F3C813818C994614A89C99FA3B5247* 8F43288AD272F3103B6FB1428485EA3014C0BCFE* A43489159A520F0D93D032CCAF37E7FE20A8B419* BE36A4562FB2EE05DBB3D32323ADF445084ED656* CDD4EEAE6000AC7F40C3802C171E30148030C072 .006 Code Signing Policy Modification Consider monitoring for modifications made to Registry keys associated with code signing policies, such as HKCU\\Software\\Policies\\Microsoft\\Windows NT\\Driver Signing. Modifications to the code signing policy of a system are likely to be rare. Enterprise T1218 System Binary Proxy Execution Monitor for changes made to Windows Registry keys and/or values that may forge credential materials that can be used to gain access to web applications or Internet services. .002 Control Panel Inventory Control Panel items to locate unregistered and potentially malicious files present on systems:* Executable format registered Control Panel items will have a globally unique identifier (GUID) and registration Registry entries in HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Explorer\\ControlPanel\\NameSpace and HKEY_CLASSES_ROOT\\CLSID{GUID}. These entries may contain information about the Control Panel item such as its display name, path to the local file, and the command executed when opened in the Control Panel. [27]* CPL format registered Control Panel items stored in the System32 directory are automatically shown in the Control Panel. Other Control Panel items will have registration entries in the CPLs and Extended Properties Registry keys of HKEY_LOCAL_MACHINE or HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Control Panel. These entries may include information such as a GUID, path to the local file, and a canonical name used to launch the file programmatically ( WinExec(\"c:\\windows\\system32\\control.exe {Canonical_Name}\", SW_NORMAL);) or from a command line (control.exe /name {Canonical_Name}).[27]* Some Control Panel items are extensible via Shell extensions registered in HKEY_LOCAL_MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Controls Folder{name}\\Shellex\\PropertySheetHandlers where {name} is the predefined name of the system item.[27] Enterprise T1569 System Services Monitor for changes made to windows registry keys and/or values that may abuse system services or daemons to execute commands or programs. .002 Service Execution Monitor for changes made to windows registry keys and/or values that may abuse the Windows service control manager to execute malicious commands or payloads. References Microsoft. (2018, May 31). Registry. Retrieved September 29, 2021. Microsoft. (2021, December 14). Registry Trees for Devices and Drivers. Retrieved March 28, 2023. Schroeder, W. & Christensen, L. (2021, June 22). Certified Pre-Owned - Abusing Active Directory Certificate Services. Retrieved August 2, 2022. Syynimaa, N. (2022, February 15). Stealing and faking Azure AD device identities. Retrieved August 3, 2022. Russinovich, M. (2016, January 4). Autoruns for Windows v13.51. Retrieved June 6, 2016. Chandel, R. (2021, April 22). Defense Evasion: Windows Event Logging (T1562.002). Retrieved September 14, 2021. Heiligenstein, L. (n.d.). REP-25: Disable Windows Event Logging. Retrieved April 7, 2022. Abrams, L. (2021, March 19). REvil ransomware has a new \u2018Windows Safe Mode\u2019 encryption mode. Retrieved June 23, 2021. Sophos. (2019, December 9). Snatch ransomware reboots PCs into Safe Mode to bypass protection. Retrieved June 23, 2021. Parisi, T., et al. (2017, July). Using Outlook Forms for Lateral Movement and Persistence. Retrieved February 5, 2019. Soutcast. (2018, September 14). Outlook Today Homepage Persistence. Retrieved February 5, 2019. Falcone, R. (2016, July 20). Technical Walkthrough: Office Test Persistence Method Used In Recent Sofacy Attacks. Retrieved July 3, 2017. Shukrun, S. (2019, June 2). Office Templates and GlobalDotName - A Stealthy Office Persistence Technique. Retrieved August 26, 2019. Knowles, W. (2017, April 21). Add-In Opportunities for Office Persistence. Retrieved July 3, 2017. Smith, T. (2016, October 27). AppUNBlocker: Bypassing AppLocker. Retrieved December 19, 2017. Nelson, M. (2016, August 15). \"Fileless\" UAC Bypass using eventvwr.exe and Registry Hijacking. Retrieved December 27, 2016. Nelson, M. (2017, March 14). Bypassing UAC using App Paths. Retrieved May 25, 2017. Nelson, M. (2017, March 17). \"Fileless\" UAC Bypass Using sdclt.exe. Retrieved May 25, 2017. Graeber, M. (2014, October). Analysis of Malicious Security Support Provider DLLs. Retrieved March 1, 2017. Microsoft. (2013, July 31). Configuring Additional LSA Protection. Retrieved June 24, 2015. Demaske, M. (2016, September 23). USING NETSHELL TO EXECUTE EVIL DLLS AND PERSIST ON A HOST. Retrieved April 8, 2017. Ewing, P. Strom, B. (2016, September 15). How to Hunt: Detecting Persistence & Evasion with the COM. Retrieved September 15, 2016. Miroshnikov, A. & Hall, J. (2017, April 18). 4657(S): A registry value was modified. Retrieved August 9, 2018. Microsoft. (2016, August 31). Registry (Global Object Access Auditing). Retrieved January 31, 2018. Microsoft. (2012, July 2). Audit Registry. Retrieved January 31, 2018. Graeber, M. (2017, September). Subverting Trust in Windows. Retrieved January 31, 2018. M. (n.d.). Implementing Control Panel Items. Retrieved January 18, 2018. "
},
{
"id": 1961,
"title": "Asset, Data Source DS0039",
"path": "/datasources/DS0039/index.html",
"content": " Asset Data sources with information about the set of devices found within the network, along with their current software and configurations ID: DS0039 \u24d8 Collection Layer: Host Version: 1.0 Created: 11 May 2022 Last Modified: 24 March 2023 Version Permalink Live Version Data Components This data source does not have any techniques in the selected domain(s) Asset: Asset Inventory This includes sources of current and expected devices on the network, including the manufacturer, model, and necessary identifiers (e.g., IP and hardware addresses) Asset: Asset Inventory This includes sources of current and expected devices on the network, including the manufacturer, model, and necessary identifiers (e.g., IP and hardware addresses) Domain ID Name Detects ICS T0838 Modify Alarm Settings Consult asset management systems to understand expected alarm settings. ICS T0836 Modify Parameter Monitor asset management systems for device configuration changes which can be used to understand expected parameter settings. ICS T0843 Program Download Consult asset management systems to understand expected program versions. ICS T0848 Rogue Master Consult asset management systems which may help with the detection of computer systems or network devices that should not exist on a network. Asset: Software This includes sources of current and expected software or application programs deployed to a device, along with information on the version and patch level for vendor products, full source code for any application programs, and unique identifiers (e.g., hashes, signatures). Asset: Software This includes sources of current and expected software or application programs deployed to a device, along with information on the version and patch level for vendor products, full source code for any application programs, and unique identifiers (e.g., hashes, signatures). Domain ID Name Detects ICS T0877 I/O Image Collecting information from the I/O image requires analyzing the application program running on the PLC for specific data block reads. Detecting this requires obtaining and analyzing a PLC\u2019s application program, either directly from the device or from asset management platforms. ICS T0835 Manipulate I/O Image A manipulated I/O image requires analyzing the application program running on the PLC for specific data block writes. Detecting this requires obtaining and analyzing a PLC\u2019s application program, either directly from the device or from asset management platforms. ICS T0821 Modify Controller Tasking Engineering and asset management software will often maintain a copy of the expected program loaded on a controller and may also record any changes made to controller programs and tasks. Data from these platforms can be used to identify modified controller tasking. ICS T0889 Modify Program Engineering and asset management software will often maintain a copy of the expected program loaded on a controller and may also record any changes made to controller programs. Data from these platforms can be used to identify modified controller programs. "
},
{
"id": 1962,
"title": "Operational Databases, Data Source DS0040",
"path": "/datasources/DS0040/index.html",
"content": " Operational Databases Operational databases contain information about the status of the operational process and associated devices, including any measurements, events, history, or alarms that have occurred ID: DS0040 \u24d8 Collection Layer: Host Version: 1.0 Created: 11 May 2022 Last Modified: 24 March 2023 Version Permalink Live Version Data Components This data source does not have any techniques in the selected domain(s) Operational Databases: Device Alarm This includes alarms associated with unexpected device functions, such as shutdowns, restarts, failures, or configuration changes Operational Databases: Device Alarm This includes alarms associated with unexpected device functions, such as shutdowns, restarts, failures, or configuration changes Domain ID Name Detects ICS T0800 Activate Firmware Update Mode Monitor device alarms that indicate the devices has been placed into Firmware Update Mode, although not all devices produce such alarms. ICS T0878 Alarm Suppression Monitor for loss of expected device alarms which could indicate alarms are being suppressed. As noted in the technique description, there may be multiple sources of alarms in an ICS environment. Discrepancies between alarms may indicate the adversary is suppressing some but not all the alarms in the environment. This will not directly detect the technique\u2019s execution, but instead may provide additional evidence that the technique has been used and may complement other detections. ICS T0892 Change Credential Monitor for device alarms produced when device management passwords are changed, although not all devices will produce such alarms. ICS T0858 Change Operating Mode Monitor alarms for information about when an operating mode is changed, although not all devices produce such logs. ICS T0816 Device Restart/Shutdown Devices may produce alarms about restarts or shutdowns. Monitor for unexpected device restarts or shutdowns. ICS T0821 Modify Controller Tasking Monitor device alarms that indicate controller task parameters have changed, although not all devices produce such alarms. Program Download may be used to enable this technique. Monitor for program downloads which may be noticeable via operational alarms. Asset management systems should be consulted to understand expected program versions. ICS T0836 Modify Parameter Monitor for device alarms produced when parameters are changed, although not all devices will produce such alarms. ICS T0889 Modify Program Monitor device alarms that indicate the program has changed, although not all devices produce such alarms. ICS T0839 Module Firmware Monitor for firmware changes which may be observable via operational alarms from devices. ICS T0843 Program Download Monitor device alarms for program downloads, although not all devices produce such alarms. ICS T0848 Rogue Master Monitor for new master devices communicating with outstations, which may be visible in alarms within the ICS environment. ICS T0856 Spoof Reporting Message Monitor asset logs for alarms or other information the adversary is unable to directly suppress. Relevant alarms include those from a loss of communications due to Adversary-in-the-Middle activity. ICS T0857 System Firmware Monitor for firmware changes which may be observable via operational alarms from devices. Operational Databases: Process History/Live Data This includes any data stores that maintain historical or real-time events and telemetry recorded from various sensors or devices Operational Databases: Process History/Live Data This includes any data stores that maintain historical or real-time events and telemetry recorded from various sensors or devices Domain ID Name Detects ICS T0878 Alarm Suppression Monitor for loss of operational process data which could indicate alarms are being suppressed. This will not directly detect the technique\u2019s execution, but instead may provide additional evidence that the technique has been used and may complement other detections. ICS T0803 Block Command Message Monitor for lack of operational process data which may help identify a loss of communications. This will not directly detect the technique\u2019s execution, but instead may provide additional evidence that the technique has been used and may complement other detections. ICS T0804 Block Reporting Message Monitor for lack of operational process data which may help identify a loss of communications. This will not directly detect the technique\u2019s execution, but instead may provide additional evidence that the technique has been used and may complement other detections. ICS T0805 Block Serial COM Monitor for lack of operational process data which may help identify a loss of communications. This will not directly detect the technique\u2019s execution, but instead may provide additional evidence that the technique has been used and may complement other detections. ICS T0806 Brute Force I/O Monitor operational process data for write commands for an excessive number of I/O points or manipulating a single value an excessive number of times. This will not directly detect the technique\u2019s execution, but instead may provide additional evidence that the technique has been used and may complement other detections. ICS T0814 Denial of Service Monitor operational data for indicators of temporary data loss which may indicate a Denial of Service. This will not directly detect the technique\u2019s execution, but instead may provide additional evidence that the technique has been used and may complement other detections. ICS T0838 Modify Alarm Settings Data about the industrial process may indicate it is operating outside of expected bounds and could help indicate that that an alarm setting has changed. This will not directly detect the technique\u2019s execution, but instead may provide additional evidence that the technique has been used and may complement other detections. ICS T0855 Unauthorized Command Message Monitor industrial process history data for events that correspond with command message functions, such as setpoint modification or changes to system status for key devices. This will not directly detect the technique\u2019s execution, but instead may provide additional evidence that the technique has been used and may complement other detections. Operational Databases: Process/Event Alarm This includes a list of any process alarms or alerts produced to indicate unusual or concerning activity within the operational process (e.g., increased temperature/pressure) Operational Databases: Process/Event Alarm This includes a list of any process alarms or alerts produced to indicate unusual or concerning activity within the operational process (e.g., increased temperature/pressure) Domain ID Name Detects ICS T0878 Alarm Suppression Monitor for loss of expected operational process alarms which could indicate alarms are being suppressed. As noted in the technique description, there may be multiple sources of alarms in an ICS environment. Discrepancies between alarms may indicate the adversary is suppressing some but not all the alarms in the environment. This will not directly detect the technique\u2019s execution, but instead may provide additional evidence that the technique has been used and may complement other detections. ICS T0803 Block Command Message Monitor asset alarms which may help identify a loss of communications. Consider correlating alarms with other data sources that indicate traffic has been blocked, such as network traffic. In cases where alternative methods of communicating with outstations exist alarms may still be visible even if command messages are blocked. ICS T0804 Block Reporting Message Monitor asset alarms which may help identify a loss of communications. Consider correlating alarms with other data sources that indicate traffic has been blocked, such as network traffic. In cases where alternative methods of communicating with outstations exist alarms may still be visible even if reporting messages are blocked. ICS T0805 Block Serial COM Monitor asset alarms which may help identify a loss of communications. Consider correlating alarms with other data sources that indicate traffic has been blocked, such as network traffic. In cases where alternative methods of communicating with outstations exist alarms may still be visible even if messages over serial COM ports are blocked. ICS T0855 Unauthorized Command Message Monitor for anomalous or unexpected commands that may result in changes to the process operation (e.g., discrete write, logic and device configuration, mode changes) observable via asset application logs. "
},
{
"id": 1963,
"title": "Malware Repository, Data Source DS0004",
"path": "/datasources/DS0004/index.html",
"content": " Malware Repository Information obtained (via shared or submitted samples) regarding malicious software (droppers, backdoors, etc.) used by adversaries ID: DS0004 \u24d8 Platform: PRE \u24d8 Collection Layer: OSINT Version: 1.1 Created: 20 October 2021 Last Modified: 07 December 2022 Version Permalink Live Version Data Components This data source does not have any techniques in the selected domain(s) Malware Repository: Malware Content Code, strings, and other signatures that compromise a malicious payload Malware Repository: Malware Content Code, strings, and other signatures that compromise a malicious payload Domain ID Name Detects Enterprise T1587 Develop Capabilities Consider analyzing malware for features that may be associated with the adversary and/or their developers, such as compiler used, debugging artifacts, or code similarities. Malware repositories can also be used to identify additional samples associated with the adversary and identify development patterns over time. Much of this activity will take place outside the visibility of the target organization, making detection of this behavior difficult. Detection efforts may be focused on related stages of the adversary lifecycle, such as during Defense Evasion or Command and Control. .001 Malware Consider analyzing malware for features that may be associated with the adversary and/or their developers, such as compiler used, debugging artifacts, or code similarities. Malware repositories can also be used to identify additional samples associated with the adversary and identify development patterns over time. Enterprise T1588 Obtain Capabilities Consider analyzing malware for features that may be associated with malware providers, such as compiler used, debugging artifacts, code similarities, or even group identifiers associated with specific Malware-as-a-Service (MaaS) offerings. Malware repositories can also be used to identify additional samples associated with the developers and the adversary utilizing their services. Identifying overlaps in malware use by different adversaries may indicate malware was obtained by the adversary rather than developed by them. In some cases, identifying overlapping characteristics in malware used by different adversaries may point to a shared quartermaster.[1] Malware repositories can also be used to identify features of tool use associated with an adversary, such as watermarks in Cobalt Strike payloads.[2] .001 Malware Consider analyzing malware for features that may be associated with malware providers, such as compiler used, debugging artifacts, code similarities, or even group identifiers associated with specific MaaS offerings. Malware repositories can also be used to identify additional samples associated with the developers and the adversary utilizing their services. Identifying overlaps in malware use by different adversaries may indicate malware was obtained by the adversary rather than developed by them. In some cases, identifying overlapping characteristics in malware used by different adversaries may point to a shared quartermaster.[1] Malware Repository: Malware Metadata Contextual data about a malicious payload, such as compilation times, file hashes, as well as watermarks or other identifiable configuration information Malware Repository: Malware Metadata Contextual data about a malicious payload, such as compilation times, file hashes, as well as watermarks or other identifiable configuration information Domain ID Name Detects Enterprise T1587 Develop Capabilities Monitor for contextual data about a malicious payload, such as compilation times, file hashes, as well as watermarks or other identifiable configuration information. Much of this activity will take place outside the visibility of the target organization, making detection of this behavior difficult. Detection efforts may be focused on related stages of the adversary lifecycle, such as during Defense Evasion or Command and Control. .001 Malware Monitor for contextual data about a malicious payload, such as compilation times, file hashes, as well as watermarks or other identifiable configuration information. Much of this activity will take place outside the visibility of the target organization, making detection of this behavior difficult. Detection efforts may be focused on post-compromise phases of the adversary lifecycle. .002 Code Signing Certificates Consider analyzing self-signed code signing certificates for features that may be associated with the adversary and/or their developers, such as the thumbprint, algorithm used, validity period, and common name. Malware repositories can also be used to identify additional samples associated with the adversary and identify patterns an adversary has used in crafting self-signed code signing certificates.Much of this activity will take place outside the visibility of the target organization, making detection of this behavior difficult. Detection efforts may be focused on related follow-on behavior, such as Code Signing or Install Root Certificate. Enterprise T1588 Obtain Capabilities Monitor for contextual data about a malicious payload, such as compilation times, file hashes, as well as watermarks or other identifiable configuration information. Much of this activity will take place outside the visibility of the target organization, making detection of this behavior difficult. Detection efforts may be focused on related stages of the adversary lifecycle, such as during Defense Evasion or Command and Control. .001 Malware Monitor for contextual data about a malicious payload, such as compilation times, file hashes, as well as watermarks or other identifiable configuration information. Much of this activity will take place outside the visibility of the target organization, making detection of this behavior difficult. Detection efforts may be focused on post-compromise phases of the adversary lifecycle. .002 Tool Monitor for contextual data about a malicious payload, such as compilation times, file hashes, as well as watermarks or other identifiable configuration information. In some cases, malware repositories can also be used to identify features of tool use associated with an adversary, such as watermarks in Cobalt Strike payloads.[2]Much of this activity will take place outside the visibility of the target organization, making detection of this behavior difficult. Detection efforts may be focused on post-compromise phases of the adversary lifecycle. .003 Code Signing Certificates Consider analyzing code signing certificates for features that may be associated with the adversary and/or their developers, such as the thumbprint, algorithm used, validity period, common name, and certificate authority. Malware repositories can also be used to identify additional samples associated with the adversary and identify patterns an adversary has used in procuring code signing certificates.Much of this activity will take place outside the visibility of the target organization, making detection of this behavior difficult. Detection efforts may be focused on related follow-on behavior, such as Code Signing or Install Root Certificate. References FireEye. (2014). SUPPLY CHAIN ANALYSIS: From Quartermaster to SunshopFireEye. Retrieved March 6, 2017. Maynier, E. (2020, December 20). Analyzing Cobalt Strike for Fun and Profit. Retrieved October 12, 2021. "
},
{
"id": 1964,
"title": "Volume, Data Source DS0034",
"path": "/datasources/DS0034/index.html",
"content": " Volume Block object storage hosted on-premise or by third-party providers, typically made available to resources as virtualized hard drives[1][2][3] ID: DS0034 \u24d8 Platforms: IaaS, Linux, Windows, macOS \u24d8 Collection Layers: Cloud Control Plane, Host Contributors: Center for Threat-Informed Defense (CTID) Version: 1.0 Created: 20 October 2021 Last Modified: 30 March 2022 Version Permalink Live Version Data Components This data source does not have any techniques in the selected domain(s) Volume: Volume Creation Initial construction of a cloud volume (ex: AWS create-volume) Volume: Volume Creation Initial construction of a cloud volume (ex: AWS create-volume) Domain ID Name Detects Enterprise T1578 Modify Cloud Compute Infrastructure Monitor for the unexpected creation or presence of cloud block storage volumes . To reduce false positives, valid change management procedures could introduce a known identifier that is logged with the change (e.g., tag or header) if supported by the cloud provider, to help distinguish valid, expected actions from malicious ones. Volume: Volume Deletion Removal of a a cloud volume (ex: AWS delete-volume) Volume: Volume Deletion Removal of a a cloud volume (ex: AWS delete-volume) Domain ID Name Detects Enterprise T1485 Data Destruction Monitor for unexpected deletion of a cloud volume (ex: AWS delete-volume) Enterprise T1578 Modify Cloud Compute Infrastructure Monitor for the unexpected deletion or absence of cloud block storage volumes . To reduce false positives, valid change management procedures could introduce a known identifier that is logged with the change (e.g., tag or header) if supported by the cloud provider, to help distinguish valid, expected actions from malicious ones. Volume: Volume Enumeration An extracted list of available volumes within a cloud environment (ex: AWS describe-volumes) Volume: Volume Enumeration An extracted list of available volumes within a cloud environment (ex: AWS describe-volumes) Domain ID Name Detects Enterprise T1580 Cloud Infrastructure Discovery Monitor cloud logs for API calls and other potentially unusual activity related to block object storage enumeration. Discovery techniques normally occur throughout an operation as an adversary learns the environment. Data and events should not be viewed in isolation, but as part of a chain of behavior that could lead to other activities, such as Collection and Exfiltration, based on the information obtained. Volume: Volume Metadata Contextual data about a cloud volume and activity around it, such as id, type, state, and size Volume: Volume Metadata Contextual data about a cloud volume and activity around it, such as id, type, state, and size Domain ID Name Detects Enterprise T1578 Modify Cloud Compute Infrastructure Periodically baseline cloud block storage volumes to identify malicious modifications or additions. Volume: Volume Modification Changes made to a cloud volume, including its settings and control data (ex: AWS modify-volume) Volume: Volume Modification Changes made to a cloud volume, including its settings and control data (ex: AWS modify-volume) Domain ID Name Detects Enterprise T1611 Escape to Host Monitor cluster-level (Kubernetes) data and events associated with changing containers' volume configurations. Enterprise T1578 Modify Cloud Compute Infrastructure Monitor for the unexpected changes to cloud block storage volumes . To reduce false positives, valid change management procedures could introduce a known identifier that is logged with the change (e.g., tag or header) if supported by the cloud provider, to help distinguish valid, expected actions from malicious ones. References Amazon. (n.d.). Amazon S3. Retrieved October 13, 2021. Microsoft. (n.d.). Azure Blob Storage. Retrieved October 13, 2021. Google. (n.d.). Cloud Storage. Retrieved October 13, 2021. "
},
{
"id": 1965,
"title": "Kernel, Data Source DS0008",
"path": "/datasources/DS0008/index.html",
"content": " Kernel A computer program, at the core of a computer OS, that resides in memory and facilitates interactions between hardware and software components[1][2] ID: DS0008 \u24d8 Platforms: Linux, macOS \u24d8 Collection Layer: Host Contributors: Center for Threat-Informed Defense (CTID) Version: 1.0 Created: 20 October 2021 Last Modified: 10 November 2021 Version Permalink Live Version Data Components This data source does not have any techniques in the selected domain(s) Kernel: Kernel Module Load An object file that contains code to extend the running kernel of an OS, typically used to add support for new hardware (as device drivers) and/or filesystems, or for adding system calls Kernel: Kernel Module Load An object file that contains code to extend the running kernel of an OS, typically used to add support for new hardware (as device drivers) and/or filesystems, or for adding system calls Domain ID Name Detects Enterprise T1547 Boot or Logon Autostart Execution Monitor for unusual kernel driver installation activity that may configure system settings to automatically execute a program during system boot or logon to maintain persistence or gain higher-level privileges on compromised systems. .006 Kernel Modules and Extensions LKMs are typically loaded into /lib/modules and have had the extension .ko (\"kernel object\") since version 2.6 of the Linux kernel. [3] Enterprise T1611 Escape to Host Monitor for the installation of kernel modules that could be abused to escape containers on a host. References Unified Compliance Framework. (2016, December 20). The audit system must be configured to audit the loading and unloading of dynamic kernel modules.. Retrieved September 28, 2021. Kerrisk, M. (2021, March 22). INIT_MODULE(2). Retrieved September 28, 2021. Wikipedia. (2018, March 17). Loadable kernel module. Retrieved April 9, 2018. "
},
{
"id": 1966,
"title": "User Account, Data Source DS0002",
"path": "/datasources/DS0002/index.html",
"content": " User Account A profile representing a user, device, service, or application used to authenticate and access resources ID: DS0002 \u24d8 Platforms: Azure AD, Containers, Google Workspace, IaaS, Linux, Office 365, SaaS, Windows, macOS \u24d8 Collection Layers: Cloud Control Plane, Container, Host Contributors: Center for Threat-Informed Defense (CTID) Version: 1.1 Created: 20 October 2021 Last Modified: 07 December 2022 Version Permalink Live Version Data Components This data source does not have any techniques in the selected domain(s) User Account: User Account Authentication An attempt by a user to gain access to a network or computing resource, often by providing credentials (ex: Windows EID 4776 or /var/log/auth.log) User Account: User Account Authentication An attempt by a user to gain access to a network or computing resource, often by providing credentials (ex: Windows EID 4776 or /var/log/auth.log) Domain ID Name Detects Enterprise T1110 Brute Force Monitor for many failed authentication attempts across various accounts that may result from password spraying attempts. It is difficult to detect when hashes are cracked, since this is generally done outside the scope of the target network. .001 Password Guessing Monitor for many failed authentication attempts across various accounts that may result from password guessing attempts.[1] .002 Password Cracking Monitor for many failed authentication attempts across various accounts that may result from password spraying attempts. It is difficult to detect when hashes are cracked, since this is generally done outside the scope of the target network. (ex: Windows EID 4625 or 5379) .003 Password Spraying Monitor for many failed authentication attempts across various accounts that may result from password spraying attempts.[1] .004 Credential Stuffing Monitor for many failed authentication attempts across various accounts that may result from credential stuffing attempts.[1] Enterprise T1538 Cloud Service Dashboard Correlate other security systems with login information, such as user accounts, IP addresses, and login names.[1] Enterprise T1212 Exploitation for Credential Access Credential resources obtained through exploitation may be detectable in use if they are not normally used or seen. Enterprise T1606 .002 Forge Web Credentials: SAML Tokens Monitor for user authentication attempts, when requesting access tokens to services, that failed because of Conditional Access Policies (CAP). Some SAML tokens features, such as the location of a user, may not be as easy to claim. Enterprise T1070 Indicator Removal Monitor for an attempt by a user to gain access to a network or computing resource, often by providing credentials that may delete or alter generated artifacts on a host system, including logs or captured files such as quarantined malware. .003 Clear Command History Monitor for an attempts by a user to gain access to a network or computing resource, often by providing credentials via remote terminal services, that do not have a corresponding entry in a command history file. .005 Network Share Connection Removal Monitoring for Windows authentication logs are also useful in determining when authenticated network shares are established and by which account, and can be used to correlate network share activity to other events to investigate potentially malicious activity. Enterprise T1556 Modify Authentication Process Monitor for account authentications in which MFA credentials are not provided by the user account to the authenticating entity. .006 Multi-Factor Authentication Monitor for account authentications in which MFA credentials are not provided by the user account to the authenticating entity. Enterprise T1621 Multi-Factor Authentication Request Generation Monitor user account logs for suspicious events: unusual login attempt source location, mismatch in location of login attempt and smart device receiving 2FA/MFA request prompts, and high volume of repeated login attempts, all of which may indicate user's primary credentials have been compromised minus 2FA/MFA mechanism. Enterprise T1207 Rogue Domain Controller Investigate usage of Kerberos Service Principal Names (SPNs), especially those associated with services (beginning with \"GC/\") by computers not present in the DC organizational unit (OU). The SPN associated with the Directory Replication Service (DRS) Remote Protocol interface (GUID E3514235\u20134B06\u201311D1-AB04\u201300C04FC2DCD2) can be set without logging.[2] A rogue DC must authenticate as a service using these two SPNs for the replication process to successfully complete. Enterprise T1552 Unsecured Credentials Monitor for an attempt by a user to gain access to a network or computing resource, often by providing credentials that may search compromised systems to find and obtain insecurely stored credentials. .005 Cloud Instance Metadata API It may be possible to detect adversary use of credentials they have obtained such as in Valid Accounts. .007 Container API It may be possible to detect adversary use of credentials they have obtained such as in Valid Accounts. Enterprise T1550 Use Alternate Authentication Material Monitor for an attempt by a user to gain access to a network or computing resource, often by providing credentials that may use alternate authentication material, such as password hashes, Kerberos tickets, and application access tokens, in order to move laterally within an environment and bypass normal system access controls. .002 Pass the Hash Monitor for user authentication attempts. From a classic Pass-The-Hash perspective, this technique uses a hash through the NTLMv1 / NTLMv2 protocol to authenticate against a compromised endpoint. This technique does not touch Kerberos. Therefore, NTLM LogonType 3 authentications that are not associated to a domain login and are not anonymous logins are suspicious. From an Over-Pass-The-Hash perspective, an adversary wants to exchange the hash for a Kerberos authentication ticket (TGT). One way to do this is by creating a sacrificial logon session with dummy credentials (LogonType 9) and then inject the hash into that session which triggers the Kerberos authentication process. .003 Pass the Ticket Audit all Kerberos authentication and credential use events and review for discrepancies. Unusual remote authentication events that correlate with other suspicious activity (such as writing and executing binaries) may indicate malicious activity. Enterprise T1078 Valid Accounts Monitor for an attempt by a user that may obtain and abuse credentials of existing accounts as a means of gaining Initial Access, Persistence, Privilege Escalation, or Defense Evasion. .001 Default Accounts Monitor for an attempt by a user to gain access to a network or computing resource, often by providing credentials .002 Domain Accounts Monitor for an attempt by a user to gain access to a network or computing resource, often by the use of domain authentication services, such as the System Security Services Daemon (sssd) on Linux Note: For Windows, Security Logs events, including Event ID 4624, can be monitored to track user login behavior. For Linux, auditing frameworks that support File Integrity Monitoring (FIM), including the audit daemon (auditd), can be used to alert on changes to files that store login information. These files include: /etc/login.defs, /etc/securetty, /var/log/faillog, /var/log/lastlog, /var/log/tallylog. For MacOS, auditing frameworks that support capturing information on user logins, such as OSQuery, can be used to audit user account logins and authentications. .003 Local Accounts Monitor for an attempt by a user to gain access to a network or computing resource, often by the use of domain authentication services, such as the System Security Services Daemon (sssd) on Linux. Notes: For Linux, auditing frameworks such as the audit daemon (auditd) can be used to alert on changes to log files that track authentication attempts, including /var/log/secure. .004 Cloud Accounts Monitor the activity of cloud accounts to detect abnormal or malicious behavior, such as accessing information outside of the normal function of the account, account usage at atypical hours, or account authentication from unexpected locations or IP addresses. Service accounts should only be accessible from IP addresses from within the cloud environment.[3] For example, in Azure AD environments, consider using Identity Protection to flag risky sign-ins based on location, device compliance, and other factors. ICS T0859 Valid Accounts Monitor for an authentication attempt by a user that may obtain and abuse credentials of existing accounts as a means of gaining Initial Access, Persistence, Privilege Escalation, or Defense Evasion. User Account: User Account Creation Initial construction of a new account (ex: Windows EID 4720 or /etc/passwd logs) User Account: User Account Creation Initial construction of a new account (ex: Windows EID 4720 or /etc/passwd logs) Domain ID Name Detects Enterprise T1136 Create Account Monitor for newly constructed user accounts through account audits to detect suspicious accounts that may have been created by an adversary. Collect data on account creation within a network or Windows Event ID 4720 (for when a user account is created on a Windows system and domain controller). .001 Local Account Monitor for newly constructed user and service accounts through account audits to detect suspicious accounts that may have been created by an adversary. Collect data on account creation within a network, a Kubernetes cluster, or Windows Event ID 4720 (for when a user account is created on a Windows system and domain controller). .002 Domain Account Monitor for newly constructed user accounts through account audits to detect suspicious accounts that may have been created by an adversary. Collect data on account creation within a network or Windows Event ID 4720 (for when a user account is created on a Windows system and domain controller). .003 Cloud Account Monitor for newly constructed user accounts through the collection of usage logs from cloud user and administrator accounts to identify unusual activity in the creation of new accounts, such as accounts that do not follow specified naming conventions or accounts created by unapproved users or sources.[4] Monitor for newly created admin accounts that go over a certain threshold of known admins. Enterprise T1564 Hide Artifacts Monitor for newly constructed user accounts that may attempt to hide artifacts associated with their behaviors to evade detection. .002 Hidden Users Monitor for newly constructed user accounts, such as userIDs under 500 on macOS, that may mask the presence of user accounts they create or modify. User Account: User Account Deletion Removal of an account (ex: Windows EID 4726 or /var/log access/authentication logs) User Account: User Account Deletion Removal of an account (ex: Windows EID 4726 or /var/log access/authentication logs) Domain ID Name Detects Enterprise T1531 Account Access Removal Monitor for unexpected deletions of user accounts. Windows event logs may designate activity associated with an adversary's attempt to remove an account (ex: Event ID 4726 - A user account was deleted). Alerting on these Event IDs may generate a high degree of false positives, so compare against baseline knowledge for how systems are typically used and correlate modification events with other indications of malicious activity where possible. Enterprise T1070 Indicator Removal Monitor for unexpected deletions of user accounts. Windows event logs may highlight activity associated with an adversary's attempt to remove an account (e.g., Event ID 4726 - A user account was deleted). Alerting on these Event IDs may generate a high degree of false positives, so compare against baseline knowledge for how systems are typically used and correlate account modification events with other indications of malicious activity where possible. .009 Clear Persistence Monitor for unexpected deletions of user accounts. Windows event logs may highlight activity associated with an adversary's attempt to remove an account (e.g., Event ID 4726 - A user account was deleted). Alerting on these Event IDs may generate a high degree of false positives, so compare against baseline knowledge for how systems are typically used and correlate account modification events with other indications of malicious activity where possible. User Account: User Account Metadata Contextual data about an account, which may include a username, user ID, environmental data, etc. User Account: User Account Metadata Contextual data about an account, which may include a username, user ID, environmental data, etc. Domain ID Name Detects Enterprise T1134 Access Token Manipulation Monitor for contextual data about an account, which may include a username, user ID, environmental data, etc. that may modify access tokens to operate under a different user or system security context to perform actions and bypass access controls. .005 SID-History Injection Examine data in user\u2019s SID-History attributes Enterprise T1564 Hide Artifacts Monitor for contextual data about an account, which may include a username, user ID, environmental data that may attempt to hide artifacts associated with their behaviors to evade detection. .002 Hidden Users Monitor for contextual data about an account, which may include a username, user ID, environmental data that may mask the presence of user accounts they create or modify. On macOS, identify users with an userID under 500 and the Hide500Users key value in the /Library/Preferences/com.apple.loginwindow plist file set to TRUE.[5] Enterprise T1556 .005 Modify Authentication Process: Reversible Encryption Monitor Fine-Grained Password Policies and regularly audit user accounts and group settings.[6] Enterprise T1201 Password Policy Discovery Monitor for contextual data about an account that may attempt to access detailed information about the password policy used within an enterprise network or cloud environment. User Account: User Account Modification Changes made to an account, such as permissions and/or membership in specific groups (ex: Windows EID 4738 or /var/log access/authentication logs) User Account: User Account Modification Changes made to an account, such as permissions and/or membership in specific groups (ex: Windows EID 4738 or /var/log access/authentication logs) Domain ID Name Detects Enterprise T1548 Abuse Elevation Control Mechanism Log cloud API calls to assume, create, or impersonate additional roles, policies, and permissions. Review uses of just-in-time access to ensure that any justifications provided are valid and only expected actions were taken. .005 Temporary Elevated Cloud Access Log API calls to assume, create, or impersonate additional roles, policies, and permissions. Review uses of just-in-time access to ensure that any justifications provided are valid and only expected actions were taken. Enterprise T1531 Account Access Removal Monitor for changes made to user accounts for unexpected modification of properties, such as passwords or status (enabled/disabled). Windows event logs may designate activity associated with an adversary's attempt to remove access to an account:Event ID 4723 - An attempt was made to change an account's passwordEvent ID 4724 - An attempt was made to reset an account's passwordEvent ID 4725 - A user account was disabled Alerting on these Event IDs may generate a high degree of false positives, so compare against baseline knowledge for how systems are typically used and correlate modification events with other indications of malicious activity where possible. Enterprise T1098 Account Manipulation Monitor events for changes to account objects and/or permissions on systems and the domain, such as event IDs 4738, 4728 and 4670. Monitor for modification of accounts in correlation with other suspicious activity. Changes may occur at unusual times or from unusual systems. Especially flag events where the subject and target accounts differ or that include additional flags such as changing a password without knowledge of the old password. Monitor for unusual permissions changes that may indicate excessively broad permissions being granted to compromised accounts. .001 Additional Cloud Credentials Monitor for unexpected changes to cloud user accounts, such as Azure Activity Logs highlighting malicious Service Principal and Application modifications. Monitor for the use of API and CLI commands that add access keys or tokens to accounts, such as CreateAccessKey or GetFederationToken in AWS or service-accounts keys create in GCP. Also monitor for the usage of APIs that create or import SSH keys, particularly by unexpected users or accounts such as the root account. .002 Additional Email Delegate Permissions Monitor for unusual Exchange and Office 365 email account permissions changes that may indicate excessively broad permissions being granted to compromised accounts. .003 Additional Cloud Roles Collect usage logs from cloud administrator accounts to identify unusual activity in the assignment of roles to those accounts. Monitor for accounts assigned to admin roles that go over a certain threshold of known admins. Monitor for updates to IAM policies and roles attached to user accounts. .005 Device Registration Monitor user accounts for new and suspicious device associations, such as those originating from unusual sources, occurring at unusual times, or following a suspicious login.[7] .006 Additional Container Cluster Roles Collect usage logs from accounts to identify unusual activity in the assignment of roles to those accounts. Monitor for accounts assigned to high-privileged cluster roles that go over a certain threshold of known admins. Enterprise T1562 Impair Defenses Monitor for changes to account settings associated with users/tenants that may impact defensive logging capabilities, such as the Update User and Change User License events in the Azure AD audit log.[8] .008 Disable or Modify Cloud Logs Monitor for changes to account settings associated with users/tenants that may impact defensive logging capabilities, such as the Update User and Change User License events in the Azure AD audit log.[8] Enterprise T1556 Modify Authentication Process Monitor for the enrollment of devices and user accounts with alternative security settings that do not require MFA credentials for successful logon. .006 Multi-Factor Authentication Monitor for the enrollment of devices and user accounts with alternative security settings that do not require MFA credentials for successful logon. Monitor for attempts to disable MFA on individual user accounts.[1] Enterprise T1528 Steal Application Access Token Administrators should set up monitoring to trigger automatic alerts when policy criteria are met. For example, using a Cloud Access Security Broker (CASB), admins can create a \"High severity app permissions\" policy that generates alerts if apps request high severity permissions or send permissions requests for too many users.Security analysts can hunt for malicious apps using the tools available in their CASB, identity provider, or resource provider (depending on platform.) For example, they can filter for apps that are authorized by a small number of users, apps requesting high risk permissions, permissions incongruous with the app\u2019s purpose, or apps with old \"Last authorized\" fields. A specific app can be investigated using an activity log displaying activities the app has performed, although some activities may be mis-logged as being performed by the user. App stores can be useful resources to further investigate suspicious apps.Administrators can set up a variety of logs and leverage audit tools to monitor actions that can be conducted as a result of OAuth 2.0 access. For instance, audit reports enable admins to identify privilege escalation actions such as role creations or policy modifications, which could be actions performed after initial access. References Pany, D. & Hanley, C. (2023, May 3). Cloudy with a Chance of Bad Logs: Cloud Platform Log Configurations to Consider in Investigations. Retrieved October 16, 2023. Lucand,G. (2018, February 18). Detect DCShadow, impossible?. Retrieved March 30, 2018. Dror Alon. (2022, December 8). Compromised Cloud Compute Credentials: Case Studies From the Wild. Retrieved March 9, 2023. Microsoft . (2022, September 16). Azure Active Directory security operations guide. Retrieved February 21, 2023. Amit Serper. (2016). Cybereason Lab Analysis OSX.Pirrit. Retrieved December 10, 2021. Metcalf, S. (2015, November 22). Dump Clear-Text Passwords for All Admins in the Domain Using Mimikatz DCSync. Retrieved November 15, 2021. Microsoft. (2022, March 22). DEV-0537 criminal actor targeting organizations for data exfiltration and destruction. Retrieved March 23, 2022. Mandiant. (2021, January 19). Remediation and Hardening Strategies for Microsoft 365 to Defend Against UNC2452. Retrieved January 22, 2021. "
},
{
"id": 1967,
"title": "Certificate, Data Source DS0037",
"path": "/datasources/DS0037/index.html",
"content": " Certificate A digital document, which highlights information such as the owner's identity, used to instill trust in public keys used while encrypting network communications ID: DS0037 \u24d8 Platform: PRE \u24d8 Collection Layer: OSINT Version: 1.0 Created: 20 October 2021 Last Modified: 20 October 2021 Version Permalink Live Version Data Components This data source does not have any techniques in the selected domain(s) Certificate: Certificate Registration Queried or logged information highlighting current and expired digital certificates (ex: Certificate transparency) Certificate: Certificate Registration Queried or logged information highlighting current and expired digital certificates (ex: Certificate transparency) Domain ID Name Detects Enterprise T1588 Obtain Capabilities Consider use of services that may aid in the tracking of newly issued certificates and/or certificates in use on sites across the Internet. In some cases it may be possible to pivot on known pieces of certificate information to uncover other adversary infrastructure.[1] Some server-side components of adversary tools may have default values set for SSL/TLS certificates.[2] Much of this activity will take place outside the visibility of the target organization, making detection of this behavior difficult. Detection efforts may be focused on related stages of the adversary lifecycle, such as during Defense Evasion or Command and Control. .004 Digital Certificates Consider use of services that may aid in the tracking of newly issued certificates and/or certificates in use on sites across the Internet. In some cases it may be possible to pivot on known pieces of certificate information to uncover other adversary infrastructure.[1] Some server-side components of adversary tools may have default values set for SSL/TLS certificates.[2] References Kovar, R. (2017, December 11). Tall Tales of Hunting with TLS/SSL Certificates. Retrieved October 16, 2020. Insikt Group. (2019, June 18). A Multi-Method Approach to Identifying Rogue Cobalt Strike Servers. Retrieved October 16, 2020. "
},
{
"id": 1968,
"title": "Module, Data Source DS0011",
"path": "/datasources/DS0011/index.html",
"content": " Module Executable files consisting of one or more shared classes and interfaces, such as portable executable (PE) format binaries/dynamic link libraries (DLL), executable and linkable format (ELF) binaries/shared libraries, and Mach-O format binaries/shared libraries[1][2] ID: DS0011 \u24d8 Platforms: Linux, Windows, macOS \u24d8 Collection Layer: Host Contributors: Center for Threat-Informed Defense (CTID) Version: 1.0 Created: 20 October 2021 Last Modified: 30 March 2022 Version Permalink Live Version Data Components This data source does not have any techniques in the selected domain(s) Module: Module Load Attaching a module into the memory of a process/program, typically to access shared resources/features provided by the module (ex: Sysmon EID 7) Module: Module Load Attaching a module into the memory of a process/program, typically to access shared resources/features provided by the module (ex: Sysmon EID 7) Domain ID Name Detects Enterprise T1547 Boot or Logon Autostart Execution Monitor DLL loads by processes, specifically looking for DLLs that are not recognized or not normally loaded into a process. Look for abnormal process behavior that may be due to a process loading a malicious DLL. .002 Authentication Package Monitor the LSA process for DLL loads. Windows 8.1 and Windows Server 2012 R2 may generate events when unsigned DLLs try to load into the LSA by setting the Registry key HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options\\LSASS.exe with AuditLevel = 8. [3] [4] .003 Time Providers There is no restriction on the number of custom time providers registrations, though each may require a DLL payload written to disk. [5] .004 Winlogon Helper DLL New DLLs written to System32 that do not correlate with known good software or patching may also be suspicious. Look for abnormal process behavior that may be due to a process loading a malicious DLL. Data and events should not be viewed in isolation, but as part of a chain of behavior that could lead to other activities, such as network connections made for Command and Control, learning details about the environment through Discovery, and Lateral Movement. .005 Security Support Provider Monitor the LSA process for DLL loads. Windows 8.1 and Windows Server 2012 R2 may generate events when unsigned SSP DLLs try to load into the LSA by setting the Registry key HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options\\LSASS.exe with AuditLevel = 8. [3] [4] .008 LSASS Driver Also monitor DLL load operations in lsass.exe. [6] .010 Port Monitors Monitor DLLs that are loaded by spoolsv.exe for DLLs that are abnormal. New DLLs written to the System32 directory that do not correlate with known good software or patching may be suspicious. .012 Print Processors Monitor for abnormal DLLs that are loaded by spoolsv.exe. Print processors that do not correlate with known good software or patching may be suspicious. New print processor DLLs are written to the print processor directory. Enterprise T1059 Command and Scripting Interpreter Monitor for events associated with scripting execution, such as the loading of modules associated with scripting languages (ex: JScript.dll or vbscript.dll). .001 PowerShell Monitor for loading and/or execution of artifacts associated with PowerShell specific assemblies, such as System.Management.Automation.dll (especially to unusual process names/locations).[7][8] Analytic 1 - Processes loading PowerShell assemblies suspicious_processes = filter ProcessGuid, ProcessFilePath, ModulePath, FileDescription where EventId == \"7\" AND (ModulePath LIKE '%system.management.automation%' OR FileDescription LIKE '%system.management.automation%') .005 Visual Basic Monitor for the loading of modules associated with VB languages (ex: vbscript.dll). Note: For Windows, Sysmon Event ID 7 (Image loaded) can be used to alert on the loading of DLL modules (e.g., vbscript.dll) associated with Visual Basic into processes. Due to the high frequency of image load operations, Event ID 7 can generate a large volume of events. Therefore, we recommend tuning the Sysmon configuration file to exclude common, benign image loads that may result in false positives. .007 JavaScript Monitor for the loading of modules associated with scripting languages (ex: JScript.dll). Enterprise T1546 Event Triggered Execution Monitor DLL loads by processes, specifically looking for DLLs that are not recognized or not normally loaded into a process. Look for abnormal process behavior that may be due to a process loading a malicious DLL. Data and events should not be viewed in isolation, but as part of a chain of behavior that could lead to other activities, such as making network connections for Command and Control, learning details about the environment through Discovery, and conducting Lateral Movement. .006 LC_LOAD_DYLIB Addition Monitor DLL/PE file events, specifically creation of these binary files as well as the loading of DLLs into processes. Look for DLLs that are not recognized or not normally loaded into a process. .007 Netsh Helper DLL Monitor DLL/PE file events, specifically creation of these binary files as well as the loading of DLLs into processes. Look for DLLs that are not recognized or not normally loaded into a process. .009 AppCert DLLs Monitor DLL loads by processes, specifically looking for DLLs that are not recognized or not normally loaded into a process. Tools such as Sysinternals Autoruns may overlook AppCert DLLs as an auto-starting location. [9] [10] .010 AppInit DLLs Monitor DLL loads by processes that load user32.dll and look for DLLs that are not recognized or not normally loaded into a process. .011 Application Shimming Monitor DLL loads by processes that load user32.dll and look for DLLs that are not recognized or not normally loaded into a process. .015 Component Object Model Hijacking Likewise, if software DLL loads are collected and analyzed, any unusual DLL load that can be correlated with a COM object Registry modification may indicate COM hijacking has been performed. ICS T0823 Graphical User Interface Monitor DLL file events, specifically creation of these binary files as well as the loading of DLLs into processes associated with remote graphical connections, such as RDP and VNC. Remote Services may be used to access a host\u2019s GUI. Enterprise T1574 Hijack Execution Flow Monitor DLLs loaded into a process and detect DLLs that have the same file name but abnormal paths. .001 DLL Search Order Hijacking Monitor DLLs loaded into a process and detect DLLs that have the same file name but abnormal paths. .002 DLL Side-Loading Monitor DLL/PE file events, specifically creation of these binary files as well as the loading of DLLs into processes. Look for DLLs that are not recognized or not normally loaded into a process. .004 Dylib Hijacking Monitor for dynamic libraries being loaded. Run path dependent libraries can include LC_LOAD_DYLIB, LC_LOAD_WEAK_DYLIB, and LC_RPATH. Other special keywords are recognized by the macOS loader are @rpath, @loader_path, and @executable_path.[11] These loader instructions can be examined for individual binaries or frameworks using the otool -l command. Objective-See's Dylib Hijacking Scanner can be used to identify applications vulnerable to dylib hijacking .005 Executable Installer File Permissions Weakness Monitor DLL/PE file events, specifically creation of these binary files as well as the loading of DLLs into processes. Look for DLLs that are not recognized or not normally loaded into a process. .006 Dynamic Linker Hijacking Monitor library metadata, such as a hash, and compare libraries that are loaded at process execution time against previous executions to detect differences that do not correlate with patching or updates. .012 COR_PROFILER Monitor DLL files that are associated with COR_PROFILER environment variables. Enterprise T1559 Inter-Process Communication Monitor DLL/PE file events, specifically creation of these binary files as well as the loading of DLLs into processes. Look for DLLs that are not recognized or not normally loaded into a process. .001 Component Object Model Monitor for COM objects loading DLLs and other modules not typically associated with the application.[12] .002 Dynamic Data Exchange Monitor processes for abnormal behavior indicative of DDE abuse, such as Microsoft Office applications loading DLLs and other modules not typically associated with the application or these applications spawning unusual processes (such as cmd.exe). Enterprise T1556 Modify Authentication Process Monitor for new, unfamiliar DLL files written to a domain controller and/or local computer. Password filters will also show up as an autorun and loaded DLL in lsass.exe.[13] If AD FS is in use, monitor the AD FS server for the creation of DLLs as well as the loading of unrecognized or unsigned DLLs into the Microsoft.IdentityServer.Servicehost application.[14] .002 Password Filter DLL Monitor for new, unfamiliar DLL files written to a domain controller and/or local computer. Password filters will also show up as an autorun and loaded DLL in lsass.exe.[13] .007 Hybrid Identity Monitor the hybrid identity solution in use for the loading of unauthorized DLLs. For example, monitor all PTA agent servers for the creation of DLLs as well as the loading of DLLs into the AzureADConnectAuthenticationAgentService process.[15] If AD FS is in use, monitor the AD FS server for the creation of DLLs as well as the loading of unrecognized or unsigned DLLs into the Microsoft.IdentityServer.Servicehost application.[14] Enterprise T1106 Native API Monitor DLL/PE file events, specifically creation of these binary files as well as the loading of DLLs into processes. Utilization of the Windows APIs may involve processes loading/accessing system DLLs associated with providing called functions (ex: ntdll.dll, kernel32.dll, advapi32.dll, user32.dll, and gdi32.dll). Monitoring for DLL loads, especially to abnormal/unusual or potentially malicious processes, may indicate abuse of the Windows API. Though noisy, this data can be combined with other indicators to identify adversary activity. Enterprise T1027 Obfuscated Files or Information Monitoring module loads, especially those not explicitly included in import tables, may highlight obfuscated code functionality. Dynamic malware analysis may also expose signs of code obfuscation.[16] .007 Dynamic API Resolution Monitoring module loads, especially those not explicitly included in import tables, may highlight obfuscated API function calls. Dynamic malware analysis may also expose signs of function obfuscation, such as memory reads that correspond to addresses of API function code within modules.[16] Enterprise T1137 Office Application Startup Monitor DLL/PE file events, specifically creation of these binary files as well as the loading of DLLs into processes. Look for DLLs that are not recognized or not normally loaded into a process. .002 Office Test Monitor DLL/PE file events, specifically creation of these binary files as well as the loading of DLLs into processes. Look for DLLs that are not recognized or not normally loaded into a process. Enterprise T1055 Process Injection Monitor DLL/PE file events, specifically creation of these binary files as well as the loading of DLLs into processes. Look for DLLs that are not recognized or not normally loaded into a process. .001 Dynamic-link Library Injection Monitor DLL/PE file events, specifically creation of these binary files as well as the loading of DLLs into processes. Look for DLLs that are not recognized or not normally loaded into a process. Sysmon Event ID 7 (Image loaded) can be used to monitor the loading of DLLs into processes. This is a particularly noisy event and can generate a large volume of data, so we recommend baselining and filtering out any known benign processes and module loads to help reduce the number of events that are produced. .014 VDSO Hijacking Monitor library load events, especially unusual creation of these binary files followed by loading into processes. Look for libraries that are not recognized or not normally loaded into a process. Enterprise T1620 Reflective Code Loading Monitor for artifacts of abnormal process execution. For example, a common signature related to reflective code loading on Windows is mechanisms related to the .NET Common Language Runtime (CLR) -- such as mscor.dll, mscoree.dll, and clr.dll -- loading into abnormal processes (such as notepad.exe) Enterprise T1021 Remote Services Monitor DLL/PE file events, specifically creation of these binary files as well as the loading of DLLs into processes, that may use Valid Accounts to log into a service specifically designed to accept remote connections, such as telnet, SSH, and VNC. The adversary may then perform actions as the logged-on user. Note: On Windows, Sysmon Event ID 7 (Image loaded) can be used to monitor the loading of DLLs into processes, including those designed to accept remote connections. This is a particularly noisy event and can generate a large volume of data, so we recommend baselining and filtering out any known benign processes and module to help reduce the number of events that are produced. .003 Distributed Component Object Model Monitor for COM objects loading DLLs and other modules not typically associated with the application.[17] Note: Sysmon Event ID 7 (Image loaded) can be used to monitor for suspicious DLLs loaded by the DCOM Server Process Launcher which runs inside of svchost.exe. This is a particularly noisy event and can generate a large volume of data, so we recommend baselining and filtering out any known benign svchost.exe module loads that occur as part of its typical operation. ICS T0886 Remote Services Monitor DLL file events, specifically creation of these files as well as the loading of DLLs into processes specifically designed to accept remote connections, such as RDP, Telnet, SSH, and VNC. ICS T0853 Scripting Monitor for events associated with scripting execution, such as the loading of modules associated with scripting languages (e.g., JScript.dll, vbscript.dll). Enterprise T1505 .005 Server Software Component: Terminal Services DLL Monitor module loads by the Terminal Services process (ex: svchost.exe -k termsvcs) for unexpected DLLs (the default is %SystemRoot%\\System32\\termsrv.dll, though an adversary could also use Match Legitimate Name or Location to potentially conceal a malicious payload). Enterprise T1129 Shared Modules Monitoring module loads may generate a significant amount of data and may not be directly useful for defense unless collected under specific circumstances, since benign use of shared modules load functions are common and may be difficult to distinguish from malicious behavior. Legitimate software will likely only need to load routine, bundled, or system modules such that deviation from known module loads may be suspicious Limiting module loads to trusted directories, such as %SystemRoot% and %ProgramFiles% on Windows, may protect against module loads from unsafe paths. Enterprise T1553 Subvert Trust Controls Enable CryptoAPI v2 (CAPI) event logging [18] to monitor and analyze error events related to failed trust validation (Event ID 81, though this event can be subverted by hijacked trust provider components) as well as any other provided information events (ex: successful validations). Code Integrity event logging may also provide valuable indicators of malicious SIP or trust provider loads, since protected processes that attempt to load a maliciously-crafted trust validation component will likely fail (Event ID 3033). [19] .003 SIP and Trust Provider Hijacking Enable CryptoAPI v2 (CAPI) event logging [18] to monitor and analyze error events related to failed trust validation (Event ID 81, though this event can be subverted by hijacked trust provider components) as well as any other provided information events (ex: successful validations). Code Integrity event logging may also provide valuable indicators of malicious SIP or trust provider loads, since protected processes that attempt to load a maliciously-crafted trust validation component will likely fail (Event ID 3033). [19] Enterprise T1218 System Binary Proxy Execution Monitor DLL/PE file events, specifically creation of these binary files as well as the loading of DLLs into processes. Look for DLLs that are not recognized or not normally loaded into a process. .002 Control Panel Monitor for DLL/PE file events, such as the Control_RunDLL and ControlRunDLLAsUser API functions in shell32.dll. .007 Msiexec Monitor DLL/PE file events, specifically creation of these binary files as well as the loading of DLLs into processes. Look for DLLs that are not recognized or not normally loaded into a process. .008 Odbcconf Monitor DLL/PE file events, specifically creation of these binary files as well as the loading of DLLs into processes. Look for DLLs that are not recognized or not normally loaded into a process. .010 Regsvr32 Monitor DLL/PE file events, specifically creation of these binary files as well as the loading of DLLs into processes. Look for DLLs that are not recognized or not normally loaded into a process. .011 Rundll32 Analyzing DLL exports and comparing to runtime arguments may be useful in uncovering obfuscated function calls. Static Portable Executable (PE) analysis tools can be used to examine and dump the exports of a particular DLL. Enterprise T1220 XSL Script Processing Monitor DLL/PE file events, specifically creation of these binary files as well as the loading of DLLs into processes. Look for DLLs that are not recognized or not normally loaded into a process. References Microsoft. (2018, December 5). LoadLibraryA function (libloaderapi.h). Retrieved September 28, 2021. Microsoft. (n.d.). Module Class. Retrieved September 28, 2021. Graeber, M. (2014, October). Analysis of Malicious Security Support Provider DLLs. Retrieved March 1, 2017. Microsoft. (2013, July 31). Configuring Additional LSA Protection. Retrieved June 24, 2015. Lundgren, S. (2017, October 28). w32time. Retrieved March 26, 2018. Microsoft. (n.d.). Dynamic-Link Library Security. Retrieved November 27, 2017. Warner, J.. (2015, January 6). Inexorable PowerShell \u2013 A Red Teamer\u2019s Tale of Overcoming Simple AppLocker Policies. Retrieved December 8, 2018. Christensen, L.. (2015, December 28). The Evolution of Offensive PowerShell Invocation. Retrieved December 8, 2018. Russinovich, M. (2016, January 4). Autoruns for Windows v13.51. Retrieved June 6, 2016. Microsoft. (2007, October 24). Windows Sysinternals - AppCertDlls. Retrieved December 18, 2017. Apple Inc.. (2012, July 7). Run-Path Dependent Libraries. Retrieved March 31, 2021. Nelson, M. (2017, January 5). Lateral Movement using the MMC20 Application COM Object. Retrieved November 21, 2017. Bialek, J. (2013, September 15). Intercepting Password Changes With Function Hooking. Retrieved November 21, 2017. Microsoft Threat Intelligence Center, Microsoft Detection and Response Team, Microsoft 365 Defender Research Team . (2022, August 24). MagicWeb: NOBELIUM\u2019s post-compromise trick to authenticate as anyone. Retrieved September 28, 2022. Mike Burns. (2020, September 30). Detecting Microsoft 365 and Azure Active Directory Backdoors. Retrieved September 28, 2022. Choi, S. (2015, August 6). Obfuscated API Functions in Modern Packers. Retrieved August 22, 2022. Nelson, M. (2017, November 16). Lateral Movement using Outlook's CreateObject Method and DotNetToJScript. Retrieved November 21, 2017. Entrust Datacard. (2017, August 16). How do I enable CAPI 2.0 logging in Windows Vista, Windows 7 and Windows 2008 Server?. Retrieved January 31, 2018. Graeber, M. (2017, September). Subverting Trust in Windows. Retrieved January 31, 2018. "
},
{
"id": 1969,
"title": "Domain Name, Data Source DS0038",
"path": "/datasources/DS0038/index.html",
"content": " Domain Name Information obtained (commonly through registration or activity logs) regarding one or more IP addresses registered with human readable names (ex: mitre.org) ID: DS0038 \u24d8 Platform: PRE \u24d8 Collection Layer: OSINT Version: 1.0 Created: 20 October 2021 Last Modified: 20 October 2021 Version Permalink Live Version Data Components This data source does not have any techniques in the selected domain(s) Domain Name: Active DNS Queried domain name system (DNS) registry data highlighting current domain to IP address resolutions (ex: dig/nslookup queries) Domain Name: Active DNS Queried domain name system (DNS) registry data highlighting current domain to IP address resolutions (ex: dig/nslookup queries) Domain ID Name Detects Enterprise T1583 Acquire Infrastructure Monitor for queried domain name system (DNS) registry data that may buy, lease, or rent infrastructure that can be used during targeting. Detection efforts may be focused on related stages of the adversary lifecycle, such as during Command and Control. .001 Domains Monitor queried domain name system (DNS) registry data for purchased domains that can be used during targeting. Reputation/category-based detection may be difficult until the categorization is updated. Detection efforts may be focused on related stages of the adversary lifecycle, such as during Initial Access and Command and Control. Enterprise T1584 Compromise Infrastructure Monitor for queried domain name system (DNS) registry data that may compromise third-party infrastructure that can be used during targeting. Detection efforts may be focused on related stages of the adversary lifecycle, such as during Command and Control. .001 Domains Monitor for queried domain name system (DNS) registry data that may hijack domains and/or subdomains that can be used during targeting. In some cases, abnormal subdomain IP addresses (such as those originating in a different country from the root domain) may indicate a malicious subdomain.[1] Much of this activity will take place outside the visibility of the target organization, making detection of this behavior difficult. Detection efforts may be focused on related stages of the adversary lifecycle, such as during Command and Control. .002 DNS Server Monitor for queried domain name system (DNS) registry data that may compromise third-party DNS servers that can be used during targeting. Much of this activity will take place outside the visibility of the target organization, making detection of this behavior difficult. Detection efforts may be focused on related stages of the adversary lifecycle, such as during Command and Control. Domain Name: Domain Registration Information about domain name assignments and other domain metadata (ex: WHOIS) Domain Name: Domain Registration Information about domain name assignments and other domain metadata (ex: WHOIS) Domain ID Name Detects Enterprise T1583 Acquire Infrastructure Consider use of services that may aid in tracking of newly acquired infrastructure, such as WHOIS databases for domain registration information. Detection efforts may be focused on related stages of the adversary lifecycle, such as during Command and Control. .001 Domains Domain registration information is, by design, captured in public registration logs. Consider use of services that may aid in tracking of newly acquired domains, such as WHOIS databases and/or passive DNS. In some cases it may be possible to pivot on known pieces of domain registration information to uncover other infrastructure purchased by the adversary. Consider monitoring for domains created with a similar structure to your own, including under a different TLD. Though various tools and services exist to track, query, and monitor domain name registration information, tracking across multiple DNS infrastructures can require multiple tools/services or more advanced analytics.[2] Detection efforts may be focused on related stages of the adversary lifecycle, such as during Initial Access and Command and Control. Enterprise T1584 Compromise Infrastructure Consider monitoring for anomalous changes to domain registrant information and/or domain resolution information that may indicate the compromise of a domain. Efforts may need to be tailored to specific domains of interest as benign registration and resolution changes are a common occurrence on the internet. .001 Domains Consider monitoring for anomalous changes to domain registrant information and/or domain resolution information that may indicate the compromise of a domain. Efforts may need to be tailored to specific domains of interest as benign registration and resolution changes are a common occurrence on the internet. Domain Name: Passive DNS Logged domain name system (DNS) data highlighting timelines of domain to IP address resolutions (ex: passive DNS) Domain Name: Passive DNS Logged domain name system (DNS) data highlighting timelines of domain to IP address resolutions (ex: passive DNS) Domain ID Name Detects Enterprise T1583 Acquire Infrastructure Monitor for logged domain name system (DNS) data that may buy, lease, or rent infrastructure that can be used during targeting. Detection efforts may be focused on related stages of the adversary lifecycle, such as during Command and Control. .001 Domains Monitor logged domain name system (DNS) data for purchased domains that can be used during targeting. Reputation/category-based detection may be difficult until the categorization is updated. Detection efforts may be focused on related stages of the adversary lifecycle, such as during Initial Access and Command and Control. Enterprise T1584 Compromise Infrastructure Monitor for logged domain name system (DNS) data that may compromise third-party infrastructure that can be used during targeting. Detection efforts may be focused on related stages of the adversary lifecycle, such as during Command and Control. .001 Domains Monitor for logged domain name system (DNS) registry data that may hijack domains and/or subdomains that can be used during targeting. In some cases, abnormal subdomain IP addresses (such as those originating in a different country from the root domain) may indicate a malicious subdomain.[1] Much of this activity will take place outside the visibility of the target organization, making detection of this behavior difficult. Detection efforts may be focused on related stages of the adversary lifecycle, such as during Command and Control. .002 DNS Server Monitor for logged domain name system (DNS) registry data that may compromise third-party DNS servers that can be used during targeting. Much of this activity will take place outside the visibility of the target organization, making detection of this behavior difficult. Detection efforts may be focused on related stages of the adversary lifecycle, such as during Command and Control. References Janos Szurdi, Rebekah Houser and Daiping Liu. (2022, September 21). Domain Shadowing: A Stealthy Use of DNS Compromise for Cybercrime. Retrieved March 7, 2023. ThreatConnect. (2020, December 15). Infrastructure Research and Hunting: Boiling the Domain Ocean. Retrieved October 12, 2021. "
},
{
"id": 1970,
"title": "Application Vetting, Data Source DS0041",
"path": "/datasources/DS0041/index.html",
"content": " Application Vetting Application vetting report generated by an external cloud service. ID: DS0041 \u24d8 Platforms: Android, iOS \u24d8 Collection Layer: Report Version: 1.0 Created: 13 March 2023 Last Modified: 13 March 2023 Version Permalink Live Version Data Components This data source does not have any techniques in the selected domain(s) Application Vetting: API Calls API calls utilized by an application that could indicate malicious activity Application Vetting: API Calls API calls utilized by an application that could indicate malicious activity Domain ID Name Detects Mobile T1661 Application Versioning Application vetting services may look for indications that the application\u2019s update includes malicious code at runtime. Mobile T1414 Clipboard Data Application vetting services could detect usage of standard clipboard APIs. Mobile T1623 Command and Scripting Interpreter Application vetting services could detect the invocations of methods that could be used to execute shell commands.[1] .001 Unix Shell Application vetting services could detect the invocations of methods that could be used to execute shell commands.[1] Mobile T1645 Compromise Client Software Binary Application vetting services could detect applications trying to modify files in protected parts of the operating system. Mobile T1634 Credentials from Password Store Application vetting services may be able to detect known privilege escalation exploits contained within applications, as well as searching application packages for strings that correlate to known password store locations. .001 Keychain Application vetting services may be able to detect known privilege escalation exploits contained within applications, as well as searching application packages for strings that correlate to known password store locations. Mobile T1662 Data Destruction Application vetting services may detect API calls for deleting files. Mobile T1471 Data Encrypted for Impact Application vetting services may be able to detect if an application attempts to encrypt files, although this may be benign behavior. Mobile T1641 Data Manipulation Application vetting services could look for use of standard APIs (e.g. the clipboard API) that could indicate data manipulation is occurring. .001 Transmitted Data Manipulation Applications could be vetted for their use of the clipboard manager APIs with extra scrutiny given to application that make use of them. Mobile T1407 Download New Code at Runtime Application vetting services could look for indications that the application downloads and executes new code at runtime (e.g., on Android, use of DexClassLoader, System.load, or the WebView JavaScriptInterface capability; on iOS, use of JSPatch or similar capabilities). Mobile T1627 Execution Guardrails Application vetting services can detect unnecessary and potentially abused API calls. .001 Geofencing Application vetting services can detect unnecessary and potentially abused API calls. Mobile T1404 Exploitation for Privilege Escalation Application vetting services could potentially determine if an application contains code designed to exploit vulnerabilities. Mobile T1541 Foreground Persistence Applications could be vetted for their use of the startForeground() API, and could be further scrutinized if usage is found. Mobile T1628 Hide Artifacts Application vetting services could potentially detect the usage of APIs intended for artifact hiding. .001 Suppress Application Icon Application vetting services could potentially detect the usage of APIs intended for suppressing the application\u2019s icon. Mobile T1629 Impair Defenses Application vetting can detect many techniques associated with impairing device defenses.[1] .001 Prevent Application Removal Application vetting services may detect API calls to performGlobalAction(int). Mobile T1630 .001 Indicator Removal on Host: Uninstall Malicious Application Application vetting services could look for use of the accessibility service or features that typically require root access. Mobile T1655 Masquerading Application vetting services may potentially determine if an application contains suspicious code and/or metadata. .001 Match Legitimate Name or Location Application vetting services may potentially determine if an application contains suspicious code and/or metadata. Mobile T1406 Obfuscated Files or Information Dynamic analysis, when used in application vetting, may in some cases be able to identify malicious code in obfuscated or encrypted form by detecting the code at execution time (after it is deobfuscated or decrypted). Some application vetting techniques apply reputation analysis of the application developer and can alert to potentially suspicious applications without actual examination of application code. .002 Software Packing Application vetting services could look for known software packers or artifacts of packing techniques. Packing is not a definitive indicator of malicious activity, because as legitimate software may use packing techniques to reduce binary size or to protect proprietary code. Mobile T1424 Process Discovery Mobile security products can typically detect rooted devices, which is an indication that Process Discovery is possible. Application vetting could potentially detect when applications attempt to abuse root access or root the system itself. Further, application vetting services could look for attempted usage of legacy process discovery mechanisms, such as the usage of ps or inspection of the /proc directory. Mobile T1631 Process Injection Application vetting services could look for misuse of dynamic libraries. .001 Ptrace System Calls Application vetting services could look for misuse of dynamic libraries. Mobile T1513 Screen Capture Application vetting services can look for the use of the Android MediaProjectionManager class, applying extra scrutiny to applications that use the class. Mobile T1418 Software Discovery Application vetting services could look for the Android permission android.permission.QUERY_ALL_PACKAGES, and apply extra scrutiny to applications that request it. On iOS, application vetting services could look for usage of the private API LSApplicationWorkspace and apply extra scrutiny to applications that employ it. .001 Security Software Discovery Application vetting services could look for the Android permission android.permission.QUERY_ALL_PACKAGES, and apply extra scrutiny to applications that request it. On iOS, application vetting services could look for usage of the private API LSApplicationWorkspace and apply extra scrutiny to applications that employ it. Mobile T1635 Steal Application Access Token When vetting applications for potential security weaknesses, the vetting process could look for insecure use of Intents. Developers should be encouraged to use techniques to ensure that the intent can only be sent to an appropriate destination (e.g., use explicit rather than implicit intents, permission checking, checking of the destination app's signing certificate, or utilizing the App Links feature). For mobile applications using OAuth, encourage use of best practice.[2][3] .001 URI Hijacking When vetting applications for potential security weaknesses, the vetting process could look for insecure use of Intents. Developers should be encouraged to use techniques to ensure that the intent can only be sent to an appropriate destination (e.g., use explicit rather than implicit intents, permission checking, checking of the destination app's signing certificate, or utilizing the App Links feature). For mobile applications using OAuth, encourage use of best practice. [2][3] Mobile T1409 Stored Application Data Application vetting services could detect when applications store data insecurely, for example, in unprotected external storage. Mobile T1474 Supply Chain Compromise Usage of insecure or malicious third-party libraries could be detected by application vetting services. Malicious software development tools could be detected by enterprises that deploy endpoint protection software on computers that are used to develop mobile apps. Application vetting could detect the usage of insecure or malicious third-party libraries. .001 Compromise Software Dependencies and Development Tools Usage of insecure or malicious third-party libraries could be detected by application vetting services. Malicious software development tools could be detected by enterprises that deploy endpoint protection software on computers that are used to develop mobile apps. Application vetting could detect the usage of insecure or malicious third-party libraries. .003 Compromise Software Supply Chain Application vetting services can detect malicious code in applications. Mobile T1633 Virtualization/Sandbox Evasion Application vetting services could look for applications attempting to get android.os.SystemProperties or getprop with the runtime exec() commands. This could indicate some level of sandbox evasion, as Google recommends against using system properties within applications. .001 System Checks Application vetting services could look for applications attempting to get android.os.SystemProperties or getprop with the runtime exec() commands. This could indicate some level of sandbox evasion, as Google recommends against using system properties within applications. Application Vetting: Network Communication Network requests made by an application or domains contacted Application Vetting: Network Communication Network requests made by an application or domains contacted Domain ID Name Detects Mobile T1661 Application Versioning Application vetting services may be able to list domains and/or IP addresses that applications communicate with. Mobile T1407 Download New Code at Runtime Application vetting services may be able to list domains and/or IP addresses that applications communicate with. Mobile T1637 Dynamic Resolution Monitor for pseudo-randomly generated domain names based on frequency analysis, Markov chains, entropy, proportion of dictionary words, ratio of vowels to other characters, and more.[4] Additionally, check if the suspicious domain has been recently registered, if it has been rarely visited, or if the domain had a spike in activity after being dormant.[5] Content delivery network (CDN) domains may trigger these detections due to the format of their domain names. .001 Domain Generation Algorithms Monitor for pseudo-randomly generated domain names based on frequency analysis, Markov chains, entropy, proportion of dictionary words, ratio of vowels to other characters, and more.[4] Additionally, check if the suspicious domain has been recently registered, if it has been rarely visited, or if the domain had a spike in activity after being dormant.[5] Content delivery network (CDN) domains may trigger these detections due to the format of their domain names. Mobile T1658 Exploitation for Client Execution Network traffic analysis may reveal processes communicating with malicious domains. Mobile T1428 Exploitation of Remote Services Application vetting may be able to identify applications that perform Discovery or utilize existing connectivity to remotely access hosts within an internal enterprise network. Mobile T1544 Ingress Tool Transfer Application vetting services could look for connections to unknown domains or IP addresses. Mobile T1509 Non-Standard Port Application vetting reports may show network communications performed by the application, including hosts, ports, protocols, and URLs. Further detection would most likely be at the enterprise level, through packet and/or netflow inspection. Mobile T1481 Web Service Application vetting services may provide a list of connections made or received by an application, or a list of domains contacted by the application. .001 Dead Drop Resolver Application vetting services may provide a list of connections made or received by an application, or a list of domains contacted by the application. .002 Bidirectional Communication Application vetting services may provide a list of connections made or received by an application, or a list of domains contacted by the application. .003 One-Way Communication Application vetting services may provide a list of connections made or received by an application, or a list of domains contacted by the application. Application Vetting: Permissions Requests Permissions declared in an application's manifest or property list file Application Vetting: Permissions Requests Permissions declared in an application's manifest or property list file Domain ID Name Detects Mobile T1626 Abuse Elevation Control Mechanism Application vetting services can detect when an application requests administrator permission. .001 Device Administrator Permissions Application vetting services can check for the string BIND_DEVICE_ADMIN in the application\u2019s manifest. This indicates it can prompt the user for device administrator permissions. Mobile T1517 Access Notifications Application vetting services can look for applications requesting the BIND_NOTIFICATION_LISTENER_SERVICE permission in a service declaration. Mobile T1640 Account Access Removal Application vetting services could closely scrutinize applications that request Device Administrator permissions. Mobile T1661 Application Versioning Application vetting services may detect when an application requests permissions after an application update. Mobile T1429 Audio Capture Android applications using the RECORD_AUDIO permission and iOS applications using RequestRecordPermission should be carefully reviewed and monitored. If the CAPTURE_AUDIO_OUTPUT permission is found in a third-party Android application, the application should be heavily scrutinized. In both Android (6.0 and up) and iOS, the user can review which applications have the permission to access the microphone through the device settings screen and revoke permissions as necessary. Mobile T1662 Data Destruction Mobile security products can detect which applications can request device administrator permissions. Application vetting services could be extra scrutinous of applications that request device administrator permissions. Mobile T1642 Endpoint Denial of Service Application vetting services can detect and closely scrutinize applications that utilize Device Administrator access. Mobile T1624 Event Triggered Execution Application vetting services can detect which broadcast intents an application registers for and which permissions it requests. .001 Broadcast Receivers Application vetting services can detect which broadcast intents an application registers for and which permissions it requests. Mobile T1627 Execution Guardrails Application vetting services can detect unnecessary and potentially abused permissions. .001 Geofencing Application vetting services can detect unnecessary and potentially abused location permissions. Mobile T1643 Generate Traffic from Victim Application vetting services can detect when applications request the SEND_SMS permission, which should be infrequently used. Mobile T1630 Indicator Removal on Host Mobile security products can detect which applications can request device administrator permissions. Application vetting services could look for use of APIs that could indicate the application is trying to hide activity. .002 File Deletion Mobile security products can detect which applications can request device administrator permissions. Application vetting services could be extra scrutinous of applications that request device administrator permissions. Mobile T1544 Ingress Tool Transfer Application vetting services may indicate precisely what content was requested during application execution. Mobile T1417 Input Capture Application vetting services can look for applications requesting the permissions granting access to accessibility services or application overlay. .001 Keylogging Application vetting services can look for applications requesting the android.permission.BIND_ACCESSIBILITY_SERVICE permission in a service declaration. On Android, the user can view and manage which applications can use accessibility services through the device settings in Accessibility. The exact device settings menu locations may vary between operating system versions. .002 GUI Input Capture Application vetting services can look for applications requesting the android.permission.SYSTEM_ALERT_WINDOW permission in the list of permissions in the app manifest. Mobile T1430 Location Tracking Android applications requesting the ACCESS_COARSE_LOCATION, ACCESS_FINE_LOCATION, or ACCESS_BACKGROUND_LOCATION permissions and iOS applications including the NSLocationWhenInUseUsageDescription, NSLocationAlwaysAndWhenInUseUsageDescription, and/or NSLocationAlwaysUsageDescription keys in their Info.plist file could be scrutinized during the application vetting process. Mobile T1636 Protected User Data Application vetting services typically flag permissions requested by an application, which can be reviewed by an administrator. Certain dangerous permissions, such as RECEIVE_SMS, could receive additional scrutiny. .001 Calendar Entries Application vetting services could look for android.permission.READ_CALENDAR or android.permission.WRITE_CALENDAR in an Android application\u2019s manifest, or NSCalendarsUsageDescription in an iOS application\u2019s Info.plist file. Most applications do not need calendar access, so extra scrutiny could be applied to those that request it. .002 Call Log Application vetting services could look for android.permission.READ_CALL_LOG in an Android application\u2019s manifest. Most applications do not need call log access, so extra scrutiny could be applied to those that request it. .003 Contact List Application vetting services could look for android.permission.READ_CONTACTS in an Android application\u2019s manifest, or NSContactsUsageDescription in an iOS application\u2019s Info.plist file. Most applications do not need contact list access, so extra scrutiny could be applied to those that request it. .004 SMS Messages Application vetting services could look for android.permission.READ_SMS in an Android application\u2019s manifest. Most applications do not need access to SMS messages, so extra scrutiny could be applied to those that request it. Mobile T1422 System Network Configuration Discovery Application vetting services could look for usage of the READ_PRIVILEGED_PHONE_STATE Android permission. This could indicate that non-system apps are attempting to access information that they do not have access to. Mobile T1512 Video Capture During the vetting process, applications using the Android permission android.permission.CAMERA, or the iOS NSCameraUsageDescription plist entry could be given closer scrutiny. Application Vetting: Protected Configuration Device configuration options that are not typically utilized by benign applications Application Vetting: Protected Configuration Device configuration options that are not typically utilized by benign applications Domain ID Name Detects Mobile T1638 Adversary-in-the-Middle Application vetting services should look for applications that request VPN access. These applications should be heavily scrutinized since VPN functionality is not very common. References Samsung Knox Partner Program. (n.d.). Knox for Mobile Threat Defense. Retrieved March 30, 2022. W. Denniss and J. Bradley. (2017, October). IETF RFC 8252: OAuth 2.0 for Native Apps. Retrieved November 30, 2018. Android. (n.d.). Handling App Links. Retrieved December 21, 2016. Jacobs, J. (2014, October 2). Building a DGA Classifier: Part 2, Feature Engineering. Retrieved February 18, 2019. Chen, Z. et al. (2021, December 29). Strategically Aged Domain Detection: Capture APT Attacks With DNS Traffic Trends. Retrieved July 31, 2023. "
},
{
"id": 1971,
"title": "Firmware, Data Source DS0001",
"path": "/datasources/DS0001/index.html",
"content": " Firmware Computer software that provides low-level control for the hardware and device(s) of a host, such as BIOS or UEFI/EFI ID: DS0001 \u24d8 Platforms: Linux, Windows, macOS \u24d8 Collection Layer: Host Contributors: Center for Threat-Informed Defense (CTID) Version: 1.0 Created: 20 October 2021 Last Modified: 30 March 2022 Version Permalink Live Version Data Components This data source does not have any techniques in the selected domain(s) Firmware: Firmware Modification Changes made to firmware, including its settings and/or data, such as MBR (Master Boot Record) and VBR (Volume Boot Record) Firmware: Firmware Modification Changes made to firmware, including its settings and/or data, such as MBR (Master Boot Record) and VBR (Volume Boot Record) Domain ID Name Detects Enterprise T1495 Firmware Corruption Monitor for changes made to the firmware for unexpected modifications to settings and/or data. [1] Log attempts to read/write to BIOS and compare against known patching behavior. Enterprise T1564 Hide Artifacts Monitor for changes made to firewall rules for unexpected modifications to allow/block specific network traffic that may attempt to hide artifacts associated with their behaviors to evade detection. .005 Hidden File System Monitor for changes made to firmware for unexpected modifications to settings and/or data that may use a hidden file system to conceal malicious activity from users and security tools. Bootkit ICS T0839 Module Firmware Monitor firmware for unexpected changes. Asset management systems should be consulted to understand known-good firmware versions. Dump and inspect BIOS images on vulnerable systems and compare against known good images.[2] Analyze differences to determine if malicious changes have occurred. Log attempts to read/write to BIOS and compare against known patching behavior. Likewise, EFI modules can be collected and compared against a known-clean list of EFI executable binaries to detect potentially malicious modules. The CHIPSEC framework can be used for analysis to determine if firmware modifications have been performed.[3] [4] [5] Enterprise T1542 Pre-OS Boot Monitor for changes made on pre-OS boot mechanisms that can be manipulated for malicious purposes. Take snapshots of boot records and firmware and compare against known good images. Log changes to boot records, BIOS, and EFI .001 System Firmware Monitor for changes made to firmware. [1] Dump and inspect BIOS images on vulnerable systems and compare against known good images. [2] Analyze differences to determine if malicious changes have occurred. Log attempts to read/write to BIOS and compare against known patching behavior.Likewise, EFI modules can be collected and compared against a known-clean list of EFI executable binaries to detect potentially malicious modules. The CHIPSEC framework can be used for analysis to determine if firmware modifications have been performed. [3] [4] [5] .002 Component Firmware Monitor for changes that may reveal indicators of malicious firmware such as strings. Also consider comparing components, including hashes of component firmware and behavior, against known good images. .004 ROMMONkit There are no documented means for defenders to validate the operation of the ROMMON outside of vendor support. If a network device is suspected of being compromised, contact the vendor to assist in further investigation. .005 TFTP Boot Monitor for changes to boot information including system uptime, image booted, and startup configuration to determine if results are consistent with expected behavior in the environment. [6] Monitor unusual connections or connection attempts to the device that may specifically target TFTP or other file-sharing protocols. Enterprise T1014 Rootkit Monitor for changes made to firmware for unexpected modifications to settings and/or data that may be used by rootkits to hide the presence of programs, files, network connections, services, drivers, and other system components. Some rootkit protections may be built into anti-virus or operating system software. There are dedicated rootkit detection tools that look for specific types of rootkit behavior. ICS T0851 Rootkit Monitor for changes made to firmware for unexpected modifications to settings and/or data that may be used by rootkits to hide the presence of programs, files, network connections, services, drivers, and other system components. Asset management systems should be consulted to understand known-good firmware versions and configurations. ICS T0857 System Firmware Monitor firmware for unexpected changes. Asset management systems should be consulted to understand known-good firmware versions. Dump and inspect BIOS images on vulnerable systems and compare against known good images.[2] Analyze differences to determine if malicious changes have occurred. Log attempts to read/write to BIOS and compare against known patching behavior. Likewise, EFI modules can be collected and compared against a known-clean list of EFI executable binaries to detect potentially malicious modules. The CHIPSEC framework can be used for analysis to determine if firmware modifications have been performed.[3] [4] [5] References Upham, K. (2014, March). Going Deep into the BIOS with MITRE Firmware Security Research. Retrieved January 5, 2016. Butterworth, J. (2013, July 30). Copernicus: Question Your Assumptions about BIOS Security. Retrieved December 11, 2015. Beek, C., Samani, R. (2017, March 8). CHIPSEC Support Against Vault 7 Disclosure Scanning. Retrieved March 13, 2017. Intel. (2017, March 18). CHIPSEC Platform Security Assessment Framework. Retrieved March 20, 2017. Intel Security. (2005, July 16). HackingTeam's UEFI Rootkit Details. Retrieved March 20, 2017. Cisco. (n.d.). Cisco IOS Software Integrity Assurance - Boot Information. Retrieved October 21, 2020. "
},
{
"id": 1972,
"title": "File, Data Source DS0022",
"path": "/datasources/DS0022/index.html",
"content": " File A computer resource object, managed by the I/O system, for storing data (such as images, text, videos, computer programs, or any wide variety of other media).[1] ID: DS0022 \u24d8 Platforms: Linux, Network, Windows, macOS \u24d8 Collection Layer: Host Contributors: Center for Threat-Informed Defense (CTID) Version: 1.0 Created: 20 October 2021 Last Modified: 07 December 2022 Version Permalink Live Version Data Components This data source does not have any techniques in the selected domain(s) File: File Access Opening a file, which makes the file contents available to the requestor (ex: Windows EID 4663) File: File Access Opening a file, which makes the file contents available to the requestor (ex: Windows EID 4663) Domain ID Name Detects Enterprise T1087 Account Discovery Monitor access to file resources that contain local accounts and groups information such as /etc/passwd, /Users directories, and the SAM database. If access requires high privileges, look for non-admin objects (such as users or processes) attempting to access restricted file resources. .001 Local Account Monitor access to file resources that contain local accounts and groups information such as /etc/passwd, /Users directories, and the Windows SAM database. If access requires high privileges, look for non-admin objects (such as users or processes) attempting to access restricted file resources. Enterprise T1119 Automated Collection Monitor for unexpected files (e.g., .pdf, .docx, .jpg, etc.) viewed for collecting internal data. ICS T0802 Automated Collection Monitor for unexpected files (e.g., .pdf, .docx, .jpg) viewed for collecting internal data. Enterprise T1020 Automated Exfiltration Monitor for abnormal access to files (i.e. .pdf, .docx, .jpg, etc.), especially sensitive documents, through the use of automated processing after being gathered during Collection. Enterprise T1217 Browser Information Discovery Monitor for unusual access to stored browser data, such as local files and databases (e.g., %APPDATA%/Google/Chrome).[2] Rather than viewing these events in isolation, this activity may highlight a chain of behavior that could lead to other activities, such as Collection and Exfiltration. Enterprise T1555 Credentials from Password Stores Monitor for files being accessed that may search for common password storage locations to obtain user credentials. .001 Keychain Monitor for Keychain files being accessed that may be related to malicious credential collection. .003 Credentials from Web Browsers Identify web browser files that contain credentials such as Google Chrome\u2019s Login Data database file: AppData\\Local\\Google\\Chrome\\User Data\\Default\\Login Data. Monitor file read events of web browser files that contain credentials, especially when the reading process is unrelated to the subject web browser. .004 Windows Credential Manager Consider monitoring file reads to Vault locations, %Systemdrive%\\Users\\\\[Username]\\AppData\\Local\\Microsoft\\\\[Vault/Credentials]\\, for suspicious activity.[3] .005 Password Managers Monitor file reads that may acquire user credentials from third-party password managers.[4] Enterprise T1005 Data from Local System Monitor for unexpected/abnormal access to files that may be malicious collection of local data, such as user files (pdf, .docx, .jpg, etc.) or local databases. ICS T0893 Data from Local System Monitor for unexpected/abnormal access to files that may be malicious collection of local data, such as user files (e.g., .pdf, .docx, .jpg, .dwg ) or local databases. Enterprise T1039 Data from Network Shared Drive Monitor for unexpected files (i.e. .pdf, .docx, .jpg, etc.) interacting with network shares. Enterprise T1025 Data from Removable Media Monitor for unexpected/abnormal file accesses to removable media (optical disk drive, USB memory, etc.) connected to the compromised system. Enterprise T1074 Data Staged Monitor processes that appear to be reading files from disparate locations and writing them to the same directory or file may be an indication of data being staged, especially if they are suspected of performing encryption or compression on the files, such as 7zip, RAR, ZIP, or zlib. .001 Local Data Staging Monitor processes that appear to be reading files from disparate locations and writing them to the same directory or file may be an indication of data being staged, especially if they are suspected of performing encryption or compression on the files, such as 7zip, RAR, ZIP, or zlib. .002 Remote Data Staging Monitor processes that appear to be reading files from disparate locations and writing them to the same directory or file may be an indication of data being staged, especially if they are suspected of performing encryption or compression on the files, such as 7zip, RAR, ZIP, or zlib. Enterprise T1114 Email Collection Monitor for unusual processes access of local system email files for Exfiltration, unusual processes connecting to an email server within a network, or unusual access patterns or authentication attempts on a public-facing webmail server may all be indicators of malicious activity. .001 Local Email Collection Monitor for unusual processes accessing local email files that may target user email on local systems to collect sensitive information. Enterprise T1048 Exfiltration Over Alternative Protocol Monitor for suspicious files (i.e. .pdf, .docx, .jpg, etc.) viewed in isolation that may steal data by exfiltrating it over a different protocol than that of the existing command and control channel. .001 Exfiltration Over Symmetric Encrypted Non-C2 Protocol Monitor for files viewed in isolation that may steal data by exfiltrating it over a symmetrically encrypted network protocol other than that of the existing command and control channel. .002 Exfiltration Over Asymmetric Encrypted Non-C2 Protocol Monitor files viewed in isolation that may steal data by exfiltrating it over a symmetrically encrypted network protocol other than that of the existing command and control channel. .003 Exfiltration Over Unencrypted Non-C2 Protocol Monitor files viewed in isolation that may steal data by exfiltrating it over a symmetrically encrypted network protocol other than that of the existing command and control channel. Enterprise T1041 Exfiltration Over C2 Channel Monitor for suspicious files (i.e. .pdf, .docx, .jpg, etc.) viewed in isolation that may steal data by exfiltrating it over an existing command and control channel. Enterprise T1011 Exfiltration Over Other Network Medium Monitor for files being accessed that could be related to exfiltration, such as file reads by a process that also has an active network connection. .001 Exfiltration Over Bluetooth Monitor for files being accessed that could be related to exfiltration, such as file reads by a process that also has an active network connection. Also monitor for and investigate changes to host adapter settings, such as addition and/or replication of communication interfaces. Enterprise T1052 Exfiltration Over Physical Medium Monitor file access on removable media that may attempt to exfiltrate data via a physical medium, such as a removable drive. .001 Exfiltration over USB Monitor file access on removable media that may attempt to exfiltrate data over a USB connected physical device. Enterprise T1567 Exfiltration Over Web Service Monitor for files being accessed by an existing, legitimate external Web service to exfiltrate data rather than their primary command and control channel. .001 Exfiltration to Code Repository Monitor for files being accessed to exfiltrate data to a code repository rather than over their primary command and control channel. .002 Exfiltration to Cloud Storage Monitor for files being accessed to exfiltrate data to a cloud storage service rather than over their primary command and control channel. .004 Exfiltration Over Webhook Monitor for files being accessed to exfiltrate data to a webhook as a malicious command and control channel. Enterprise T1187 Forced Authentication Monitor for unexpected files used to gather credentials when the files are rendered Enterprise T1654 Log Enumeration Monitor for access to system and service log files, especially from unexpected and abnormal users. Enterprise T1003 OS Credential Dumping Monitor for hash dumpers opening the Security Accounts Manager (SAM) on the local file system (%SystemRoot%/system32/config/SAM). Some hash dumpers will open the local file system as a device and parse to the SAM table to avoid file access defenses. Others will make an in-memory copy of the SAM table before reading hashes. Detection of compromised ( LinkById: T1078) in-use by adversaries may help as well. .002 Security Account Manager Monitor for hash dumpers opening the Security Accounts Manager (SAM) on the local file system (%SystemRoot%/system32/config/SAM). Some hash dumpers will open the local file system as a device and parse to the SAM table to avoid file access defenses. Others will make an in-memory copy of the SAM table before reading hashes. Detection of compromised Valid Accounts in-use by adversaries may help as well. .003 NTDS Monitor for access or copy of the NTDS.dit. Note: Events 4656 and 4663 (Microsoft Windows Security Auditing) provide context of processes and users requesting access or accessing file objects (ObjectType = File) such as C:\\Windows\\NTDS\\ntds.dit. It is important to note that, in order to generate these events, a System Access Control List (SACL) must be defined for the ntds.dit file. Access rights that allow read operations on file objects and its attributes are %%4416 Read file data, %%4419 Read extended file attributes, %%4423 Read file attributes. If you search for just the name of the file and not the entire directory, you may get access events related to the ntds.dit file within a snapshot or volume shadow copy. Events 4656 and 4663 (Microsoft Windows Security Auditing) provide context of processes and users creating or copying file objects (ObjectType = File) such as C:\\Windows\\NTDS\\ntds.dit. It is important to note that, in order to generate these events, a System Access Control List (SACL) must be defined for the ntds.dit file. In order to filter file creation events, filter access rigths %%4417 Write data to the file and %%4424 Write file attributes. Event 11 (Microsoft Windows Sysmon) provide context of processes and users creating or copying files. Unfortunately, this event provides context of the file being created or copied, but not the file being copied. A good starting point would be to look for new files created or copied with extension .dit. Analytic 1 suspicious_file = filter file_access where ((event_id = \"4656\" OR event_id = \"4663\") AND (object_type = \"File\") AND(file_name = \"ntds.dit\") AND(access_list = \"%%4416\" OR access_list = \"%%4419\" OR access_list = \"%%4416\") Analytic 2 suspicious_file = filter file_access where ((event_id = \"4656\" OR event_id = \"4663\") AND (object_type = \"File\") AND(file_name = \"ntds.dit\") AND(access_list = \"%%4417\" OR access_list = \"%%4424\") Analytic 3 suspicious_file = filter file_access where ((event_id = \"11\") AND (file_name = \"*.dit\") .007 Proc Filesystem Monitor for unexpected access to passwords and hashes stored in memory, processes must open a maps file in the /proc filesystem for the process being analyzed. This file is stored under the path /proc/\\/maps, where the \\ directory is the unique pid of the program being interrogated for such authentication data. The AuditD monitoring tool, which ships stock in many Linux distributions, can be used to watch for hostile processes opening this file in the proc file system, alerting on the pid, process name, and arguments of such programs. .008 /etc/passwd and /etc/shadow Monitor for files being accessed that may attempt to dump the contents of /etc/passwd and /etc/shadow to enable offline password cracking. The AuditD monitoring tool, which ships stock in many Linux distributions, can be used to watch for hostile processes attempting to access /etc/passwd and /etc/shadow, alerting on the pid, process name, and arguments of such programs. Enterprise T1018 Remote System Discovery Monitor for files (such as /etc/hosts) being accessed that may attempt to get a listing of other systems by IP address, hostname, or other logical identifier on a network that may be used for Lateral Movement from the current system. For Windows, Event ID 4663 (An Attempt Was Made to Access An Object) can be used to alert on access attempts of local files that store host data, including C:\\Windows\\System32\\Drivers\\etc\\hosts. For Linux, auditing frameworks such as the audit daemon (auditd) can be used to alert on access attempts of local files that store host data, including /etc/hosts. ICS T0846 Remote System Discovery Monitor for files (such as /etc/hosts) being accessed that may attempt to get a listing of other systems by IP address, hostname, or other logical identifier on a network that may be used for Lateral Movement from the current system. ICS T0888 Remote System Information Discovery Monitor for files (such as /etc/hosts) being accessed that may attempt to get a listing of other systems by IP address, hostname, or other logical identifier on a network that may be used for Lateral Movement from the current system. Enterprise T1091 Replication Through Removable Media Monitor for unexpected files accessed on removable media. ICS T0847 Replication Through Removable Media Monitor for files accessed on removable media, particularly those with executable content. Enterprise T1649 Steal or Forge Authentication Certificates Monitor for attempts to access files that store information about certificates and their associated private keys. For example, personal certificates for users may be stored on disk in folders such as %APPDATA%\\Microsoft\\SystemCertificates\\My\\Certificates\\.[5][6] Enterprise T1558 Steal or Forge Kerberos Tickets Monitor for unexpected processes interacting with lsass.exe.[7] Common credential dumpers such as Mimikatz access the LSA Subsystem Service (LSASS) process by opening the process, locating the LSA secrets key, and decrypting the sections in memory where credential details, including Kerberos tickets, are stored. Monitor for unusual processes accessing secrets.ldb and .secrets.mkey located in /var/lib/sss/secrets/. Enterprise T1539 Steal Web Session Cookie Monitor for an attempt by a user to gain access to a network or computing resource, often by providing credentials to cloud service management consoles. Some cloud providers, such as AWS, provide distinct log events for login attempts to the management console. Enterprise T1033 System Owner/User Discovery Monitor for hash dumpers opening the Security Accounts Manager (SAM) on the local file system (%SystemRoot%/system32/config/SAM). Some hash dumpers will open the local file system as a device and parse to the SAM table to avoid file access defenses. Others will make an in-memory copy of the SAM table before reading hashes. Detection of compromised Valid Accounts in-use by adversaries may help as well. Enterprise T1552 Unsecured Credentials Monitor for suspicious file access activity, specifically indications that a process is reading multiple files in a short amount of time and/or using command-line arguments indicative of searching for credential material (ex: regex patterns). These may be indicators of automated/scripted credential access behavior. Monitoring when the user's .bash_history is read can help alert to suspicious activity. While users do typically rely on their history of commands, they often access this history through other utilities like \"history\" instead of commands like cat ~/.bash_history. .001 Credentials In Files Monitor for files being accessed that may search local file systems and remote file shares for files containing insecurely stored credentials. While detecting adversaries accessing these files may be difficult without knowing they exist in the first place, it may be possible to detect adversary use of credentials they have obtained. .003 Bash History Monitoring when the user's .bash_history is read can help alert to suspicious activity. .004 Private Keys Monitor access to files and directories related to cryptographic keys and certificates as a means for potentially detecting access patterns that may indicate collection and exfiltration activity. .006 Group Policy Preferences Monitor for attempts to access SYSVOL that involve searching for XML files. ICS T0863 User Execution Anti-virus can potentially detect malicious documents and files that are downloaded and executed on the user's computer. Endpoint sensing or network sensing can potentially detect malicious events once the file is opened (such as a Microsoft Word document or PDF reaching out to the internet or spawning PowerShell). File: File Creation Initial construction of a new file (ex: Sysmon EID 11) File: File Creation Initial construction of a new file (ex: Sysmon EID 11) Domain ID Name Detects Enterprise T1560 Archive Collected Data Monitor newly constructed files being written with extensions and/or headers associated with compressed or encrypted file types. Detection efforts may focus on follow-on exfiltration activity, where compressed or encrypted files can be detected in transit with a network intrusion detection or data loss prevention system analyzing file headers. .001 Archive via Utility Monitor newly constructed files being written with extensions and/or headers associated with compressed or encrypted file types. Detection efforts may focus on follow-on exfiltration activity, where compressed or encrypted files can be detected in transit with a network intrusion detection or data loss prevention system analyzing file headers. .002 Archive via Library Monitor newly constructed files being written with extensions and/or headers associated with compressed or encrypted file types. Detection efforts may focus on follow-on exfiltration activity, where compressed or encrypted files can be detected in transit with a network intrusion detection or data loss prevention system analyzing file headers. .003 Archive via Custom Method Monitor newly constructed files being written with extensions and/or headers associated with compressed or encrypted file types. Detection efforts may focus on follow-on exfiltration activity, where compressed or encrypted files can be detected in transit with a network intrusion detection or data loss prevention system analyzing file headers. Enterprise T1547 Boot or Logon Autostart Execution Monitor for newly constructed files that may configure system settings to automatically execute a program during system boot or logon to maintain persistence or gain higher-level privileges on compromised systems. .006 Kernel Modules and Extensions Monitor for newly constructed files that may modify the kernel to automatically execute programs on system boot. .008 LSASS Driver Monitor newly constructed files that may modify or add LSASS drivers to obtain persistence on compromised systems. .009 Shortcut Modification Monitor for LNK files created with a Zone Identifier value greater than 1, which may indicate that the LNK file originated from outside of the network.[8] Analysis should attempt to relate shortcut creation events to other potentially suspicious events based on known adversary behavior such as process launches of unknown executables that make network connections. .010 Port Monitors Monitor newly constructed files that may use port monitors to run an attacker supplied DLL during system boot for persistence or privilege escalation. .012 Print Processors Monitor for newly constructed files that may abuse print processors to run malicious DLLs during system boot for persistence and/or privilege escalation. .013 XDG Autostart Entries Malicious XDG autostart entries may be detected by auditing file creation events within the /etc/xdg/autostart and ~/.config/autostart directories. Depending on individual configurations, defenders may need to query the environment variables $XDG_CONFIG_HOME or $XDG_CONFIG_DIRS to determine the paths of Autostart entries. Autostart entry files not associated with legitimate packages may be considered suspicious. Suspicious entries can also be identified by comparing entries to a trusted system baseline. .015 Login Items All login items created via shared file lists are viewable by using the System Preferences GUI or in the ~/Library/Application Support/com.apple.backgroundtaskmanagementagent/backgrounditems.btm file.[9][10][11][12] These locations should be monitored and audited. Enterprise T1037 Boot or Logon Initialization Scripts Monitor for newly constructed files that may use scripts automatically executed at boot or logon initialization to establish persistence. .002 Login Hook Monitor for the creation of and/or changes to login hook files (/Library/Preferences/com.apple.loginwindow.plist), especially by unusual accounts outside of normal administration duties. .003 Network Logon Script Monitor for newly constructed files by unusual accounts outside of normal administration duties .004 RC Scripts Monitor for newly constructed /etc/rc.local file .005 Startup Items Monitor for newly constructed files by unusual accounts outside of normal administration duties Enterprise T1176 Browser Extensions Monitor for newly constructed files and/or all installed extensions maintain a plist file in the /Library/Managed Preferences/username/ directory. Ensure all listed files are in alignment with approved extensions Enterprise T1554 Compromise Client Software Binary Monitor for newly constructed files that may modify client software binaries to establish persistent access to systems. Enterprise T1659 Content Injection Monitor for unexpected and abnormal file creations that may indicate malicious content injected through online network communications. Enterprise T1543 Create or Modify System Process Monitor for newly constructed files that may create or modify system-level processes to repeatedly execute malicious payloads as part of persistence. .001 Launch Agent Monitor for newly constructed files that may create or modify launch agents to repeatedly execute malicious payloads as part of persistence. .002 Systemd Service Systemd service unit files may be detected by auditing file creation and modification events within the /etc/systemd/system, /usr/lib/systemd/system/, and /home//.config/systemd/user/ directories, as well as associated symbolic links .004 Launch Daemon Monitor for new files added to the /Library/LaunchDaemons/ folder. The System LaunchDaemons are protected by SIP. Enterprise T1486 Data Encrypted for Impact Monitor for newly constructed files in user directories. Enterprise T1565 Data Manipulation Monitor for newly constructed files in order to manipulate external outcomes or hide activity .001 Stored Data Manipulation Monitor for newly constructed files in order to manipulate external outcomes or hide activity .003 Runtime Data Manipulation Monitor for newly constructed files in order to manipulate external outcomes or hide activity Enterprise T1074 Data Staged Monitor publicly writeable directories, central locations, and commonly used staging directories (recycle bin, temp folders, etc.) to regularly check for compressed or encrypted data that may be indicative of staging. .001 Local Data Staging Monitor publicly writeable directories, central locations, and commonly used staging directories (recycle bin, temp folders, etc.) to regularly check for compressed or encrypted data that may be indicative of staging. .002 Remote Data Staging Monitor publicly writeable directories, central locations, and commonly used staging directories (recycle bin, temp folders, etc.) to regularly check for compressed or encrypted data that may be indicative of staging. Enterprise T1491 Defacement Monitor for newly constructed visual content for internal or external enterprise networks. .001 Internal Defacement Monitor for newly constructed files that may deface systems internal to an organization in an attempt to intimidate or mislead users. .002 External Defacement Monitor for newly constructed files that may deface systems external to an organization in an attempt to deliver messaging, intimidate, or otherwise mislead an organization or users. Enterprise T1006 Direct Volume Access Monitor for the creation of volume shadow copy and backup files, especially unexpected and irregular activity (relative to time, user, etc.). Enterprise T1189 Drive-by Compromise Monitor for newly constructed files written to disk to gain access to a system through a user visiting a website over the normal course of browsing. ICS T0817 Drive-by Compromise Monitor for newly constructed files written to disk through a user visiting a website over the normal course of browsing. Enterprise T1546 Event Triggered Execution Monitor newly constructed files that may establish persistence and/or elevate privileges using system mechanisms that trigger execution based on specific events. .002 Screensaver Monitor newly constructed files that may establish persistence by executing malicious content triggered by user inactivity. Analytic 1 - Created on disk that are being used as Screensaver files screensaver_key_modification = filter ProcessGuid, ProcessFilePath, UserName, RegistryKeyPath, RegistryKeyValueData where event_id == \"13\" AND RegistryKeyPath LIKE '%Software\\Policies\\Microsoft\\Windows\\Control Panel\\Desktop\\SCRNSAVE.EXE%' new_files = filter ProcessFilePath, UserName, FileName where event_id == \"11\" suspicious_files = filter k.ProcessGuid, k.ProcessFilePath, k.UserName, k.RegistryKeypath, k.RegistryKeyValueData FROM screensaver_key_modification kINNER JOIN new_files fON k.RegistryKeyValueData = f.FileName .004 Unix Shell Configuration Modification Monitor for newly constructed files that may establish persistence through executing malicious commands triggered by a user\u2019s shell. For most Linux and macOS systems, a list of file paths for valid shell options available on a system are located in the /etc/shells file. .005 Trap Monitor for newly constructed files that may establish persistence by executing malicious content triggered by an interrupt signal. .008 Accessibility Features Monitor newly constructed files that may establish persistence and/or elevate privileges by executing malicious content triggered by accessibility features. .013 PowerShell Profile Locations where profile.ps1 can be stored should be monitored for new profiles. [13] Example profile locations include:* $PsHome\\Profile.ps1* $PsHome\\Microsoft.{HostProgram}_profile.ps1* $Home\\My Documents\\PowerShell\\Profile.ps1* $Home\\My Documents\\PowerShell\\Microsoft.{HostProgram}_profile.ps1 .014 Emond Monitor emond rules creation by checking for files created in /etc/emond.d/rules/ and /private/var/db/emondClients. .016 Installer Packages Monitor creation of files associated with installer packages that may be abused for malicious execution. Enterprise T1187 Forced Authentication Monitor for newly constructed .LNK, .SCF, or any other files on systems and within virtual environments that contain resources that point to external network resources Enterprise T1564 Hide Artifacts Monitor for newly constructed files that may attempt to hide artifacts associated with their behaviors to evade detection. .001 Hidden Files and Directories Monitor the file system and shell commands for files being created with a leading \".\" .006 Run Virtual Instance Monitor for newly constructed files associated with running a virtual instance, such as binary files associated with common virtualization technologies (ex: VirtualBox, VMware, QEMU, Hyper-V). .009 Resource Forking Monitor for newly constructed files that may abuse resource forks to hide malicious code or executables to evade detection and bypass security applications. Enterprise T1574 Hijack Execution Flow Monitor for newly constructed files that may execute their own malicious payloads by hijacking the way operating systems run programs. .001 DLL Search Order Hijacking Monitor newly constructed .manifest and .local redirection files that do not correlate with software updates. .002 DLL Side-Loading Monitor for newly constructed files in common folders on the computer system. .004 Dylib Hijacking Monitor for newly constructed dylibs .005 Executable Installer File Permissions Weakness Monitor for newly constructed files to match an existing service executable, it could be detected and correlated with other suspicious behavior. .006 Dynamic Linker Hijacking Monitor for newly constructed files that are added to absolute paths of shared libraries such as LD_PRELOAD on Linux and DYLD_INSERT_LIBRARIES on macOS. .007 Path Interception by PATH Environment Variable Monitor for newly constructed files for files named after partial directories and in locations that may be searched for common processes through the environment variable, or otherwise should not be user writable. Also, monitor file creation for programs that are named after Windows system programs or programs commonly executed without a path (such as \"findstr,\" \"net,\" and \"python\"). If this activity occurs outside of known administration activity, upgrades, installations, or patches, then it may be suspicious. .008 Path Interception by Search Order Hijacking Monitor file creation for files named after partial directories and in locations that may be searched for common processes through the environment variable, or otherwise should not be user writable. Also, monitor file creation for programs that are named after Windows system programs or programs commonly executed without a path (such as \"findstr,\" \"net,\" and \"python\"). If this activity occurs outside of known administration activity, upgrades, installations, or patches, then it may be suspicious. .009 Path Interception by Unquoted Path Monitor file creation for files named after partial directories and in locations that may be searched for common processes through the environment variable, or otherwise should not be user writable. Also, monitor file creation for programs that are named after Windows system programs or programs commonly executed without a path (such as \"findstr,\" \"net,\" and \"python\"). If this activity occurs outside of known administration activity, upgrades, installations, or patches, then it may be suspicious. .010 Services File Permissions Weakness Monitor for creation of binaries and service executables that do not occur during a regular software update or an update scheduled by the organization. This behavior also considers files that are overwritten. Enterprise T1105 Ingress Tool Transfer Monitor for file creation and files transferred into the network Enterprise T1570 Lateral Tool Transfer Monitor newly constructed files to/from a lateral tool transfer ICS T0867 Lateral Tool Transfer Monitor for file creation in conjunction with other techniques (e.g., file transfers using Remote Services). Enterprise T1036 .007 Masquerading: Double File Extension Monitor for files written to disk that contain two file extensions, particularly when the second is an executable. Enterprise T1556 Modify Authentication Process Monitor for suspicious additions to the /Library/Security/SecurityAgentPlugins directory.[14] Monitor for newly created files that may be used to register malicious network provider dynamic link libraries (DLLs). .002 Password Filter DLL Monitor for newly constructed files that may register malicious password filter dynamic link libraries (DLLs) into the authentication process to acquire user credentials as they are validated. .008 Network Provider DLL Monitor for newly created files that may be used to register malicious network provider dynamic link libraries (DLLs). Enterprise T1027 Obfuscated Files or Information Detection of file obfuscation is difficult unless artifacts are left behind by the obfuscation process that are uniquely detectable with a signature. If detection of the obfuscation itself is not possible, it may be possible to detect the malicious activity that caused the obfuscated file (for example, the method that was used to write, read, or modify the file on the file system). .004 Compile After Delivery Monitor for newly constructed files for payloads .006 HTML Smuggling Monitor for newly constructed files via JavaScript, developing rules for the different variants, with a combination of different encoding and/or encryption schemes, may be very challenging. Consider monitoring files downloaded from the Internet, possibly by HTML Smuggling, for suspicious activities. Data and events should not be viewed in isolation, but as part of a chain of behavior that could lead to other activities. .009 Embedded Payloads Monitor for newly constructed files containing large amounts of data. Abnormal file sizes may be an indicator of embedded content. .012 LNK Icon Smuggling Monitor for downloaded malicious files, though developing rules for the different variants, with a combination of different encoding and/or encryption schemes, may be very challenging. Consider monitoring files downloaded from the Internet, possibly by LNK Icon Smuggling, for suspicious activities. Data and events should not be viewed in isolation, but as part of a chain of behavior that could lead to other activities. Enterprise T1137 Office Application Startup Monitor for newly constructed files that may leverage Microsoft Office-based applications for persistence between startups. .001 Office Template Macros Monitor for newly constructed files that may abuse Microsoft Office templates to obtain persistence on a compromised system. .002 Office Test Monitor for newly constructed files that may abuse the Microsoft Office \"Office Test\" Registry key to obtain persistence on a compromised system. .006 Add-ins Monitor for newly constructed files that may abuse Microsoft Office add-ins to obtain persistence on a compromised system. Enterprise T1003 .002 OS Credential Dumping: Security Account Manager Monitor newly constructed files being written with default names that have extracted credentials from the Security Account Manager. Enterprise T1566 Phishing Monitor for newly constructed files from a phishing messages to gain access to victim systems. .001 Spearphishing Attachment Monitor for newly constructed files from a spearphishing emails with a malicious attachment in an attempt to gain access to victim systems. Enterprise T1091 Replication Through Removable Media Monitor for newly constructed files on removable media ICS T0847 Replication Through Removable Media Monitor for newly constructed files copied to or from removable media. Enterprise T1496 Resource Hijacking Monitor for common cryptomining or proxyware files on local systems that may indicate compromise and resource usage. Enterprise T1053 Scheduled Task/Job Monitor newly constructed files that may abuse task scheduling functionality to facilitate initial or recurring execution of malicious code. .005 Scheduled Task Monitor Windows Task Scheduler stores in %systemroot%\\System32\\Tasks for change entries related to scheduled tasks that do not correlate with known software, patch cycles, etc. In order to gain persistence, privilege escalation, or remote execution, an adversary may use the Windows Task Scheduler to schedule a command to be run at a specified time, date, and even host. Task Scheduler stores tasks as files in two locations - C:\\Windows\\Tasks (legacy) or C:\\Windows\\System32\\Tasks. Accordingly, this analytic looks for the creation of task files in these two locations. Analytic 1 - Scheduled Task - File Creation task_files = filter files where ( (file_path = \"C:\\Windows\\System32\\Tasks*\" or file_path = \"C:\\Windows\\Tasks*\") and image_path != \"C:\\WINDOWS\\system32\\svchost.exe\") .007 Container Orchestration Job Monitor for newly constructed files by using the logging agents on Kubernetes nodes and retrieve logs from sidecar proxies for application and resource pods to monitor malicious container orchestration job deployments. Enterprise T1505 Server Software Component Consider monitoring file locations associated with the installation of new application software components such as paths from which applications typically load such extensible components. .002 Transport Agent Consider monitoring file locations associated with the installation of new application software components such as paths from which applications typically load such extensible components. .003 Web Shell File monitoring may be used to detect changes to files in the Web directory of a Web server that do not match with updates to the Web server's content and may indicate implantation of a Web shell script.[15] .004 IIS Components Monitor for creation of files (especially DLLs on webservers) that could be abused as malicious ISAPI extensions/filters or IIS modules. ICS T0865 Spearphishing Attachment Monitor for newly constructed files from a spearphishing emails with a malicious attachment in an attempt to gain access to victim systems. Enterprise T1553 .005 Subvert Trust Controls: Mark-of-the-Web Bypass Monitor compressed/archive and image files downloaded from the Internet as the contents may not be tagged with the MOTW. Data and events should not be viewed in isolation, but as part of a chain of behavior that could lead to other activities. Enterprise T1218 System Binary Proxy Execution Monitor for file activity (creations, downloads, modifications, etc.), especially for file types that are not typical within an environment and may be indicative of adversary activity. .001 Compiled HTML File Monitor presence and use of CHM files, especially if they are not typically used within an environment. .002 Control Panel Monitor for newly constructed files that may forge web cookies that can be used to gain access to web applications or Internet services. .005 Mshta Monitor use of HTA files. If they are not typically used within an environment then execution of them may be suspicious .014 MMC Monitor for creation and use of .msc files. MMC may legitimately be used to call Microsoft-created .msc files, such as services.msc or eventvwr.msc. Invoking non-Microsoft .msc files may be an indicator of malicious activity. Enterprise T1080 Taint Shared Content Monitor for newly constructed files from files that write or overwrite many files to a network shared directory may be suspicious. Enterprise T1204 User Execution Anti-virus can potentially detect malicious documents and files that are downloaded and executed on the user's computer. Endpoint sensing or network sensing can potentially detect malicious events once the file is opened (such as a Microsoft Word document or PDF reaching out to the internet or spawning powershell.exe). .001 Malicious Link malicious documents and files that are downloaded from a link and executed on the user's computer .002 Malicious File Monitor for newly constructed files that are downloaded and executed on the user's computer. Endpoint sensing or network sensing can potentially detect malicious events once the file is opened (such as a Microsoft Word document or PDF reaching out to the internet or spawning powershell.exe). While batch files are not inherently malicious, it is uncommon to see them created after OS installation, especially in the Windows directory. This analytic looks for the suspicious activity of a batch file being created within the C:\\Windows\\System32 directory tree. There will be only occasional false positives due to administrator actions. For Windows, Sysmon Event ID 11 (File create) can be used to track file creation events. This event also provides the Process ID of the process that created the file, which can be correlated with process creation events (e.g., Sysmon Event ID 1) to determine if the file was downloaded from an external network. For MacOS, utilities that work in concert with Apple\u2019s Endpoint Security Framework such as File Monitor can be used to track file creation events. Analytic 1 : Batch File Write to System32 batch_files = filter files where ( extension =\".bat\" AND file_path = \"C:\\Windows\\system32*\" ) File: File Deletion Removal of a file (ex: Sysmon EID 23, macOS ESF EID ES_EVENT_TYPE_AUTH_UNLINK, or Linux commands auditd unlink, rename, rmdir, unlinked, or renameat rules) File: File Deletion Removal of a file (ex: Sysmon EID 23, macOS ESF EID ES_EVENT_TYPE_AUTH_UNLINK, or Linux commands auditd unlink, rename, rmdir, unlinked, or renameat rules) Domain ID Name Detects Enterprise T1554 Compromise Client Software Binary Monitor for unexpected deletion of client software binaries to establish persistent access to systems. Enterprise T1485 Data Destruction Monitor for unexpected deletion to a file (ex: Sysmon EID 23) ICS T0809 Data Destruction Monitor for unexpected deletion of files. Enterprise T1565 Data Manipulation Monitor for unexpected deletion of a file in order to manipulate external outcomes or hide activity .001 Stored Data Manipulation Monitor for unexpected deletion of a file in order to manipulate external outcomes or hide activity .003 Runtime Data Manipulation Monitor for unexpected deletion of a file in order to manipulate external outcomes or hide activity Enterprise T1562 Impair Defenses Monitor for missing log files hosts and services with known active periods. .012 Disable or Modify Linux Audit System Monitor for missing log files from machines with known active periods. Enterprise T1070 Indicator Removal Monitor for a file that may delete or alter generated artifacts on a host system, including logs or captured files such as quarantined malware. .001 Clear Windows Event Logs Monitor for unexpected deletion of Windows event logs (via native binaries) and may also generate an alterable event (Event ID 1102: \"The audit log was cleared\"). When an eventlog is cleared, a new event is created that alerts that the eventlog was cleared. For Security logs, its event code 1100 and 1102. For System logs, it is event code 104. It is unlikely that event log data would be cleared during normal operations, and it is likely that malicious attackers may try to cover their tracks by clearing an event log. When an event log gets cleared, it is suspicious. This is often done using wevtutil, a legitimate tool provided by Microsoft. This action interferes with event collection and notification, and may lead to a security event going undetected, thereby potentially leading to further compromise of the network. Alerting when a Clear Event Log is generated could point to this intruder technique. Centrally collecting events has the added benefit of making it much harder for attackers to cover their tracks. Event Forwarding permits sources to forward multiple copies of a collected event to multiple collectors, thus enabling redundant event collection. Using a redundant event collection model can minimize the single point of failure risk. Attackers may set the option of the sources of events with Limit-EventLog -LogName Security -OverflowAction DoNotOverwrite to not delete old Evenlog when the .evtx is full. By default the Security Log size is configured with the minimum value of 20 480KB (~23 000 EventLog). So if this option is enabled, all the new EventLogs will be automatically deleted. We can detect this behavior with the Security EventLog 1104. Attackers may delete .evtx with del C:\\Windows\\System32\\winevt\\logs\\Security.evtx or Remove-Item C:\\Windows\\System32\\winevt\\logs\\Security.evtx after having disabled and stopped the Eventlog service. As the EventLog service is disabled and stopped, the .evtx files are no longer used by this service and can be deleted. The new EventLog will be Unavailable until the configuration is reset. Attackers may use the powershell command Remove-EventLog -LogName Security to unregister source of events that are part of Windows (Application, Security\u2026). This command deletes the security EventLog (which also generates EventId 1102) but the new Eventlogs are still recorded until the system is rebooted . After the System is rebooted, the Security log is unregistered and doesn\u2019t log any new Eventlog. However logs generated between the command and the reboot are still available in the .evtx file. Analytic 1 - User Activity from Clearing Event Logs cleared_logs = filter log_files where ((log_name = \"Security\") AND (event_id = \"1100\" OR event_id =\"1102\" OR event_id = \"1104\")) OR (log_name = \"System\" AND event_code = \"104\") .002 Clear Linux or Mac System Logs Monitor for unexpected deletion of a system log file, typically stored in /var/logs or /Library/Logs. .003 Clear Command History Monitor for unexpected deletion of a command history file, such as ConsoleHost_history.txt, ~/.zsh_history, or ~/.bash_history. Analytic 1 : Deletion of command history files suspicious_files = filter ProcessGuid, ProcessFilePath, UserName, FilePath where (event_id == \"23\" AND FilePath LIKE '%ConsoleHost_history.txt%') OR (event_id == \"4663\" AND FilePath LIKE '%ConsoleHost_history.txt%' AND ObjectType == \"File\" AND (UserAccessList LIKE '%1537%' OR UserAccessList LIKE '%DELETE%')) .004 File Deletion Monitor for unexpected deletion of files from the system .008 Clear Mailbox Data Monitor for deletion of generated artifacts on a host system, including logs or captured files such as quarantined emails. On Windows 10, mail application data is stored in C:\\Users\\Username\\AppData\\Local\\Comms\\Unistore\\data. On Linux, mail data is stored in /var/spool/mail or /var/mail. On macOS, mail data is stored in ~/Library/Mail. .009 Clear Persistence Monitor for a file that may delete or alter generated artifacts associated with persistence on a host system. ICS T0872 Indicator Removal on Host Monitor for a file that may delete or alter generated artifacts on a host system, including logs or captured files such as quarantined malware. Enterprise T1490 Inhibit System Recovery The Windows event logs, ex. Event ID 524 indicating a system catalog was deleted, may contain entries associated with suspicious activity. File: File Metadata Contextual data about a file, which may include information such as name, the content (ex: signature, headers, or data/media), user/owner, permissions, etc. File: File Metadata Contextual data about a file, which may include information such as name, the content (ex: signature, headers, or data/media), user/owner, permissions, etc. Domain ID Name Detects Enterprise T1548 Abuse Elevation Control Mechanism Monitor the file system for files that have the setuid or setgid bits set. On Linux, auditd can alert every time a user's actual ID and effective ID are different (this is what happens when you sudo). .001 Setuid and Setgid Monitor the file system for files that have the setuid or setgid bits set. Enterprise T1554 Compromise Client Software Binary Collect and analyze signing certificate metadata and check signature validity on software that executes within the environment Enterprise T1543 .003 Create or Modify System Process: Windows Service Adversaries may modify the binary file for an existing service to achieve Persistence while potentially Defense Evasion. If a newly created or modified runs as a service, it may indicate APT activity. However, services are frequently installed by legitimate software. A well-tuned baseline is essential to differentiating between benign and malicious service modifications. Look for events where a file was created and then later run as a service. In these cases, a new service has been created or the binary has been modified. Many programs, such as msiexec.exe, do these behaviors legitimately and can be used to help validate legitimate service creations/modifications. Analytic 1 - Service Binary Modifications legitimate_installers = [\"C:\\windows\\system32\\msiexec.exe\", \"C:\\windows\\syswow64\\msiexec.exe\", ...] file_change = search File:Create,Modifyprocess = search Process:Createservice_process = filter processes where (parent_exe == \"services.exe\")modified_service = join (search, filter) where ( file_change.time < service_process.time and file_change.file_path == service_process.image_path) modified_service = filter modified_service where (modified_service.file_change.image_path not in legitimate_installers)output modified_service Enterprise T1565 Data Manipulation Monitor for contextual data about a file, which may include information such as name, the content (ex: signature, headers, or data/media), user/owner, permissions, etc that would aid in the manipulation of data to hide activity .003 Runtime Data Manipulation Monitor for contextual data about a file, which may include information such as name, the content (ex: signature, headers, or data/media), user/owner, permissions, etc that would aid in the manipulation of data to hide activity Enterprise T1546 Event Triggered Execution Monitor for contextual data about a file, which may include information such as name, the content (ex: signature, headers, or data/media), user/owner, permissions, etc. .006 LC_LOAD_DYLIB Addition Changes to binaries that do not line up with application updates or patches are also extremely suspicious. Enterprise T1222 File and Directory Permissions Modification Monitor and investigate attempts to modify ACLs and file/directory ownership. .001 Windows File and Directory Permissions Modification Consider enabling file/directory permission change auditing on folders containing key binary/configuration files. For example, Windows Security Log events (Event ID 4670) are created when DACLs are modified. Adversaries sometimes modify object access rights at the operating system level. There are varying motivations behind this action - they may not want some files/objects to be changed on systems for persistence reasons and therefore provide admin only rights; also, they may want files to be accessible with lower levels of permissions. Windows environment logs can be noisy, so we take the following into consideration: We need to exclude events generated by the local system (subject security ID \"NT AUTHORITY\\SYSTEM\") and focus on actual user events. When a permission modification is made for a folder, a new event log is generated for each subfolder and file under that folder. It is advised to group logs based on handle ID or user ID. The Windows security log (event ID 4670) also includes information about the process that modifies the file permissions. It is advised to focus on uncommon process names, and it is also uncommon for real-users to perform this task without a GUI. Pseudocode Event ID is for Windows Security Log (Event ID 4670 - Permissions on an object were changed). Windows Event ID 4719 (An Attempt Was Made to Access An Object) can also be used to alert on changes to Active Directory audit policy for a system. Linux environment logs can be more noisy than the Windows-specific implementation, although Linux does not generate logs for system triggered activities like in Windows. In addition, it may be necessary to whitelist cron jobs that regularly run and execute chmod. Analytic 1 : Access Permission Modification for Windows file_dacl_events = filter log_events where (event_id == \"4670\" ANDobject_type == \"File\" ANDsubject_security_id != \"NT AUTHORITY\\SYSTEM\") Analytic 2 - Access Permission Modification for Linux chmod_processes = filter processes where command_line == \"chmod *\" .002 Linux and Mac File and Directory Permissions Modification Monitor and investigate attempts to modify ACLs and file/directory ownership. Consider enabling file/directory permission change auditing on folders containing key binary/configuration files. Adversaries sometimes modify object access rights at the operating system level. There are varying motivations behind this action - they may not want some files/objects to be changed on systems for persistence reasons and therefore provide admin only rights; also, they may want files to be accessible with lower levels of permissions. Windows environment logs can be noisy, so we take the following into consideration: We need to exclude events generated by the local system (subject security ID \"NT AUTHORITY\\SYSTEM\") and focus on actual user events. When a permission modification is made for a folder, a new event log is generated for each subfolder and file under that folder. It is advised to group logs based on handle ID or user ID. The Windows security log (event ID 4670) also includes information about the process that modifies the file permissions. It is advised to focus on uncommon process names, and it is also uncommon for real-users to perform this task without a GUI. Pseudocode Event ID is for Windows Security Log (Event ID 4670 - Permissions on an object were changed). Windows Event ID 4719 (An Attempt Was Made to Access An Object) can also be used to alert on changes to Active Directory audit policy for a system. Linux environment logs can be more noisy than the Windows-specific implementation, although Linux does not generate logs for system triggered activities like in Windows. In addition, it may be necessary to whitelist cron jobs that regularly run and execute chmod. Analytic 1 : Access Permission Modification for Windows file_dacl_events = filter log_events where (event_id == \"4670\" ANDobject_type == \"File\" ANDsubject_security_id != \"NT AUTHORITY\\SYSTEM\") Analytic 2 - Access Permission Modification for Linux chmod_processes = filter processes where command_line == \"chmod *\" Enterprise T1564 Hide Artifacts Monitor for contextual data about a file, which may include information such as name, the content (ex: signature, headers, or data/media), user/owner, permissions that may attempt to hide artifacts associated with their behaviors to evade detection. .001 Hidden Files and Directories Monitor for contextual data about a file, which may include information such as name, the content (ex: signature, headers, or data/media), user/owner, permissions may set files and directories to be hidden to evade detection mechanisms. .004 NTFS File Attributes Monitor for contextual data about a file, which may include information such as name, the content (ex: signature, headers, or data/media), user/owner, permissions, may use NTFS file attributes to hide their malicious data in order to evade detection. Forensic techniques exist to identify information stored in NTFS EA. [16] .007 VBA Stomping If the document is opened with a Graphical User Interface (GUI) the malicious p-code is decompiled and may be viewed. However, if the PROJECT stream, which specifies the project properties, is modified in a specific way the decompiled VBA code will not be displayed. For example, adding a module name that is undefined to the PROJECT stream will inhibit attempts of reading the VBA source code through the GUI.[17] .009 Resource Forking Identify files with the com.apple.ResourceFork extended attribute and large data amounts stored in resource forks. Enterprise T1070 Indicator Removal Monitor for contextual file data that may show signs of deletion or alter generated artifacts on a host system, including logs or captured files such as quarantined malware. .006 Timestomp Monitor for file modifications that collects information on file handle opens and can compare timestamp values ICS T0872 Indicator Removal on Host Monitor for contextual file data that may show signs of deletion or alter generated artifacts on a host system, including logs or captured files such as quarantined malware. Enterprise T1570 Lateral Tool Transfer Monitor for alike file hashes or characteristics (ex: filename) that are created on multiple hosts. ICS T0867 Lateral Tool Transfer Monitor for alike file hashes or characteristics (ex: filename) that are created on multiple hosts. Enterprise T1036 Masquerading Collect file hashes; file names that do not match their expected hash are suspect. Perform file monitoring; files with known names but in unusual locations are suspect. Look for indications of common characters that may indicate an attempt to trick users into misidentifying the file type, such as a space as the last character of a file name or the right-to-left override characters\"\\u202E\", \"[U+202E]\", and \"%E2%80%AE\". Check and ensure that file headers/signature and extensions match using magic bytes detection and/or file signature validation.[18] In Linux, the file command may be used to check the file signature.[19] .001 Invalid Code Signature Collect and analyze signing certificate metadata and check signature validity on software that executes within the environment, look for invalid signatures as well as unusual certificate characteristics and outliers. .002 Right-to-Left Override Monitor for common formats of RTLO characters within filenames such as \\u202E, [U+202E], and %E2%80%AE. Defenders should also check their analysis tools to ensure they do not interpret the RTLO character and instead print the true name of the file containing it. .003 Rename System Utilities Collecting and comparing disk and resource filenames for binaries by looking to see if the InternalName, OriginalFilename, and/or ProductName match what is expected could provide useful leads, but may not always be indicative of malicious activity. .005 Match Legitimate Name or Location Collect file hashes; file names that do not match their expected hash are suspect. Perform file monitoring; files with known names but in unusual locations are suspect. Likewise, files that are modified outside of an update or patch are suspect. .006 Space after Filename Monitor for spaces at the end of file names, that can easily be checked with file monitoring. From the user's perspective though, this is very hard to notice from within the Finder.app or on the command-line in Terminal.app. Processes executed from binaries containing non-standard extensions in the filename are suspicious. .007 Double File Extension Monitor for contextual data about a file, which may include information such as name, the content (ex: signature, headers, or data/media), user/owner, permissions, etc. ICS T0849 Masquerading Collect file hashes. Monitor for file names that do not match their expected hash. Perform file monitoring. Files with known names but in unusual locations are suspect. Look for indications of common characters that may indicate an attempt to trick users into misidentifying the file type, such as a space as the last character of a file name or the right-to-left override characters\"\\u202E\", \"[U+202E]\", and \"%E2%80%AE\". For added context on adversary procedures and background see Masquerading and applicable sub-techniques. Enterprise T1027 Obfuscated Files or Information Monitor for contextual data about a file, which may include information such as name, the content (ex: signature, headers, or data/media), user/owner, permissions, etc. File-based signatures may be capable of detecting code obfuscation depending on the methods used.[20][21][22] .001 Binary Padding Depending on the method used to pad files, a file-based signature may be capable of detecting padding using a scanning or on-access based tool. When executed, the resulting process from padded files may also exhibit other behavior characteristics of being used to conduct an intrusion such as system and network information Discovery or Lateral Movement, which could be used as event indicators that point to the source file. .002 Software Packing Use file scanning to look for known software packers or artifacts of packing techniques. Packing is not a definitive indicator of malicious activity, because legitimate software may use packing techniques to reduce binary size or to protect proprietary code. .003 Steganography Detection of steganography is difficult unless artifacts are left behind by the obfuscation process that are detectable with a known signature. Look for strings or other signatures left in system artifacts related to decoding steganography. .004 Compile After Delivery Monitor for contextual data about a file, which may include information such as name, the content (ex: signature, headers, or data/media), user/owner, permissions, etc. .007 Dynamic API Resolution Depending on the method used to obfuscate API function calls, a file-based signature may be capable of detecting dynamical resolution.[20][21][22] .008 Stripped Payloads Detecting the presence of stripped payloads may be difficult and unwarranted in real-time, though analyzing contextual data about files (such as content and character entropy) may highlight attempts at obfuscation. .009 Embedded Payloads Monitor contextual data about a file that may highlight embedded payloads, which may include information such as name, the content (ex: signature, headers, or data/media), file size, etc.; correlate with other suspicious behavior to reduce false positives. .010 Command Obfuscation Scripts containing obfuscated content may have higher entropy of characters/strings. .012 LNK Icon Smuggling Monitor contextual data about a file that may highlight embedded malicious content, which may include information such as name, the content (ex: signature, headers, or data/media), file size, etc.; correlate with other suspicious behavior to reduce false positives. Enterprise T1055 Process Injection Monitor for contextual data about a file, which may include information such as name, the content (ex: signature, headers, or data/media), user/owner, permissions, etc. .013 Process Doppelg\u00e4nging Scan file objects reported during the PsSetCreateProcessNotifyRoutine, [23] which triggers a callback whenever a process is created or deleted, specifically looking for file objects with enabled write access. [24] Also consider comparing file objects loaded in memory to the corresponding file on disk. [25] Enterprise T1553 Subvert Trust Controls Collect and analyze signing certificate metadata on software that executes within the environment to look for unusual certificate characteristics and outliers. .001 Gatekeeper Bypass Review false values under the LSFileQuarantineEnabled entry in an application's Info.plist file (required by every application). false under LSFileQuarantineEnabled indicates that an application does not use the quarantine flag. Unsandboxed applications with an unspecified LSFileQuarantineEnabled entry will default to not setting the quarantine flag. QuarantineEvents is a SQLite database containing a list of all files assigned the com.apple.quarantine attribute, located at ~/Library/Preferences/com.apple.LaunchServices.QuarantineEventsV2. Each event contains the corresponding UUID, timestamp, application, Gatekeeper score, and decision if it was allowed. [26] .002 Code Signing Collect and analyze signing certificate metadata on software that executes within the environment to look for unusual certificate characteristics and outliers. .005 Mark-of-the-Web Bypass Monitor files (especially those downloaded from untrusted locations) for MOTW attributes. Also consider inspecting and scanning file formats commonly abused to bypass MOTW (ex: .arj, .gzip, .iso, .vhd). Enterprise T1195 Supply Chain Compromise Use verification of distributed binaries through hash checking or other integrity checking mechanisms. Scan downloads for malicious signatures and attempt to test software and updates prior to deployment while taking note of potential suspicious activity. .001 Compromise Software Dependencies and Development Tools Use verification of distributed binaries through hash checking or other integrity checking mechanisms. Scan downloads for malicious signatures and attempt to test software and updates prior to deployment while taking note of potential suspicious activity. .002 Compromise Software Supply Chain Use verification of distributed binaries through hash checking or other integrity checking mechanisms. Scan downloads for malicious signatures and attempt to test software and updates prior to deployment while taking note of potential suspicious activity. ICS T0862 Supply Chain Compromise Use verification of distributed binaries through hash checking or other integrity checking mechanisms. Scan downloads for malicious signatures. Enterprise T1218 .011 System Binary Proxy Execution: Rundll32 Analyze contextual data about executed DLL files, which may include information such as name, the content (ex: signature, headers, or data/media), age, user/owner, permissions, etc. File: File Modification Changes made to a file, or its access permissions and attributes, typically to alter the contents of the targeted file (ex: Windows EID 4670 or Sysmon EID 2) File: File Modification Changes made to a file, or its access permissions and attributes, typically to alter the contents of the targeted file (ex: Windows EID 4670 or Sysmon EID 2) Domain ID Name Detects Enterprise T1548 Abuse Elevation Control Mechanism On Linux, auditd can alert every time a user's actual ID and effective ID are different (this is what happens when you sudo). This technique is abusing normal functionality in macOS and Linux systems, but sudo has the ability to log all input and output based on the LOG_INPUT and LOG_OUTPUT directives in the /etc/sudoers file. Consider monitoring for /usr/libexec/security_authtrampoline executions which may indicate that AuthorizationExecuteWithPrivileges is being executed. MacOS system logs may also indicate when AuthorizationExecuteWithPrivileges is being called. .001 Setuid and Setgid Monitor for changes made to files that may perform shell escapes or exploit vulnerabilities in an application with the setsuid or setgid bits to get code running in a different user\u2019s context. .003 Sudo and Sudo Caching On Linux, auditd can alert every time a user's actual ID and effective ID are different (this is what happens when you sudo). This technique is abusing normal functionality in macOS and Linux systems, but sudo has the ability to log all input and output based on the LOG_INPUT and LOG_OUTPUT directives in the /etc/sudoers file. Enterprise T1098 Account Manipulation Monitor for changes made to files related to account settings, such as /etc/ssh/sshd_config and the authorized_keys file for each user on a system. .004 SSH Authorized Keys Monitor for changes made to detect changes made to the authorized_keys file for each user on a system. Monitor for changes to and suspicious processes modifiying /etc/ssh/sshd_config. Enterprise T1547 Boot or Logon Autostart Execution Monitor for changes made to files that may configure system settings to automatically execute a program during system boot or logon to maintain persistence or gain higher-level privileges on compromised systems. .001 Registry Run Keys / Startup Folder Monitor the start folder for additions or changes. Tools such as Sysinternals Autoruns may also be used to detect system changes that could be attempts at persistence, including the startup folders. [27] .006 Kernel Modules and Extensions Monitor for changes made to files that may modify the kernel to automatically execute programs on system boot. .007 Re-opened Applications Monitoring the specific plist files associated with reopening applications can indicate when an application has registered itself to be reopened. .008 LSASS Driver Monitor for changes made to files that may modify or add LSASS drivers to obtain persistence on compromised systems. .009 Shortcut Modification Since a shortcut's target path likely will not change, modifications to shortcut files that do not correlate with known software changes, patches, removal, etc., may be suspicious. Analysis should attempt to relate shortcut file change events to other potentially suspicious events based on known adversary behavior such as process launches of unknown executables that make network connections. .013 XDG Autostart Entries Malicious XDG autostart entries may be detected by auditing file modification events within the /etc/xdg/autostart and ~/.config/autostart directories. Depending on individual configurations, defenders may need to query the environment variables $XDG_CONFIG_HOME or $XDG_CONFIG_DIRS to determine the paths of Autostart entries. Autostart entry files not associated with legitimate packages may be considered suspicious. Suspicious entries can also be identified by comparing entries to a trusted system baseline. .015 Login Items All login items created via shared file lists are viewable by using the System Preferences GUI or in the ~/Library/Application Support/com.apple.backgroundtaskmanagementagent/backgrounditems.btm file.[9][10][11][12] These locations should be monitored and audited. Enterprise T1037 Boot or Logon Initialization Scripts Monitor for changes made to files that are modified by unusual accounts outside of normal administration duties. .002 Login Hook Monitor for changes to login hook files (/Library/Preferences/com.apple.loginwindow.plist), especially by unusual accounts outside of normal administration duties. .003 Network Logon Script Monitor for changes made to files for unexpected modifications to unusual accounts outside of normal administration duties .004 RC Scripts Monitor for changes made to files for unexpected modifications to RC scripts in the /etc/ directory .005 Startup Items Monitor for changes made to files for unexpected modifications to /Library/StartupItem folder Enterprise T1554 Compromise Client Software Binary Monitor changes to client software that do not correlate with known software or patch cycles. Enterprise T1543 Create or Modify System Process Monitor for changes to files associated with system-level processes. .001 Launch Agent Launch Agents also require files on disk for persistence which can also be monitored via other file monitoring applications. .002 Systemd Service Systemd service unit files may be detected by auditing file creation and modification events within the /etc/systemd/system, /usr/lib/systemd/system/, and /home//.config/systemd/user/ directories, as well as associated symbolic links .004 Launch Daemon Monitor files for changes that may create or modify Launch Daemons to execute malicious payloads as part of persistence. Enterprise T1485 Data Destruction Monitor for changes made to a large quantity of files for unexpected modifications in user directories and under C:\\Windows\\System32. ICS T0809 Data Destruction Monitor for changes made to a large quantity of files for unexpected modifications in both user directories and directories used to store programs and OS components (e.g., C:\\Windows\\System32). Enterprise T1486 Data Encrypted for Impact Monitor for changes made to files in user directories. Enterprise T1565 Data Manipulation Monitor for unexpected files with manipulated data in order to manipulate external outcomes or hide activity .001 Stored Data Manipulation Monitor for unexpected files with manipulated data in order to manipulate external outcomes or hide activity .003 Runtime Data Manipulation Monitor for unexpected files with manipulated data in order to manipulate external outcomes or hide activity Enterprise T1491 Defacement Monitor for changes made to files for unexpected modifications to internal and external websites for unplanned content changes. .001 Internal Defacement Monitor internal and websites for unplanned content changes. .002 External Defacement Monitor external websites for unplanned content changes. Enterprise T1140 Deobfuscate/Decode Files or Information Monitor for changes made to files for unexpected modifications that attempt to hide artifacts. On Windows, Event ID 4663 (Security Log - An attempt was made to access an object) can be used to alert on suspicious file accesses (e.g., attempting to write to a file which shouldn\u2019t be further modified) that may coincide with attempts to hide artifacts. Enterprise T1546 Event Triggered Execution Monitor for changes made to files that may establish persistence and/or elevate privileges using system mechanisms that trigger execution based on specific events. .002 Screensaver Monitor for changes made to files that may establish persistence by executing malicious content triggered by user inactivity. Note: Although there are no standard events for file modification, Windows Event ID 4663 (An Attempt Was Made to Access An Object) can be used to alert on attempted accesses of screensaver files (typically ending in a file extension of .scr). .004 Unix Shell Configuration Modification Monitor for changes to /etc/profile and /etc/profile.d, these files should only be modified by system administrators. MacOS users can leverage Endpoint Security Framework file events monitoring these specific files.[28] .005 Trap Monitor for changes made to files that may establish persistence by executing malicious content triggered by an interrupt signal. .006 LC_LOAD_DYLIB Addition Monitor file systems for changes to application binaries and invalid checksums/signatures. .008 Accessibility Features Monitor for changes made to files that may establish persistence and/or elevate privileges by executing malicious content triggered by accessibility features. Changes to accessibility utility binaries or binary paths that do not correlate with known software, patch cycles, etc., are suspicious. .011 Application Shimming Monitor for changes made to files that may establish persistence and/or elevate privileges by executing malicious content triggered by application shims. .013 PowerShell Profile Locations where profile.ps1 can be stored should be monitored for modifications. [13] Example profile locations include:* $PsHome\\Profile.ps1* $PsHome\\Microsoft.{HostProgram}_profile.ps1* $Home\\My Documents\\PowerShell\\Profile.ps1* $Home\\My Documents\\PowerShell\\Microsoft.{HostProgram}_profile.ps1 .014 Emond Monitor emond rules creation by checking for files modified in /etc/emond.d/rules/ and /private/var/db/emondClients. Enterprise T1187 Forced Authentication Monitor for changes made to the .LNK, .SCF, or any other files on systems and within virtual environments that contain resources that point to external network resources Enterprise T1564 Hide Artifacts Monitor for changes made to files that may attempt to hide artifacts associated with their behaviors to evade detection. .002 Hidden Users Monitor for changes made to files that may use hidden users to mask the presence of user accounts they create or modify. Monitor for changes made to the /Library/Preferences/com.apple.loginwindow plist file for unexpected modifications to the Hide500Users key value on macOS.[29] .003 Hidden Window Monitor for changes made to files that may use hidden windows to conceal malicious activity from the plain sight of users. In MacOS, plist files are ASCII text files with a specific format, so they're relatively easy to parse. File monitoring can check for the apple.awt.UIElement or any other suspicious plist tag in plist files and flag them. .004 NTFS File Attributes There are many ways to create and interact with ADSs using Windows utilities. Monitor for operations (execution, copies, etc.) with file names that contain colons. This syntax (ex: file.ext:ads[.ext]) is commonly associated with ADSs. [30] [31] [32] For a more exhaustive list of utilities that can be used to execute and create ADSs, see https://gist.github.com/api0cradle/cdd2d0d0ec9abb686f0e89306e277b8f. .005 Hidden File System Detecting the use of a hidden file system may be exceptionally difficult depending on the implementation. Emphasis may be placed on detecting related aspects of the adversary lifecycle, such as how malware interacts with the hidden file system or how a hidden file system is loaded. .008 Email Hiding Rules On MacOS systems, monitor for modifications to the RulesActiveState.plist, SyncedRules.plist, UnsyncedRules.plist, and MessageRules.plist files.[33] Enterprise T1574 Hijack Execution Flow Monitor file systems for moving, renaming, replacing, or modifying DLLs. Changes in the set of DLLs that are loaded by a process (compared with past behavior) that do not correlate with known software, patches, etc., are suspicious. Modifications to or creation of .manifest and .local redirection files that do not correlate with software updates are suspicious. .001 DLL Search Order Hijacking Monitor for changed made to .manifest/.local redirection files, or file systems for moving, renaming, replacing, or modifying DLLs. Changes in the set of DLLs that are loaded by a process (compared with past behavior) that do not correlate with known software, patches, etc., are suspicious. .002 DLL Side-Loading Monitor for changes made to files for unexpected modifications to access permissions and attributes .004 Dylib Hijacking Monitor file systems for moving, renaming, replacing, or modifying dylibs. Changes in the set of dylibs that are loaded by a process (compared to past behavior) that do not correlate with known software, patches, etc., are suspicious. Check the system for multiple dylibs with the same name and monitor which versions have historically been loaded into a process. .005 Executable Installer File Permissions Weakness Monitor for changes to binaries and service executables that may normally occur during software updates. .006 Dynamic Linker Hijacking Monitor for changes to environment variables and files associated with loading shared libraries such as LD_PRELOAD on Linux and DYLD_INSERT_LIBRARIES on macOS. .008 Path Interception by Search Order Hijacking Monitor for programs metadata modifications such as deletion of the path to an executable since it makes programs vulnerable to this type of technique. Also, monitor modifications of files such as renaming programs using Windows system utilities names. .009 Path Interception by Unquoted Path Monitor for changes made to files that may execute their own malicious payloads by hijacking vulnerable file path references. .010 Services File Permissions Weakness Monitor for modification of binaries and service executables that do not occur during a regular software update or an update scheduled by the organization. Modification of files considers actions such as renaming and directory moving. Enterprise T1562 Impair Defenses Monitor changes made to configuration files that contain settings for logging and defensive tools. .012 Disable or Modify Linux Audit System Monitor changes made to the /etc/audit/audit.rules file containing the sequence of auditctl commands loaded at boot time. Enterprise T1070 Indicator Removal Monitor for changes made to a file may delete or alter generated artifacts on a host system, including logs or captured files such as quarantined malware. .002 Clear Linux or Mac System Logs Monitor for changes made to system log files, typically stored in /var/log or /Library/Logs, for unexpected modifications to access permissions and attributes .003 Clear Command History Monitor for changes made to command history files, such as ConsoleHost_history.txt, ~/.zsh_history, or ~/.bash_history, for unexpected modifications to contents, access permissions, and attributes. Analytic 1 : Modification of access rights to command history files suspicious_files = filter ProcessGuid, ProcessFilePath, UserName, FilePath where (event_id == \"4663\" AND FilePath LIKE '%ConsoleHost_history.txt%' AND ObjectType == \"File\" AND (UserAccessList LIKE '%1539%' or UserAccessList LIKE '%WRITE_DAC%')) OR (event_id == \"4670\" AND FilePath LIKE '%ConsoleHost_history.txt%' AND ObjectType == \"File\" AND (ObjectNewSd LIKE '%;FA%' OR ObjectNewSd LIKE '%;FW%' OR ObjectNewSd LIKE '%;BU%')) .006 Timestomp Monitor for unexpected modifications to file timestamps .007 Clear Network Connection History and Configurations Monitor changes to files that may be indicators of deleting or altering malicious network configuration settings as well as generated artifacts on a host system that highlight network connection history, such as Default.rdp or /var/log/. .008 Clear Mailbox Data Monitor for changes made to generated artifacts on a host system, including logs or captured files such as quarantined emails. On Windows 10, mail application data is stored in C:\\Users\\Username\\AppData\\Local\\Comms\\Unistore\\data. On Linux, mail data is stored in /var/spool/mail or /var/mail. On macOS, mail data is stored in ~/Library/Mail. .009 Clear Persistence Monitor for changes made to a file may delete or alter generated artifacts associated with persistence on a host system. ICS T0872 Indicator Removal on Host Monitor for changes made to a file may delete or alter generated artifacts on a host system, including logs or captured files such as quarantined malware. Enterprise T1056 Input Capture Monitor for changes made to files for unexpected modifications to access permissions and attributes .003 Web Portal Capture Monitor for changes made to detect changes to files in the Web directory for organization login pages that do not match with authorized updates to the Web server's content. Enterprise T1036 Masquerading Monitor for changes made to files outside of an update or patch that may attempt to manipulate features of their artifacts to make them appear legitimate or benign to users and/or security tools. Windows Event ID 4663 (An Attempt Was Made to Access An Object) can be used to alert on attempted file accesses that may be associate with Masquerading. .003 Rename System Utilities Monitor for changes made to files for unexpected modifications to file names that are mismatched between the file name on disk and that of the binary's PE metadata. This is a likely indicator that a binary was renamed after it was compiled. Note: There are no standard Windows events for file modification. However, Event ID 4663 (An attempt was made to access an object) can be used to audit and alert on attempts to access system utility binaries; the \"Accesses\" field can be used to filter by type of access (e.g., MODIFY vs DELETE). .008 Masquerade File Type Check and ensure that file headers/signature and extensions match using magic bytes detection and/or file signature validation.[18] In Linux, the file command may be used to check the file signature.[19] ICS T0849 Masquerading Monitor for changes made to files outside of an update or patch that may attempt to manipulate features of their artifacts to make them appear legitimate or benign to users and/or security tools. Enterprise T1556 Modify Authentication Process Monitor for suspicious modification of files associated with authentication processes, such as configuration files and module paths (e.g. /etc/pam.d/). Use system-integrity tools such as AIDE and monitoring tools such as auditd to monitor PAM files. Also monitor for access to certificates and cryptographic keys material. .001 Domain Controller Authentication Monitor for changes to functions exported from authentication-related system DLLs (such as cryptdll.dll and samsrv.dll).[34] .003 Pluggable Authentication Modules Monitor PAM configuration and module paths (ex: /etc/pam.d/) for changes. Use system-integrity tools such as AIDE and monitoring tools such as auditd to monitor PAM files. .004 Network Device Authentication Monitor for changes made to the checksum of the operating system file and verifying the image of the operating system in memory.[35][36] Detection of this behavior may be difficult, detection efforts may be focused on closely related adversary behaviors, such as Modify System Image. .007 Hybrid Identity Monitor for suspicious modification of files associated with hybrid identity authentication processes, such as configuration files. Monitor for access to certificates and cryptographic keys material. Enterprise T1601 Modify System Image Most embedded network devices provide a command to print the version of the currently running operating system. Use this command to query the operating system for its version number and compare it to what is expected for the device in question. Because this method may be used in conjunction with Patch System Image, it may be appropriate to also verify the integrity of the vendor provided operating system image file. Compare the checksum of the operating system file with the checksum of a known good copy from a trusted source. Some embedded network device platforms may have the capability to calculate the checksum of the file, while others may not. Even for those platforms that have the capability, it is recommended to download a copy of the file to a trusted computer to calculate the checksum with software that is not compromised. [35] Many vendors of embedded network devices can provide advanced debugging support that will allow them to work with device owners to validate the integrity of the operating system running in memory. If a compromise of the operating system is suspected, contact the vendor technical support and seek such services for a more thorough inspection of the current running system. [36] .001 Patch System Image Compare the checksum of the operating system file with the checksum of a known good copy from a trusted source. Some embedded network device platforms may have the capability to calculate the checksum of the file, while others may not. Even for those platforms that have the capability, it is recommended to download a copy of the file to a trusted computer to calculate the checksum with software that is not compromised.https://tools.cisco.com/security/center/resources/integrity_assurance.html#7 Many vendors of embedded network devices can provide advanced debugging support that will allow them to work with device owners to validate the integrity of the operating system running in memory. If a compromise of the operating system is suspected, contact the vendor technical support and seek such services for a more thorough inspection of the current running system. https://tools.cisco.com/security/center/resources/integrity_assurance.html#13 .002 Downgrade System Image Monitor for changes made to the operating system of a network device because image downgrade may be used in conjunction with Patch System Image, it may be appropriate to also verify the integrity of the vendor provided operating system image file. Enterprise T1137 Office Application Startup Monitor for changes made to files that may leverage Microsoft Office-based applications for persistence between startups. .001 Office Template Macros Monitor for changes made to files that may abuse Microsoft Office templates to obtain persistence on a compromised system. Modification to base templates, like Normal.dotm, should also be investigated since the base templates should likely not contain VBA macros. Changes to the Office macro security settings should also be investigated .002 Office Test Monitor for changes made to files that may abuse the Microsoft Office \"Office Test\" Registry key to obtain persistence on a compromised system. .006 Add-ins Monitor for changes made to files that may abuse Microsoft Office add-ins to obtain persistence on a compromised system. Enterprise T1647 Plist File Modification Monitor for plist file modification, especially if immediately followed by other suspicious events such as code execution from \\~/Library/Scripts or \\~/Library/Preferences. Also, monitor for significant changes to any path pointers in a modified plist. Enterprise T1653 Power Settings Monitor for unexpected changes to configuration files associated with the power settings of a system. Enterprise T1055 Process Injection Monitor for changes made to files that may inject code into processes in order to evade process-based defenses as well as possibly elevate privileges. .009 Proc Memory Monitor for changes made to /proc files that may inject malicious code into processes via the /proc filesystem in order to evade process-based defenses as well as possibly elevate privileges. Users should not have permission to modify these in most cases. ICS T0873 Project File Infection Monitor for unexpected changes to project files, although if the malicious modification occurs in tandem with legitimate changes it will be difficult to isolate the unintended changes by analyzing only file systems modifications. Enterprise T1014 Rootkit Monitor for changes and the existence of unrecognized DLLs, drivers, devices, services, and to the MBR. [37] Enterprise T1053 Scheduled Task/Job Monitor for changes made to files that may abuse task scheduling functionality to facilitate initial or recurring execution of malicious code. .002 At On Windows, monitor Windows Task Scheduler stores in %systemroot%\\System32\\Tasks for change entries related to scheduled tasks, especially those that do not correlate with known software, patch cycles, etc. On Linux and macOS, all at jobs are stored in /var/spool/cron/atjobs/.[38] .003 Cron Monitor for changes made to files for unexpected modifications to access permissions and attributes .005 Scheduled Task Monitor Windows Task Scheduler stores in %systemroot%\\System32\\Tasks for change entries related to scheduled tasks that do not correlate with known software, patch cycles, etc. .006 Systemd Timers Monitor for changes made to systemd timer unit files for unexpected modification events within the /etc/systemd/system, /usr/lib/systemd/system/, and ~/.config/systemd/user/ directories, as well as associated symbolic links Enterprise T1505 Server Software Component Monitor for changes made to files that may abuse legitimate extensible development features of servers to establish persistent access to systems. .003 Web Shell Monitor for changes made to files that may backdoor web servers with web shells to establish persistent access to systems. .004 IIS Components Monitor for modification of files (especially DLLs on webservers) that could be abused as malicious ISAPI extensions/filters or IIS modules. Changes to %windir%\\system32\\inetsrv\\config\\applicationhost.config could indicate an IIS module installation.[39][40] .005 Terminal Services DLL Monitor unexpected changes and/or interactions with termsrv.dll, which is typically stored in %SystemRoot%\\System32\\. Enterprise T1489 Service Stop Monitor for changes made to files that may stop or disable services on a system to render those services unavailable to legitimate users. ICS T0881 Service Stop Monitor for changes made to files that may stop or disable services on a system to render those services unavailable to legitimate users. Enterprise T1553 Subvert Trust Controls Periodically baseline registered SIPs and trust providers (Registry entries and files on disk), specifically looking for new, modified, or non-Microsoft entries.[41] Also analyze Autoruns data for oddities and anomalies, specifically malicious files attempting persistent execution by hiding within auto-starting locations. Autoruns will hide entries signed by Microsoft or Windows by default, so ensure \"Hide Microsoft Entries\" and \"Hide Windows Entries\" are both deselected.[41] On macOS, the removal of the com.apple.quarantine flag by a user instead of the operating system is a suspicious action and should be examined further. Also monitor software update frameworks that may strip this flag when performing updates. .001 Gatekeeper Bypass The removal of the com.apple.quarantine flag by a user instead of the operating system is a suspicious action and should be examined further. Also monitor software update frameworks that may strip this flag when performing updates. .003 SIP and Trust Provider Hijacking Periodically baseline registered SIPs and trust providers (Registry entries and files on disk), specifically looking for new, modified, or non-Microsoft entries.[41] Also analyze Autoruns data for oddities and anomalies, specifically malicious files attempting persistent execution by hiding within auto-starting locations. Autoruns will hide entries signed by Microsoft or Windows by default, so ensure \"Hide Microsoft Entries\" and \"Hide Windows Entries\" are both deselected.[41] Enterprise T1569 System Services Monitor for changes made to files that may abuse system services or daemons to execute commands or programs. .001 Launchctl Every Launch Agent and Launch Daemon must have a corresponding plist file on disk which can be monitored. Plist files are located in the root, system, and users /Library/LaunchAgents or /Library/LaunchDaemons folders. Launch Agent or Launch Daemon with executable paths pointing to /tmp and /Shared folders locations are potentially suspicious. Enterprise T1080 Taint Shared Content Monitor for files that write or overwrite many files to a network shared directory may be suspicious. Enterprise T1600 Weaken Encryption File Modification .001 Reduce Key Space There is no documented method for defenders to directly identify behaviors that reduce encryption key space. Detection efforts may be focused on closely related adversary behaviors, such as Modify System Image and Network Device CLI. Some detection methods require vendor support to aid in investigation. .002 Disable Crypto Hardware There is no documented method for defenders to directly identify behaviors that reduce encryption key space. Detection efforts may be focused on closely related adversary behaviors, such as Modify System Image and Network Device CLI. Some detection methods require vendor support to aid in investigation. References Microsoft. (2018, May 31). File Management (Local File Systems). Retrieved September 28, 2021. Chrome Enterprise and Education Help. (n.d.). Use Chrome Browser with Roaming User Profiles. Retrieved March 28, 2023. Arntz, P. (2016, March 30). The Windows Vault . Retrieved November 23, 2020. ise. (2019, February 19). Password Managers: Under the Hood of Secrets Management. Retrieved January 22, 2021. Schroeder, W. & Christensen, L. (2021, June 22). Certified Pre-Owned - Abusing Active Directory Certificate Services. Retrieved August 2, 2022. Syynimaa, N. (2022, February 15). Stealing and faking Azure AD device identities. Retrieved August 3, 2022. French, D. (2018, October 2). Detecting Attempts to Steal Passwords from Memory. Retrieved October 11, 2019. French, D., Filar, B.. (2020, March 21). A Chain Is No Stronger Than Its Weakest LNK. Retrieved November 30, 2020. Apple. (n.d.). Open items automatically when you log in on Mac. Retrieved October 1, 2021. hoakley. (2021, September 16). How to run an app or tool at startup. Retrieved October 5, 2021. Patrick Wardle. (2018, July 23). Block Blocking Login Items. Retrieved October 1, 2021. Stokes, Phil. (2019, June 17). HOW MALWARE PERSISTS ON MACOS. Retrieved September 10, 2019. Malware Archaeology. (2016, June). WINDOWS POWERSHELL LOGGING CHEAT SHEET - Win 7/Win 2008 or later. Retrieved June 24, 2016. Chris Ross. (2018, October 17). Persistent Credential Theft with Authorization Plugins. Retrieved April 22, 2021. NSA Cybersecurity Directorate. (n.d.). Mitigating Web Shells. Retrieved July 22, 2021. Harrell, C. (2012, December 11). Extracting ZeroAccess from NTFS Extended Attributes. Retrieved June 3, 2016. Cole, R., Moore, A., Stark, G., Stancill, B. (2020, February 5). STOMP 2 DIS: Brilliance in the (Visual) Basics. Retrieved September 17, 2020. Li, V. (2019, October 2). Polyglot Files: a Hacker\u2019s best friend. Retrieved September 27, 2022. Kessler, G. (2022, December 9). GCK'S FILE SIGNATURES TABLE. Retrieved August 23, 2022. Brennan, M. (2022, February 16). Hackers No Hashing: Randomizing API Hashes to Evade Cobalt Strike Shellcode Detection. Retrieved August 22, 2022. Choi, S. (2015, August 6). Obfuscated API Functions in Modern Packers. Retrieved August 22, 2022. Jason (jxb5151). (2021, January 28). findapihash.py. Retrieved August 22, 2022. Microsoft. (n.d.). PsSetCreateProcessNotifyRoutine routine. Retrieved December 20, 2017. Liberman, T. & Kogan, E. (2017, December 7). Lost in Transaction: Process Doppelg\u00e4nging. Retrieved December 20, 2017. hasherezade. (2017, December 18). Process Doppelg\u00e4nging \u2013 a new way to impersonate a process. Retrieved December 20, 2017. hoakley. (2020, October 29). Quarantine and the quarantine flag. Retrieved September 13, 2021. Russinovich, M. (2016, January 4). Autoruns for Windows v13.51. Retrieved June 6, 2016. Patrick Wardle. (2019, September 17). Writing a File Monitor with Apple's Endpoint Security Framework. Retrieved December 17, 2020. Amit Serper. (2016). Cybereason Lab Analysis OSX.Pirrit. Retrieved December 10, 2021. Marlin, J. (2013, March 24). Alternate Data Streams in NTFS. Retrieved March 21, 2018. Moe, O. (2018, January 14). Putting Data in Alternate Data Streams and How to Execute It. Retrieved June 30, 2018. Moe, O. (2018, April 11). Putting Data in Alternate Data Streams and How to Execute It - Part 2. Retrieved June 30, 2018. Apple. (n.d.). Use rules to manage emails you receive in Mail on Mac. Retrieved June 14, 2021. Dell SecureWorks. (2015, January 12). Skeleton Key Malware Analysis. Retrieved April 8, 2019. Cisco. (n.d.). Cisco IOS Software Integrity Assurance - Cisco IOS Image File Verification. Retrieved October 19, 2020. Cisco. (n.d.). Cisco IOS Software Integrity Assurance - Cisco IOS Run-Time Memory Integrity Verification. Retrieved October 19, 2020. Wikipedia. (2016, June 1). Rootkit. Retrieved June 2, 2016. Craig Rowland. (2019, July 25). Getting an Attacker IP Address from a Malicious Linux At Job. Retrieved October 15, 2021. Microsoft. (2007, November 24). IIS Modules Overview. Retrieved June 17, 2021. Hromcov\u00e1, Z., Cherepanov, A. (2021). Anatomy of Native IIS Malware. Retrieved September 9, 2021. Graeber, M. (2017, September). Subverting Trust in Windows. Retrieved January 31, 2018. "
},
{
"id": 1973,
"title": "Application Log, Data Source DS0015",
"path": "/datasources/DS0015/index.html",
"content": " Application Log Events collected by third-party services such as mail servers, web applications, or other appliances (not by the native OS or platform)[1] ID: DS0015 \u24d8 Platforms: Google Workspace, IaaS, Linux, Office 365, SaaS, Windows, macOS \u24d8 Collection Layers: Cloud Control Plane, Host Version: 1.0 Created: 20 October 2021 Last Modified: 11 May 2022 Version Permalink Live Version Data Components This data source does not have any techniques in the selected domain(s) Application Log: Application Log Content Logging, messaging, and other artifacts provided by third-party services (ex: metrics, errors, and/or alerts from mail/web applications) Application Log: Application Log Content Logging, messaging, and other artifacts provided by third-party services (ex: metrics, errors, and/or alerts from mail/web applications) Domain ID Name Detects Enterprise T1098 .002 Account Manipulation: Additional Email Delegate Permissions Enable the UpdateFolderPermissions action for all logon types. The mailbox audit log will forward folder permission modification events to the Unified Audit Log. Create rules to alert on ModifyFolderPermissions operations where the Anonymous or Default user is assigned permissions other than None. A larger than normal volume of emails sent from an account and similar phishing emails sent from real accounts within a network may be a sign that an account was compromised and attempts to leverage access with modified email permissions is occurring. .005 Account Manipulation: Device Registration Azure AD creates several log entries when new devices are enrolled, which can be monitored for unexpected device registrations.[2] Additionally, joined devices can be viewed via the Azure AD portal.[3] ICS T0800 Activate Firmware Update Mode Monitor asset log which may provide information that an asset has been placed into Firmware Update Mode. Some assets may log firmware updates themselves without logging that the device has been placed into update mode. Enterprise T1557 Adversary-in-the-Middle Monitor application logs for changes to settings and other events associated with network protocols and other services commonly abused for AiTM.[4] .003 DHCP Spoofing Monitor Windows logs (ex: EIDs 1341, 1342, 1020, and 1063) for changes to DHCP settings. These may also highlight DHCP issues such as when IP allocations are low or have run out.[4][5] ICS T0830 Adversary-in-the-Middle Monitor application logs for changes to settings and other events associated with network protocols and other services commonly abused for AiTM. ICS T0803 Block Command Message Monitor application logs for changes to settings and other events associated with network protocols that may be used to block communications. ICS T0804 Block Reporting Message Monitor application logs for changes to settings and other events associated with network protocols that may be used to block communications. ICS T0805 Block Serial COM Monitor application logs for changes to settings and other events associated with network protocols that may be used to block communications. Enterprise T1110 Brute Force Monitor authentication logs for system and application login failures of Valid Accounts. If authentication failures are high, then there may be a brute force attempt to gain access to a system using legitimate credentials. .001 Password Guessing Monitor authentication logs for system and application login failures of Valid Accounts. If authentication failures are high, then there may be a brute force attempt to gain access to a system using legitimate credentials.[6] .002 Password Cracking Monitor authentication logs for system and application login failures of Valid Accounts. It is difficult to detect when hashes are cracked, since this is generally done outside the scope of the target network. Consider focusing efforts on detecting other adversary behavior used to acquire credential materials, such as OS Credential Dumping or Kerberoasting. .003 Password Spraying Monitor authentication logs for system and application login failures of Valid Accounts. Consider the following event IDs:[7]Domain Controllers: \"Audit Logon\" (Success & Failure) for event ID 4625.Domain Controllers: \"Audit Kerberos Authentication Service\" (Success & Failure) for event ID 4771.All systems: \"Audit Logon\" (Success & Failure) for event ID 4648.[6] .004 Credential Stuffing Monitor authentication logs for system and application login failures of Valid Accounts. If authentication failures are high, then there may be a brute force attempt to gain access to a system using legitimate credentials.[6] ICS T0806 Brute Force I/O Some asset application logs may provide information on I/O points related to write commands. Monitor for write commands for an excessive number of I/O points or manipulating a single value an excessive number of times. ICS T0858 Change Operating Mode Monitor device application logs which may contain information related to operating mode changes, although not all devices produce such logs. ICS T0807 Command-Line Interface Monitor logs from installed applications (e.g., historian logs) for unexpected commands or abuse of system features. Enterprise T1213 Data from Information Repositories Monitor for third-party application logging, messaging, and/or other artifacts that may leverage information repositories to mine valuable information. Information repositories generally have a considerably large user base, detection of malicious use can be non-trivial. At minimum, access to information repositories performed by privileged users (for example, Active Directory Domain, Enterprise, or Schema Administrators) should be closely monitored and alerted upon, as these types of accounts should generally not be used to access information repositories. If the capability exists, it may be of value to monitor and alert on users that are retrieving and viewing a large number of documents and pages; this behavior may be indicative of programmatic means being used to retrieve all data within the repository. In environments with high-maturity, it may be possible to leverage User-Behavioral Analytics (UBA) platforms to detect and alert on user based anomalies. .001 Confluence Monitor for third-party application logging, messaging, and/or other artifacts that may leverage Confluence repositories to mine valuable information. Watch for access to Confluence repositories performed by privileged users (for example, Active Directory Domain, Enterprise, or Schema Administrators) as these types of accounts should generally not be used to access information repositories. If the capability exists, it may be of value to monitor and alert on users that are retrieving and viewing a large number of documents and pages; this behavior may be indicative of programmatic means being used to retrieve all data within the repository. In environments with high-maturity, it may be possible to leverage User-Behavioral Analytics (UBA) platforms to detect and alert on user based anomalies. .002 Sharepoint Monitor for third-party application logging, messaging, and/or other artifacts that may leverage the SharePoint repository as a source to mine valuable information. Monitor access to Microsoft SharePoint repositories performed by privileged users (for example, Active Directory Domain, Enterprise, or Schema Administrators) should be closely monitored and alerted upon, as these types of accounts should generally not be used to access information repositories. If the capability exists, it may be of value to monitor and alert on users that are retrieving and viewing a large number of documents and pages; this behavior may be indicative of programmatic means being used to retrieve all data within the repository. In environments with high-maturity, it may be possible to leverage User-Behavioral Analytics (UBA) platforms to detect and alert on user based anomalies. .003 Code Repositories Monitor for third-party application logging, messaging, and/or other artifacts that may leverage code repositories to collect valuable information. Monitor access to code repositories, especially performed by privileged users such as Active Directory Domain or Enterprise Administrators as these types of accounts should generally not be used to access code repositories. In environments with high-maturity, it may be possible to leverage User-Behavioral Analytics (UBA) platforms to detect and alert on user-based anomalies. ICS T0811 Data from Information Repositories Monitor for third-party application logging, messaging, and/or other artifacts that may leverage information repositories to mine valuable information. Information repositories generally have a considerably large user base, detection of malicious use can be non-trivial. At minimum, access to information repositories performed by privileged users (for example, Active Directory Domain, Enterprise, or Schema Administrators) should be closely monitored and alerted upon, as these types of accounts should generally not be used to access information repositories. If the capability exists, it may be of value to monitor and alert on users that are retrieving and viewing a large number of documents and pages; this behavior may be indicative of programmatic means being used to retrieve all data within the repository. In environments with high-maturity, it may be possible to leverage User-Behavioral Analytics (UBA) platforms to detect and alert on user-based anomalies. Enterprise T1622 Debugger Evasion Monitor debugger logs for signs of abnormal and potentially malicious activity. Enterprise T1491 Defacement Monitor for third-party application logging, messaging, and/or other artifacts that may modify visual content available internally or externally to an enterprise network. .001 Internal Defacement Monitor for third-party application logging, messaging, and/or other artifacts that may deface systems internal to an organization in an attempt to intimidate or mislead users. .002 External Defacement Monitor for third-party application logging, messaging, and/or other artifacts that may deface systems external to an organization in an attempt to deliver messaging, intimidate, or otherwise mislead an organization or users. ICS T0814 Denial of Service Monitor for application logging, messaging, and/or other artifacts that may result from Denial of Service (DoS) attacks which degrade or block the availability of services to users. In addition to network level detections, endpoint logging and instrumentation can be useful for detection. Enterprise T1610 Deploy Container Configuration management databases (CMDB) and other asset management systems may help with the detection of computer systems or network devices that should not exist on a network. ICS T0816 Device Restart/Shutdown Device restarts and shutdowns may be observable in device application logs. Monitor for unexpected device restarts or shutdowns. Enterprise T1189 Drive-by Compromise Firewalls and proxies can inspect URLs for potentially known-bad domains or parameters. They can also do reputation-based analytics on websites and their requested resources such as how old a domain is, who it's registered to, if it's on a known bad list, or how many other users have connected to it before. ICS T0817 Drive-by Compromise Firewalls and proxies can inspect URLs for potentially known-bad domains or parameters. They can also do reputation-based analytics on websites and their requested resources such as how old a domain is, who it's registered to, if it's on a known bad list, or how many other users have connected to it before. Enterprise T1114 Email Collection Detection is challenging because all messages forwarded because of an auto-forwarding rule have the same presentation as a manually forwarded message. It is also possible for the user to not be aware of the addition of such an auto-forwarding rule and not suspect that their account has been compromised; email-forwarding rules alone will not affect the normal usage patterns or operations of the email account. Auto-forwarded messages generally contain specific detectable artifacts that may be present in the header; such artifacts would be platform-specific. Examples include X-MS-Exchange-Organization-AutoForwarded set to true, X-MailFwdBy and X-Forwarded-To. The forwardingSMTPAddress parameter used in a forwarding process that is managed by administrators and not by user actions. All messages for the mailbox are forwarded to the specified SMTP address. However, unlike typical client-side rules, the message does not appear as forwarded in the mailbox; it appears as if it were sent directly to the specified destination mailbox.[8] High volumes of emails that bear the X-MS-Exchange-Organization-AutoForwarded header (indicating auto-forwarding) without a corresponding number of emails that match the appearance of a forwarded message may indicate that further investigation is needed at the administrator level rather than user-level. .002 Remote Email Collection In Office365 environments, consider using PurviewAudit to collect MailItemsAccessed events and monitoring for unusual email access behavior.[6] .003 Email Forwarding Rule Detection is challenging because all messages forwarded because of an auto-forwarding rule have the same presentation as a manually forwarded message. It is also possible for the user to not be aware of the addition of such an auto-forwarding rule and not suspect that their account has been compromised; email-forwarding rules alone will not affect the normal usage patterns or operations of the email account. This is especially true in cases with hidden auto-forwarding rules. This makes it only possible to reliably detect the existence of a hidden auto-forwarding rule by examining message tracking logs or by using a MAPI editor to notice the modified rule property values.[9]Auto-forwarded messages generally contain specific detectable artifacts that may be present in the header; such artifacts would be platform-specific. Examples include X-MS-Exchange-Organization-AutoForwarded set to true, X-MailFwdBy and X-Forwarded-To. The forwardingSMTPAddress parameter used in a forwarding process that is managed by administrators and not by user actions. All messages for the mailbox are forwarded to the specified SMTP address. However, unlike typical client-side rules, the message does not appear as forwarded in the mailbox; it appears as if it were sent directly to the specified destination mailbox.[8] High volumes of emails that bear the X-MS-Exchange-Organization-AutoForwarded header (indicating auto-forwarding) without a corresponding number of emails that match the appearance of a forwarded message may indicate that further investigation is needed at the administrator level rather than user-level. In environments using Exchange, monitor logs for the creation or modification of mail transport rules. Enterprise T1499 Endpoint Denial of Service Monitor for third-party application logging, messaging, and/or other artifacts that may perform Endpoint Denial of Service (DoS) attacks to degrade or block the availability of services to users. In addition to network level detections, endpoint logging and instrumentation can be useful for detection. Attacks targeting web applications may generate logs in the web server, application server, and/or database server that can be used to identify the type of attack, possibly before the impact is felt. Externally monitor the availability of services that may be targeted by an Endpoint DoS. .002 Service Exhaustion Flood Monitor for third-party application logging, messaging, and/or other artifacts that may target the different network services provided by systems to conduct a DoS. In addition to network level detections, endpoint logging and instrumentation can be useful for detection. Attacks targeting web applications may generate logs in the web server, application server, and/or database server that can be used to identify the type of attack, possibly before the impact is felt. Externally monitor the availability of services that may be targeted by an Endpoint DoS. .003 Application Exhaustion Flood Monitor for third-party application logging, messaging, and/or other artifacts that may target resource intensive features of web applications to cause a denial of service (DoS). In addition to network level detections, endpoint logging and instrumentation can be useful for detection. Attacks targeting web applications may generate logs in the web server, application server, and/or database server that can be used to identify the type of attack, possibly before the impact is felt. Externally monitor the availability of services that may be targeted by an Endpoint DoS. .004 Application or System Exploitation Monitor for third-party application logging, messaging, and/or other artifacts that may exploit software vulnerabilities that can cause an application or system to crash and deny availability to users. [10] Attacks targeting web applications may generate logs in the web server, application server, and/or database server that can be used to identify the type of attack. Externally monitor the availability of services that may be targeted by an Endpoint DoS. Enterprise T1048 Exfiltration Over Alternative Protocol Monitor cloud-based file hosting services, such as Google Drive and Microsoft OneDrive, for unusual instances of file downloads \u2013 for example, many downloads by a single user in a short period of time. In environments with high-maturity, it may be possible to leverage User-Behavioral Analytics (UBA) platforms to detect and alert on user-based anomalies. Additionally, data loss prevention policies can be defined to detect and alert on exfiltration events on particularly sensitive data. Enterprise T1567 Exfiltration Over Web Service Review logs for SaaS services, including Office 365 and Google Workspace, to detect the configuration of new webhooks or other features that could be abused to exfiltrate data. .004 Exfiltration Over Webhook Review logs for SaaS services, including Office 365 and Google Workspace, to detect the configuration of new webhooks. Enterprise T1190 Exploit Public-Facing Application Detecting software exploitation may be difficult depending on the tools available. Software exploits may not always succeed or may cause the exploited process to become unstable or crash. Web Application Firewalls may detect improper inputs attempting exploitation. ICS T0819 Exploit Public-Facing Application Detecting software exploitation may be difficult depending on the tools available. Software exploits may not always succeed or may cause the exploited process to become unstable or crash. Web Application Firewalls may detect improper inputs attempting exploitation. Enterprise T1203 Exploitation for Client Execution Detecting software exploitation may be difficult depending on the tools available. Software exploits may not always succeed or may cause the exploited process to become unstable or crash. Enterprise T1212 Exploitation for Credential Access Detecting software exploitation may be difficult depending on the tools available. Software exploits may not always succeed or may cause the exploited process to become unstable or crash. Enterprise T1211 Exploitation for Defense Evasion Exploitation for defense evasion may happen shortly after the system has been compromised to prevent detection during later actions for for additional tools that may be brought in and used. Detecting software exploitation may be difficult depending on the tools available. Software exploits may not always succeed or may cause the exploited process to become unstable or crash. ICS T0820 Exploitation for Evasion Detecting software exploitation may be difficult depending on the tools available. Software exploits may not always succeed or may cause the exploited process to become unstable or crash. ICS T0890 Exploitation for Privilege Escalation Detecting software exploitation may be difficult depending on the tools available. Software exploits may not always succeed or may cause the exploited process to become unstable or crash. Enterprise T1210 Exploitation of Remote Services Detecting software exploitation may be difficult depending on the tools available. Software exploits may not always succeed or may cause the exploited process to become unstable or crash. Web Application Firewalls may detect improper inputs attempting exploitation. ICS T0866 Exploitation of Remote Services Detecting software exploitation may be difficult depending on the tools available. Software exploits may not always succeed or may cause the exploited process to become unstable or crash, which may be recorded in the application log. Enterprise T1133 External Remote Services When authentication is not required to access an exposed remote service, monitor for follow-on activities such as anomalous external use of the exposed API or application. ICS T0822 External Remote Services When authentication is not required to access an exposed remote service, monitor for follow-on activities such as anomalous external use of the exposed API or application. Enterprise T1657 Financial Theft Review and monitor financial application logs for signs of financial theft, such as abnormal monetary transactions or resource balances. Email logs may also highlight account takeovers, impersonation, or another activity that may enable monetary theft. Enterprise T1200 Hardware Additions Configuration management databases (CMDB) and other asset management systems may help with the detection of computer systems or network devices that should not exist on a network. Enterprise T1564 Hide Artifacts Monitor for third-party application logging, messaging, and/or other artifacts that may attempt to hide artifacts associated with their behaviors to evade detection. .008 Email Hiding Rules Monitor for third-party application logging, messaging, and/or other artifacts that may use email rules to hide inbound emails in a compromised user's mailbox. Monitor email clients and applications for suspicious activity, such as missing messages or abnormal configuration and/or log entries. In environments using Exchange, monitor logs for the creation or modification of mail transport rules. Enterprise T1562 .002 Impair Defenses: Disable Windows Event Logging Monitor for third-party application logging, messaging, and/or other artifacts provided by third-party services that may disable Windows event logging to limit data that can be leveraged for detections and audits. Enterprise T1656 Impersonation Review and monitor email and other user communication logs for signs of impersonation, such as suspicious emails (e.g., from known malicious or compromised accounts) or content associated with an adversary's actions on objective (e.g., abnormal monetary transactions). Enterprise T1070 Indicator Removal Monitor logs for abnormal modifications to application settings, such as the creation of malicious Exchange transport rules. .008 Clear Mailbox Data In environments using Exchange, monitor logs for the creation or modification of mail processing settings, such as transport rules. Enterprise T1534 Internal Spearphishing Monitor email gateways usually do not scan internal email, but an organization can leverage the journaling-based solution which sends a copy of emails to a security service for offline analysis or incorporate service-integrated solutions using on-premise or API-based integrations to help detect internal spearphishing attacks.[11] ICS T0838 Modify Alarm Settings Monitor ICS asset application logs that indicate alarm settings have changed, although not all assets will produce such logs. Enterprise T1556 Modify Authentication Process Enable security auditing to collect logs from hybrid identity solutions. For example, monitor sign-ins to the Azure AD Application Proxy Connector, which are typically generated only when a new Pass Through Authentication (PTA) Agent is added. [12] If AD FS is in use, review the logs for event ID 501, which specifies all EKU attributes on a claim, and raise alerts on any values that are not configured in your environment.[13] .007 Hybrid Identity Enable security auditing to collect logs from hybrid identity solutions. For example, monitor sign-ins to the Azure AD Application Proxy Connector, which are typically generated only when a new PTA Agent is added. [12] If AD FS is in use, review the logs for event ID 501, which specifies all EKU attributes on a claim, and raise alerts on any values that are not configured in your environment.[13] ICS T0821 Modify Controller Tasking Monitor asset application logs for information that indicate task parameters have changed. ICS T0836 Modify Parameter Monitor device application logs parameter changes, although not all devices will produce such logs. ICS T0889 Modify Program Monitor device application logs that indicate the program has changed, although not all devices produce such logs. ICS T0839 Module Firmware Monitor device application logs for firmware changes, although not all devices will produce such logs. ICS T0801 Monitor Process State Monitor applications logs for any access attempts to operational databases (e.g., historians) or other sources of operational data within the ICS environment. These devices should be monitored for adversary collection using techniques relevant to the underlying technologies (e.g., Windows, Linux). Enterprise T1621 Multi-Factor Authentication Request Generation Monitor application logs for suspicious events including repeated MFA failures that may indicate user's primary credentials have been compromised. Enterprise T1027 .005 Obfuscated Files or Information: Indicator Removal from Tools The first detection of a malicious tool may trigger an anti-virus or other security tool alert. Similar events may also occur at the boundary through network IDS, email scanning appliance, etc. The initial detection should be treated as an indication of a potentially more invasive intrusion. The alerting system should be thoroughly investigated beyond that initial alert for activity that was not detected. Adversaries may continue with an operation, assuming that individual events like an anti-virus detect will not be investigated or that an analyst will not be able to conclusively link that event to other activity occurring on the network. Enterprise T1137 Office Application Startup Monitor for third-party application logging, messaging, and/or other artifacts that may leverage Microsoft Office-based applications for persistence between startups. SensePost, whose tool Ruler can be used to carry out malicious rules, forms, and Home Page attacks, has released a tool to detect Ruler usage.[14] .003 Outlook Forms Monitor for third-party application logging, messaging, and/or other artifacts that may abuse Microsoft Outlook forms to obtain persistence on a compromised system. SensePost, whose tool Ruler can be used to carry out malicious rules, forms, and Home Page attacks, has released a tool to detect Ruler usage.[14] .004 Outlook Home Page Monitor for third-party application logging, messaging, and/or other artifacts that may abuse Microsoft Outlook's Home Page feature to obtain persistence on a compromised system. SensePost, whose tool Ruler can be used to carry out malicious rules, forms, and Home Page attacks, has released a tool to detect Ruler usage.[14] .005 Outlook Rules Monitor for third-party application logging, messaging, and/or other artifacts that may abuse Microsoft Outlook rules to obtain persistence on a compromised system. SensePost, whose tool Ruler can be used to carry out malicious rules, forms, and Home Page attacks, has released a tool to detect Ruler usage.[14] Enterprise T1069 Permission Groups Discovery Monitor for logging, messaging, and other artifacts provided by cloud services. .003 Cloud Groups Monitor for events collected that may attempt to find cloud groups and permission settings. Enterprise T1566 Phishing Monitor for third-party application logging, messaging, and/or other artifacts that may send phishing messages to gain access to victim systems. Filtering based on DKIM+SPF or header analysis can help detect when the email sender is spoofed.[15][16] URL inspection within email (including expanding shortened links) can help detect links leading to known malicious sites. Detonation chambers can be used to detect these links and either automatically go to these sites to determine if they're potentially malicious, or wait and capture the content if a user visits the link. Monitor call logs from corporate devices to identify patterns of potential voice phishing, such as calls to/from known malicious phone numbers. Correlate these records with system events. .001 Spearphishing Attachment Monitor for third-party application logging, messaging, and/or other artifacts that may send spearphishing emails with a malicious attachment in an attempt to gain access to victim systems. Filtering based on DKIM+SPF or header analysis can help detect when the email sender is spoofed.[15][16] Anti-virus can potentially detect malicious documents and attachments as they're scanned to be stored on the email server or on the user's computer. Monitor for suspicious descendant process spawning from Microsoft Office and other productivity software.[17] .002 Spearphishing Link Monitor for third-party application logging, messaging, and/or other artifacts that may send spearphishing emails with a malicious link in an attempt to gain access to victim systems. Filtering based on DKIM+SPF or header analysis can help detect when the email sender is spoofed.[15][16] URL inspection within email (including expanding shortened links and identifying obfuscated URLs) can help detect links leading to known malicious sites.[18] Detonation chambers can be used to detect these links and either automatically go to these sites to determine if they're potentially malicious, or wait and capture the content if a user visits the link. Furthermore, monitor browser logs for homographs in ASCII and in internationalized domain names abusing different character sets (e.g. Cyrillic vs Latin versions of trusted sites). .003 Spearphishing via Service Monitor for third-party application logging, messaging, and/or other artifacts that may send spearphishing messages via third-party services in an attempt to gain access to victim systems. .004 Spearphishing Voice Monitor call logs from corporate devices to identify patterns of potential voice phishing, such as calls to/from known malicious phone numbers. Correlate these records with system events. Enterprise T1598 Phishing for Information Depending on the specific method of phishing, the detections can vary. Monitor for suspicious email activity, such as numerous accounts receiving messages from a single unusual/unknown sender. Filtering based on DKIM+SPF or header analysis can help detect when the email sender is spoofed.[15][16]When it comes to following links, monitor for references to uncategorized or known-bad sites. URL inspection within email (including expanding shortened links) can also help detect links leading to known malicious sites.Monitor social media traffic for suspicious activity, including messages requesting information as well as abnormal file or data transfers (especially those involving unknown, or otherwise suspicious accounts). Monitor call logs from corporate devices to identify patterns of potential voice phishing, such as calls to/from known malicious phone numbers. .001 Spearphishing Service Monitor social media traffic for suspicious activity, including messages requesting information as well as abnormal file or data transfers (especially those involving unknown, or otherwise suspicious accounts).Much of this activity may have a very high occurrence and associated false positive rate, as well as potentially taking place outside the visibility of the target organization, making detection difficult for defenders.Detection efforts may be focused on related stages of the adversary lifecycle, such as during Initial Access. .002 Spearphishing Attachment Monitor for suspicious email activity, such as numerous accounts receiving messages from a single unusual/unknown sender. Filtering based on DKIM+SPF or header analysis can help detect when the email sender is spoofed.[15][16] .003 Spearphishing Link Monitor for suspicious email activity, such as numerous accounts receiving messages from a single unusual/unknown sender. Filtering based on DKIM+SPF or header analysis can help detect when the email sender is spoofed.[15][16] Monitor for references to uncategorized or known-bad sites. URL inspection within email (including expanding shortened links and identifying obfuscated URLs) can also help detect links leading to known malicious sites.[18] Furthermore, monitor browser logs for homographs in ASCII and in internationalized domain names abusing different character sets (e.g. Cyrillic vs Latin versions of trusted sites). .004 Spearphishing Voice Monitor call logs from corporate devices to identify patterns of potential voice phishing, such as calls to/from known malicious phone numbers. ICS T0861 Point & Tag Identification Monitor asset application logs which may provide information about requests for points or tags. Look for anomalies related to reading point or tag data, such as new assets using these functions, changes in volume or timing, or unusual information being queried. Many devices provide multiple ways to achieve the same result (e.g., functions with/without an acknowledgment or functions that operate on a single point vs. multiple points). Monitor for changes in the functions used. ICS T0843 Program Download Monitor devices configuration logs which may contain alerts that indicate whether a program download has occurred. Devices may maintain application logs that indicate whether a full program download, online edit, or program append function has occurred. ICS T0845 Program Upload Monitor for device alarms produced when program uploads occur, although not all devices will produce such alarms. ICS T0848 Rogue Master Monitor for new master devices communicating with outstation assets, which may be visible in asset application logs. Enterprise T1594 Search Victim-Owned Websites Monitor for suspicious network traffic that could be indicative of adversary reconnaissance, such as rapid successions of requests indicative of web crawling and/or large quantities of requests originating from a single source (especially if the source is known to be associated with an adversary). Analyzing web metadata may also reveal artifacts that can be attributed to potentially malicious activity, such as referer or user-agent string HTTP/S fields. Enterprise T1505 Server Software Component Monitor for third-party application logging, messaging, and/or other artifacts that may abuse legitimate extensible development features of servers to establish persistent access to systems. Consider monitoring application logs for abnormal behavior that may indicate suspicious installation of application software components. Log authentication attempts to the server and any unusual traffic patterns to or from the server and internal network. [19] .001 SQL Stored Procedures Monitor for third-party application logging, messaging, and/or other artifacts that may abuse SQL stored procedures to establish persistent access to systems. On a MSSQL Server, consider monitoring for xp_cmdshell usage.[20] Consider enabling audit features that can log malicious startup activities. .002 Transport Agent Monitor for third-party application logging, messaging, and/or other artifacts that may abuse Microsoft transport agents to establish persistent access to systems. Consider monitoring application logs for abnormal behavior that may indicate suspicious installation of application software components. .003 Web Shell Monitor for third-party application logging, messaging, and/or other artifacts that may backdoor web servers with web shells to establish persistent access to systems. Log authentication attempts to the server and any unusual traffic patterns to or from the server and internal network. [19] Enterprise T1648 Serverless Execution Monitor logs generated by serverless execution for unusual activity. For example, in Exchange environments emails sent by Power Automate via the Outlook 365 connector include the phrase \u2018Power App\u2019 or \u2018Power Automate\u2019 in the SMTP header 'x-ms-mail-application.'[21] Enterprise T1072 Software Deployment Tools Often these third-party applications will have logs of their own that can be collected and correlated with other data from the environment. Ensure that third-party application logs are on-boarded to the enterprise logging system and the logs are regularly reviewed. Audit software deployment logs and look for suspicious or unauthorized activity. A system not typically used to push software to clients that suddenly is used for such a task outside of a known admin function may be suspicious. Monitor account login activity on these applications to detect suspicious/abnormal usage.Perform application deployment at regular times so that irregular deployment activity stands out. ICS T0865 Spearphishing Attachment Monitor mail server and proxy logs for evidence of messages originating from spoofed addresses, including records indicating failed DKIM+SPF validation or mismatched message headers.[15][16] Anti-virus can potentially detect malicious documents and attachments as they're scanned to be stored on the email server or on the user's computer. Enterprise T1649 Steal or Forge Authentication Certificates Ensure CA audit logs are enabled and monitor these services for signs of abuse.[22] ICS T0857 System Firmware Monitor device application logs for firmware changes, although not all devices will produce such logs. ICS T0864 Transient Cyber Asset Networking devices such as switches may log when new client devices connect (e.g., SNMP notifications). Monitor for any logs documenting changes to network connection status to determine when a new connection has occurred, including the resulting addresses (e.g., IP, MAC) of devices on that network. Enterprise T1199 Trusted Relationship Configuration management databases (CMDB) and other asset management systems may help with the detection of computer systems or network devices that should not exist on a network. Monitor logs for unexpected actions taken by any delegated administrator accounts.[23] ICS T0855 Unauthorized Command Message Monitor for anomalous or unexpected commands that may result in changes to the process operation (e.g., discrete write, logic and device configuration, mode changes) observable via asset application logs. Enterprise T1552 Unsecured Credentials Monitor application logs for activity that may highlight malicious attempts to access application data, especially abnormal search activity targeting passwords and other artifacts related to credentials.[24] .008 Chat Messages Monitor application logs for activity that may highlight malicious attempts to access application data, especially abnormal search activity targeting passwords and other artifacts related to credentials.[24] Enterprise T1550 Use Alternate Authentication Material Monitor for third-party application logging, messaging, and/or other artifacts that may use alternate authentication material, such as password hashes, Kerberos tickets, and application access tokens, in order to move laterally within an environment and bypass normal system access controls. .004 Web Session Cookie Monitor for third-party application logging, messaging, and/or other service artifacts that provide context of user authentication to web applications, including cloud-based services. Combine this information with web credentials usage events to identify authentication events that do not fit the organization baseline. Enterprise T1204 User Execution Monitor for third-party application logging, messaging, and/or other artifacts that may rely upon specific actions by a user in order to gain execution. .003 Malicious Image Monitor for third-party application logging, messaging, and/or other artifacts that may rely on a user running a malicious image to facilitate execution. ICS T0863 User Execution Monitor for application logging, messaging, and/or other artifacts that may rely upon specific actions by a user in order to gain execution. ICS T0860 Wireless Compromise Monitor application logs for new or unexpected devices or sessions on wireless networks. References Confluence Support. (2021, April 22). Working with Confluence Logs. Retrieved September 23, 2021. Dr. Nestori Syynimaa. (2021, January 31). BPRT unleashed: Joining multiple devices to Azure AD and Intune. Retrieved March 4, 2022. Microsoft. (2022, February 18). Manage device identities by using the Azure portal. Retrieved April 13, 2022. Microsoft. (2006, August 31). DHCP Server Operational Events. Retrieved March 7, 2022. Shoemaker, E. (2015, December 31). Solution: Monitor DHCP Scopes and Detect Man-in-the-Middle Attacks with PRTG and PowerShell. Retrieved March 7, 2022. Pany, D. & Hanley, C. (2023, May 3). Cloudy with a Chance of Bad Logs: Cloud Platform Log Configurations to Consider in Investigations. Retrieved October 16, 2023. Metcalf, S. (2018, May 6). Trimarc Research: Detecting Password Spraying with Security Event Auditing. Retrieved January 16, 2019. McMichael, T.. (2015, June 8). Exchange and Office 365 Mail Forwarding. Retrieved October 8, 2019. Damian Pfammatter. (2018, September 17). Hidden Inbox Rules in Microsoft Exchange. Retrieved October 12, 2021. Cid, D.. (2015, August 2). BIND9 \u2013 Denial of Service Exploit in the Wild. Retrieved April 26, 2019. Chris Taylor. (2017, October 5). When Phishing Starts from the Inside. Retrieved October 8, 2019. Mike Burns. (2020, September 30). Detecting Microsoft 365 and Azure Active Directory Backdoors. Retrieved September 28, 2022. Microsoft Threat Intelligence Center, Microsoft Detection and Response Team, Microsoft 365 Defender Research Team . (2022, August 24). MagicWeb: NOBELIUM\u2019s post-compromise trick to authenticate as anyone. Retrieved September 28, 2022. SensePost. (2017, September 21). NotRuler - The opposite of Ruler, provides blue teams with the ability to detect Ruler usage against Exchange. Retrieved February 4, 2019. Microsoft. (2020, October 13). Anti-spoofing protection in EOP. Retrieved October 19, 2020. Australian Cyber Security Centre. (2012, December). Mitigating Spoofed Emails Using Sender Policy Framework. Retrieved October 19, 2020. Stepanic, D.. (2020, January 13). Embracing offensive tooling: Building detections against Koadic using EQL. Retrieved November 30, 2020. Nick Simonian. (2023, May 22). Don't @ Me: URL Obfuscation Through Schema Abuse. Retrieved August 4, 2023. US-CERT. (2015, November 13). Compromised Web Servers and Web Shells - Threat Awareness and Guidance. Retrieved June 8, 2016. Sutherland, S. (2016, March 7). Maintaining Persistence via SQL Server \u2013 Part 1: Startup Stored Procedures. Retrieved July 8, 2019. Microsoft. (2022, February 15). Email exfiltration controls for connectors. Retrieved May 27, 2022. Schroeder, W. & Christensen, L. (2021, June 22). Certified Pre-Owned - Abusing Active Directory Certificate Services. Retrieved August 2, 2022. Microsoft Threat Intelligence Center. (2021, October 25). NOBELIUM targeting delegated administrative privileges to facilitate broader attacks. Retrieved January 31, 2022. Slack Help Center. (n.d.). View Access Logs for your workspace. Retrieved April 10, 2023. "
},
{
"id": 1974,
"title": "Snapshot, Data Source DS0020",
"path": "/datasources/DS0020/index.html",
"content": " Snapshot A point-in-time copy of cloud volumes (files, settings, etc.) that can be created and/or deployed in cloud environments[1][2] ID: DS0020 \u24d8 Platform: IaaS \u24d8 Collection Layer: Cloud Control Plane Contributors: Center for Threat-Informed Defense (CTID) Version: 1.0 Created: 20 October 2021 Last Modified: 10 November 2021 Version Permalink Live Version Data Components This data source does not have any techniques in the selected domain(s) Snapshot: Snapshot Creation Initial construction of a new snapshot (ex: AWS create-snapshot) Snapshot: Snapshot Creation Initial construction of a new snapshot (ex: AWS create-snapshot) Domain ID Name Detects Enterprise T1578 Modify Cloud Compute Infrastructure Establish centralized logging for the activity of cloud compute infrastructure components. Monitor for suspicious sequences of events, such as the creation of multiple snapshots within a short period of time. To reduce false positives, valid change management procedures could introduce a known identifier that is logged with the change (e.g., tag or header) if supported by the cloud provider, to help distinguish valid, expected actions from malicious ones. .001 Create Snapshot The creation of a snapshot is a common part of operations within many cloud environments. Events should then not be viewed in isolation, but as part of a chain of behavior that could lead to other activities such as the creation of one or more snapshots and the restoration of these snapshots by a new user account.In AWS, CloudTrail logs capture the creation of snapshots and all API calls for AWS Backup as events. Using the information collected by CloudTrail, you can determine the request that was made, the IP address from which the request was made, which user made the request, when it was made, and additional details.[3]In Azure, the creation of a snapshot may be captured in Azure activity logs. Backup restoration events can also be detected through Azure Monitor Log Data by creating a custom alert for completed restore jobs.[4]Google's Admin Activity audit logs within their Cloud Audit logs can be used to detect the usage of the gcloud compute instances create command to create a new VM disk from a snapshot.[5] It is also possible to detect the usage of the GCP API with the sourceSnapshot parameter pointed to global/snapshots/[BOOT_SNAPSHOT_NAME].[6] Enterprise T1537 Transfer Data to Cloud Account Monitor account activity for attempts to create and share data, such as snapshots or backups, with untrusted or unusual accounts. Snapshot: Snapshot Deletion Removal of a snapshot (ex: AWS delete-snapshot) Snapshot: Snapshot Deletion Removal of a snapshot (ex: AWS delete-snapshot) Domain ID Name Detects Enterprise T1485 Data Destruction Monitor for unexpected deletion of a snapshot (ex: AWS delete-snapshot) Enterprise T1490 Inhibit System Recovery Monitor for unexpected deletion of snapshots (ex: AWS delete-snapshot), especially those associated with cloud backups. Enterprise T1578 Modify Cloud Compute Infrastructure Establish centralized logging for the activity of cloud compute infrastructure components. Monitor for suspicious sequences of events, such as the deletion of multiple snapshots within a short period of time. To reduce false positives, valid change management procedures could introduce a known identifier that is logged with the change (e.g., tag or header) if supported by the cloud provider, to help distinguish valid, expected actions from malicious ones. Snapshot: Snapshot Enumeration An extracted list of snapshops within a cloud environment (ex: AWS describe-snapshots) Snapshot: Snapshot Enumeration An extracted list of snapshops within a cloud environment (ex: AWS describe-snapshots) Domain ID Name Detects Enterprise T1580 Cloud Infrastructure Discovery Monitor cloud logs for API calls and other potentially unusual activity related to snapshot enumeration. Discovery techniques normally occur throughout an operation as an adversary learns the environment. Data and events should not be viewed in isolation, but as part of a chain of behavior that could lead to other activities, such as Collection and Exfiltration, based on the information obtained. Snapshot: Snapshot Metadata Contextual data about a snapshot, which may include information such as ID, type, and status Snapshot: Snapshot Metadata Contextual data about a snapshot, which may include information such as ID, type, and status Domain ID Name Detects Enterprise T1578 Modify Cloud Compute Infrastructure Periodically baseline snapshots to identify malicious modifications or additions. .001 Create Snapshot Periodically baseline snapshots to identify malicious modifications or additions. Enterprise T1537 Transfer Data to Cloud Account Periodically baseline snapshots to identify malicious modifications or additions. Snapshot: Snapshot Modification Changes made to a snapshop, such as metadata and control data (ex: AWS modify-snapshot-attribute) Snapshot: Snapshot Modification Changes made to a snapshop, such as metadata and control data (ex: AWS modify-snapshot-attribute) Domain ID Name Detects Enterprise T1578 Modify Cloud Compute Infrastructure Establish centralized logging for the activity of cloud compute infrastructure components. Monitor for suspicious sequences of events, such as the mounting of a snapshot to a new instance by a new or unexpected user. To reduce false positives, valid change management procedures could introduce a known identifier that is logged with the change (e.g., tag or header) if supported by the cloud provider, to help distinguish valid, expected actions from malicious ones. Enterprise T1537 Transfer Data to Cloud Account Monitor account activity for attempts to share data, snapshots, or backups with untrusted or unusual accounts on the same cloud service provider. Monitor for anomalous file transfer activity between accounts and to untrusted VPCs. References Microsoft. (2021, September 16). Create a snapshot of a virtual hard disk. Retrieved October 13, 2021. Amazon. (n.d.). Amazon EBS snapshots. Retrieved October 13, 2021. Amazon. (2020). Logging AWS Backup API Calls with AWS CloudTrail. Retrieved April 27, 2020. Microsoft. (2019, June 4). Monitor at scale by using Azure Monitor. Retrieved May 1, 2020. Google. (n.d.). Audit Logs. Retrieved June 1, 2020. Google. (2020, April 23). Creating and Starting a VM instance. Retrieved May 1, 2020. "
},
{
"id": 1975,
"title": "Container, Data Source DS0032",
"path": "/datasources/DS0032/index.html",
"content": " Container A standard unit of virtualized software that packages up code and all its dependencies so the application runs quickly and reliably from one computing environment to another[1] ID: DS0032 \u24d8 Platform: Containers \u24d8 Collection Layer: Container Contributors: Center for Threat-Informed Defense (CTID) Version: 1.0 Created: 20 October 2021 Last Modified: 10 November 2021 Version Permalink Live Version Data Components This data source does not have any techniques in the selected domain(s) Container: Container Creation Initial construction of a new container (ex: docker create ) Container: Container Creation Initial construction of a new container (ex: docker create ) Domain ID Name Detects Enterprise T1610 Deploy Container Monitor for newly constructed containers that may deploy a container into an environment to facilitate execution or evade defenses. Enterprise T1611 Escape to Host Monitor for the deployment of suspicious or unknown container images and pods in your environment, particularly containers running as root. Enterprise T1053 Scheduled Task/Job Monitor for newly constructed containers that may abuse task scheduling functionality to facilitate initial or recurring execution of malicious code. .007 Container Orchestration Job Monitor for newly constructed containers Enterprise T1204 User Execution Monitor for newly constructed containers that may use an existing, legitimate external Web service to exfiltrate data rather than their primary command and control channel. .003 Malicious Image Track the deployment of new containers, especially from newly built images. Container: Container Enumeration An extracted list of containers (ex: docker ps) Container: Container Enumeration An extracted list of containers (ex: docker ps) Domain ID Name Detects Enterprise T1613 Container and Resource Discovery Monitor logs for actions that could be taken to gather information about container infrastructure, including the use of discovery API calls by new or unexpected users. Monitor account activity logs to see actions performed and activity associated with the Kubernetes dashboard and other web applications. Container: Container Start Activation or invocation of a container (ex: docker start or docker restart) Container: Container Start Activation or invocation of a container (ex: docker start or docker restart) Domain ID Name Detects Enterprise T1610 Deploy Container Monitor for activation or invocation of a container that may deploy a container into an environment to facilitate execution or evade defenses. Enterprise T1204 User Execution Monitor for the activation or invocation of a container (ex: docker start or docker restart) .003 Malicious Image Monitor the behavior of containers within the environment to detect anomalous behavior or malicious activity after users deploy from malicious images. References docker docs. (n.d.). Containers. Retrieved October 13, 2021. "
},
{
"id": 1976,
"title": "Script, Data Source DS0012",
"path": "/datasources/DS0012/index.html",
"content": " Script A file or stream containing a list of commands, allowing them to be launched in sequence[1][2][3] ID: DS0012 \u24d8 Platform: Windows \u24d8 Collection Layer: Host Contributors: Center for Threat-Informed Defense (CTID) Version: 1.1 Created: 20 October 2021 Last Modified: 07 December 2022 Version Permalink Live Version Data Components This data source does not have any techniques in the selected domain(s) Script: Script Execution The execution of a text file that contains code via the interpreter (e.g. Powershell, WMI, Windows EID 4104, etc.) Script: Script Execution The execution of a text file that contains code via the interpreter (e.g. Powershell, WMI, Windows EID 4104, etc.) Domain ID Name Detects Enterprise T1560 Archive Collected Data Monitor for any attempts to enable scripts running on a system would be considered suspicious. If scripts are not commonly used on a system, but enabled, scripts running out of cycle from patching or other administrator functions are suspicious. Scripts should be captured from the file system when possible to determine their actions and intent. .002 Archive via Library Monitor for any attempts to enable scripts running on a system would be considered suspicious. If scripts are not commonly used on a system, but enabled, scripts running out of cycle from patching or other administrator functions are suspicious. Scripts should be captured from the file system when possible to determine their actions and intent. .003 Archive via Custom Method Monitor for any attempts to enable scripts running on a system would be considered suspicious. If scripts are not commonly used on a system, but enabled, scripts running out of cycle from patching or other administrator functions are suspicious. Scripts should be captured from the file system when possible to determine their actions and intent. Enterprise T1119 Automated Collection Monitor for any attempts to enable scripts running on a system would be considered suspicious. If scripts are not commonly used on a system, but enabled, scripts running out of cycle from patching or other administrator functions are suspicious. Scripts should be captured from the file system when possible to determine their actions and intent. ICS T0802 Automated Collection Monitor for any attempts to enable scripts running on a system would be considered suspicious. If scripts are not commonly used on a system, but enabled, scripts running out of cycle from patching or other administrator functions are suspicious. Scripts should be captured from the file system when possible, to determine their actions and intent. Enterprise T1020 Automated Exfiltration Monitor for any attempts to enable scripts running on a system would be considered suspicious. If scripts are not commonly used on a system, but enabled, scripts running out of cycle from patching or other administrator functions are suspicious. Scripts should be captured from the file system when possible to determine their actions and intent. Enterprise T1651 Cloud Administration Command Monitor commands and scripts executed on virtual machines. In Azure, usage of Azure RunCommand can be identified via the Azure Activity Logs, and additional details on the result of executed jobs are available in the C:\\Packages\\Plugins\\Microsoft.CPlat.Core.RunCommandWindows directory on Windows virtual machines.[4] Enterprise T1059 Command and Scripting Interpreter Monitor for any attempts to enable scripts running on a system would be considered suspicious. If scripts are not commonly used on a system, but enabled, scripts running out of cycle from patching or other administrator functions are suspicious. Scripts should be captured from the file system when possible to determine their actions and intent. .001 PowerShell Monitor for any attempts to enable scripts running on a system would be considered suspicious. If scripts are not commonly used on a system, but enabled, scripts running out of cycle from patching or other administrator functions are suspicious. Scripts should be captured from the file system when possible to determine their actions and intent. .005 Visual Basic Monitor for any attempts to enable scripts running on a system would be considered suspicious. If scripts are not commonly used on a system, but enabled, scripts running out of cycle from patching or other administrator functions are suspicious. Scripts should be captured from the file system when possible to determine their actions and intent. .007 JavaScript Monitor for any attempts to enable scripts running on a system would be considered suspicious. If scripts are not commonly used on a system, but enabled, scripts running out of cycle from patching or other administrator functions are suspicious. Scripts should be captured from the file system when possible to determine their actions and intent. Enterprise T1005 Data from Local System Monitor for any attempts to enable scripts running on a system would be considered suspicious. If scripts are not commonly used on a system, but enabled, scripts running out of cycle from patching or other administrator functions are suspicious. Scripts should be captured from the file system when possible to determine their actions and intent. Data may also be acquired through Windows system management tools such as Windows Management Instrumentation and PowerShell. ICS T0893 Data from Local System Monitor for any suspicious attempts to enable scripts running on a system. If scripts are not commonly used on a system, but enabled, scripts running out of cycle from patching or other administrator functions are suspicious. Scripts should be captured from the file system when possible to determine their actions and intent. Data may also be acquired through Windows system management tools such as Windows Management Instrumentation and PowerShell. Enterprise T1140 Deobfuscate/Decode Files or Information Monitor for any attempts to enable scripts running on a system would be considered suspicious. If scripts are not commonly used on a system, but enabled, scripts running out of cycle from patching or other administrator functions are suspicious. Scripts should be captured from the file system when possible to determine their actions and intent. Enterprise T1482 Domain Trust Discovery Monitor for any attempts to enable scripts running on a system would be considered suspicious. If scripts are not commonly used on a system, but enabled, scripts running out of cycle from patching or other administrator functions are suspicious. Scripts should be captured from the file system when possible to determine their actions and intent. Enterprise T1615 Group Policy Discovery Monitor for any attempts to enable scripts running on a system would be considered suspicious. If scripts are not commonly used on a system, but enabled, scripts running out of cycle from patching or other administrator functions are suspicious. Scripts should be captured from the file system when possible to determine their actions and intent. Enterprise T1564 Hide Artifacts Monitor for any attempts to enable scripts running on a system would be considered suspicious. If scripts are not commonly used on a system, but enabled, scripts running out of cycle from patching or other administrator functions are suspicious. Scripts should be captured from the file system when possible to determine their actions and intent. .003 Hidden Window Monitor for any attempts to enable scripts running on a system would be considered suspicious. If scripts are not commonly used on a system, but enabled, scripts running out of cycle from patching or other administrator functions are suspicious. Scripts should be captured from the file system when possible to determine their actions and intent. .007 VBA Stomping Detection efforts should be placed finding differences between VBA source code and p-code.[5] VBA code can be extracted from p-code before execution with tools such as the pcodedmp disassembler. The oletools toolkit leverages the pcodedmp disassembler to detect VBA stomping by comparing keywords present in the VBA source code and p-code.[6][7] Enterprise T1562 Impair Defenses Monitor for any attempts to enable scripts running on a system would be considered suspicious. If scripts are not commonly used on a system, but enabled, scripts running out of cycle from patching or other administrator functions are suspicious. Scripts should be captured from the file system when possible to determine their actions and intent. .002 Disable Windows Event Logging Monitor for any attempts to enable scripts running on a system would be considered suspicious. If scripts are not commonly used on a system, but enabled, scripts running out of cycle from patching or other administrator functions are suspicious. Scripts should be captured from the file system when possible to determine their actions and intent. Enterprise T1056 .002 Input Capture: GUI Input Capture Monitor for any attempts to enable scripts running on a system would be considered suspicious. If scripts are not commonly used on a system, but enabled, scripts running out of cycle from patching or other administrator functions are suspicious. Scripts should be captured from the file system when possible to determine their actions and intent. Enterprise T1559 Inter-Process Communication Monitor for any attempts to enable scripts running on a system would be considered suspicious. If scripts are not commonly used on a system, but enabled, scripts running out of cycle from patching or other administrator functions are suspicious. Scripts should be captured from the file system when possible to determine their actions and intent. .001 Component Object Model Monitor for any attempts to enable scripts running on a system would be considered suspicious. Enumeration of COM objects, via Query Registry or PowerShell, may also proceed malicious use.[8][9] .002 Dynamic Data Exchange Monitor for any attempts to enable scripts running on a system would be considered suspicious. OLE and Office Open XML files can be scanned for \u2018DDEAUTO', \u2018DDE\u2019, and other strings indicative of DDE execution.https://blog.nviso.be/2017/10/11/detecting-dde-in-ms-office-documents/ Enterprise T1556 .005 Modify Authentication Process: Reversible Encryption Consider monitoring and/or blocking suspicious execution of Active Directory PowerShell modules, such as Set-ADUser and Set-ADAccountControl, that change account configurations. ICS T0840 Network Connection Enumeration Monitor for any attempts to enable scripts running on a system would be considered suspicious. If scripts are not commonly used on a system, but enabled, scripts running out of cycle from patching or other administrator functions are suspicious. Scripts should be captured from the file system when possible to determine their actions and intent. Enterprise T1027 Obfuscated Files or Information Monitor executed scripts for indicators of obfuscation and potentially suspicious command syntax, such as uninterpreted escape characters (e.g., ^). Also monitor commands within scripts for syntax-specific signs of obfuscation, such as encoded or otherwise unreadable blobs of characters. .010 Command Obfuscation Monitor executed scripts for indicators of obfuscation and potentially suspicious command syntax, such as uninterpreted escape characters (e.g., ^). Also monitor commands within scripts for syntax-specific signs of obfuscation, such as encoded or otherwise unreadable blobs of characters. Enterprise T1620 Reflective Code Loading Similarly, AMSI / ETW traces can be used to identify signs of arbitrary code execution from within the memory of potentially compromised processes.[10][11] ICS T0853 Scripting Monitor for any attempts to enable scripts running on a system would be considered suspicious. If scripts are not commonly used on a system, but enabled, scripts running out of cycle from patching or other administrator functions are suspicious. Scripts should be captured from the file system when possible to determine their actions and intent. Enterprise T1016 System Network Configuration Discovery Monitor for any attempts to enable scripts running on a system would be considered suspicious. If scripts are not commonly used on a system, but enabled, scripts running out of cycle from patching or other administrator functions are suspicious. Scripts should be captured from the file system when possible to determine their actions and intent. Enterprise T1216 System Script Proxy Execution Monitor for any attempts to enable scripts running on a system would be considered suspicious. If scripts are not commonly used on a system, but enabled, scripts running out of cycle from patching or other administrator functions are suspicious. Scripts should be captured from the file system when possible to determine their actions and intent. .001 PubPrn Monitor for any attempts to enable scripts running on a system would be considered suspicious. If scripts are not commonly used on a system, but enabled, scripts running out of cycle from patching or other administrator functions are suspicious. Scripts should be captured from the file system when possible to determine their actions and intent. References Microsoft. (2020, March 30). about_Logging_Windows. Retrieved September 28, 2021. Dunwoody, M. (2016, February 11). Greater Visibility Through PowerShell Logging. Retrieved September 28, 2021. Microsoft. (2019, April 19). Antimalware Scan Interface (AMSI). Retrieved September 28, 2021. Adrien Bataille, Anders Vejlby, Jared Scott Wilson, and Nader Zaveri. (2021, December 14). Azure Run Command for Dummies. Retrieved March 13, 2023. Sayre, K., Ogden, H., Roberts, C. (2018, October 10). VBA Stomping \u2014 Advanced Maldoc Techniques. Retrieved September 17, 2020. Bontchev, V. (2019, July 30). pcodedmp.py - A VBA p-code disassembler. Retrieved September 17, 2020. decalage2. (2019, December 3). python-oletools. Retrieved September 18, 2020. Hamilton, C. (2019, June 4). Hunting COM Objects. Retrieved June 10, 2019. Nelson, M. (2017, January 5). Lateral Movement using the MMC20 Application COM Object. Retrieved November 21, 2017. MDSec Research. (n.d.). Detecting and Advancing In-Memory .NET Tradecraft. Retrieved October 4, 2021. The Wover. (2019, May 9). Donut - Injecting .NET Assemblies as Shellcode. Retrieved October 4, 2021. "
},
{
"id": 1977,
"title": "Pod, Data Source DS0014",
"path": "/datasources/DS0014/index.html",
"content": " Pod A single unit of shared resources within a cluster, comprised of one or more containers[1][2] ID: DS0014 \u24d8 Platform: Containers \u24d8 Collection Layer: Container Contributors: Center for Threat-Informed Defense (CTID) Version: 1.0 Created: 20 October 2021 Last Modified: 10 November 2021 Version Permalink Live Version Data Components This data source does not have any techniques in the selected domain(s) Pod: Pod Creation Initial construction of a new pod (ex: kubectl apply|run) Pod: Pod Creation Initial construction of a new pod (ex: kubectl apply|run) Domain ID Name Detects Enterprise T1610 Deploy Container Monitor for newly constructed pods that may deploy a container into an environment to facilitate execution or evade defenses. Pod: Pod Enumeration An extracted list of pods within a cluster (ex: kubectl get pods) Pod: Pod Enumeration An extracted list of pods within a cluster (ex: kubectl get pods) Domain ID Name Detects Enterprise T1613 Container and Resource Discovery Monitor logs for actions that could be taken to gather information about pods, including the use of discovery API calls by new or unexpected users. Monitor account activity logs to see actions performed and activity associated with the Kubernetes dashboard and other web applications. Pod: Pod Modification Changes made to a pod, including its settings and/or control data (ex: kubectl set|patch|edit) Pod: Pod Modification Changes made to a pod, including its settings and/or control data (ex: kubectl set|patch|edit) Domain ID Name Detects Enterprise T1610 Deploy Container Monitor for changes made to pods for unexpected modifications to settings and/or control data that may deploy a container into an environment to facilitate execution or evade defenses. References kubernetes. (n.d.). kubectl. Retrieved October 13, 2021. kubenetes. (n.d.). Pod v1 core. Retrieved October 13, 2021. "
},
{
"id": 1978,
"title": "Instance, Data Source DS0030",
"path": "/datasources/DS0030/index.html",
"content": " Instance A virtual server environment which runs workloads, hosted on-premise or by third-party cloud providers[1][2] ID: DS0030 \u24d8 Platform: IaaS \u24d8 Collection Layer: Cloud Control Plane Version: 1.0 Created: 20 October 2021 Last Modified: 20 October 2021 Version Permalink Live Version Data Components This data source does not have any techniques in the selected domain(s) Instance: Instance Creation Initial construction of a new instance (ex: instance.insert within GCP Audit Logs) Instance: Instance Creation Initial construction of a new instance (ex: instance.insert within GCP Audit Logs) Domain ID Name Detects Enterprise T1578 Modify Cloud Compute Infrastructure The creation of a new instance or VM is a common part of operations within many cloud environments. Events should then not be viewed in isolation, but as part of a chain of behavior that could lead to other activities. For example, the creation of an instance by a new user account or the unexpected creation of one or more snapshots followed by the creation of an instance may indicate suspicious activity.In AWS, CloudTrail logs capture the creation of an instance in the RunInstances event, and in Azure the creation of a VM may be captured in Azure activity logs.[3] [4] Google's Admin Activity audit logs within their Cloud Audit logs can be used to detect the usage of gcloud compute instances create to create a VM.[5] .002 Create Cloud Instance The creation of a new instance or VM is a common part of operations within many cloud environments. Events should then not be viewed in isolation, but as part of a chain of behavior that could lead to other activities. For example, the creation of an instance by a new user account or the unexpected creation of one or more snapshots followed by the creation of an instance may indicate suspicious activity.In AWS, CloudTrail logs capture the creation of an instance in the RunInstances event, and in Azure the creation of a VM may be captured in Azure activity logs.[3] [4] Google's Admin Activity audit logs within their Cloud Audit logs can be used to detect the usage of gcloud compute instances create to create a VM.[5] Enterprise T1535 Unused/Unsupported Cloud Regions Monitor system logs to review instance activities occurring across all cloud environments and regions. Enterprise T1204 User Execution Monitor for newly constructed instances that may use an existing, legitimate external Web service to exfiltrate data rather than their primary command and control channel. .003 Malicious Image Monitor for newly constructed instances that may attempt to take advantage of a weakness in an Internet-facing computer or program using software, data, or commands in order to cause unintended or unanticipated behavior. Instance: Instance Deletion Removal of an instance (ex: instance.delete within GCP Audit Logs) Instance: Instance Deletion Removal of an instance (ex: instance.delete within GCP Audit Logs) Domain ID Name Detects Enterprise T1485 Data Destruction Monitor for unexpected deletion of an instance (ex: instance.delete within GCP Audit Logs) Enterprise T1578 Modify Cloud Compute Infrastructure The deletion of a new instance or virtual machine is a common part of operations within many cloud environments. Events should then not be viewed in isolation, but as part of a chain of behavior that could lead to other activities. For example, detecting a sequence of events such as the creation of an instance, mounting of a snapshot to that instance, and deletion of that instance by a new user account may indicate suspicious activity. In AWS, CloudTrail logs capture the deletion of an instance in the TerminateInstances event, and in Azure the deletion of a VM may be captured in Azure activity logs.[3] [4] Google's Admin Activity audit logs within their Cloud Audit logs can be used to detect the usage of gcloud compute instances delete to delete a VM.[5] .003 Delete Cloud Instance The deletion of a new instance or virtual machine is a common part of operations within many cloud environments. Events should then not be viewed in isolation, but as part of a chain of behavior that could lead to other activities. For example, detecting a sequence of events such as the creation of an instance, mounting of a snapshot to that instance, and deletion of that instance by a new user account may indicate suspicious activity. In AWS, CloudTrail logs capture the deletion of an instance in the TerminateInstances event, and in Azure the deletion of a VM may be captured in Azure activity logs.[3] [4] Google's Admin Activity audit logs within their Cloud Audit logs can be used to detect the usage of gcloud compute instances delete to delete a VM.[5] Instance: Instance Enumeration An extracted list of instances within a cloud environment (ex: instance.list within GCP Audit Logs) Instance: Instance Enumeration An extracted list of instances within a cloud environment (ex: instance.list within GCP Audit Logs) Domain ID Name Detects Enterprise T1580 Cloud Infrastructure Discovery Monitor cloud logs for API calls and other potentially unusual activity related to cloud instance enumeration. Discovery techniques normally occur throughout an operation as an adversary learns the environment. Data and events should not be viewed in isolation, but as part of a chain of behavior that could lead to other activities, such as Collection and Exfiltration, based on the information obtained. Instance: Instance Metadata Contextual data about an instance and activity around it such as name, type, or status Instance: Instance Metadata Contextual data about an instance and activity around it such as name, type, or status Domain ID Name Detects Enterprise T1578 Modify Cloud Compute Infrastructure Periodically baseline instances to identify malicious modifications or additions. .002 Create Cloud Instance Periodically baseline instances to identify malicious modifications or additions. .003 Delete Cloud Instance Periodically baseline instances to identify malicious modifications or additions. .004 Revert Cloud Instance Periodically baseline instances to identify malicious modifications or additions. Enterprise T1535 Unused/Unsupported Cloud Regions Monitor and consider configuring alerting to notify of activity in normally unused regions or if the number of instances active in a region goes above a certain threshold. Instance: Instance Modification Changes made to an instance, including its settings and/or control data (ex: instance.addResourcePolicies or instances.setMetadata within GCP Audit Logs) Instance: Instance Modification Changes made to an instance, including its settings and/or control data (ex: instance.addResourcePolicies or instances.setMetadata within GCP Audit Logs) Domain ID Name Detects Enterprise T1578 Modify Cloud Compute Infrastructure Establish centralized logging of instance activity, which can be used to monitor and review system events even after reverting to a snapshot, rolling back changes, or changing persistence/type of storage. Monitor specifically for events related to snapshots and rollbacks and VM configuration changes, that are occurring outside of normal activity. To reduce false positives, valid change management procedures could introduce a known identifier that is logged with the change (e.g., tag or header) if supported by the cloud provider, to help distinguish valid, expected actions from malicious ones. .004 Revert Cloud Instance Establish centralized logging of instance activity, which can be used to monitor and review system events even after reverting to a snapshot, rolling back changes, or changing persistence/type of storage. Monitor specifically for events related to snapshots and rollbacks and VM configuration changes, that are occurring outside of normal activity. To reduce false positives, valid change management procedures could introduce a known identifier that is logged with the change (e.g., tag or header) if supported by the cloud provider, to help distinguish valid, expected actions from malicious ones. Instance: Instance Start Activation or invocation of an instance (ex: instance.start within GCP Audit Logs) Instance: Instance Start Activation or invocation of an instance (ex: instance.start within GCP Audit Logs) Domain ID Name Detects Enterprise T1578 Modify Cloud Compute Infrastructure Establish centralized logging of instance activity, which can be used to monitor and review system events even after reverting to a snapshot, rolling back changes, or changing persistence/type of storage. Monitor specifically for events related to activation of instances that are occurring outside of normal activity/planned operations. To reduce false positives, valid change management procedures could introduce a known identifier that is logged with the change (e.g., tag or header) if supported by the cloud provider, to help distinguish valid, expected actions from malicious ones. .004 Revert Cloud Instance Establish centralized logging of instance activity, which can be used to monitor and review system events even after reverting to a snapshot, rolling back changes, or changing persistence/type of storage. Monitor specifically for events related to activation of instances that are occurring outside of normal activity/planned operations. To reduce false positives, valid change management procedures could introduce a known identifier that is logged with the change (e.g., tag or header) if supported by the cloud provider, to help distinguish valid, expected actions from malicious ones. Enterprise T1204 User Execution Monitor for the activation or invocation of an instance (ex: instance.start within GCP Audit Logs) .003 Malicious Image Monitor for the activation or invocation of an instance (ex: instance.start within GCP Audit Logs) Instance: Instance Stop Deactivation or stoppage of an instance (ex: instance.stop within GCP Audit Logs) Instance: Instance Stop Deactivation or stoppage of an instance (ex: instance.stop within GCP Audit Logs) Domain ID Name Detects Enterprise T1578 Modify Cloud Compute Infrastructure Establish centralized logging of instance activity, which can be used to monitor and review system events even after reverting to a snapshot, rolling back changes, or changing persistence/type of storage. Monitor specifically for events related to deactivation of instances that are occurring outside of planned operations. To reduce false positives, valid change management procedures could introduce a known identifier that is logged with the change (e.g., tag or header) if supported by the cloud provider, to help distinguish valid, expected actions from malicious ones. .004 Revert Cloud Instance Establish centralized logging of instance activity, which can be used to monitor and review system events even after reverting to a snapshot, rolling back changes, or changing persistence/type of storage. Monitor specifically for events related to deactivation of instances that are occurring outside of planned operations. To reduce false positives, valid change management procedures could introduce a known identifier that is logged with the change (e.g., tag or header) if supported by the cloud provider, to help distinguish valid, expected actions from malicious ones. References Microsoft. (n.d.). What is a virtual machine (VM)?. Retrieved October 13, 2021. Google. (n.d.). Virtual machine instances. Retrieved October 13, 2021. Amazon. (n.d.). Search CloudTrail logs for API calls to EC2 Instances. Retrieved June 17, 2020. Microsoft. (n.d.). View Azure activity logs. Retrieved June 17, 2020. Google. (n.d.). Audit Logs. Retrieved June 1, 2020. "
},
{
"id": 1979,
"title": "Driver, Data Source DS0027",
"path": "/datasources/DS0027/index.html",
"content": " Driver A computer program that operates or controls a particular type of device that is attached to a computer. Provides a software interface to hardware devices, enabling operating systems and other computer programs to access hardware functions without needing to know precise details about the hardware being used[1][2] ID: DS0027 \u24d8 Platforms: Linux, Windows, macOS \u24d8 Collection Layer: Host Contributors: Center for Threat-Informed Defense (CTID) Version: 1.0 Created: 20 October 2021 Last Modified: 30 March 2022 Version Permalink Live Version Data Components This data source does not have any techniques in the selected domain(s) Driver: Driver Load Attaching a driver to either user or kernel-mode of a system (ex: Sysmon EID 6) Driver: Driver Load Attaching a driver to either user or kernel-mode of a system (ex: Sysmon EID 6) Domain ID Name Detects Enterprise T1547 Boot or Logon Autostart Execution Monitor for unusual kernel driver installation activity that may configure system settings to automatically execute a program during system boot or logon to maintain persistence or gain higher-level privileges on compromised systems. .008 LSASS Driver With LSA Protection enabled, monitor the event logs (Events 3033 and 3063) for failed attempts to load LSA plug-ins and drivers. [3] Utilize the Sysinternals Autoruns/Autorunsc utility [4] to examine loaded drivers associated with the LSA. .012 Print Processors Monitor for unusual kernel driver installation activity that may abuse print processors to run malicious DLLs during system boot for persistence and/or privilege escalation. Enterprise T1543 Create or Modify System Process Monitor for new service driver installations and loads (ex: Sysmon Event ID 6) that are not part of known software update/patch cycles. .003 Windows Service Monitor for new service driver installations and loads (ex: Sysmon Event ID 6) that are not part of known software update/patch cycles. Note: Sysmon Event ID 6 (driver load) provides information on whether the loaded driver was signed with a valid signature (via the Signature and SignatureStatus fields). As such, one way to help reduce the volume of alerts and false positives associated with this event is to filter and exclude any driver load events signed by common and legitimate publishers like Microsoft. Enterprise T1561 Disk Wipe Monitor for unusual kernel driver installation activity that may wipe or corrupt raw disk data on specific systems or in large numbers in a network to interrupt availability to system and network resources. .001 Disk Content Wipe Monitor for unusual kernel driver installation activity may erase the contents of storage devices on specific systems or in large numbers in a network to interrupt availability to system and network resources. .002 Disk Structure Wipe Monitor for unusual kernel driver installation activity may corrupt or wipe the disk data structures on a hard drive necessary to boot a system; targeting specific critical systems or in large numbers in a network to interrupt availability to system and network resources. Enterprise T1068 Exploitation for Privilege Escalation Detecting software exploitation may be difficult depending on the tools available. Software exploits may not always succeed or may cause the exploited process to become unstable or crash. Also look for behavior on the endpoint system that might indicate successful compromise, such as abnormal behavior of the processes. This could include suspicious files written to disk, evidence of Process Injection for attempts to hide execution or evidence of Discovery. Consider monitoring for the presence or loading (ex: Sysmon Event ID 6) of known vulnerable drivers that adversaries may drop and exploit to execute code in kernel mode.[5] Higher privileges are often necessary to perform additional actions such as some methods of OS Credential Dumping. Look for additional activity that may indicate an adversary has gained higher privileges. Enterprise T1562 Impair Defenses Monitor for unusual/suspicious driver activity, especially regarding EDR and drivers associated with security tools as well as those that may be abused to disable security products. .001 Disable or Modify Tools Monitor for unusual/suspicious driver activity, especially regarding EDR and drivers associated with security tools as well as those that may be abused to disable security products. Enterprise T1056 Input Capture Monitor for unusual kernel driver installation activity .001 Keylogging Monitor for unusual kernel driver installation activity Enterprise T1111 Multi-Factor Authentication Interception Monitor for use of proxied smart card connections by an adversary may be difficult because it requires the token to be inserted into a system; thus it is more likely to be in use by a legitimate user and blend in with other network behavior. Similar to Input Capture, keylogging activity can take various forms but can may be detected via installation of a driver. Driver: Driver Metadata Contextual data about a driver and activity around it such as driver issues reporting or integrity (page hash, code) checking Driver: Driver Metadata Contextual data about a driver and activity around it such as driver issues reporting or integrity (page hash, code) checking Domain ID Name Detects Enterprise T1542 Pre-OS Boot Disk check, forensic utilities, and data from device drivers (i.e. processes and API calls) may reveal anomalies that warrant deeper investigation .002 Component Firmware Monitor for unexpected disk partition table entries, or blocks of otherwise unusual memory that warrant deeper investigation References Apple. (2014, April 9). What Is the I/O Kit?. Retrieved September 24, 2021. Viviano, A. (2021, August 17). Getting started with Windows drivers: User mode and kernel mode. Retrieved September 24, 2021. Microsoft. (2014, March 12). Configuring Additional LSA Protection. Retrieved November 27, 2017. Russinovich, M. (2016, January 4). Autoruns for Windows v13.51. Retrieved June 6, 2016. Microsoft. (2020, October 15). Microsoft recommended driver block rules. Retrieved March 16, 2021. "
},
{
"id": 1980,
"title": "Process, Data Source DS0009",
"path": "/datasources/DS0009/index.html",
"content": " Process Instances of computer programs that are being executed by at least one thread. Processes have memory space for process executables, loaded modules (DLLs or shared libraries), and allocated memory regions containing everything from user input to application-specific data structures[1] ID: DS0009 \u24d8 Platforms: Android, Linux, Windows, iOS, macOS \u24d8 Collection Layer: Host Contributors: Center for Threat-Informed Defense (CTID) Version: 1.1 Created: 20 October 2021 Last Modified: 20 April 2023 Version Permalink Live Version Data Components This data source does not have any techniques in the selected domain(s) Process: OS API Execution Operating system function/method calls executed by a process Process: OS API Execution Operating system function/method calls executed by a process Domain ID Name Detects Enterprise T1548 Abuse Elevation Control Mechanism Also look for any process API calls for behavior that may be indicative of Process Injection. Monitoring OS API callbacks for the execution can also be a way to detect this behavior but requires specialized security tooling. .004 Elevated Execution with Prompt Monitoring OS API callbacks for the execution can also be a way to detect this behavior but requires specialized security tooling. Enterprise T1134 Access Token Manipulation Monitor for API calls, loaded by a payload, for token manipulation only through careful analysis of user network activity, examination of running processes, and correlation with other endpoint and network behavior. There are many Windows API calls a payload can take advantage of to manipulate access tokens (e.g., LogonUser [2], DuplicateTokenEx[3], and ImpersonateLoggedOnUser[4]). Please see the referenced Windows API pages for more information. .001 Token Impersonation/Theft Monitor for API calls associated with other suspicious behavior to reduce false positives that may be due to normal benign use by users and administrators, such as DuplicateToken(Ex), ImpersonateLoggedOnUser , and SetThreadToken. .002 Create Process with Token Monitor for API calls associated with detecting token manipulation only through careful analysis of user activity, examination of running processes, and correlation with other endpoint and network behavior. Analysts can also monitor for use of Windows APIs such as CreateProcessWithTokenW and correlate activity with other suspicious behavior to reduce false positives that may be due to normal benign use by users and administrators. .003 Make and Impersonate Token Monitor for API calls associated with detecting token manipulation only through careful analysis of user activity, examination of running processes, and correlation with other endpoint and network behavior, such as LogonUser and SetThreadToken. Correlate activity with other suspicious behavior to reduce false positives that may be due to normal benign use by users and administrators .004 Parent PID Spoofing Monitor for API calls to CreateProcess/CreateProcessA, specifically those from user/potentially malicious processes and with parameters explicitly assigning PPIDs (ex: the Process Creation Flags of 0x8XXX, indicating that the process is being created with extended startup information[5]). Malicious use of CreateProcess/CreateProcessA may also be proceeded by a call to UpdateProcThreadAttribute, which may be necessary to update process creation attributes.[6]This may generate false positives from normal UAC elevation behavior, so compare to a system baseline/understanding of normal system activity if possible. .005 SID-History Injection Monitor for API calls, such as PowerShell's Get-ADUser cmdlet or Windows API DsAddSidHistory function, to examine data in user\u2019s SID-History attributes, especially users who have SID-History values from the same domain. Enterprise T1087 .001 Account Discovery: Local Account Monitor for API calls (such as NetUserEnum()) that may attempt to gather local accounts information such as type of user, privileges and groups. .002 Account Discovery: Domain Account Monitor for API calls that may attempt to gather information about domain accounts such as type of user, privileges and groups. Enterprise T1010 Application Window Discovery Monitor for API calls (such as GetForegroundWindow()) that may attempt to get a listing of open application windows. GetForegroundWindow api returns a handle to the foreground window (the window with which the user is currently working). Other API calls relevant to Local Group discovery include GetProcesses and GetForegroundWindow. GetProcesses api returns an array of type Process that represents all the process resources running on the local computer. Note: Most EDR tools do not support direct monitoring of API calls due to the sheer volume of calls produced by an endpoint but may have alerts or events that are based on abstractions of OS API calls. Dynamic malware analysis tools (i.e., sandboxes) can be used to trace the execution, including OS API calls, for a single PE binary. Analytic 1 - Suspicious API Calls suspicious_apis = filter processes where ApiName LIKE '%GetProcesses%' OR ApiName LIKE '%GetForegroundWindow%' Enterprise T1123 Audio Capture Monitor for API calls associated with leveraging a computer's peripheral devices (e.g., microphones and webcams) or applications (e.g., voice and video call services) to capture audio recordings for the purpose of listening into sensitive conversations to gather information. Enterprise T1547 Boot or Logon Autostart Execution Monitor for API calls that may configure system settings to automatically execute a program during system boot or logon to maintain persistence or gain higher-level privileges on compromised systems. .010 Port Monitors Monitor process API calls to AddMonitor.[7] .012 Print Processors Monitor process API calls to AddPrintProcessor and GetPrintProcessorDirectory. Enterprise T1115 Clipboard Data Monitor API calls that could collect data stored in the clipboard from users copying information within or between applications. Enterprise T1059 .002 Command and Scripting Interpreter: AppleScript Monitor for execution of AppleScript through osascript and usage of the NSAppleScript and OSAScript APIs that may be related to other suspicious behavior occurring on the system. Enterprise T1543 Create or Modify System Process Monitor for API calls that may create or modify system-level processes to repeatedly execute malicious payloads as part of persistence. .003 Windows Service Monitor for API calls that may create or modify Windows services (ex: CreateServiceW()) to repeatedly execute malicious payloads as part of persistence. Enterprise T1555 Credentials from Password Stores Monitor for API calls that may search for common password storage locations to obtain user credentials. .001 Keychain Monitor for Keychain Services API calls, specifically legacy extensions such as SecKeychainFindInternetPassword, that may collect Keychain data from a system to acquire credentials.[8] .003 Credentials from Web Browsers Monitor for API calls that may acquire credentials from web browsers by reading files specific to the target browser.[9] .004 Windows Credential Manager Consider monitoring API calls such as CredEnumerateA that may list credentials from the Windows Credential Manager.[10][11] .005 Password Managers Monitor for API calls that may search for common password storage locations to obtain user credentials. Enterprise T1005 Data from Local System Monitor for API calls that may search local system sources, such as file systems or local databases, to find files of interest and sensitive data prior to Exfiltration. ICS T0893 Data from Local System Monitor for API calls that may search local system sources, such as file systems or local databases, to find files of interest and sensitive data. Enterprise T1565 Data Manipulation Monitor for API calls associated with altering data. Remote access tools with built-in features may interact directly with the Windows API to gather information. .002 Transmitted Data Manipulation Monitor for API calls associated with altering data. Remote access tools with built-in features may interact directly with the Windows API to gather information. .003 Runtime Data Manipulation Monitor for API calls associated with altering data. Remote access tools with built-in features may interact directly with the Windows API to gather information. Enterprise T1622 Debugger Evasion Monitor for API calls (such as IsDebuggerPresent()) that may employ various means to detect and avoid debugged environments. Detecting actions related to debugger identification may be difficult depending on the adversary's implementation and monitoring required. Enterprise T1652 Device Driver Discovery Monitor for API calls (such as EnumDeviceDrivers()) that may attempt to gather information about local device drivers. Enterprise T1482 Domain Trust Discovery Monitor for API calls associated with gathering information on domain trust relationships that may be used to identify lateral movement like DSEnumerateDomainTrusts() Win32 API call to spot activity associated with Domain Trust Discovery.[12] Information may also be acquired through Windows system management tools such as PowerShell. The .NET method GetAllTrustRelationships() can be an indicator of Domain Trust Discovery.[13] Enterprise T1611 Escape to Host Monitor for unexpected usage of syscalls such as mount that may indicate an attempt to escape from a privileged container to host. Enterprise T1546 .009 Event Triggered Execution: AppCert DLLs Monitor and analyze application programming interface (API) calls that are indicative of Registry edits, such as RegCreateKeyEx and RegSetValueEx. [14] .010 Event Triggered Execution: AppInit DLLs Monitor and analyze application programming interface (API) calls that are indicative of Registry edits such as RegCreateKeyEx and RegSetValueEx. [14] ICS T0871 Execution through API Devices that provide user access to the underlying operating system may allow the installation of custom software to monitor OS API execution. Monitoring API calls may generate a significant amount of data and may not be useful for defense unless collected under specific circumstances, since benign use of API functions are common and may be difficult to distinguish from malicious behavior. Correlation of other events with behavior surrounding API function calls using API monitoring will provide additional context to an event that may assist in determining if it is due to malicious behavior. Enterprise T1083 File and Directory Discovery Monitor for API calls that may enumerate files and directories or may search in specific locations of a host or network share for certain information within a file system. Enterprise T1564 Hide Artifacts Monitor for API calls that may attempt to hide artifacts associated with their behaviors to evade detection. .004 NTFS File Attributes Monitor calls to the ZwSetEaFile and ZwQueryEaFile Windows API functions as well as binaries used to interact with EA, [15] [16] and consider regularly scanning for the presence of modified information. [17] Enterprise T1574 .013 Hijack Execution Flow: KernelCallbackTable Monitoring Windows API calls indicative of the various types of code injection may generate a significant amount of data and may not be directly useful for defense unless collected under specific circumstances. for known bad sequence of calls, since benign use of API functions may be common and difficult to distinguish from malicious behavior. Windows API calls such as WriteProcessMemory() and NtQueryInformationProcess() with the parameter set to ProcessBasicInformation may be used for this technique.[18] ICS T0874 Hooking Monitor for API calls that can be used to install a hook procedure, such as the SetWindowsHookEx and SetWinEventHook functions.[19][20] Also consider analyzing hook chains (which hold pointers to hook procedures for each type of hook) using tools[20][21][22] or by programmatically examining internal kernel structures.[23][24] Enterprise T1562 Impair Defenses Monitor for the abnormal execution of API functions associated with system logging. .012 Disable or Modify Linux Audit System Monitor for abnormal execution of syslog and other functions associated with system logging. Enterprise T1070 Indicator Removal Monitor for API calls that may delete or alter generated artifacts on a host system, including logs or captured files such as quarantined malware. .001 Clear Windows Event Logs Monitor for Windows API calls that may clear Windows Event Logs to hide the activity of an intrusion. ICS T0872 Indicator Removal on Host Monitor for API calls that may delete or alter generated artifacts on a host system, including logs or captured files such as quarantined malware. Enterprise T1056 Input Capture Monitor for API calls to SetWindowsHook, GetKeyState, and GetAsyncKeyState [25] .001 Keylogging Monitor for API calls to the SetWindowsHook, GetKeyState, and GetAsyncKeyState.[25] and look for common keylogging API calls. API calls alone are not an indicator of keylogging, but may provide behavioral data that is useful when combined with other information such as new files written to disk and unusual processes. .004 Credential API Hooking Monitor for API calls to the SetWindowsHookEx and SetWinEventHook functions, which install a hook procedure.[19][20] Also consider analyzing hook chains (which hold pointers to hook procedures for each type of hook) using tools[20][21][22] or by programmatically examining internal kernel structures.[23][24] Enterprise T1036 Masquerading Monitor for API calls such as fork() which can be abused to masquerade or manipulate process metadata. .009 Break Process Trees Monitor for API calls such as fork() which can be abused to masquerade or manipulate process metadata. Enterprise T1556 Modify Authentication Process Monitor for calls to OpenProcess that can be used to manipulate lsass.exe running on a domain controller as well as for malicious modifications to functions exported from authentication-related system DLLs (such as cryptdll.dll and samsrv.dll).[26] Monitor for abnormal API calls to NPLogonNotify() that may highlight malicious network provider DLLs.[27] .001 Domain Controller Authentication Monitor for API calls to OpenProcess that can be used to manipulate lsass.exe running on a domain controller .008 Network Provider DLL Monitor for abnormal API calls to NPLogonNotify().[27] Enterprise T1112 Modify Registry Monitor for API calls associated with concealing Registry keys, such as Reghide. [28] Inspect and cleanup malicious hidden Registry entries using Native Windows API calls and/or tools such as Autoruns [29] and RegDelNull [30]. Other API calls relevant to Registry Modification include RegOpenKeyExA, RegCreateKeyExA, RegDeleteKeyExA, RegDeleteValueExA, RegEnumKeyExA, RegEnumValueExA, among others. Note: Most EDR tools do not support direct monitoring of API calls due to the sheer volume of calls produced by an endpoint but may have alerts or events that are based on abstractions of OS API calls. Dynamic malware analysis tools (i.e., sandboxes) can be used to trace the execution, including OS API calls, for a single PE binary. Enterprise T1111 Multi-Factor Authentication Interception Monitor for API calls associated with polling to intercept keystrokes. Enterprise T1106 Native API Monitoring API calls may generate a significant amount of data and may not be useful for defense unless collected under specific circumstances, since benign use of API functions are common and may be difficult to distinguish from malicious behavior. Correlation of other events with behavior surrounding API function calls using API monitoring will provide additional context to an event that may assist in determining if it is due to malicious behavior. Correlation of activity by process lineage by process ID may be sufficient. ICS T0834 Native API Devices that provide user access to the underlying operating system may allow the installation of custom software to monitor OS API execution. Monitoring API calls may generate a significant amount of data and may not be useful for defense unless collected under specific circumstances, since benign use of API functions are common and may be difficult to distinguish from malicious behavior. Correlation of other events with behavior surrounding API function calls using API monitoring will provide additional context to an event that may assist in determining if it is due to malicious behavior. ICS T0840 Network Connection Enumeration Monitor for API calls (such as GetAdaptersInfo() and GetIpNetTable()) that may gather details about the network configuration and settings, such as IP and/or MAC addresses. Also monitor for API calls that may attempt to get a listing of network connections to or from the compromised system they are currently accessing or from remote systems by querying for information over the network. For added context on adversary procedures and background see System Network Configuration Discovery and System Network Connections Discovery. Enterprise T1135 Network Share Discovery Monitor for API calls that may look for folders and drives shared on remote systems as a means of identifying sources of information to gather as a precursor for Collection and to identify potential systems of interest for Lateral Movement. Enterprise T1027 Obfuscated Files or Information Monitor and analyze calls to functions such as GetProcAddress() that are associated with malicious code obfuscation.[31] .007 Dynamic API Resolution Monitor and analyze calls to functions such as GetProcAddress() and LoadLibrary() that are associated with dynamically loading API functions.[31] Enterprise T1003 OS Credential Dumping Monitor for API calls that may attempt to dump credentials to obtain account login and credential material, normally in the form of a hash or a clear text password, from the operating system and software. .001 LSASS Memory Monitor for API calls that may attempt to access credential material stored in the process memory of the Local Security Authority Subsystem Service (LSASS). OS API calls associated with LSASS process dumping include OpenProcess and MiniDumpWriteDump. Execution of these functions might trigger security log ids such as 4663 (Microsoft Security Auditing) and 10 (Microsoft Sysmon) Note: Most EDR tools do not support direct monitoring of API calls due to the sheer volume of calls produced by an endpoint but may have alerts or events that are based on abstractions of OS API calls. Dynamic malware analysis tools (i.e., sandboxes) can be used to trace the execution, including OS API calls, for a single PE binary. Enterprise T1120 Peripheral Device Discovery Monitor for API calls that may attempt to gather information about attached peripheral devices and components connected to a computer system. Enterprise T1069 .001 Permission Groups Discovery: Local Groups Monitor for API calls associated with finding local system groups and permission settings, such as NetLocalGroupEnum. Other API calls relevant to Local Group discovery include NetQueryDisplayInformation and NetGetDisplayInformationIndex. Note: Most EDR tools do not support direct monitoring of API calls due to the sheer volume of calls produced by an endpoint but may have alerts or events that are based on abstractions of OS API calls. Dynamic malware analysis tools (i.e., sandboxes) can be used to trace the execution, including OS API calls, for a single PE binary. .002 Permission Groups Discovery: Domain Groups Monitor for API calls associated with finding domain-level groups and permission settings, such as NetGroupEnum. Other API calls relevant to Domain Group discovery include NetQueryDisplayInformation and NetGetDisplayInformationIndex. Note: Most EDR tools do not support direct monitoring of API calls due to the sheer volume of calls produced by an endpoint but may have alerts or events that are based on abstractions of OS API calls. Dynamic malware analysis tools (i.e., sandboxes) can be used to trace the execution, including OS API calls, for a single PE binary. Enterprise T1542 Pre-OS Boot Monitor for API calls that may abuse Pre-OS Boot mechanisms as a way to establish persistence on a system. Disk check, forensic utilities, and data from device drivers (i.e. API calls) may reveal anomalies that warrant deeper investigation. [32] .002 Component Firmware Monitor for API calls associated with the use of device drivers and/or provided by SMART (Self-Monitoring, Analysis and Reporting Technology) [33] [34] disk monitoring may reveal malicious manipulations of components. Otherwise, this technique may be difficult to detect since malicious activity is taking place on system components possibly outside the purview of OS security and integrity mechanisms. Enterprise T1057 Process Discovery Monitor for API calls may attempt to get information about running processes on a system. Enterprise T1055 Process Injection Monitoring Windows API calls indicative of the various types of code injection may generate a significant amount of data and may not be directly useful for defense unless collected under specific circumstances for known bad sequences of calls, since benign use of API functions may be common and difficult to distinguish from malicious behavior. Windows API calls such as CreateRemoteThread, SuspendThread/SetThreadContext/ResumeThread, QueueUserAPC/NtQueueApcThread, and those that can be used to modify memory within another process, such as VirtualAllocEx/WriteProcessMemory, may be used for this technique.[14] Monitoring for Linux specific calls such as the ptrace system call should not generate large amounts of data due to their specialized nature, and can be a very effective method to detect some of the common process injection methods.[35] [36] [37] [38] .001 Dynamic-link Library Injection Monitoring Windows API calls indicative of the various types of code injection may generate a significant amount of data and may not be directly useful for defense unless collected under specific circumstances for known bad sequences of calls, since benign use of API functions may be common and difficult to distinguish from malicious behavior. Windows API calls such as CreateRemoteThread and those that can be used to modify memory within another process, such as VirtualAllocEx/WriteProcessMemory, may be used for this technique.[14] Search for remote thread creations that start at LoadLibraryA or LoadLibraryW. Depending on the tool, it may provide additional information about the DLL string that is an argument to the function. If there is any security software that legitimately injects DLLs, it must be carefully whitelisted. Microsoft Windows allows for processes to remotely create threads within other processes of the same privilege level. This functionality is provided via the Windows API CreateRemoteThread. Both Windows and third-party software use this ability for legitimate purposes. For example, the Windows process csrss.exe creates threads in programs to send signals to registered callback routines. Both adversaries and host-based security software use this functionality to inject DLLs, but for very different purposes. An adversary is likely to inject into a program to evade defenses or bypass User Account Control, but a security program might do this to gain increased monitoring of API calls. One of the most common methods of DLL Injection is through the Windows API LoadLibrary. Allocate memory in the target program with VirtualAllocEx Write the name of the DLL to inject into this program with WriteProcessMemory Create a new thread and set its entry point to LoadLibrary using the API CreateRemoteThread. This behavior can be detected by looking for thread creations across processes, and resolving the entry point to determine the function name. If the function is LoadLibraryA or LoadLibraryW, then the intent of the remote thread is clearly to inject a DLL. When this is the case, the source process must be examined so that it can be ignored when it is both expected and a trusted process. Analytic 1 - DLL Injection via Load Library remote_thread = filter (start_function == \"LoadLibraryA\" or start_function == \"LoadLibraryW\")remote_thread = filter (src_image_path != \"C:\\Path\\To\\TrustedProgram.exe\") .002 Portable Executable Injection Monitoring Windows API calls indicative of the various types of code injection may generate a significant amount of data and may not be directly useful for defense unless collected under specific circumstances for known bad sequences of calls, since benign use of API functions may be common and difficult to distinguish from malicious behavior. Windows API calls such as CreateRemoteThread and those that can be used to modify memory within another process, such as VirtualAllocEx/WriteProcessMemory, may be used for this technique.[14] .003 Thread Execution Hijacking Monitoring Windows API calls indicative of the various types of code injection may generate a significant amount of data and may not be directly useful for defense unless collected under specific circumstances for known bad sequences of calls, since benign use of API functions may be common and difficult to distinguish from malicious behavior. Windows API calls such as CreateRemoteThread, SuspendThread/SetThreadContext/ResumeThread, and those that can be used to modify memory within another process, such as VirtualAllocEx/WriteProcessMemory, may be used for this technique.[14] .004 Asynchronous Procedure Call Monitoring Windows API calls indicative of the various types of code injection may generate a significant amount of data and may not be directly useful for defense unless collected under specific circumstances for known bad sequences of calls, since benign use of API functions may be common and difficult to distinguish from malicious behavior. Windows API calls such as SuspendThread/SetThreadContext/ResumeThread, QueueUserAPC/NtQueueApcThread, and those that can be used to modify memory within another process, such as VirtualAllocEx/WriteProcessMemory, may be used for this technique.[14] .005 Thread Local Storage Monitoring Windows API calls indicative of the various types of code injection may generate a significant amount of data and may not be directly useful for defense unless collected under specific circumstances for known bad sequences of calls, since benign use of API functions may be common and difficult to distinguish from malicious behavior. Windows API calls such as CreateRemoteThread, SuspendThread/SetThreadContext/ResumeThread, and those that can be used to modify memory within another process, such as VirtualAllocEx/WriteProcessMemory, may be used for this technique.[14] .008 Ptrace System Calls Monitoring for Linux specific calls such as the ptrace system call should not generate large amounts of data due to their specialized nature, and can be a very effective method to detect some of the common process injection methods.[35] [36] [37] [38] .011 Extra Window Memory Injection Monitor for API calls related to enumerating and manipulating EWM such as GetWindowLong [39] and SetWindowLong [40]. Malware associated with this technique have also used SendNotifyMessage [41] to trigger the associated window procedure and eventual malicious injection. [14] .012 Process Hollowing Monitoring Windows API calls indicative of the various types of code injection may generate a significant amount of data and may not be directly useful for defense unless collected under specific circumstances for known bad sequences of calls, since benign use of API functions may be common and difficult to distinguish from malicious behavior. Windows API calls such as CreateRemoteThread, SuspendThread/SetThreadContext/ResumeThread, and those that can be used to modify memory within another process, such as VirtualAllocEx/WriteProcessMemory, may be used for this technique.[14] .013 Process Doppelg\u00e4nging Monitor and analyze calls to CreateTransaction, CreateFileTransacted, RollbackTransaction, and other rarely used functions indicative of TxF activity. Process Doppelg\u00e4nging also invokes an outdated and undocumented implementation of the Windows process loader via calls to NtCreateProcessEx and NtCreateThreadEx as well as API calls used to modify memory within another process, such as WriteProcessMemory. [42] [43] .014 VDSO Hijacking Monitor for malicious usage of system calls, such as ptrace and mmap, that can be used to attach to, manipulate memory, then redirect a processes' execution path. Monitoring for Linux specific calls such as the ptrace system call should not generate large amounts of data due to their specialized nature, and can be a very effective method to detect some of the common process injection methods.[35][36][37][38] .015 ListPlanting Consider monitoring for excessive use of SendMessage and/or PostMessage API functions with LVM_SETITEMPOSITION and/or LVM_GETITEMPOSITION arguments. Monitoring Windows API calls indicative of the various types of code injection may generate a significant amount of data and may not be directly useful for defense unless collected under specific circumstances for known bad sequences of calls, since benign use of API functions may be common and difficult to distinguish from malicious behavior. Windows API calls such as FindWindow, FindWindowEx, EnumWindows, EnumChildWindows, and those that can be used to modify memory within another process, such as VirtualAllocEx/WriteProcessMemory, may be abused for this technique. Enterprise T1012 Query Registry Monitor for API calls (such as RegOpenKeyExA) that may interact with the Windows Registry to gather information about the system, configuration, and installed software. OS API calls associated with querying the Windows Registry are RegOpenKeyEx , RegOpenUserClassesRoot, RegQueryValueExA, and RegQueryValueExW. Execution of these functions might trigger security log ids such as 4663 (Microsoft Security Auditing). Also monitor for RegOpenUserClassesRoot api to retrieve a handle to the HKEY_CLASSES_ROOT key for a specified user. The returned key has a view of the registry that merges the contents of the HKEY_LOCAL_MACHINE\\Software\\Classes key with the contents of the Software\\Classes keys in the user's registry hive. Note: Most EDR tools do not support direct monitoring of API calls due to the sheer volume of calls produced by an endpoint but may have alerts or events that are based on abstractions of OS API calls. Analytic 1 - Suspicious API Calls suspicious_apis = filter api_calls where ApiName LIKE '%RegOpenKeyEx%' OR ApiName LIKE '%RegOpenUserClassesRoot%' Enterprise T1620 Reflective Code Loading Monitor for code artifacts associated with reflectively loading code, such as the abuse of .NET functions such as Assembly.Load() and Native API functions such as CreateThread(), memfd_create(), execve(), and/or execveat().[44][45] Enterprise T1113 Screen Capture Monitoring for screen capture behavior will depend on the method used to obtain data from the operating system and write output files. Detection methods could include collecting information from unusual processes using API calls used to obtain image data, and monitoring for image files written to disk, such as CopyFromScreen, xwd, or screencapture.[46][47]. The sensor data may need to be correlated with other events to identify malicious activity, depending on the legitimacy of this behavior within a given network environment. ICS T0852 Screen Capture Monitoring for screen capture behavior will depend on the method used to obtain data from the operating system and write output files. Detection methods could include collecting information from unusual processes using API calls used to obtain image data, and monitoring for image files written to disk, such as CopyFromScreen, xwd, or screencapture.[46][47] The data may need to be correlated with other events to identify malicious activity, depending on the legitimacy of this behavior within a given network environment. Enterprise T1489 Service Stop Remote access tools with built-in features may interact directly with the Windows API to perform these functions outside of typical system utilities. For example, ChangeServiceConfigW may be used by an adversary to prevent services from starting.[9] ICS T0881 Service Stop Remote access tools with built-in features may interact directly with the Windows API to perform these functions outside of typical system utilities. For example, ChangeServiceConfigW may be used by an adversary to prevent services from starting. For added context on adversary procedures and background see Service Stop. Enterprise T1129 Shared Modules Monitor for API calls that may execute malicious payloads via loading shared modules. Enterprise T1518 Software Discovery Monitor for API calls that may attempt to get a listing of software and software versions that are installed on a system or in a cloud environment. .001 Security Software Discovery Monitor for API calls that may attempt to get a listing of security software, configurations, defensive tools, and sensors that are installed on a system or in a cloud environment. OS API calls associated with LSASS process dumping include EnumProcesses, which can be used to enumerate the set of processes running on a host and filtered to look for security-specific processes. Note: Most EDR tools do not support direct monitoring of API calls due to the sheer volume of calls produced by an endpoint but may have alerts or events that are based on abstractions of OS API calls. Dynamic malware analysis tools (i.e., sandboxes) can be used to trace the execution, including OS API calls, for a single PE binary. Enterprise T1218 System Binary Proxy Execution Monitor for API calls that bypass process and/or signature based defenses by proxying execution of malicious content with signed, or otherwise trusted, binaries. .002 Control Panel Monitor for API calls that may forge web cookies that can be used to gain access to web applications or Internet services. Enterprise T1082 System Information Discovery Monitor for API calls that may attempt to get detailed information about the operating system and hardware, including version, patches, hotfixes, service packs, and architecture. Remote access tools with built-in features may interact directly with the Windows API to gather information. Information may also be acquired through Windows system management tools such as Windows Management Instrumentation and PowerShell. In cloud-based systems, native logging can be used to identify access to certain APIs and dashboards that may contain system information. Depending on how the environment is used, that data alone may not be useful due to benign use during normal operations. Enterprise T1614 System Location Discovery Remote access tools with built-in features may interact directly with the Windows API, such as calling GetLocaleInfoW to gather information.[48] .001 System Language Discovery Monitor for API calls that may attempt to gather information about the system language of a victim in order to infer the geographical location of that host. Enterprise T1016 System Network Configuration Discovery Monitor for API calls (such as GetAdaptersInfo() and GetIpNetTable()) that may gather details about the network configuration and settings, such as IP and/or MAC addresses. .002 Wi-Fi Discovery Monitor for API calls (such as those from wlanAPI.dll) that may gather details about locally reachable Wi-Fi networks. Enterprise T1049 System Network Connections Discovery Monitor for API calls that may attempt to get a listing of network connections to or from the compromised system they are currently accessing or from remote systems by querying for information over the network. Enterprise T1033 System Owner/User Discovery Monitor for API calls that may attempt to dump credentials to obtain account login and credential material, normally in the form of a hash or a clear text password, from the operating system and software. Enterprise T1007 System Service Discovery Monitor for API calls associated with gathering information about registered local system services, such as QueryServiceStatusEx. Other Windows API calls worth monitoring include EnumServicesStatusExA, which can be used to enumerate services in the service control manager database. Note: Most EDR tools do not support direct monitoring of API calls due to the sheer volume of calls produced by an endpoint but may have alerts or events that are based on abstractions of OS API calls. Dynamic malware analysis tools (i.e., sandboxes) can be used to trace the execution, including OS API calls, for a single PE binary. Enterprise T1124 System Time Discovery Monitor for API calls that may gather the system time and/or time zone from a local or remote system. Remote access tools with built-in features may interact directly with the Windows API to gather information. Enterprise T1125 Video Capture Detection of this technique may be difficult due to the various APIs that may be used. Telemetry data regarding API use may not be useful depending on how a system is normally used, but may provide context to other potentially malicious activity occurring on a system. Behavior that could indicate technique use include an unknown or unusual process accessing APIs associated with devices or software that interact with the video camera, recording devices, or recording software, and a process periodically writing files to disk that contain video or camera image data. Enterprise T1497 Virtualization/Sandbox Evasion Monitor for API calls that may employ various means to detect and avoid virtualization and analysis environments. Detecting actions related to virtualization and sandbox identification may be difficult depending on the adversary's implementation and monitoring required. .001 System Checks Monitor for API calls that may employ various means to detect and avoid virtualization and analysis environments. Detecting actions related to virtualization and sandbox identification may be difficult depending on the adversary's implementation and monitoring required. .002 User Activity Based Checks Monitor for API calls that may employ various means to detect and avoid virtualization and analysis environments. Detecting actions related to virtualization and sandbox identification may be difficult depending on the adversary's implementation and monitoring required. .003 Time Based Evasion Monitor for API calls that may employ various time-based methods to detect and avoid virtualization and analysis environments. Detecting actions related to virtualization and sandbox identification may be difficult depending on the adversary's implementation and monitoring required. Process: Process Access Opening of a process by another process, typically to read memory of the target process (ex: Sysmon EID 10) Process: Process Access Opening of a process by another process, typically to read memory of the target process (ex: Sysmon EID 10) Domain ID Name Detects Enterprise T1185 Browser Session Hijacking This may be a difficult technique to detect because adversary traffic may be masked by normal user traffic. Monitor for Process Injection against browser applications. Enterprise T1555 Credentials from Password Stores Monitor for processes being accessed that may search for common password storage locations to obtain user credentials. .002 Securityd Memory Monitor for processes being accessed that may obtain root access (allowing them to read securityd\u2019s memory), then they can scan through memory to find the correct sequence of keys in relatively few tries to decrypt the user\u2019s logon keychain. .003 Credentials from Web Browsers Monitor process execution logs to include PowerShell Transcription focusing on those that perform a combination of behaviors including reading web browser process memory, utilizing regular expressions, and those that contain numerous keywords for common web applications (Gmail, Twitter, Office365, etc.). .005 Password Managers Monitor process being accessed that may acquire user credentials from third-party password managers.[49] Enterprise T1559 Inter-Process Communication Monitor for processes making abnormal calls to higher privileged processes, such as a user application connecting to a VPN service.[50] .003 XPC Services Monitor for processes making abnormal calls to higher privileged processes, such as a user application connecting to a VPN service.[50] Enterprise T1556 Modify Authentication Process Monitor for unexpected processes interacting with authentication mechanisms and processes to access user credentials or enable otherwise unwarranted access to accounts. .001 Domain Controller Authentication Monitor for unexpected processes interacting with the authentication process on a domain controller to bypass the typical authentication mechanisms and enable access to accounts. Enterprise T1003 OS Credential Dumping Monitor for unexpected processes interacting with lsass.exe.[51] Common credential dumpers such as Mimikatz access the LSA Subsystem Service (LSASS) process by opening the process, locating the LSA secrets key, and decrypting the sections in memory where credential details are stored. Credential dumpers may also use methods for reflective Process Injection to reduce potential indicators of malicious activity. Linux To obtain the passwords and hashes stored in memory, processes must open a maps file in the /proc filesystem for the process being analyzed. This file is stored under the path /proc/<pid>/maps, where the <pid> directory is the unique pid of the program being interrogated for such authentication data. The AuditD monitoring tool, which ships stock in many Linux distributions, can be used to watch for hostile processes opening this file in the proc file system, alerting on the pid, process name, and arguments of such programs. .001 LSASS Memory Monitor for unexpected processes interacting with LSASS.exe.[51] Common credential dumpers such as Mimikatz access LSASS.exe by opening the process, locating the LSA secrets key, and decrypting the sections in memory where credential details are stored. Credential dumpers may also use methods for reflective Process Injection to reduce potential indicators of malicious activity. Usage of Procdump and Windows Task Manager for LSASS dumping can also be detected via process creation events, since they both have a predictable set of command-line arguments (i.e., for specifying the process to be dumped). Note: Sysmon process access events (Event ID 10) can be extremely noisy, which necessitates tweaking the Sysmon configuration file. We recommend taking an approach analogous to that of the Sysmon Modular Configuration project (https://github.com/olafhartong/sysmon-modular) and filtering out any benign processes in your environment that produce large volumes of process access events. The GrantedAccess value in the below analytic for Mimikatz is meant to be used solely as an illustrative example of detecting Mimikatz LSASS access. However, actual GrantedAccess values change over time with different versions of Mimikatz and therefore detection engineers need to verify the accuracy of any GrantedAccess values that their analytics are using. Analytic 1 - Mimikatz processes = filter processes where (event_id == \"10\" AND target_process == \"*lsass.exe\" AND granted_access == \"0x1410\") Analytic 2 - Procdump processes = filter processes where (event_id == \"10\" AND target_process == \"lsass.exe\" AND source_process == \"procdump.exe\") Analytic 3 - Windows Task Manager processes = filter processes where (event_id == \"10\" AND target_process == \"*lsass.exe\" AND source_process == \"c:\\windows*\\taskmgr.exe\") Enterprise T1055 Process Injection Monitor for processes being viewed that may inject code into processes in order to evade process-based defenses as well as possibly elevate privileges. .001 Dynamic-link Library Injection Monitor for process being viewed that may inject dynamic-link libraries (DLLs) into processes in order to evade process-based defenses as well as possibly elevate privileges. .002 Portable Executable Injection Monitor for processes being viewed that may inject portable executables (PE) into processes in order to evade process-based defenses as well as possibly elevate privileges. .003 Thread Execution Hijacking Monitor for processes being viewed that may inject malicious code into hijacked processes in order to evade process-based defenses as well as possibly elevate privileges. .004 Asynchronous Procedure Call Monitor for processes being viewed that may inject malicious code into processes via the asynchronous procedure call (APC) queue in order to evade process-based defenses as well as possibly elevate privileges. .005 Thread Local Storage Monitor for processes being viewed that may inject malicious code into processes via thread local storage (TLS) callbacks in order to evade process-based defenses as well as possibly elevate privileges. .008 Ptrace System Calls Monitor for processes being viewed that may inject malicious code into processes via ptrace (process trace) system calls in order to evade process-based defenses as well as possibly elevate privileges. .012 Process Hollowing Monitor for processes being viewed that may inject malicious code into suspended and hollowed processes in order to evade process-based defenses. Enterprise T1539 Steal Web Session Cookie Monitor for attempts by programs to inject into or dump browser process memory. Enterprise T1033 System Owner/User Discovery Monitor for unexpected processes interacting with lsass.exe.[51] Common credential dumpers such as Mimikatz access the LSA Subsystem Service (LSASS) process by opening the process, locating the LSA secrets key, and decrypting the sections in memory where credential details are stored. Credential dumpers may also use methods for reflective Process Injection to reduce potential indicators of malicious activity. Linux To obtain the passwords and hashes stored in memory, processes must open a maps file in the /proc filesystem for the process being analyzed. This file is stored under the path /proc/<pid>/maps, where the <pid> directory is the unique pid of the program being interrogated for such authentication data. The AuditD monitoring tool, which ships stock in many Linux distributions, can be used to watch for hostile processes opening this file in the proc file system, alerting on the pid, process name, and arguments of such programs. Process: Process Creation The initial construction of an executable managed by the OS, that may involve one or more tasks or threads. (e.g. Win EID 4688, Sysmon EID 1, cmd.exe > net use, etc.) Process: Process Creation The initial construction of an executable managed by the OS, that may involve one or more tasks or threads. (e.g. Win EID 4688, Sysmon EID 1, cmd.exe > net use, etc.) Domain ID Name Detects Enterprise T1548 Abuse Elevation Control Mechanism Monitor for newly executed processes that may circumvent mechanisms designed to control elevate privileges to gain higher-level permissions. Cyber actors frequently escalate to the SYSTEM account after gaining entry to a Windows host, to enable them to carry out various attacks more effectively. Tools such as Meterpreter, Cobalt Strike, and Empire carry out automated steps to \"Get System\", which is the same as switching over to the System user account. Most of these tools utilize multiple techniques to try and attain SYSTEM: in the first technique, they create a named pipe and connects an instance of cmd.exe to it, which allows them to impersonate the security context of cmd.exe, which is SYSTEM. In the second technique, a malicious DLL is injected into a process that is running as SYSTEM; the injected DLL steals the SYSTEM token and applies it where necessary to escalate privileges. This analytic looks for both of these techniques. Analytic 1 : Get System Elevation suspicious_processes = filter processes where ( (parent_image_path == C:\\Windows\\System32\\services.exe\" AND image_path == \"C:\\Windows\\System32\\cmd.exe\" AND command_line == \"echo\" AND command_line == \"\\pipe*\") OR (image_path == \"C:\\Windows\\System32\\rundll32.exe\" AND command_line == \",a /p:*\")) .002 Bypass User Account Control Monitor newly executed processes, such as eventvwr.exe and sdclt.exe, that may bypass UAC mechanisms to elevate process privileges on system. Threat actors often, after compromising a machine, try to disable User Access Control (UAC) to escalate privileges. This is often done by changing the registry key for system policies using \"reg.exe\", a legitimate tool provided by Microsoft for modifying the registry via command prompt or scripts. This action interferes with UAC and may enable a threat actor to escalate privileges on the compromised system, thereby allowing further exploitation of the system. Analytic 1 : UAC Bypass possible_uac_bypass = filter processes where ( integrity_level == \"High\" and (parent_image_path == \"c:\\windows\\system32\\fodhelper.exe\") or (command_line == \".exe\\\"cleanmgr.exe /autoclean\") or (image_path == \"c:\\program files\\windows media player\\osk.exe\") or (parent_image_path == \"c:\\windows\\system32\\slui.exe\") or (parent_command_line == '\"c:\\windows\\system32\\dism.exe\"\"\".xml\"' and image_path != \"c:\\users*\\appdata\\local\\temp*\\dismhost.exe\") or (command_line == '\"c:\\windows\\system32\\wusa.exe\"/quiet*' and user != \"NOT_TRANSLATED\" and current_working_directory == \"c:\\windows\\system32\\\" and parent_image_path != \"c:\\windows\\explorer.exe\") or (parent_image_path == \"c:\\windows*dccw.exe\" and image_path != \"c:\\windows\\system32\\cttune.exe\")) Analytic 2 : Disable UAC cmd_processes = filter processes where ( (parent_image = \"C:\\Windows\\System32\\cmd.exe\") AND (command_line = \"reg.exe%HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System%REG_DWORD /d 0%\")) .003 Sudo and Sudo Caching Monitor newly executed processes that may perform sudo caching and/or use the suoders file to elevate privileges. .004 Elevated Execution with Prompt Consider monitoring for /usr/libexec/security_authtrampoline executions which may indicate that AuthorizationExecuteWithPrivileges is being executed. MacOS system logs may also indicate when AuthorizationExecuteWithPrivileges is being called. Enterprise T1134 Access Token Manipulation Monitor for executed processes that may modify access tokens to operate under a different user or system security context to perform actions and bypass access controls. .004 Parent PID Spoofing Monitor for newly constructed processes and/or command-lines that may abuse mechanisms to evade defenses, such as those blocking processes spawning directly from Office documents, and analysis targeting unusual/potentially malicious parent-child process relationships, such as spoofing the PPID of PowerShell/Rundll32 to be explorer.exe Enterprise T1087 Account Discovery Monitor for processes that can be used to enumerate user accounts and groups such as net.exe and net1.exe, especially when executed in quick succession.[52] Information may also be acquired through Windows system management tools such as Windows Management Instrumentation and PowerShell. .001 Local Account Monitor for processes that can be used to enumerate user accounts and groups such as net.exe and net1.exe, especially when executed in quick succession.[52] Information may also be acquired through Windows system management tools such as Windows Management Instrumentation and PowerShell. Note: Event IDs are for Sysmon (Event ID 10 - process access) and Windows Security Log (Event ID 4688 - a new process has been created). - For Linux, auditing frameworks such as the Linux Auditing System (auditd) can be used to alert on the enumeration/reading of files that store local users, including /etc/passwd. - For MacOS, utilities that work in concert with Apple\u2019s Endpoint Security Framework such as Process Monitor can be used to track usage of commands such as id and groups. Analytic 1 - Net Discovery Commands processes = filter processes where ((event_id=\"10\" OR event_id=\"4688\") AND exe == \"net.exe\" OR exe == \"net1.exe\") .002 Domain Account Monitor for processes that can be used to enumerate domain accounts and groups, such as net.exe and net1.exe, especially when executed in quick succession.[52] Information may also be acquired through Windows system management tools such as Windows Management Instrumentation and PowerShell. .003 Email Account Monitor for newly executed processes, such as Windows Management Instrumentation and PowerShell , with arguments that can be used to enumerate email addresses and accounts. Enterprise T1098 Account Manipulation Monitor for newly constructed processes indicative of modifying account settings, such as those that modify authorized_keys or /etc/ssh/sshd_config files. .004 SSH Authorized Keys Monitor for suspicious processes modifying the authorized_keys or /etc/ssh/sshd_config files. ICS T0830 Adversary-in-the-Middle Host-based implementations of this technique may utilize networking-based system calls or network utility commands (e.g., iptables) to locally intercept traffic. Monitor for relevant process creation events. Enterprise T1010 Application Window Discovery Monitor for newly executed processes that may attempt to get a listing of open application windows. System and network discovery techniques normally occur throughout an operation as an adversary learns the environment. Data and events should not be viewed in isolation, but as part of a chain of behavior that could lead to other activities based on the information obtained. Note: Event IDs are for Sysmon (Event ID 1 - process create) and Windows Security Log (Event ID 4688 - a new process has been created). Analytic 1 - Suspicious Processes suspicious_processes = filter process where (event_id == \"1\" OR event_id == \"4688\") AND (command_line LIKE '%Get-Process%' AND command_line LIKE '%mainWindowTitle%') Enterprise T1560 Archive Collected Data Monitor for newly constructed processes and/or command-lines that aid in compression or encrypting data that is collected prior to exfiltration, such as 7-Zip, WinRAR, and WinZip. .001 Archive via Utility Monitor for newly constructed processes and/or command-lines that aid in compression or encrypting data that is collected prior to exfiltration, such as 7-Zip, WinRAR, and WinZip. Before Exfiltration that an adversary has Collection, it is very likely that a Archive Collected Data will be created, so that transfer times are minimized and fewer files are transmitted. There is variety between the tools used to compress data, but the command line usage and context of archiving tools, such as ZIP, RAR, and 7ZIP, should be monitored.In addition to looking for RAR or 7z program names, command line usage of 7Zip or RAR can be detected with the flag usage of \"* a *\". This is helpful, as adversaries may change program names. Note: This analytic looks for the command line argument a, which is used by RAR. However, there may be other programs that have this as a legitimate argument and may need to be filtered out. Analytic 1 - Command Line Usage of Archiving Software rar_argument = filter processes where (command_line == \" a \") Enterprise T1197 BITS Jobs Monitor for newly constructed BITS tasks to enumerate using the BITSAdmin tool (bitsadmin /list /allusers /verbose). Note: Event IDs are for Sysmon (Event ID 1 - process create) and Windows Security Log (Event ID 4688 - a new process has been created). Analytic 1 is oriented around looking for the creation of Microsoft Background Intelligent Transfer Service utility (bitsadmin.exe) processes that schedule a BITS job to persist on an endpoint. The analytic identifies the command-line parameters used to create, resume or add a file to a BITS job; these are typically seen combined in a single command-line or executed in sequence. Analytic 2 identifies Microsoft Background Intelligent Transfer Service utility bitsadmin.exe using the transfer parameter to download a remote object. In addition, look for download or upload on the command-line, the switches are not required to perform a transfer. Capture any files downloaded. Review the reputation of the IP or domain used. Typically once executed, a follow on command will be used to execute the dropped file. Network connection or file modification events related will not spawn or create from bitsadmin.exe , but the artifacts will appear in a parallel process of svchost.exe with a command-line similar to svchost.exe -k netsvcs -s BITS . It\u2019s important to review all parallel and child processes to capture any behaviors and artifacts. In some suspicious and malicious instances, BITS jobs will be created. You can use bitsadmin /list /verbose to list out the jobs during investigation. Analytic 1 - BITS Job Persistence processes = filter processes where ( (event_id == \"1\" OR event_id == \"4688\") AND exe =\"C:\\Windows\\System32\\bitsadmin.exe\" AND (command_line == \"create\" OR command_line == \"addfile\" OR command_line == \"setnotifyflags\" OR command_line == \"setnotifycmdline\" OR command_line == \"setminretrydelay\" OR command_line == \"setcustomheaders\" OR command_line == \"resume\")) Analytic 2 : BITSAdmin Download File bitsadmin_commands = filter processes where ( exe =\"C:\\Windows\\System32\\bitsadmin.exe\" AND command_line = transfer)output bitsadmin_commands Enterprise T1547 Boot or Logon Autostart Execution Suspicious program execution as autostart programs may show up as outlier processes that have not been seen before when compared against historical data to increase confidence of malicious activity, data and events should not be viewed in isolation, but as part of a chain of behavior that could lead to other activities, such as network connections made for Command and Control, learning details about the environment through Discovery, and Lateral Movement. .001 Registry Run Keys / Startup Folder Monitor for newly executed processes executed from the Run/RunOnce registry keys through Windows EID 9707 or \"Software\\Microsoft\\Windows\\CurrentVersion\\Run\" and \"Software\\Microsoft\\Windows\\CurrentVersion\\RunOnce\" registry keys with the full command line. Registry modifications are often essential in establishing persistence via known Windows mechanisms. Many legitimate modifications are done graphically via regedit.exe or by using the corresponding channels, or even calling the Registry APIs directly. The built-in utility reg.exe provides a command-line interface to the registry, so that queries and modifications can be performed from a shell, such as cmd.exe. When a user is responsible for these actions, the parent of cmd.exe will likely be explorer.exe. Occasionally, power users and administrators write scripts that do this behavior as well, but likely from a different process tree. These background scripts must be learned so they can be tuned out accordingly. Output DescriptionThe sequence of processes that resulted in reg.exe being started from a shell. That is, a hierarchy that looks like\u2022 great-grand_parent.exe\u2022 grand_parent.exe\u2022 parent.exe\u2022 reg.exe Analytic 1 - Reg.exe called from Command Shell reg = filter processes where (exe == \"reg.exe\" and parent_exe == \"cmd.exe\")cmd = filter processes where (exe == \"cmd.exe\" and parent_exe != \"explorer.exe\"\")reg_and_cmd = join (reg, cmd) where (reg.ppid == cmd.pid and reg.hostname == cmd.hostname) Analytic 2 - Rare LolBAS Command Lines lolbas_processes = filter processes where (exe = \"At.exe\" OR exe = \"Atbroker.exe\" OR exe = \"Bash.exe\" OR exe = \"Bitsadmin.exe\" OR exe = \"Certutil.exe\" OR exe = \"Cmd.exe\" OR exe = \"Cmdkey.exe\" OR exe = \"Cmstp.exe\" OR exe = \"Control.exe\" OR exe = \"Csc.exe\" OR exe = \"Cscript.exe\" OR exe = \"Dfsvc.exe\" OR exe = \"Diskshadow.exe\" OR exe = \"Dnscmd.exe\" OR exe = \"Esentutl.exe\" OR exe = \"Eventvwr.exe\" OR exe = \"Expand.exe\" OR exe = \"Extexport.exe\" OR exe = \"Extrac32.exe\" OR exe = \"Findstr.exe\" OR exe = \"Forfiles.exe\" OR exe = \"Ftp.exe\" OR exe = \"Gpscript.exe\" OR exe = \"Hh.exe\" OR exe = \"Ie4uinit.exe\" OR exe = \"Ieexec.exe\" OR exe = \"Infdefaultinstall.exe\" OR exe = \"Installutil.exe\" OR exe = \"Jsc.exe\" OR exe = \"Makecab.exe\" OR exe = \"Mavinject.exe\" OR exe = \"Microsoft.Workflow.r.exe\" OR exe = \"Mmc.exe\" OR exe = \"Msbuild.exe\" OR exe = \"Msconfig.exe\" OR exe = \"Msdt.exe\" OR exe = \"Mshta.exe\" OR exe = \"Msiexec.exe\" OR exe = \"Odbcconf.exe\" OR exe = \"Pcalua.exe\" OR exe = \"Pcwrun.exe\" OR exe = \"Presentationhost.exe\" OR exe = \"Print.exe\" OR exe = \"Reg.exe\" OR exe = \"Regasm.exe\" OR exe = \"Regedit.exe\" OR exe = \"Register-cimprovider.exe\" OR exe = \"Regsvcs.exe\" OR exe = \"Regsvr32.exe\" OR exe = \"Replace.exe\" OR exe = \"Rpcping.exe\" OR exe = \"Rundll32.exe\" OR exe = \"Runonce.exe\" OR exe = \"Runscripthelper.exe\" OR exe = \"Sc.exe\" OR exe = \"Schtasks.exe\" OR exe = \"Scriptrunner.exe\" OR exe = \"SyncAppvPublishingServer.exe\" OR exe = \"Tttracer.exe\" OR exe = \"Verclsid.exe\" OR exe = \"Wab.exe\" OR exe = \"Wmic.exe\" OR exe = \"Wscript.exe\" OR exe = \"Wsreset.exe\" OR exe = \"Xwizard.exe\" OR exe = \"Advpack.dll OR exe = \"Comsvcs.dll OR exe = \"Ieadvpack.dll OR exe = \"Ieaframe.dll OR exe = \"Mshtml.dll OR exe = \"Pcwutl.dll OR exe = \"Setupapi.dll OR exe = \"Shdocvw.dll OR exe = \"Shell32.dll OR exe = \"Syssetup.dll OR exe = \"Url.dll OR exe = \"Zipfldr.dll OR exe = \"Appvlp.exe\" OR exe = \"Bginfo.exe\" OR exe = \"Cdb.exe\" OR exe = \"csi.exe\" OR exe = \"Devtoolslauncher.exe\" OR exe = \"dnx.exe\" OR exe = \"Dxcap.exe\" OR exe = \"Excel.exe\" OR exe = \"Mftrace.exe\" OR exe = \"Msdeploy.exe\" OR exe = \"msxsl.exe\" OR exe = \"Powerpnt.exe\" OR exe = \"rcsi.exe\" OR exe = \"Sqler.exe\" OR exe = \"Sqlps.exe\" OR exe = \"SQLToolsPS.exe\" OR exe = \"Squirrel.exe\" OR exe = \"te.exe\" OR exe = \"Tracker.exe\" OR exe = \"Update.exe\" OR exe = \"vsjitdebugger.exe\" OR exe = \"Winword.exe\" OR exe = \"Wsl.exe\" OR exe = \"CL_Mutexverifiers.ps1 OR exe = \"CL_Invocation.ps1 OR exe = \"Manage-bde.wsf OR exe = \"Pubprn.vbs OR exe = \"Slmgr.vbs OR exe = \"Syncappvpublishingserver.vbs OR exe = \"winrm.vbs OR exe = \"Pester.bat)process_count = count(lolbas_processes) by processprocess_count_avg = average(process_count)process_count_stdev = standard_deviation(process_count)lower_bound = process_count_avg - stdev * 1.5outliers = filter lolbas_processes where (process_count < lower_bound) .003 Time Providers Monitor newly executed processes, such as the W32tm.exe utility. [53] The Sysinternals Autoruns tool may also be used to analyze auto-starting locations, including DLLs listed as time providers. [54] .006 Kernel Modules and Extensions Monitor for newly created processes that may modify the kernel to automatically execute programs on system boot. .009 Shortcut Modification Monitor for newly executed processes that may create or edit shortcuts to run a program during system boot or user login. .013 XDG Autostart Entries Monitor newly executed processes that may modify XDG autostart entries to execute programs or commands during system boot. .014 Active Setup Monitor newly executed processes that may achieve persistence by adding a Registry key to the Active Setup of the local machine. .015 Login Items Monitor processes that start at login for unusual or unknown applications. Usual applications for login items could include what users add to configure their user environment, such as email, chat, or music applications, or what administrators include for organization settings and protections. Check for running applications from login items that also have abnormal behavior, such as establishing network connections. Enterprise T1037 Boot or Logon Initialization Scripts Monitor for newly executed processes that may use scripts automatically executed at boot or logon initialization to establish persistence. Adversaries may schedule software to run whenever a user logs into the system; this is done to establish persistence and sometimes for lateral movement. This trigger is established through the registry key HKEY_CURRENT_USER\\EnvironmentUserInitMprLogonScript. This signature looks edits to existing keys or creation of new keys in that path. Users purposefully adding benign scripts to this path will result in false positives; that case is rare, however. There are other ways of running a script at startup or login that are not covered in this signature. Note that this signature overlaps with the Windows Sysinternals Autoruns tool, which would also show changes to this registry path. Analytic 1 - Boot or Logon Initialization Scripts logon_script_key_processes = filter processes where ( command_line = \"regadd\\EnvironmentUserInitMprLogonScript\")registry = search (Registry:Add OR Registry:Edit)registry_logon_key_events = filter registry where ( key = \"\\EnvironmentUserInitMprLogonScript\") .001 Logon Script (Windows) Monitor for newly constructed processes and/or command-lines that execute logon scripts .002 Login Hook Monitor for processes and/or command-lines to install or modify login hooks, as well as processes spawned at user login by these hooks. .003 Network Logon Script Monitor for newly constructed processes and/or command-lines that execute logon scripts .004 RC Scripts Monitor for newly constructed processes and/or command-lines that execute /etc/rc.local if present. .005 Startup Items Monitor for newly constructed processes and/or command-lines that execute during the boot up process to check for unusual or unknown applications and behavior Enterprise T1176 Browser Extensions Monitor for newly executed processes that could be used to abuse internet browser extensions to establish persistence. Enterprise T1217 Browser Information Discovery Monitor for processes with arguments that may be associated with gathering browser information, such as local files and databases (e.g., %APPDATA%/Google/Chrome).[55] Enterprise T1651 Cloud Administration Command Monitor virtual machines for the creation of processes associated with cloud virtual machine agents. In Windows-based Azure machines, monitor for the WindowsAzureGuestAgent.exe process.[56] Enterprise T1059 Command and Scripting Interpreter Monitor log files for process execution through command-line and scripting activities. This information can be useful in gaining additional insight to adversaries' actions through how they use native processes or custom tools. Also monitor for loading of modules associated with specific languages. .001 PowerShell Monitor for newly executed processes that may abuse PowerShell commands and scripts for execution. Note: Event IDs are for Sysmon (Event ID 10 - process access) and Windows Security Log (Event ID 4688 - a new process has been created). - The logic for Analytic 1 is based around detecting on non-interactive Powershell sessions (i.e., those not launched by a user through explorer.exe). This may lead to false positives when used in a production environment, so we recommend tuning any such analytics by including additional logic (e.g., looking for suspicious parent processes) that helps filter such events.- The logic for Analytic 2 is based around detecting on remote Powershell sessions. PowerShell can be used over WinRM to remotely run commands on a host. When a remote PowerShell session starts, svchost.exe executes wsmprovhost.exe. Analytic 1- Non-interactive Powershell Sessions processes = filter process where ((event_id=\"10\" OR event_id=\"4688\") AND exe == \"powershell.exe\" AND parent_exe != \"explorer.exe\") Analytic 2- Remote Powershell Sessions processes = filter process where ((event_id=\"10\" OR event_id=\"4688\") AND exe == \"wsmprovhost.exe\" and parent_exe == \"svchost.exe\") .002 AppleScript Monitor for newly executed processes that may abuse AppleScript for execution. Scripts are likely to perform actions with various effects on a system that may generate events, depending on the types of monitoring used. Actions may be related to network and system information Discovery, Collection, or other scriptable post-compromise behaviors and could be used as indicators of detection leading back to the source script. .003 Windows Command Shell Monitor for newly executed processes that may abuse the Windows command shell for execution. Note: This Analytic works by creating a baseline of parent processes of cmd seen over the last 30 days and a list of parent processes of cmd seen today. Parent processes in the baseline are removed from the set of parent processes seen today, leaving a list of new parent processes. This analytic attempts to identify suspicious programs spawning cmd by looking for programs that do not normally create cmd. It is very common for some programs to spawn cmd as a subprocess, for example to run batch files or Windows commands. However, many processes don\u2019t routinely launch a command prompt - e.g., Microsoft Outlook. A command prompt being launched from a process that normally doesn\u2019t launch command prompts could be the result of malicious code being injected into that process, or of an attacker replacing a legitimate program with a malicious one. Analytic 1 cmd == filter processes where ((event_id == \"1\" OR event_id == \"4688\") AND exe == \"cmd.exe\")cmd == from cmd select parent_exehistoric_cmd == filter cmd (where timestamp < now - 1 day AND timestamp > now - 1 day)current_cmd == filter cmd (where timestamp >= now - 1 day)new_cmd == historic_cmd - current_cmd .004 Unix Shell Monitor for newly executed processes that may abuse Unix shell commands and scripts for execution. .005 Visual Basic Monitor for events associated with VB execution, such as Office applications spawning processes, usage of the Windows Script Host (typically cscript.exe or wscript.exe). VB execution is likely to perform actions with various effects on a system that may generate events, depending on the types of monitoring used. .006 Python Monitor systems for abnormal Python usage and python.exe behavior, which could be an indicator of malicious activity. Understanding standard usage patterns is important to avoid a high number of false positives. If scripting is restricted for normal users, then any attempts to enable scripts running on a system would be considered suspicious. If scripts are not commonly used on a system, but enabled, scripts running out of cycle from patching or other administrator functions are suspicious. Scripts should be captured from the file system when possible to determine their actions and intent. Scripts are likely to perform actions with various effects on a system that may generate events, depending on the types of monitoring used. Monitor newly executed processes that may abuse Python commands and scripts for execution. .007 JavaScript Monitor for events associated with scripting execution, such as process activity, usage of the Windows Script Host (typically cscript.exe or wscript.exe), file activity involving scripts Mobile T1623 Command and Scripting Interpreter Mobile Threat Defense (MTD) with lower-level OS APIs integrations may have access to newly created processes and their parameters, potentially detecting unwanted or malicious shells. .001 Unix Shell Mobile Threat Defense (MTD) with lower-level OS APIs integrations may have access to newly created processes and their parameters, potentially detecting unwanted or malicious shells. ICS T0807 Command-Line Interface Monitor for processes spawning from known command shell applications (e.g., PowerShell, Bash). Benign activity will need to be allow-listed. This information can be useful in gaining additional insight to adversaries' actions through how they use native processes or custom tools. Enterprise T1609 Container Administration Command Container administration service activities and executed commands can be captured through logging of process execution with command-line arguments on the container as well as within the underlying host. Enterprise T1659 Content Injection Look for behaviors on the endpoint system that might indicate successful compromise, such as abnormal behaviors of browser processes. This could include suspicious files written to disk, evidence of Process Injection for attempts to hide execution, or evidence of Discovery. Enterprise T1136 Create Account Monitor newly executed processes associated with account creation, such as net.exe .001 Local Account Monitor newly executed processes associated with account creation, such as net.exe Analytic 1 - Create local admin accounts using net.exe certutil_downloads = filter processes where ( (exe = C:\\Windows\\System32\\net.exe OR exe = C:\\Windows\\System32\\net1.exe ) AND command_line = * -exportPFX * ) .002 Domain Account Monitor newly executed processes associated with account creation, such as net.exe Enterprise T1543 Create or Modify System Process New, benign system processes may be created during installation of new software. .002 Systemd Service Suspicious processes or scripts spawned in this manner will have a parent process of \u2018systemd\u2019, a parent process ID of 1, and will usually execute as the \u2018root\u2019 user. .003 Windows Service Suspicious program execution through services may show up as outlier processes that have not been seen before when compared against historical data. Look for abnormal process call trees from known services and for execution of other commands that could relate to Discovery or other adversary techniques. Data and events should not be viewed in isolation, but as part of a chain of behavior that could lead to other activities, such as network connections made for Command and Control, learning details about the environment through Discovery, and Lateral Movement. Windows runs the Service Control Manager (SCM) within the process services.exe. Windows launches services as independent processes or DLL loads within a svchost.exe group. To be a legitimate service, a process (or DLL) must have the appropriate service entry point SvcMain. If an application does not have the entry point, then it will timeout (default is 30 seconds) and the process will be killed. To survive the timeout, adversaries and red teams can create services that direct to cmd.exe with the flag /c, followed by the desired command. The /c flag causes the command shell to run a command and immediately exit. As a result, the desired program will remain running and it will report an error starting the service. This analytic will catch that command prompt instance that is used to launch the actual malicious executable. Additionally, the children and descendants of services.exe will run as a SYSTEM user by default. Note: Create a baseline of services seen over the last 30 days and a list of services seen today. Remove services in the baseline from services seen today, leaving a list of new services. Returns all processes named cmd.exe that have services.exe as a parent process. Because this should never happen, the /c flag is redundant in the search. Analytic 1 : Service Outlier Executables services = filter processes where (parent_image_path == \"C:\\Windows\\System32\\services.exe\")historic_services = filter services (where timestamp < now - 1 day AND timestamp > now - 1 day)current_services = filter services (where timestamp >= now - 1 day)new_services = historic_services - current_services Analytic 2 : Services launching CMD suspicious_processes = filter processes where (event_id == \"1\" OR event_id == \"4688\") AND (exe == \"cmd.exe\" and parent_exe == \"services.exe\") .004 Launch Daemon Monitor for newly executed processes that may create or modify Launch Daemons to execute malicious payloads as part of persistence. Enterprise T1555 Credentials from Password Stores Monitor newly executed processes that may search for common password storage locations to obtain user credentials. .001 Keychain Monitor processes spawned by command line utilities to manipulate keychains directly, such as security, combined with arguments to collect passwords, such as dump-keychain -d. .004 Windows Credential Manager Monitor newly executed processes for suspicious activity listing credentials from the Windows Credentials locker (e.g. vaultcmd /listcreds:\"Windows Credentials\").[57] Enterprise T1485 Data Destruction Monitor for newly executed processes of binaries that could be involved in data destruction activity, such as SDelete. ICS T0809 Data Destruction Monitor for newly executed processes of binaries that could be involved in data destruction activity, such as SDelete. Enterprise T1486 Data Encrypted for Impact Monitor for newly constructed processes and/or command-lines involved in data destruction activity, such as vssadmin, wbadmin, and bcdedit. Enterprise T1005 Data from Local System Monitor for newly executed processes that may search local system sources, such as file systems or local databases, to find files of interest and sensitive data prior to Exfiltration. ICS T0893 Data from Local System Monitor for newly executed processes that may search local system sources, such as file systems or local databases, to find files of interest and sensitive data. Enterprise T1622 Debugger Evasion Monitoring for suspicious processes being spawned that gather a variety of system information or perform other forms of Discovery, especially in a short period of time, may aid in detection. Debugger related system checks will likely occur in the first steps of an operation but may also occur throughout as an adversary learns the environment. Data and events should not be viewed in isolation, but as part of a chain of behavior that could lead to other activities, such as lateral movement, based on the information obtained. Enterprise T1140 Deobfuscate/Decode Files or Information Monitor for newly executed processes that attempt to hide artifacts of an intrusion, such as common archive file applications and extensions (ex: Zip and RAR archive tools), and correlate with other suspicious behavior to reduce false positives from normal user and administrator behavior. CertUtil.exe may be used to encode and decode a file, including PE and script code. Encoding will convert a file to base64 with -----BEGIN CERTIFICATE----- and -----END CERTIFICATE----- tags. Malicious usage will include decoding an encoded file that was downloaded. Once decoded, it will be loaded by a parallel process. Note that there are two additional command switches that may be used - encodehex and decodehex. Similarly, the file will be encoded in HEX and later decoded for further execution. During triage, identify the source of the file being decoded. Review its contents or execution behavior for further analysis. Analytic Event IDs are for Sysmon (Event ID 1 - process create) and Windows Security Log (Event ID 4688 - a new process has been created). The analytic is oriented around the creation of CertUtil.exe processes, which may be used to encode and decode files, including PE and script code. Malicious usage will include decoding a encoded file that was downloaded. Once decoded, it will be loaded by a parallel process. Analytic 1 - CertUtil with Decode Argument processes = filter processes where ( (event_id == \"1\" OR event_id == \"4688\") AND exe =\"C:\\Windows\\System32\\certutil.exe\" AND command_line = decode ) Enterprise T1652 Device Driver Discovery Monitor processes (lsmod, driverquery.exe, etc.) for events that may highlight potentially malicious attempts to enumerate device drivers. Enterprise T1561 Disk Wipe Monitor newly executed processes that may wipe or corrupt raw disk data on specific systems or in large numbers in a network to interrupt availability to system and network resources. .001 Disk Content Wipe Monitor newly executed processes that may erase the contents of storage devices on specific systems or in large numbers in a network to interrupt availability to system and network resources. .002 Disk Structure Wipe Monitor newly executed processes that may corrupt or wipe the disk data structures on a hard drive necessary to boot a system; targeting specific critical systems or in large numbers in a network to interrupt availability to system and network resources. Enterprise T1482 Domain Trust Discovery Monitor for newly executed processes that may attempt to gather information on domain trust relationships that may be used to identify lateral movement opportunities in Windows multi-domain/forest environments. Enterprise T1189 Drive-by Compromise Look for behaviors on the endpoint system that might indicate successful compromise, such as abnormal behaviors of browser processes. This could include suspicious files written to disk, evidence of Process Injection for attempts to hide execution, or evidence of Discovery. ICS T0817 Drive-by Compromise Monitor for behaviors on the endpoint system that might indicate successful compromise, such as abnormal behaviors of browser processes. This could include suspicious files written to disk. Enterprise T1611 Escape to Host Monitor for process activity (such as unexpected processes spawning outside a container and/or on a host) that might indicate an attempt to escape from a privileged container to host. Enterprise T1546 Event Triggered Execution Tools such as Sysinternals Autoruns can be used to detect changes to execution triggers that could be attempts at persistence. Also look for abnormal process call trees for execution of other commands that could relate to Discovery actions or other techniques. .001 Change Default File Association Monitor for newly executed processes that may establish persistence by executing malicious content triggered by a file type association. .002 Screensaver Monitor newly executed processes that may establish persistence by executing malicious content triggered by user inactivity. Analytic 1 : New processes whose image files are being used as Screensaver files and make an outbound network connection to unknown IP address new_processes = filter ProcessGuid, ProcessFilePath, ProcessCommandLine, UserNameFROM ProcessCreationDataWHERE event_id == \"1\" new_network_connections = filter ProcessFilePath, DestinationIpFROM NetworkConnectionDataWHERE event_id == \"3\" screensaver_key_modification = filter ProcessGuid, ProcessFilePath, UserName, RegistryKeyPath, RegistryKeyValueData FROM KeyModificationDataWHERE event_id == \"13\" AND RegistryKeyPath LIKE '%Software\\Policies\\Microsoft\\Windows\\Control Panel\\Desktop\\SCRNSAVE.EXE%' screensaver_processes = filter p.ProcessGuid, p.ProcessFilePath, p.UserNameFROM new_processes pINNER JOIN screensaver_key_modification kON p.ProcessFilePath = k.RegistryKeyValueData suspicious_processes = filter p.ProcessGuid, p.ProcessFilePath, p.UserName, n.DestinationIpFROM new_network_connections nINNER JOIN screensaver_processes pON p.ProcessFilePath = n.ProcessFilePathWHERE n.DestinationIP NOT IN ('KnownIp01','KnownIp02') .003 Windows Management Instrumentation Event Subscription Monitor newly executed processes that result from the execution of subscriptions (i.e. spawning from the WmiPrvSe.exe WMI Provider Host process). Note: Windows Event ID 4688 (A new process has been created) and Sysmon Event ID 1 (Process creation) can be used to alert on processes created by WMI event subscription triggers by filtering on events with a parent process name of WmiPrvSe.exe. .004 Unix Shell Configuration Modification Monitor newly executed processes that may establish persistence through executing malicious commands triggered by a user\u2019s shell. .005 Trap Monitor newly executed processes that may establish persistence by executing malicious content triggered by an interrupt signal. .006 LC_LOAD_DYLIB Addition Monitor processes for those that may be used to modify binary headers. .007 Netsh Helper DLL It is likely unusual for netsh.exe to have any child processes in most environments. Monitor process executions and investigate any child processes spawned by netsh.exe for malicious behavior. .008 Accessibility Features Monitor newly executed processes that may establish persistence and/or elevate privileges by executing malicious content triggered by accessibility features. An adversary can use accessibility features (Ease of Access), such as StickyKeys or Utilman, to launch a command shell from the logon screen and gain SYSTEM access. Since an adversary does not have physical access to the machine, this technique must be run within Remote Desktop. To prevent an adversary from getting to the login screen without first authenticating, Network-Level Authentication (NLA) must be enabled. If a debugger is set up for one of the accessibility features, then it will intercept the process launch of the feature and instead execute a new command line. This analytic looks for instances of cmd.exe or powershell.exe launched directly from the logon process, winlogon.exe. Several accessibility programs can be run using the Ease of Access center sethc.exe handles StickyKeys utilman.exe is the Ease of Access menu osk.exe runs the On-Screen Keyboard narrator.exe reads screen text over audio magnify.exe magnifies the view of the screen near the cursor One simple way to implement this technique is to note that in a default Windows configuration there are no spaces in the path to the system32 folder. If the accessibility programs are ever run with a Debugger set, then Windows will launch the Debugger process and append the command line to the accessibility program. As a result, a space is inserted in the command line before the path. Looking for any instances of a space in the command line before the name of an accessibility program will help identify when Debuggers are set. The Windows Registry location HKLM\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options allows for parameters to be set for applications during execution. One feature used by malicious actors is the \"Debugger\" option. When a key has this value enabled, a Debugging command line can be specified. Windows will launch the Debugging command line, and pass the original command line in as an argument. Adversaries can set a Debugger for Accessibility Applications. The analytic looks for the original command line as an argument to the Debugger. When the strings \"sethc.exe\", \"utilman.exe\", \"osk.exe\", \"narrator.exe\", and \"Magnify.exe\" are detected in the arguments, but not as the main executable, it is very likely that a Debugger is set. Note: Event IDs are for Sysmon (Event ID 1 - process create) and Windows Security Log (Event ID 4688 - a new process has been created). The Analytic example looks for any creation of common accessibility processes such as sethc.exe but does no other filtering, which may result in false positives. Therefore, we recommend tuning any such analytics by including additional logic (e.g., testing the name of the parent process) that helps reduce false positives. Analytic 2 could depend on the possibility of the known strings used as arguments for other applications used in the day-to-day environment. Although the chance of the string \"sethc.exe\" being used as an argument for another application is unlikely, it still is a possibility. Analytic 1 : Command Launched from Winlogon processes = filter process where ((event_id == \"1\" OR event_id=\"4688\") AND (parent_exe == \"winlogon.exe\" and exe == \"cmd.exe\") AND command_line=\"(sethc.exe OR utilman.exe OR osk.exe OR narrator.exe OR magnify.exe)\" Analytic 2 : Debuggers for Accessibility Applications debuggers = filter process where (command_line match \"$. .(sethcutilmanosknarratormagnify).exe\") .009 AppCert DLLs Monitor newly executed processes that may establish persistence and/or elevate privileges by executing malicious content triggered by AppCert DLLs loaded into processes. .010 AppInit DLLs Monitor newly executed processes that may establish persistence and/or elevate privileges by executing malicious content triggered by AppInit DLLs loaded into processes. Note: Sysmon Event ID 1 (process create) and Windows Security Log Event ID 4688 (a new process has been created) can be used to detect new reg.exe processes that modify the AppInit DLL registry keys since the registry keys are specified as a command-line parameter. .011 Application Shimming Monitor newly executed processs for sdbinst.exe for potential indications of application shim abuse. There are several public tools available that will detect shims that are currently available [58]:* Shim-Process-Scanner - checks memory of every running process for any shim flags* Shim-Detector-Lite - detects installation of custom shim databases* Shim-Guard - monitors registry for any shim installations* ShimScanner - forensic tool to find active shims in memory* ShimCacheMem - Volatility plug-in that pulls shim cache from memory (note: shims are only cached after reboot) .012 Image File Execution Options Injection Monitor for abnormal usage of the GFlags tool as well as common processes spawned under abnormal parents and/or with creation flags indicative of debugging such as DEBUG_PROCESS and DEBUG_ONLY_THIS_PROCESS. [59] .013 PowerShell Profile Monitor newly executed processes that may gain persistence and elevate privileges by executing malicious content triggered by PowerShell profiles. .014 Emond Monitor newly executed processes that may gain persistence and elevate privileges by executing malicious content triggered by the Event Monitor Daemon (emond). .015 Component Object Model Hijacking Monitor newly executed processes that may establish persistence by executing malicious content triggered by hijacked references to Component Object Model (COM) objects. .016 Installer Packages Monitor processes with arguments that may be related to abuse of installer packages, including malicious, likely elevated processes triggered by application installations. Enterprise T1480 Execution Guardrails Monitoring for suspicious processes being spawned that gather a variety of system information or perform other forms of Discovery, especially in a short period of time, may aid in detection. Detecting the use of guardrails may be difficult depending on the implementation. .001 Environmental Keying Monitoring for suspicious processes being spawned that gather a variety of system information or perform other forms of Discovery, especially in a short period of time, may aid in detection. Detecting the use of environmental keying may be difficult depending on the implementation. Enterprise T1052 Exfiltration Over Physical Medium Monitor for newly executed processes when removable media is mounted. .001 Exfiltration over USB Monitor for newly executed processes when removable media is mounted Enterprise T1203 Exploitation for Client Execution Monitor for abnormal process creations, such as a Command and Scripting Interpreter spawning from a potentially exploited application. Also look for other behavior on the endpoint system that might indicate successful compromise, such as abnormal behavior of browser or Office processes. Enterprise T1212 Exploitation for Credential Access Monitor for abnormal process creations, such as a Command and Scripting Interpreter spawning from a potentially exploited application. Also look for behavior on the system that might indicate successful compromise, such as abnormal behavior of processes. Enterprise T1211 Exploitation for Defense Evasion Monitor for abnormal process creations, such as a Command and Scripting Interpreter spawning from a potentially exploited application. Also look for behavior on the system that might indicate successful compromise, such as abnormal behavior of processes. Enterprise T1068 Exploitation for Privilege Escalation Monitor for newly executed processes that may exploit software vulnerabilities in an attempt to elevate privileges. Note: Event IDs are for Sysmon (Event ID 1 - process create) and Windows Security Log (Event ID 4688 - a new process has been created). The Analytic is oriented around looking for an invocation of either spoolsv.exe or conhost.exe by a user, thus alerting us of any potentially malicious activity. A common way of escalating privileges in a system is by externally invoking and exploiting these executables, both of which are legitimate Windows applications. Analytic 1 - Unusual Child Process for spoolsv.exe or connhost.exe processes = filter processes where ( (event_id == \"1\" OR event_id == \"4688\") AND (exe ==\"C:\\Windows\\System32\\spoolsv.exe\" OR exe ==\"C:\\Windows\\System32\\conhost.exe\") AND parent_image_path == \"C:\\Windows\\System32\\cmd.exe\") Enterprise T1083 File and Directory Discovery Monitor newly executed processes that may enumerate files and directories or may search in specific locations of a host or network share for certain information within a file system. Enterprise T1222 File and Directory Permissions Modification Monitor for newly executed processes that may modify file or directory permissions/attributes to evade access control lists (ACLs) and access protected files.[60][61] .001 Windows File and Directory Permissions Modification Monitor for newly constructed processes and/or command-lines that can interact with the DACLs using built-in Windows commands, such as icacls, cacls, takeown, and attrib, which can grant adversaries higher permissions on specific files and folders. .002 Linux and Mac File and Directory Permissions Modification Monitor for newly executed processes that may modify file or directory permissions/attributes to evade access control lists (ACLs) and access protected files.[60][61] ICS T0823 Graphical User Interface Monitor for newly executed processes related to services specifically designed to accept remote graphical connections, such as RDP and VNC. Remote Services and Valid Accounts may be used to access a host\u2019s GUI. Enterprise T1615 Group Policy Discovery Monitor for newly executed processes that may gather information on Group Policy settings to identify paths for privilege escalation, security measures applied within a domain, and to discover patterns in domain objects that can be manipulated or used to blend in the environment. Enterprise T1564 Hide Artifacts Monitor newly executed processes that may attempt to hide artifacts associated with their behaviors to evade detection. .001 Hidden Files and Directories Monitor newly executed processes that may set files and directories to be hidden to evade detection mechanisms. .002 Hidden Users Monitor newly executed processes for actions that could be taken to add a new user and subsequently hide it from login screens. .003 Hidden Window Monitor newly executed processes that may use hidden windows to conceal malicious activity from the plain sight of users. .006 Run Virtual Instance Monitor newly executed processes associated with running a virtual instance, such as those launched from binary files associated with common virtualization technologies (ex: VirtualBox, VMware, QEMU, Hyper-V). .009 Resource Forking Monitor newly executed processes that may abuse resource forks to hide malicious code or executables to evade detection and bypass security applications. .010 Process Argument Spoofing Analyze process behavior to determine if a process is performing actions it usually does not and/or do no align with its logged command-line arguments. Detection of process argument spoofing may be difficult as adversaries may momentarily modify stored arguments used for malicious execution. These changes may bypass process creation detection and/or later process memory analysis. Consider monitoring for Process Hollowing, which includes monitoring for process creation (especially those in a suspended state) as well as access and/or modifications of these processes (especially by the parent process) via Windows API calls.[62][63] .011 Ignore Process Interrupts Monitor newly created processes for artifacts, such as nohup or PowerShell -ErrorAction SilentlyContinue, that may attempt to hide processes from interrupt signals. Enterprise T1574 Hijack Execution Flow Monitor processes for unusual activity (e.g., a process that does not use the network begins to do so, abnormal process call trees). Track library metadata, such as a hash, and compare libraries that are loaded at process execution time against previous executions to detect differences that do not correlate with patching or updates. .002 DLL Side-Loading Monitor newly constructed processes for unusual activity (e.g., a process that does not use the network begins to do so) as well as the introduction of new files/programs. .005 Executable Installer File Permissions Weakness Monitor for newly constructed processes to match an existing service executables. .006 Dynamic Linker Hijacking Monitor for newly executed processes for unusual activity (e.g., a process that does not use the network begins to do so). .007 Path Interception by PATH Environment Variable Monitor for newly executed processes for process executable paths that are named for partial directories. .008 Path Interception by Search Order Hijacking Monitor for newly executed processes for process executable paths that are named for partial directories. .009 Path Interception by Unquoted Path Monitor for newly executed processes that may execute their own malicious payloads by hijacking vulnerable file path references. .010 Services File Permissions Weakness Monitor for newly executed processes that may execute their own malicious payloads by hijacking the binaries used by services. .011 Services Registry Permissions Weakness Monitor suspicious programs execution through services. These processes may show up as outlier processes that have not been seen before when compared against historical data. .012 COR_PROFILER Monitor for newly executed processes, such as setx.exe, that may abuse of the COR_PROFILER variable, monitor for new suspicious unmanaged profiling DLLs loading into .NET processes shortly after the CLR causing abnormal process behavior.[64] Enterprise T1562 Impair Defenses Monitor newly executed processes that may maliciously modify components of a victim environment in order to hinder or disable defensive mechanisms. .001 Disable or Modify Tools In an attempt to avoid detection after compromising a machine, threat actors often try to disable Windows Defender. This is often done using \"sc\" [service control], a legitimate tool provided by Microsoft for managing services. This action interferes with event detection and may lead to a security event going undetected, thereby potentially leading to further compromise of the network. Note: Though this analytic is utilizing Event ID 1 for process creation, the arguments are specifically looking for the use of service control for querying or trying to stop Windows Defender. Analytic 1 - Detecting Tampering of Windows Defender Command Prompt target_processes = filter processes where ((exe=\"C:\\Windows\\System32\\sc.exe\") AND (command_line=\"sc config\" OR command_line=\"sc stop\" OR command_line=\"sc query\")) .002 Disable Windows Event Logging Monitor newly executed processes that may disable Windows event logging to limit data that can be leveraged for detections and audits. Analytic 1 - Disable Windows Event Logging susp_processes = filter processes where ((command_line CONTAINS(\"New-Item\") OR command_line CONTAINS(\"reg add\")) OR command_line CONTAINS(\"MiniNt\")) OR (command_line CONTAINS(\"Stop-Service\")AND command_line CONTAINS(\"EventLog\")) OR (command_line CONTAINS(\"EventLog\") AND (command_line CONTAINS(\"Set-Service\") OR command_line CONTAINS(\"reg add\") OR command_line CONTAINS(\"Set-ItemProperty\") OR command_line CONTAINS(\"New-ItemProperty\") OR command_line CONTAINS(\"sc config\"))) OR (command_line CONTAINS(\"auditpol\") AND (command_line CONTAINS(\"/set\") OR command_line CONTAINS(\"/clear\") OR command_line CONTAINS(\"/revove\"))) OR ((command_line CONTAINS(\"wevtutil\") AND (command_line CONTAINS(\"sl\") OR command_line CONTAINS(\"set-log\")))) .009 Safe Mode Boot Monitor newly executed processes that may abuse Windows safe mode to disable endpoint defenses. .010 Downgrade Attack Monitor newly executed processes that may downgrade or use a version of system features that may be outdated, vulnerable, and/or does not support updated security controls such as logging. .011 Spoof Security Alerting Consider monitoring for suspicious processes that may be spoofing security tools and monitoring messages. Enterprise T1070 Indicator Removal Monitor for newly executed processes that may delete or alter generated artifacts on a host system, including logs or captured files such as quarantined malware. .001 Clear Windows Event Logs Monitor for newly executed processes that may clear Windows Event Logs to hide the activity of an intrusion. In an attempt to clear traces after compromising a machine, threat actors often try to clear Windows Event logs. This is often done using \"wevtutil\", a legitimate tool provided by Microsoft. This action interferes with event collection and notification, and may lead to a security event going undetected, thereby potentially leading to further compromise of the network. Analytic 1 - Clearing Windows Logs with Wevtutil cleared_logs = filter processes where (event_id = \"1\" AND process_name = \"wevtutil\" AND cmd_line= \"cl\" .005 Network Share Connection Removal Monitor for newly constructed processes and/or command line execution that can be used to remove network share connections via the net.exe process. Note: Event IDs are for Sysmon (Event ID 1 - process create) and Windows Security Log (Event ID 4688 - a new process has been created). The Analytic is oriented around looking for various methods of removing network shares via the command line, which is otherwise a rare event. Analytic 1: Network Share Connection Removal target_processes = filter processes where ( (event_id == \"1\" OR event_id == \"4688\") AND (exe == \"C:\\Windows\\System32\\net.exe\" AND command_line == \"delete\") OR command_line=\"Remove-SmbShare\" OR command_line=\"Remove-FileShare\" ) .007 Clear Network Connection History and Configurations Monitor created processes with arguments that may delete or alter malicious network configuration settings as well as generated artifacts that highlight network connection history on a host system -- which may include logs, files, or Registry values. .008 Clear Mailbox Data Monitor for newly executed processes with arguments that may delete or alter generated artifacts on a host system, including logs or captured files such as quarantined emails. .009 Clear Persistence Monitor for newly executed processes that may delete or alter generated artifacts associated with persistence on a host system. ICS T0872 Indicator Removal on Host Monitor for newly executed processes that may delete or alter generated artifacts on a host system, including logs or captured files such as quarantined malware. Enterprise T1202 Indirect Command Execution Monitor for newly constructed processes and/or command-lines that can be used instead of invoking cmd (i.e. pcalua.exe, winrs.exe, cscript/wscript.exe, hh.exe, or bash.exe) Enterprise T1490 Inhibit System Recovery Use process monitoring to monitor the execution and command line parameters of binaries involved in inhibiting system recovery, such as vssadmin, wbadmin, and bcdedit. After compromising a network of systems, threat actors often try to delete/resize Shadow Copy in an attempt to prevent administrators from restoring the systems to versions present before the attack. This is often done via vssadmin, a legitimate Windows tool to interact with shadow copies. This action is often employed by ransomware, may lead to a failure in recovering systems after an attack. The pseudo code detection focus on Windows Security and Sysmon process creation (4688 and 1). The use of wmic to delete shadow copy generates WMI-Activity Operationnal 5857 event and could generate 5858 (if the operation fails). These 2 EventIDs could be interesting when attackers use wmic without process creation and/or for forensics. Analytic 1 - Detecting Shadow Copy Deletion or Resize deleted_copy = filter processes where ((event_id =\"4688\" OR event_id =\"1\") (CommandLine=\"vssadmin delete shadows\" OR CommandLine=\"wmic shadowcopy delete\" OR CommandLine=\"vssadmin resize shadowstorage\")) OR (event_id =\"5857\" ProviderName=\"MSVSS__PROVIDER\") OR (event_id =\"5858\" Operation=\"Win32_ShadowCopy\") Analytic 2 - BCDEdit Failure Recovery Modification bcdedit_commands = filter processes where ( exe = \"C:\\Windows\\System32\\bcdedit.exe\" AND command_line=\"recoveryenabled\" ) Enterprise T1056 Input Capture Monitor for newly executed processes conducting malicious activity .002 GUI Input Capture Monitor for newly executed processes Enterprise T1559 Inter-Process Communication Monitor for newly executed processes that are associated with abuse of IPC mechanisms .001 Component Object Model Monitor for newly executed processes that are associated with COM objects, especially those invoked by a user different than the one currently logged on. .002 Dynamic Data Exchange Monitor for newly executed processes that may use Windows Dynamic Data Exchange (DDE) to execute arbitrary commands. Adversaries may use Windows Dynamic Data Exchange (DDE) to execute arbitrary commands. DDE is a client-server protocol for one-time and/or continuous inter-process communication (IPC) between applications. Once a link is established, applications can autonomously exchange transactions consisting of strings, warm data links (notifications when a data item changes), hot data links (duplications of changes to a data item), and requests for command execution. Analytic 1 - Unusual Child Process spawned using DDE exploit target_processes = filter processes where ( (parent_image=\"excel.exe\" OR parent_image=\"word.exe\" OR parent_image=\"outlook.exe\") AND image=\".exe\") Enterprise T1570 Lateral Tool Transfer Monitor newly constructed processes that assist in lateral tool transfers. ICS T0867 Lateral Tool Transfer Monitor newly constructed processes that assist in lateral tool transfers, such as file transfer programs. Enterprise T1654 Log Enumeration Monitor for unexpected process activity associated with utilities that can access and export logs, such as wevutil.exe on Windows and CollectGuestLogs.exe on Azure hosted VMs. Enterprise T1036 Masquerading Monitor for newly executed processes that may attempt to manipulate features of their artifacts to make them appear legitimate or benign to users and/or security tools. The RECYCLER and SystemVolumeInformation directories will be present on every drive. Replace %systemroot% and %windir% with the actual paths as configured by the endpoints. Analytic 1 - Suspicious Run Locations suspicious_locations = filter process where ( image_path == \":\\RECYCLER*\" or image_path == \":\\SystemVolumeInformation*\" or image_path == \"%windir%\\Tasks*\" or image_path == \"%systemroot%\\debug*\") .005 Match Legitimate Name or Location Monitor for newly executed processes that may match or approximate the name or location of legitimate files or resources when naming/placing them. Looks for mismatches between process names and their image paths.Malware authors often use this technique to hide malicious executables behind legitimate Windows executable names (e.g. lsass.exe, svchost.exe, etc).There are several sub-techniques, but this analytic focuses on Match Legitimate Name or Location only. Note: With process monitoring, hunt for processes matching these criteria: process name is svchost.exe, smss.exe, wininit.exe, taskhost.exe, etc. process path is not C:\\Windows\\System32\\ or C:\\Windows\\SysWow64\\ Examples (true positive):C:\\Users\\administrator\\svchost.exe To make sure the rule doesn\u2019t miss cases where the executable would be started from a sub-folder of these locations, the entire path is checked for the process path. The below example should be considered as suspicious: C:\\Windows\\System32\\srv\\svchost.exe Analytic 1 - Common Windows Process Masquerading suspicious_processes = filter processes where ( (exe=svchost.exe AND (image_path!=\"C:\\Windows\\System32\\svchost.exe\" OR process_path!=\"C:\\Windows\\SysWow64\\svchost.exe\")) OR (exe=smss.exe AND image_path!=\"C:\\Windows\\System32\\smss.exe\") OR (exe=wininit.exe AND image_path!=\"C:\\Windows\\System32\\wininit.exe\") OR (exe=taskhost.exe AND image_path!=\"C:\\Windows\\System32\\taskhost.exe\") OR (exe=lasass.exe AND image_path!=\"C:\\Windows\\System32\\lsass.exe\") OR (exe=winlogon.exe AND image_path!=\"C:\\Windows\\System32\\winlogon.exe\") OR (exe=csrss.exe AND image_path!=\"C:\\Windows\\System32\\csrss.exe\") OR (exe=services.exe AND image_path!=\"C:\\Windows\\System32\\services.exe\") OR (exe=lsm.exe AND image_path!=\"C:\\Windows\\System32\\lsm.exe\") OR (exe=explorer.exe AND image_path!=\"C:\\Windows\\explorer.exe\")) .009 Break Process Trees Monitor for the abnormal creation of background processes as well as processes executing from abnormal locations, such as /dev/shm. Enterprise T1112 Modify Registry Monitor processes and command-line arguments for actions that could be taken to change, conceal, and/or delete information in the Registry. (i.e. reg.exe, regedit.exe). The analytic is oriented around detecting invocations of Reg where the parent executable is an instance of cmd.exe that wasn\u2019t spawned by explorer.exe. The built-in utility reg.exe provides a command-line interface to the registry, so that queries and modifications can be performed from a shell, such as cmd.exe. When a user is responsible for these actions, the parent of cmd.exewill typically be explorer.exe. Occasionally, power users and administrators write scripts that do this behavior as well, but likely from a different process tree. These background scripts must be baselined so they can be tuned out accordingly. Analytic Event IDs are for Sysmon (Event ID 1 - process create) and Windows Security Log (Event ID 4688 - a new process has been created). Analytic 1 - Suspicious Processes reg_processes = filter processes where ( (event_id == \"1\" OR event_id == \"4688\") AND (exe == \"reg.exe\" AND parent_exe == \"cmd.exe\"))cmd_processes = filter processes where ( (event_id == \"1\" OR event_id == \"4688\") AND (exe == \"cmd.exe\" AND parent_exe != \"explorer.exe\"\"))reg_and_cmd_processes = join (reg_processes, cmd_processes) where (reg.parent_pid == cmd.pid and reg.hostname == cmd.hostname) Analytic 2 - Rare LolBAS Command Lines lolbas_processes = filter processes where (exe = \"At.exe\" OR exe = \"Atbroker.exe\" OR exe = \"Bash.exe\" OR exe = \"Bitsadmin.exe\" OR exe = \"Certutil.exe\" OR exe = \"Cmd.exe\" OR exe = \"Cmdkey.exe\" OR exe = \"Cmstp.exe\" OR exe = \"Control.exe\" OR exe = \"Csc.exe\" OR exe = \"Cscript.exe\" OR exe = \"Dfsvc.exe\" OR exe = \"Diskshadow.exe\" OR exe = \"Dnscmd.exe\" OR exe = \"Esentutl.exe\" OR exe = \"Eventvwr.exe\" OR exe = \"Expand.exe\" OR exe = \"Extexport.exe\" OR exe = \"Extrac32.exe\" OR exe = \"Findstr.exe\" OR exe = \"Forfiles.exe\" OR exe = \"Ftp.exe\" OR exe = \"Gpscript.exe\" OR exe = \"Hh.exe\" OR exe = \"Ie4uinit.exe\" OR exe = \"Ieexec.exe\" OR exe = \"Infdefaultinstall.exe\" OR exe = \"Installutil.exe\" OR exe = \"Jsc.exe\" OR exe = \"Makecab.exe\" OR exe = \"Mavinject.exe\" OR exe = \"Microsoft.Workflow.r.exe\" OR exe = \"Mmc.exe\" OR exe = \"Msbuild.exe\" OR exe = \"Msconfig.exe\" OR exe = \"Msdt.exe\" OR exe = \"Mshta.exe\" OR exe = \"Msiexec.exe\" OR exe = \"Odbcconf.exe\" OR exe = \"Pcalua.exe\" OR exe = \"Pcwrun.exe\" OR exe = \"Presentationhost.exe\" ORexe = \"Print.exe\" OR exe = \"Reg.exe\" OR exe = \"Regasm.exe\" OR exe = \"Regedit.exe\" OR exe = \"Register-cimprovider.exe\" OR exe = \"Regsvcs.exe\" OR exe = \"Regsvr32.exe\" OR exe = \"Replace.exe\" OR exe = \"Rpcping.exe\" OR exe = \"Rundll32.exe\" OR exe = \"Runonce.exe\" OR exe = \"Runscripthelper.exe\" OR exe = \"Sc.exe\" OR exe = \"Schtasks.exe\" OR exe = \"Scriptrunner.exe\" OR exe = \"SyncAppvPublishingServer.exe\" OR exe = \"Tttracer.exe\" OR exe = \"Verclsid.exe\" OR exe = \"Wab.exe\" OR exe = \"Wmic.exe\" OR exe = \"Wscript.exe\" OR exe = \"Wsreset.exe\" OR exe = \"Xwizard.exe\" OR exe = \"Advpack.dll OR exe = \"Comsvcs.dll OR exe = \"Ieadvpack.dll OR exe = \"Ieaframe.dll OR exe = \"Mshtml.dll OR exe = \"Pcwutl.dll OR exe = \"Setupapi.dll OR exe = \"Shdocvw.dll OR exe = \"Shell32.dll OR exe = \"Syssetup.dll ORexe = \"Url.dll OR exe = \"Zipfldr.dll OR exe = \"Appvlp.exe\" OR exe = \"Bginfo.exe\" OR exe = \"Cdb.exe\" OR exe = \"csi.exe\" OR exe = \"Devtoolslauncher.exe\" OR exe = \"dnx.exe\" OR exe = \"Dxcap.exe\" OR exe = \"Excel.exe\" OR exe = \"Mftrace.exe\" OR exe = \"Msdeploy.exe\" OR exe = \"msxsl.exe\" OR exe = \"Powerpnt.exe\" OR exe = \"rcsi.exe\" OR exe = \"Sqler.exe\" OR exe = \"Sqlps.exe\" OR exe = \"SQLToolsPS.exe\" OR exe = \"Squirrel.exe\" OR exe = \"te.exe\" OR exe = \"Tracker.exe\" OR exe = \"Update.exe\" OR exe = \"vsjitdebugger.exe\" OR exe = \"Winword.exe\" OR exe = \"Wsl.exe\" OR exe = \"CL_Mutexverifiers.ps1 OR exe = \"CL_Invocation.ps1 OR exe = \"Manage-bde.wsf OR exe = \"Pubprn.vbs OR exe = \"Slmgr.vbs OR exe = \"Syncappvpublishingserver.vbs OR exe = \"winrm.vbs OR exe = \"Pester.bat)process_count = count(lolbas_processes) by processprocess_count_avg = average(process_count)process_count_stdev = standard_deviation(process_count)lower_bound = process_count_avg - stdev * 1.5outliers = filter lolbas_processes where (process_count < lower_bound) ICS T0840 Network Connection Enumeration Monitor for executed processes (such as ipconfig/ifconfig and arp) with arguments that may look for details about the network configuration and settings, such as IP and/or MAC addresses. Also monitor for executed processes that may attempt to get a listing of network connections to or from the compromised system they are currently accessing or from remote systems by querying for information over the network. Enterprise T1135 Network Share Discovery Monitor for newly executed processes that may look for folders and drives shared on remote systems as a means of identifying sources of information to gather as a precursor for Collection and to identify potential systems of interest for Lateral Movement. Enterprise T1040 Network Sniffing Monitor for newly executed processes that can aid in sniffing network traffic to capture information about an environment, including authentication material passed over the network Note: The Analytic is for Windows systems and looks for new processes that have the names of the most common network sniffing tools. While this may be noisy on networks where sysadmins are using any of these tools on a regular basis, in most networks their use is noteworthy. Analytic 1 - Windows processes = filter processes where ((event_id == \"1\" OR event_id == \"4688\") ANDexe == \"tshark.exe\" ORexe == \"windump.exe\" OR(exe == \"logman.exe\" AND parent_exe exists AND parent_exe!=\"C:\\Program Files\\Windows Event Reporting\\Core\\EventReporting.AgentService.exe\") ORexe == \"tcpdump.exe\" ORexe == \"wprui.exe\" ORexe == \"wpr.exe\" ) ICS T0842 Network Sniffing Monitor for newly executed processes that can aid in sniffing network traffic to capture information about an environment. Enterprise T1027 Obfuscated Files or Information Monitor for newly executed processes that may attempt to make an executable or file difficult to discover or analyze by encrypting, encoding, or otherwise obfuscating its contents on the system or in transit. .004 Compile After Delivery Monitor for newly constructed processes and/or command-lines that look for non-native binary formats and cross-platform compiler and execution frameworks like Mono and determine if they have a legitimate purpose on the system. Typically these should only be used in specific and limited cases, like for software development. Enterprise T1137 Office Application Startup Monitor newly executed processes that may leverage Microsoft Office-based applications for persistence between startups. Collect process execution information including process IDs (PID) and parent process IDs (PPID) and look for abnormal chains of activity resulting from Office processes. Non-standard process execution trees may also indicate suspicious or malicious behavior. If winword.exe is the parent process for suspicious processes and activity relating to other adversarial techniques, then it could indicate that the application was used maliciously. .001 Office Template Macros Monitor newly executed processes that may abuse Microsoft Office templates to obtain persistence on a compromised system. .002 Office Test Monitor newly executed processes that may abuse the Microsoft Office \"Office Test\" Registry key to obtain persistence on a compromised system. .003 Outlook Forms Monitor newly executed processes that may abuse Microsoft Outlook forms to obtain persistence on a compromised system. .004 Outlook Home Page Monitor newly executed processes that may abuse Microsoft Outlook's Home Page feature to obtain persistence on a compromised system. .005 Outlook Rules Monitor newly executed processes that may abuse Microsoft Outlook rules to obtain persistence on a compromised system. .006 Add-ins Monitor newly executed processes that may abuse Microsoft Office add-ins to obtain persistence on a compromised system. Enterprise T1003 OS Credential Dumping Monitor for newly executed processes that may be indicative of credential dumping. On Windows 8.1 and Windows Server 2012 R2, monitor Windows Logs for LSASS.exe creation to verify that LSASS started as a protected process. .001 LSASS Memory Monitor for newly executed processes that may be indicative of credential dumping. On Windows 8.1 and Windows Server 2012 R2, monitor Windows Logs for LSASS.exe creation to verify that LSASS started as a protected process. Try monitoring for Sysmon Event ID 1 and/or Windows Security Event ID 4688 for process activity. Note: Rundll32/MiniDump has a different command-line syntax than that of Procdump, in that the process being dumped is specified via process ID instead of name (as with Procdump). Therefore, because the LSASS process ID is non-deterministic, the MiniDump detection isn\u2019t specific to LSASS dumping and may need to be tuned to help reduce false positives. Analytic 1 - Procdump processes = filter processes where ((event_id == \"1\" OR event_id == \"4688\") AND exe == \"procdump.exe\" and command_line == \"lsass*\") Analytic 2 - MiniDump via rundll32 processes = filter processes where ((event_id == \"1\" OR event_id == \"4688\") AND exe == \"rundll32.exe\" and command_line == \"comsvcs.dll MiniDump*\") Enterprise T1201 Password Policy Discovery Monitor for newly executed processes that may attempt to access detailed information about the password policy used within an enterprise network or cloud environment. Enterprise T1120 Peripheral Device Discovery Monitor for newly executed processes that may attempt to gather information about attached peripheral devices and components connected to a computer system. Enterprise T1069 Permission Groups Discovery Monitor for newly constructed processes and/or command-lines for actions that could be taken to gather system and network information. System and network discovery techniques normally occur throughout an operation as an adversary learns the environment. Data and events should not be viewed in isolation, but as part of a chain of behavior that could lead to other activities, such as Lateral Movement, based on the information obtained. .001 Local Groups Monitor newly executed processes that may attempt to find local system groups and permission settings. Note: Event IDs are for Sysmon (Event ID 1 - process creation) and Windows Security Log (Event ID 4688 - a new process has been created). The logic in the Analytic looks for any instances of net.exe used for local user/group discovery; although this utility is not normally used for benign purposes, such usage by system administrator actions may trigger false positives. Analytic 1 - Suspicious Processes processes = filter processes where ( (event_id == \"1\" OR event_id == \"4688\") AND exe = \"net.exe\" AND ( command_line=\"net user\" OR command_line=\"net group\" OR command_line=\"net localgroup\" OR command_line=\"get-localgroup\" OR command_line=\"get-ADPrincipalGroupMembership*\" ) .002 Domain Groups Monitor newly executed processes that may attempt to find domain-level groups and permission settings. For Linux, auditing frameworks that support alerting on process creation, including the audit daemon (auditd), can be used to alert on invocations of commands such as ldapsearch. For MacOS, utilities that work in concert with Apple\u2019s Endpoint Security Framework such as Process Monitor can be used to track usage of commands such as dscacheutil -q group. Note: Event IDs are for Sysmon (Event ID 10 - process access) and Windows Security Log (Event ID 4688 - a new process has been created). Analytic 1 - Local Permission Group Discovery - Net processes = filter processes where ((event_id=\"10\" OR event_id=\"4688\") AND (exe == \"net.exe\" OR exe == \"net1.exe\") AND command_line=\"group/domain*\") .003 Cloud Groups Monitor newly executed processes that may attempt to find cloud groups and permission settings. Enterprise T1647 Plist File Modification Monitor for newly executed processes with arguments that can modify property list (plist) files. Enterprise T1057 Process Discovery Monitor for newly executed processes that may attempt to get information about running processes on a system. To be effective in deciphering malicious and benign activity, the full command line is essential. Similarly, having information about the parent process can help with making decisions and tuning to an environment. Because these commands are built in, they may be run frequently by power users or even by normal users. Thus, an analytic looking at this information should have well-defined white- or blacklists, and should consider looking at an anomaly detection approach, so that this information can be learned dynamically.Within the built-in Windows Commands: hostname ipconfig net quser qwinsta sc with flags query, queryex, qc systeminfo tasklist dsquery whoamiNote dsquery is only pre-existing on Windows servers. Analytic 1 - Host Discovery Commands info_command = filter process where ( exe == \"hostname.exe\" or exe == \"ipconfig.exe\" or exe == \"net.exe\" or exe == \"quser.exe\" or exe == \"qwinsta.exe\" or exe == \"sc\" and (command_line match \" query\" or command_line match \" qc\")) or exe == \"systeminfo.exe\" or exe == \"tasklist.exe\" or exe == \"whoami.exe\") Enterprise T1055 .012 Process Injection: Process Hollowing Monitor for newly executed processes that may inject malicious code into suspended and hollowed processes in order to evade process-based defenses. Adversaries may start legitimate processes and then use their memory space to run malicious code. This analytic looks for common Windows processes that have been abused this way in the past; when the processes are started for this purpose they may not have the standard parent that we would expect. This list is not exhaustive, and it is possible for cyber actors to avoid this discepency. These signatures only work if Sysmon reports the parent process, which may not always be the case if the parent dies before sysmon processes the event. Analytic 1 - Processes Started From Irregular Parents mismatch_processes = filter processes where ( parent_exe exists AND (exe=\"smss.exe\" AND (parent_exe!=\"smss.exe\" AND parent_exe!=\"System\") OR (exe=\"csrss.exe\" AND (parent_exe!=\"smss.exe\" AND parent_exe!=\"svchost.exe\")) OR (exe=\"wininit.exe\" AND parent_exe!=\"smss.exe\") OR (exe=\"winlogon.exe\" AND parent_exe!=\"smss.exe\") OR (exe=\"lsass.exe\" AND (parent_exe!=\"wininit.exe\" AND parent_exe!=\"winlogon.exe\")) OR (exe=\"LogonUI.exe\" AND (parent_exe!=\"winlogon.exe\" AND parent_exe!=\"wininit.exe\")) OR (exe=\"services.exe\" AND parent_exe!=\"wininit.exe\") OR (exe=\"spoolsv.exe\" AND parent_exe!=\"services.exe\") OR (exe=\"taskhost.exe\" AND (parent_exe!=\"services.exe\" AND parent_exe!=\"svchost.exe\")) OR (exe=\"taskhostw.exe\" AND (parent_exe!=\"services.exe\" AND parent_exe!=\"svchost.exe\")) OR (exe=\"userinit.exe\" AND (parent_exe!=\"dwm.exe\" AND parent_exe!=\"winlogon.exe\")) Enterprise T1012 Query Registry Monitor for newly executed processes that may interact with the Windows Registry to gather information about the system, configuration, and installed software. Note: The New-PSDrive PowerShell cmdlet creates temporary and persistent drives that are mapped to or associated with a location in a data store, such a registry key (PSProvider \"Registry\"). The Get-ChildItem gets the items in one or more specified locations. By using both, you can enumerate COM objects in one or more specified locations. Note for Analytic 3: Replace FilePathToLolbasProcessXX.exe with lolBAS process names that are used by your organization. The number_standard_deviations parameter should be tuned accordingly. Identifying outliers by comparing distance from a data point to the average value against a certain number of standard deviations is recommended for data values that are symmetrical distributed. If your data is not distributed, try a different algorithm such as the Interquartile Range (IQR). Analytic 1 - Suspicious Processes with Registry keys suspicious_processes = filter processes where (EventId == \"1\" OR EventId == \"4688\") AND((ProcessCommandLine LIKE '%reg%' AND ProcessCommandLine LIKE '%query%') OR (ProcessCommandLine LIKE '%Registry%' AND (ProcessCommandLine LIKE '%HKEY_CLASSES_ROOT%' OR ProcessCommandLine '%HKCR%'))) Analytic 2 - reg.exe spawned from suspicious cmd.exe reg_processes = filter processes where (EventId == \"1\" OR EventId == \"4688\") AND (ProcessFilePath LIKE '%reg.exe%' AND ProcessParentFilePath LIKE '%cmd.exe%') cmd_processes = filter command_line where (event_id == \"1\" OR event_id == \"4688\") AND (ProcessFilePath LIKE '%cmd.exe%' AND ProcessParentFilePath NOT LIKE '%explorer.exe%') suspicious_processes = SELECT r.ProcessGuid, r.ProcessFilePath, c.ProcessFilePath AS ProcessParentFilePathFROM reg_processes rINNER JOIN cmd_processes cON r.ProcessParentGuid = c.ProcessGuid Analytic 3 - Rare LolBAS command lines count_lolbas_processes = filter processes where (EventId == \"1\" OR EventId == \"4688\") AND ProcessFilePath IN ('FilePathToLolbasProcess01.exe','FilePathToLolbasProcess02.exe')GROUP BY ProcessFilePath number_standard_deviations = 1.5 suspicious_processes = SELECT ProcessFilePath, ProcessCount, AVG(ProcessCount) Over() - STDEV(ProcessCount) Over() * number_standard_deviations as LowerBound FROM count_lolbas_processesWHERE ProcessCount < LowerBound Enterprise T1219 Remote Access Software Monitor for applications and processes related to remote admin software. Correlate activity with other suspicious behavior that may reduce false positives if this type of software is used by legitimate users and administrators. Domain Fronting may be used in conjunction to avoid defenses. Adversaries will likely need to deploy and/or install these remote software to compromised systems. It may be possible to detect or prevent the installation of this type of software with host-based solutions. Enterprise T1563 Remote Service Session Hijacking Monitor newly executed processes that may take control of preexisting sessions with remote services to move laterally in an environment. .001 SSH Hijacking Monitor newly executed processes that may hijack a legitimate user's SSH session to move laterally within an environment. .002 RDP Hijacking Consider monitoring processes for tscon.exe usage. Using tscon.exe to hijack an RDP session requires SYSTEM level permissions. Therefore, we recommend also looking for Privilege Escalation techniques that may be used for this purpose in conjunction with RDP Session Hijacking. In addition to tscon.exe, mstsc.exe can similarly be used to hijack existing RDP sessions. In this case, we recommend looking for the command-line parameters of /noconsentPrompt and /shadow:, which allow for stealthy hijacking of an RDP session with no prompt and without kicking off the existing session. Enterprise T1021 Remote Services Monitor for newly executed processes that may use Valid Accounts to log into a service specifically designed to accept remote connections, such as RDP, telnet, SSH, and VNC. The adversary may then perform actions that spawn additional processes as the logged-on user. .001 Remote Desktop Protocol Monitor for newly executed processes (such as mstsc.exe) that may use Valid Accounts to log into a computer using the Remote Desktop Protocol (RDP). The adversary may then perform actions that spawn additional processes as the logged-on user. .002 SMB/Windows Admin Shares Monitor for the creation of WMI Win32_Process class and method Create to interact with a remote network share using Server Message Block (SMB). Relevant indicators detected by Bro/Zeek is IWbemServices::ExecMethod or IWbemServices::ExecMethodAsync. One thing to notice is that when the Create method is used on a remote system, the method is run under a host process named \"Wmiprvse.exe\". The process WmiprvSE.exe is what spawns the process defined in the CommandLine parameter of the Create method. Therefore, the new process created remotely will have Wmiprvse.exe as a parent. WmiprvSE.exe is a DCOM server and it is spawned underneath the DCOM service host svchost.exe with the following parameters C:\\WINDOWS\\system32\\svchost.exe -k DcomLaunch -p. From a logon session perspective, on the target, WmiprvSE.exe is spawned in a different logon session by the DCOM service host. However, whatever is executed by WmiprvSE.exe occurs on the new network type (3) logon session created by the user that authenticated from the network. Analytic 1 - Basic suspicious_smb_traffic = filter processes where((event_id = \"4688\" or event_id = \"1\") AND parent_process_name = \"wmiprvse.exe\" AND targetlogonid = \"0x3e7\") .003 Distributed Component Object Model Monitor for newly executed processes associated with DCOM activity, especially those invoked by a user different than the one currently logged on. Enumeration of COM objects, via Query Registry or PowerShell, may also precede malicious use.[65][66] The Microsoft Management Console (mmc.exe) can be by used by threat actors used to spawn arbitrary processes through DCOM. The typical process tree for this method looks like: svchost.exe \u2014> mmc.exe \u2014> .exe. Accordingly, look for process creation events of mmc.exe in conjunction with the -Embedding command-line argument, along with suspicious child processes that can be used for malicious purposes, such as cmd.exe, reg.exe, etc. Similar to the Microsoft Management Console, Excel can also be used to execute processes through DCOM. In this case, the typical process tree looks like: svchost.exe \u2014> excel.exe \u2014> .exe. Look for process creation events of excel.exe in conjunction with the /automation -Embedding command-line argument, along with suspicious child processes that can be used for malicious purposes, such as cmd.exe, reg.exe, etc. .004 SSH Monitor for newly executed processes that may use Valid Accounts to log into remote machines using Secure Shell (SSH). For example, on macOS systems log show --predicate 'process = \"sshd\"' can be used to review incoming SSH connection attempts for suspicious activity. The command log show --info --predicate 'process = \"ssh\" or eventMessage contains \"ssh\"' can be used to review outgoing SSH connection activity.[67] For Linux systems, the Audit framework (auditd) can be used to monitor for the creation of SSH related processes such as ssh. For macOS systems (10.12+), the above command can be used to look through the Unified Logs for SSH connection activity, though we also recommend including the \"\u2014debug\" parameter to ensure that all relevant data is returned: log show --info --debug --predicate 'process = \"ssh\" or eventMessage contains \"ssh\"' .005 VNC Monitor for newly executed processes that may use Valid Accounts to remotely control machines using Virtual Network Computing (VNC). For example, on macOS systems the screensharingd process may be related to VNC connection activity.[67] .006 Windows Remote Management Monitor for newly executed processes that may use Valid Accounts to interact with remote systems using Windows Remote Management (WinRM), as well as service processes such as wmiprvse.exe on destination hosts. ICS T0886 Remote Services Monitor for newly executed processes related to services specifically designed to accept remote connections, such as RDP, Telnet, SSH, and VNC. The adversary may use Valid Accounts to login and may perform follow-on actions that spawn additional processes as the user. Enterprise T1018 Remote System Discovery Monitor for newly executed processes that can be used to discover remote systems, such as ping.exe and tracert.exe, especially when executed in quick succession.[52] ICS T0846 Remote System Discovery Monitor for newly executed processes that can be used to discover remote systems, such as ping.exe and tracert.exe , especially when executed in quick succession.[52] Consider monitoring for new processes engaging in scanning activity or connecting to multiple systems by correlating process creation network data. ICS T0888 Remote System Information Discovery Monitor for newly executed processes that can be used to discover remote systems, such as ping.exe and tracert.exe, especially when executed in quick succession.[52] Consider monitoring for new processes engaging in scanning activity or connecting to multiple systems by correlating process creation network data. Enterprise T1091 Replication Through Removable Media Monitor for newly executed processes that execute from removable media after it is mounted or when initiated by a user. If a remote access tool is used in this manner to move laterally, then additional actions are likely to occur after execution, such as opening network connections for Command and Control and system and network information Discovery. ICS T0847 Replication Through Removable Media Monitor for newly executed processes that execute from removable media after it is mounted or when initiated by a user. If a remote access tool is used in this manner to move laterally, then additional actions are likely to occur after execution, such as opening network connections for Command and Control and system and network information Discovery. Enterprise T1496 Resource Hijacking Monitor for common cryptomining or proxyware software process names that may indicate compromise and resource usage. Enterprise T1053 Scheduled Task/Job Monitor for newly executed processes that may abuse task scheduling functionality to facilitate initial or recurring execution of malicious code. .002 At Monitor for newly constructed processes with command-lines that create/modify or are executed from tasks. For example, on Windows tasks may spawn from svchost.exe or the Windows Task Scheduler taskeng.exe for older OS versions. [68] Suspicious program execution through scheduled tasks may show up as outlier processes that have not been seen before when compared against historical data. Instances of the process at.exe running imply the querying or creation of tasks. Although the command_line is not essential for the analytic to run, it is critical when identifying the command that was scheduled. Analytic at = filter process where (exe == \"at.exe\") .003 Cron Monitor for newly constructed processes and/or command-lines that executed through scheduled tasks may show up as outlier processes that have not been seen before when compared against historical data. Data and events should not be viewed in isolation, but as part of a chain of behavior that could lead to other activities, such as network connections made for Command and Control, learning details about the environment through Discovery, and Lateral Movement. .005 Scheduled Task Monitor for newly constructed processes and/or command-lines that execute from the svchost.exe in Windows 10 and the Windows Task Scheduler taskeng.exe for older versions of Windows. [68] If scheduled tasks are not used for persistence, then the adversary is likely to remove the task when the action is complete. Look for instances of schtasks.exe running as processes. The command_line field is necessary to disambiguate between types of schtasks commands. These include the flags /create , /run, /query, /delete, /change, and /end. Detection of the creation or modification of Scheduled Tasks with a suspicious script, extension or user writable path. Attackers may create or modify Scheduled Tasks for the persistent execution of malicious code. This detection focuses at the same time on EventIDs 4688 and 1 with process creation (SCHTASKS) and EventID 4698, 4702 for Scheduled Task creation/modification event log. Analytic 1 - New processes whose parent processes are svchost.exe or taskeng.exe suspicious_processes = filter ProcessId, ProcessFilePath, ProcessParentFilePath where (EventId == \"1\" OR EventId == \"4688\") AND (ProcessParentFilePath LIKE '%svchost.exe%' OR ProcessParentFilePath LIKE '%taskeng.exe%') Analytic 2 - Scheduled Task Creation or Modification Containing Suspicious Scripts, Extensions or User Writable Paths susp_tasks_processes = filter processes where command_line CONTAINS(\"SCHTASKS\") AND (command_line CONTAINS(\"/CREATE\") OR command_line CONTAINS(\"/CHANGE\")) AND (command_line CONTAINS(\".cmd\") OR command_line CONTAINS(\".ps1\") OR command_line CONTAINS(\".vbs\") OR command_line CONTAINS(\".py\") OR command_line CONTAINS(\".js\") OR command_line CONTAINS(\".exe\") OR command_line CONTAINS(\".bat\") OR (command_line CONTAINS(\"javascript\") OR command_line CONTAINS(\"powershell\") OR command_line CONTAINS(\"wmic\") OR command_line CONTAINS(\"rundll32\") OR command_line CONTAINS(\"cmd\") OR command_line CONTAINS(\"cscript\") OR command_line CONTAINS(\"wscript\") OR command_line CONTAINS(\"regsvr32\") OR command_line CONTAINS(\"mshta\") OR command_line CONTAINS(\"bitsadmin\") OR command_line CONTAINS(\"certutil\") OR command_line CONTAINS(\"msiexec\") OR command_line CONTAINS(\"javaw\") OR (command_line CONTAINS(\"%APPDATA%\") OR command_line CONTAINS(\"\\AppData\\Roaming\") OR command_line CONTAINS(\"%PUBLIC%\") OR command_line CONTAINS(\"C:\\Users\\Public\") OR command_line CONTAINS(\"%ProgramData%\") OR command_line CONTAINS(\"C:\\ProgramData\") OR command_line CONTAINS(\"%TEMP%\") OR command_line CONTAINS(\"\\AppData\\Local\\Temp\") OR command_line CONTAINS(\"\\Windows\\PLA\\System\") OR command_line CONTAINS(\"\\tasks\") OR command_line CONTAINS(\"\\Registration\\CRMLog\") OR command_line CONTAINS(\"\\FxsTmp\") OR command_line CONTAINS(\"\\spool\\drivers\\color\") OR command_line CONTAINS(\"\\tracing\")))) tasks = search Task:createsusp_tasks = filter tasks where (task_content CONTAINS(\".cmd\") OR task_content CONTAINS(\".ps1\") OR task_content CONTAINS(\".vbs\") OR task_content CONTAINS(\".py\") OR task_content CONTAINS(\".js\") OR task_content CONTAINS(\".exe\") OR task_content CONTAINS(\".bat\") OR (task_content CONTAINS(\"javascript\") OR task_content CONTAINS(\"powershell\") OR task_content CONTAINS(\"wmic\") OR task_content CONTAINS(\"rundll32\") OR task_content CONTAINS(\"cmd\") OR task_content CONTAINS(\"cscript\") OR task_content CONTAINS(\"wscript\") OR task_content CONTAINS(\"regsvr32\") OR task_content CONTAINS(\"mshta\") OR task_content CONTAINS(\"bitsadmin\") OR task_content CONTAINS(\"certutil\") OR task_content CONTAINS(\"msiexec\") OR task_content CONTAINS(\"javaw\") OR (task_content CONTAINS(\"%APPDATA%\") OR task_content CONTAINS(\"\\AppData\\Roaming\") OR task_content CONTAINS(\"%PUBLIC%\") OR task_content CONTAINS(\"C:\\Users\\Public\") OR task_content CONTAINS(\"%ProgramData%\") OR task_content CONTAINS(\"C:\\ProgramData\") OR task_content CONTAINS(\"%TEMP%\") OR task_content CONTAINS(\"\\AppData\\Local\\Temp\") OR task_content CONTAINS(\"\\Windows\\PLA\\System\") OR task_content CONTAINS(\"\\tasks\") OR task_content CONTAINS(\"\\Registration\\CRMLog\") OR task_content CONTAINS(\"\\FxsTmp\") OR task_content CONTAINS(\"\\spool\\drivers\\color\") OR task_content CONTAINS(\"\\tracing\")))) .006 Systemd Timers Monitor for newly constructed processes and/or command-lines that will have a parent process of \u2018systemd\u2019, a parent process ID of 1, and will usually execute as the \u2018root\u2019 user. ICS T0853 Scripting Monitor log files for process execution through command-line and scripting activities. This information can be useful in gaining additional insight to adversaries' actions through how they use native processes or custom tools. Also monitor for loading of modules associated with specific languages. Enterprise T1505 Server Software Component Process monitoring may be used to detect servers components that perform suspicious actions such as running cmd.exe or accessing files. .003 Web Shell Web shells can be difficult to detect. Unlike other forms of persistent remote access, they do not initiate connections. The portion of the Web shell that is on the server may be small and innocuous looking. The PHP version of the China Chopper Web shell, for example, is very similar to the following short payload: [69] <?php @evaI($_P0ST['password']);> Nevertheless, detection mechanisms exist. Process monitoring may be used to detect Web servers that perform suspicious actions such as spawning cmd.exe or accessing files that are not in the Web directory.[70] A web shell is a web script placed on an openly accessible web server to allow an adversary to use the server as a gatway in a network. As the shell operates, commands will be issued from within the web application into the broader server operating system. This analytic looks for host enumeration executables initiated by any web service that would not normally be executed within that environment. Analytic 1 - Webshell-Indicative Process Tree suspicious_processes = filter processes where ( (parent_exe == \"w3wp.exe\" OR parent_exe == \"httpd.exe\" OR parent_exe == \"tomcat*.exe\" OR parent_exe == \"nginx.exe\" ) AND (exe == \"cmd.exe\" OR exe == \"powershell.exe\" OR exe == \"net.exe\" OR exe == \"whoami.exe\" OR exe == \"hostname.exe\" OR exe == \"systeminfo.exe\" OR exe == \"ipconfig.exe) ) .005 Terminal Services DLL Monitor processes with arguments that may potentially highlight adversary actions to modify Registry values (ex: reg.exe) or modify/replace the legitimate termsrv.dll. Enterprise T1489 Service Stop Monitor for newly executed processes that may stop or disable services on a system to render those services unavailable to legitimate users. ICS T0881 Service Stop Monitor for newly executed processes that may stop or disable services on a system to render those services unavailable to legitimate users. Enterprise T1072 Software Deployment Tools Monitor for newly executed processes that does not correlate to known good software. Analyze the process execution trees, historical activities from the third-party application (such as what types of files are usually pushed), and the resulting activities or events from the file/binary/script pushed to systems. Enterprise T1518 Software Discovery Monitor newly executed processes that may attempt to get a listing of software and software versions that are installed on a system or in a cloud environment. .001 Security Software Discovery Monitor newly executed processes that may attempt to get a listing of security software, configurations, defensive tools, and sensors that are installed on a system or in a cloud environment. ICS T0865 Spearphishing Attachment Monitor for suspicious descendant process spawning from Microsoft Office and other productivity software.[52] For added context on adversary procedures and background see Spearphishing Attachment. Enterprise T1553 Subvert Trust Controls Monitor processes and arguments for malicious attempts to modify trust settings, such as the installation of root certificates or modifications to trust attributes/policies applied to files. .001 Gatekeeper Bypass Monitor and investigate attempts to modify extended file attributes with utilities such as xattr. Built-in system utilities may generate high false positive alerts, so compare against baseline knowledge for how systems are typically used and correlate modification events with other indications of malicious activity where possible. .004 Install Root Certificate Monitor for processes, such as certmgr.exe (macOS) or certutil.exe (Windows), that can be used to install root certificates. A system's root certificates are unlikely to change frequently. Monitor new certificates installed on a system that could be due to malicious activity. [71] Check pre-installed certificates on new systems to ensure unnecessary or suspicious certificates are not present. Microsoft provides a list of trustworthy root certificates online and through authroot.stl. [71] The Sysinternals Sigcheck utility can also be used (sigcheck[64].exe -tuv) to dump the contents of the certificate store and list valid certificates not rooted to the Microsoft Certificate Trust List. [72] Analytic 1 - Attempt to Add Certificate to Untrusted Store addstore_commands = filter processes where ( exe =\"C:\\Windows\\System32\\certutil.exe\" AND command_line=\"-addstore\" ) .006 Code Signing Policy Modification Monitor processes and command-line arguments for actions that could be taken to modify the code signing policy of a system, such as bcdedit.exe -set TESTSIGNING ON. [73] Enterprise T1218 System Binary Proxy Execution Monitor processes and command-line parameters for signed binaries that may be used to proxy execution of malicious files. Compare recent invocations of signed binaries that may be used to proxy execution with prior history of known good arguments and loaded files to determine anomalous and potentially adversarial activity. Legitimate programs used in suspicious ways, like msiexec.exe downloading an MSI file from the Internet, may be indicative of an intrusion. Correlate activity with other suspicious behavior to reduce false positives that may be due to normal benign use by users and administrators. .001 Compiled HTML File Monitor and analyze the execution and arguments of hh.exe. [74] Compare recent invocations of hh.exe with prior history of known good arguments to determine anomalous and potentially adversarial activity (ex: obfuscated and/or malicious commands). Non-standard process execution trees may also indicate suspicious or malicious behavior, such as if hh.exe is the parent process for suspicious processes and activity relating to other adversarial techniques. Note: Event IDs are for Sysmon (Event ID 1 - process create) and Windows Security Log (Event ID 4688 - a new process has been created). The Analytic looks for the creation of any HTML Help Executable ( hh.exe ) processes. Adversaries may hide malicious code in .chm compiled help files; whenever a user tries to open one of these files, Windows executes the HTML Help Executable. Therefore, if there are legitimate uses of compiled help files in your environment, this analytic may lead to false positives and will require additional tuning. Analytic 1 - Compiled HTML Access processes = filter processes where ((event_id == \"1\" OR event_id == \"4688\") AND exe=\"C:\\Windows\\syswow64\\hh.exe\" OR exe=\"C:\\Windows\\system32\\hh.exe\") .002 Control Panel Monitor and analyze activity related to items associated with CPL files, such as the control.exe. Analyze new Control Panel items as well as those present on disk for malicious content. Both executable and CPL formats are compliant Portable Executable (PE) images and can be examined using traditional tools and methods, pending anti-reverse-engineering techniques.[75] .003 CMSTP Use process monitoring to detect and analyze the execution and arguments of CMSTP.exe. Compare recent invocations of CMSTP.exe with prior history of known good arguments and loaded files to determine anomalous and potentially adversarial activity. Sysmon events can also be used to identify potential abuses of CMSTP.exe. Detection strategy may depend on the specific adversary procedure, but potential rules include: [76]* To detect loading and execution of local/remote payloads - Event 1 (Process creation) where ParentImage contains CMSTP.exe* Also monitor for events, such as the creation of processes (Sysmon Event 1), that involve auto-elevated CMSTP COM interfaces such as CMSTPLUA (3E5FC7F9-9A51-4367-9063-A120244FBEC7) and CMLUAUTIL (3E000D72-A845-4CD9-BD83-80C07C3B881F). Note: Event IDs are for Sysmon (Event ID 1 - process create) and Windows Security Log (Event ID 4688 - a new process has been created). The Analytic looks for the creation of a new CMSTP.exe process which initiates a network connection to a non-local IP address. This is a specific implementation where CMSTP.exe can be leveraged to setup listeners that will receive and install malware from remote sources in a trusted fashion. Analytic 1 - CMSTP processes = filter processes where ( (event_id == \"1\" OR event_id == \"4688\") AND exe == \"C:\\Windows\\System32\\CMSTP.exe\" AND src_ip NOT IN [\"10.0.0.0/8\", \"192.168.0.0/16\", \"172.16.0.0/12\"] ) .004 InstallUtil Use process monitoring to monitor the execution and arguments of InstallUtil.exe. Compare recent invocations of InstallUtil.exe with prior history of known good arguments and executed binaries to determine anomalous and potentially adversarial activity .005 Mshta Use process monitoring to monitor the execution and arguments of mshta.exe. .007 Msiexec Use process monitoring to monitor the execution and arguments of msiexec.exe. Compare recent invocations of msiexec.exe with prior history of known good arguments and executed MSI files. .008 Odbcconf Use process monitoring to monitor the execution and arguments of odbcconf.exe. Compare recent invocations of odbcconf.exe with prior history of known good arguments and loaded DLLs to determine anomalous and potentially adversarial activity. .009 Regsvcs/Regasm Use process monitoring to monitor the execution and arguments of Regsvcs.exe and Regasm.exe. Compare recent invocations of Regsvcs.exe and Regasm.exe with prior history of known good arguments and executed binaries to determine anomalous and potentially adversarial activity. .010 Regsvr32 Use process monitoring to monitor the execution and arguments of regsvr32.exe. Compare recent invocations of regsvr32.exe with prior history of known good arguments and loaded files to determine anomalous and potentially adversarial activity. Note: Event IDs are for Sysmon (Event ID 1 - process create) and Windows Security Log (Event ID 4688 - a new process has been created). - Analytic 1 is a more generic analytic that looks for suspicious usage of regsvr32.exe, specifically for cases where regsvr32.exe creates child processes that aren\u2019t itself. It\u2019s not likely that this will result in millions of hits, but it does occur during benign activity so some form of baselining would be necessary for this to be useful as an alerting analytic.- Analytic 2 is around \"Squiblydoo\", which is a specific usage of regsvr32.exe to load a COM scriptlet directly from the internet and execute it in a way that bypasses application whitelisting. It looks for regsvr32.exe process creation events that load scrobj.dll via the command-line (which executes the COM scriptlet). Analytic 1 - Generic Regsvr32 processes = filter processes where ( (event_id == \"1\" OR event_id == \"4688\") AND parent_image_path == \"regsvr32.exe\" and exe != \"regsvr32.exe*\") Analytic 2 - Squiblydoo processes = filter process where ( (event_id == \"1\" OR event_id == \"4688\") AND (process_path == \"regsvr32.exe\" and command_line == \"scrobj.dll\")) .011 Rundll32 Use process monitoring to monitor the execution and arguments of rundll32.exe. Compare recent invocations of rundll32.exe with prior history of known good arguments and loaded DLLs to determine anomalous and potentially adversarial activity. When monitoring for all instances of Rundll32 execution, as defined by the logic in the Detection Pseudocode, it is imperative to also investigate the full set of command-line parameters used. These parameters contain key information about the DLL payload, including the name, entry point, and optional arguments. Note: Event IDs are for Sysmon (Event ID 10 - process create) and Windows Security Log (Event ID 4688 - a new process has been created). The Analytic looks for any instances of rundll32.exe but does no other filtering, which may result in false positives. Therefore, we recommend tuning any such analytics by including additional logic (e.g., testing the name of the user that created the process) that helps reduce false positives. Analytic 1 - RunDLL32.exe Monitoring processes = filter process where ((event_id == \"1\" OR event_id == \"4688\") AND exe == \"rundll32.exe\") .012 Verclsid Use process monitoring to monitor the execution and arguments of verclsid.exe. Compare recent invocations of verclsid.exe with prior history of known good arguments and loaded files to determine anomalous and potentially adversarial activity. Depending on the environment, it may be unusual for verclsid.exe to have a parent process of a Microsoft Office product. It may also be unusual for verclsid.exe to have any child processes or to make network connections or file modifications. .013 Mavinject Monitor the execution and arguments of mavinject.exe. Compare recent invocations of mavinject.exe with prior history of known good arguments and injected DLLs to determine anomalous and potentially adversarial activity. .014 MMC Monitor processes for suspicious or malicious use of MMC. Since MMC is a signed Windows binary, verify use of MMC is legitimate and not malicious. Enterprise T1082 System Information Discovery Monitor newly executed processes that may attempt to get detailed information about the operating system and hardware, including version, patches, hotfixes, service packs, and architecture. Enterprise T1614 System Location Discovery Monitor newly executed processes that may gather information in an attempt to calculate the geographical location of a victim host. .001 System Language Discovery Monitor for newly executed processes that may attempt to gather information about the system language of a victim in order to infer the geographical location of that host. Enterprise T1016 System Network Configuration Discovery Monitor for executed processes (such as ipconfig/ifconfig and arp) with arguments that may look for details about the network configuration and settings, such as IP and/or MAC addresses. Note: The Analytic looks for the creation of ipconfig, route, and nbtstat processes, all of which are system administration utilities that can be used for the purpose of system network configuration discovery. If these tools are commonly used in your environment (e.g., by system administrators) this may lead to false positives and this analytic will therefore require tuning. Analytic 1 - Suspicious Process processes = filter processes where ( (event_id == \"1\" OR event_id == \"4688\") AND exe == \"C:\\Windows\\System32\\ipconfig.exe\" OR exe == \"C:\\Windows\\System32\\route.exe\" OR exe == \"C:\\Windows\\System32\\nbtstat.exe\") .001 Internet Connection Discovery Monitor for executed processes (such as tracert or ping) that may check for Internet connectivity on compromised systems. Enterprise T1049 System Network Connections Discovery Monitor for executed processes that may attempt to get a listing of network connections to or from the compromised system they are currently accessing or from remote systems by querying for information over the network. Enterprise T1033 System Owner/User Discovery Monitor for newly executed processes that may be indicative of credential dumping. On Windows 8.1 and Windows Server 2012 R2, monitor Windows Logs for LSASS.exe creation to verify that LSASS started as a protected process. Note: Event IDs are for Sysmon (Event ID 1 - process create) and Windows Security Log (Event ID 4688 - a new process has been created). The Analytic looks for any instances of at being created, therefore implying the querying or creation of tasks. If this tools is commonly used in your environment (e.g., by system administrators) this may lead to false positives and this analytic will therefore require tuning. Analytic 1 - Suspicious Process Execution processes = filter processes where ( (event_id == \"1\" OR event_id == \"4688\") AND exe == \"at.exe\") Enterprise T1216 System Script Proxy Execution Monitor script processes, such as `cscript that may be used to proxy execution of malicious files. .001 PubPrn Monitor script processes, such as `cscript that may be used to proxy execution of malicious files. Enterprise T1007 System Service Discovery Monitor for newly executed processes with arguments that may try to get information about registered services. System and network discovery techniques normally occur throughout an operation as an adversary learns the environment. Data and events should not be viewed in isolation, but as part of a chain of behavior that could lead to other activities, such as Lateral Movement, based on the information obtained. Note: Event IDs are for Sysmon (Event ID 1 - process create) and Windows Security Log (Event ID 4688 - a new process has been created). For event id 4688, depending on Windows version, you might need to enable Administrative Templates\\System\\Audit Process Creation\\Include command line in process creation events group policy to include command line in process creation events. Analytic 1 - Suspicious Processes suspicious_processes = filter processes where (event_id == \"1\" OR event_id == \"4688\") AND ((command_line LIKE '%sc%' AND command_line LIKE '%query%') OR (command_line LIKE '%tasklist%' AND command_line LIKE '%/svc%') OR (command_line LIKE '%systemctl%' AND command_line LIKE '%--type=service%') OR (command_line LIKE '%net%' AND command_line LIKE '%start%')) Enterprise T1569 System Services Monitor newly executed processes that may abuse system services or daemons to execute commands or programs. .001 Launchctl Monitor for newly executed daemons that may abuse launchctl to execute commands or programs. .002 Service Execution Monitor for newly executed processes that may abuse the Windows service control manager to execute malicious commands or payloads. Enterprise T1529 System Shutdown/Reboot Monitor for newly executed processes of binaries involved in shutting down or rebooting systems. Enterprise T1124 System Time Discovery Monitor for newly executed processes that may gather the system time and/or time zone from a local or remote system. Enterprise T1080 Taint Shared Content Monitor processes that are executed from removable media for malicious or abnormal activity such as network connections due to Command and Control and possible network Discovery techniques. Enterprise T1221 Template Injection Analyze process behavior to determine if an Office application is performing actions, such as opening network connections, reading files, spawning abnormal child processes (ex: PowerShell), or other suspicious actions that could relate to post-compromise behavior. Enterprise T1205 Traffic Signaling Identify running processes with raw sockets. Ensure processes listed have a need for an open raw socket and are in accordance with enterprise policy.[77] .002 Socket Filters Identify running processes with raw sockets. Ensure processes listed have a need for an open raw socket and are in accordance with enterprise policy.[77] Enterprise T1127 Trusted Developer Utilities Proxy Execution Monitor for abnormal presence of these or other utilities that enable proxy execution that are typically used for development, debugging, and reverse engineering on a system that is not used for these purposes may be suspicious. Use process monitoring to monitor the execution and arguments of from developer utilities that may be abused. Compare recent invocations of those binaries with prior history of known good arguments and executed binaries to determine anomalous and potentially adversarial activity. It is likely that these utilities will be used by software developers or for other software development related tasks, so if it exists and is used outside of that context, then the event may be suspicious. .001 MSBuild Monitor for newly executed processes of MSBuild.exe. Compare recent invocations of those binaries with prior history of known good arguments and executed binaries to determine anomalous and potentially adversarial activity. Trusted developer utilities such as MSBuild may be leveraged to run malicious code with elevated privileges. This analytic looks for any instances of msbuild.exe, which will execute any C# code placed within a given XML document; and msxsl.exe, which processes xsl transformation specifications for XML files and will execute a variaty of scripting languages contained within the XSL file. Both of these executables are rarely used outside of Visual Studio. Analytic 1 - MSBuild and msxsl target_processes = filter processes where ( (exe=\"C:\\Program Files (x86)\\Microsoft Visual Studio*\\bin\\MSBuild.exe\" OR exe=\"C:\\Windows\\Microsoft.NET\\Framework\\msbuild.exe\" OR exe=\"C:\\users*\\appdata\\roaming\\microsoft\\msxsl.exe\") AND image_path!=\"Microsoft Visual Studio*\") Enterprise T1552 Unsecured Credentials Monitor newly executed processes that may search compromised systems to find and obtain insecurely stored credentials. .001 Credentials In Files Monitor newly executed processes for local file systems and remote file shares for files containing insecurely stored credentials. Note: Pseudocode Event IDs are for Sysmon (Event ID 1 - process create) and Windows Security Log (Event ID 4688 - a new process has been created). The Analytic looks for command-line instances of searching the Windows Registry for insecurely stored credentials. This can be accomplished using the query functionality of the Reg system utility, by looking for keys and values that contain strings such as \"password\". In addition, adversaries may use toolkits such as PowerSploit in order to dump credentials from various applications such as IIS. Accordingly, this analytic looks for invocations of reg.exe in this capacity as well as that of several PowerSploit modules with similar functionality. Analytic 1 - Credentials in Files & Registry processes = filter processes where ( (event_id == \"1\" OR event_id == \"4688\") AND command_line == \"reg query HKLM /f password /t REG_SZ /s\" OR command_line == \"reg query HKCU /f password /t REG_SZ /s\" OR command_line == \"Get-UnattendedInstallFile\" OR command_line == \"Get-Webconfig\" OR command_line == \"Get-ApplicationHost\" OR command_line == \"Get-SiteListPassword\" OR command_line == \"Get-CachedGPPPassword\" OR command_line == \"Get-RegistryAutoLogon\") .002 Credentials in Registry Monitor newly executed processes for applications that can be used to query the Registry, such as Reg, and collect command parameters that may indicate credentials are being searched. Correlate activity with related suspicious behavior that may indicate an active intrusion to reduce false positives. Note: Pseudocode Event IDs are for Sysmon (Event ID 1 - process create) and Windows Security Log (Event ID 4688 - a new process has been created). The Analytic looks for command-line instances of searching the Windows Registry for insecurely stored credentials. This can be accomplished using the query functionality of the Reg system utility, by looking for keys and values that contain strings such as \"password\". In addition, adversaries may use toolkits such as PowerSploit in order to dump credentials from various applications such as IIS. Accordingly, this analytic looks for invocations of reg.exe in this capacity as well as that of several PowerSploit modules with similar functionality. Analytic 1 - Credentials in Files & Registry processes = filter processes where ( (event_id == \"1\" OR event_id == \"4688\") AND command_line == \"reg query HKLM /f password /t REG_SZ /s\" OR command_line == \"reg query HKCU /f password /t REG_SZ /s\" OR command_line == \"Get-UnattendedInstallFile\" OR command_line == \"Get-Webconfig\" OR command_line == \"Get-ApplicationHost\" OR command_line == \"Get-SiteListPassword\" OR command_line == \"Get-CachedGPPPassword\" OR command_line == \"Get-RegistryAutoLogon\") Enterprise T1204 User Execution Monitor for newly executed processes that may be used by an adversary to gain Initial Access that require user interaction. This includes compression applications, such as those for zip files, that can be used to Deobfuscate/Decode Files or Information in payloads. .002 Malicious File Monitor for newly constructed processes and/or command-lines for applications that may be used by an adversary to gain initial access that require user interaction. This includes compression applications, such as those for zip files, that can be used to Deobfuscate/Decode Files or Information in payloads. ICS T0863 User Execution Monitor for newly executed processes that depend on user interaction, especially for applications that can embed programmatic capabilities (e.g., Microsoft Office products with scripts, installers, zip files). This includes compression applications, such as those for zip files, that can be used to Deobfuscate/Decode Files or Information in payloads. Enterprise T1497 Virtualization/Sandbox Evasion Virtualization, sandbox, user activity, and related discovery techniques will likely occur in the first steps of an operation but may also occur throughout as an adversary learns the environment. Data and events should not be viewed in isolation, but as part of a chain of behavior that could lead to other activities, such as lateral movement, based on the information obtained. Detecting actions related to virtualization and sandbox identification may be difficult depending on the adversary's implementation and monitoring required. Monitoring for suspicious processes being spawned that gather a variety of system information or perform other forms of Discovery, especially in a short period of time, may aid in detection. .001 System Checks Virtualization, sandbox, user activity, and related discovery techniques will likely occur in the first steps of an operation but may also occur throughout as an adversary learns the environment. Data and events should not be viewed in isolation, but as part of a chain of behavior that could lead to other activities, such as lateral movement, based on the information obtained. Detecting actions related to virtualization and sandbox identification may be difficult depending on the adversary's implementation and monitoring required. Monitoring for suspicious processes being spawned that gather a variety of system information or perform other forms of Discovery, especially in a short period of time, may aid in detection. .002 User Activity Based Checks User activity-based checks will likely occur in the first steps of an operation but may also occur throughout as an adversary learns the environment. Data and events should not be viewed in isolation, but as part of a chain of behavior that could lead to other activities, such as lateral movement, based on the information obtained. Detecting actions related to virtualization and sandbox identification may be difficult depending on the adversary's implementation and monitoring required. Monitoring for suspicious processes being spawned that gather a variety of system information or perform other forms of Discovery, especially in a short period of time, may aid in detection. .003 Time Based Evasion Time-based evasion will likely occur in the first steps of an operation but may also occur throughout as an adversary learns the environment. Data and events should not be viewed in isolation, but as part of a chain of behavior that could lead to other activities, such as lateral movement, based on the information obtained. Detecting actions related to virtualization and sandbox identification may be difficult depending on the adversary's implementation and monitoring required. Monitoring for suspicious processes being spawned that gather a variety of system information or perform other forms of Discovery, especially in a short period of time, may aid in detection. Enterprise T1047 Windows Management Instrumentation Monitor for newly constructed processes and/or command-lines of \"wmic\". If the command line utility wmic.exe is used on the source host, then it can additionally be detected on an analytic. The command line on the source host is constructed into something like wmic.exe /node:\"\\<hostname>\" process call create \"\\<command line>\". It is possible to also connect via IP address, in which case the string \"\\<hostname>\" would instead look like IP Address. Processes can be created remotely via WMI in a few other ways, such as more direct API access or the built-in utility PowerShell. Note: Event IDs are for Sysmon (Event ID 10 - process access) and Windows Security Log (Event ID 4688 - a new process has been created). Besides executing arbitrary processes, wmic.exe can also be used to executed data stored in NTFS alternate data streams NTFS File Attributes.Looks for instances of wmic.exe as well as the substrings in the command line:- process call create- /node: Analytic 1 : Create Remote Process via WMIC processes = filter processes where ((event_id=\"10\" OR event_id=\"4688\") AND exe == \"wmic.exe\" AND command_line == \" process call create \") Enterprise T1220 XSL Script Processing Use process monitoring to monitor the execution and arguments of msxsl.exe and wmic.exe. [78] [79] Command arguments used before and after the script invocation may also be useful in determining the origin and purpose of the payload being loaded. The presence of msxsl.exe or other utilities that enable proxy execution that are typically used for development, debugging, and reverse engineering on a system that is not used for these purposes may be suspicious. Process: Process Metadata Contextual data about a running process, which may include information such as environment variables, image name, user/owner, etc. Process: Process Metadata Contextual data about a running process, which may include information such as environment variables, image name, user/owner, etc. Domain ID Name Detects Enterprise T1548 Abuse Elevation Control Mechanism Monitor contextual data about a running process, which may include information such as environment variables, image name, user/owner that may circumvent mechanisms designed to control elevate privileges to gain higher-level permissions. .002 Bypass User Account Control Monitor contextual data about a running process, which may include information such as environment variables, image name, user/owner that may bypass UAC mechanisms to elevate process privileges on system. .003 Sudo and Sudo Caching Monitor contextual data about a running process, which may include information such as environment variables, image name, user/owner that may perform sudo caching and/or use the suoders file to elevate privileges. Enterprise T1134 Access Token Manipulation Query systems for process and thread token information and look for inconsistencies such as user owns processes impersonating the local SYSTEM account.[80] Look for inconsistencies between the various fields that store PPID information, such as the EventHeader ProcessId from data collected via Event Tracing for Windows (ETW), Creator Process ID/Name from Windows event logs, and the ProcessID and ParentProcessID (which are also produced from ETW and other utilities such as Task Manager and Process Explorer). The ETW provided EventHeader ProcessId identifies the actual parent process. .004 Parent PID Spoofing Look for inconsistencies between the various fields that store PPID information, such as the EventHeader ProcessId from data collected via Event Tracing for Windows (ETW), Creator Process ID/Name from Windows event logs, and the ProcessID and ParentProcessID (which are also produced from ETW and other utilities such as Task Manager and Process Explorer). The ETW provided EventHeader ProcessId identifies the actual parent process.[81] Enterprise T1059 Command and Scripting Interpreter Monitor contextual data about a running process, which may include information such as environment variables, image name, user/owner, or other information that may reveal abuse of system features. For example, consider monitoring for Windows Event ID (EID) 400, which shows the version of PowerShell executing in the EngineVersion field (which may also be relevant to detecting a potential Downgrade Attack) as well as if PowerShell is running locally or remotely in the HostName field. Furthermore, EID 400 may indicate the start time and EID 403 indicates the end time of a PowerShell session.[82] .001 PowerShell Consider monitoring for Windows event ID (EID) 400, which shows the version of PowerShell executing in the EngineVersion field (which may also be relevant to detecting a potential Downgrade Attack) as well as if PowerShell is running locally or remotely in the HostName field. Furthermore, EID 400 may indicate the start time and EID 403 indicates the end time of a PowerShell session.[82] Mobile T1623 Command and Scripting Interpreter Mobile Threat Defense (MTD) with lower-level OS APIs integrations may have access to running processes and their parameters, potentially detecting unwanted or malicious shells. .001 Unix Shell Mobile Threat Defense (MTD) with lower-level OS APIs integrations may have access to running processes and their parameters, potentially detecting unwanted or malicious shells. ICS T0874 Hooking Verify integrity of live processes by comparing code in memory to that of corresponding static binaries, specifically checking for jumps and other instructions that redirect code flow. Enterprise T1562 .010 Impair Defenses: Downgrade Attack Monitor contextual data about a running process, which may include information such as environment variables, image name, user/owner, or other information that may reveal use of a version of system features that may be outdated, vulnerable, and/or does not support updated security controls such as logging. For example, monitoring for Windows event ID (EID) 400, specifically the EngineVersion field which shows the version of PowerShell running, may highlight a malicious downgrade attack.[82] Enterprise T1056 Input Capture Verify integrity of live processes by comparing code in memory to that of corresponding static binaries, specifically checking for jumps and other instructions that redirect code flow. .004 Credential API Hooking Verify integrity of live processes by comparing code in memory to that of corresponding static binaries, specifically checking for jumps and other instructions that redirect code flow. Enterprise T1036 Masquerading Monitor for file names that are mismatched between the file name on disk and that of the binary's PE metadata, this is a likely indicator that a binary was renamed after it was compiled. .003 Rename System Utilities Monitor for file names that are mismatched between the file name on disk and that of the binary's PE metadata, this is a likely indicator that a binary was renamed after it was compiled. .005 Match Legitimate Name or Location Collecting and comparing disk and resource filenames for binaries by looking to see if the InternalName, OriginalFilename, and/or ProductName match what is expected could provide useful leads, but may not always be indicative of malicious activity. ICS T0849 Masquerading Monitor for file names that are mismatched between the file name on disk and that of the binary's metadata. This is a likely indicator that a binary was renamed after it was compiled. For added context on adversary procedures and background see Masquerading and applicable sub-techniques. Enterprise T1055 Process Injection Monitor for process memory inconsistencies, such as checking memory ranges against a known copy of the legitimate module.[83] .001 Dynamic-link Library Injection Monitor for process memory inconsistencies compared to DLL files on disk by checking memory ranges against a known copy of the legitimate module.[83] ICS T0853 Scripting Monitor contextual data about a running process, which may include information such as environment variables, image name, user/owner, or other information that may reveal abuse of system features. Process: Process Modification Changes made to a process, or its contents, typically to write and/or execute code in the memory of the target process (ex: Sysmon EID 8) Process: Process Modification Changes made to a process, or its contents, typically to write and/or execute code in the memory of the target process (ex: Sysmon EID 8) Domain ID Name Detects Enterprise T1185 Browser Session Hijacking This may be a difficult technique to detect because adversary traffic may be masked by normal user traffic. Monitor for Process Injection against browser applications. Enterprise T1562 Impair Defenses Using another process or third-party tools, monitor for modifications or access to system processes associated with logging. .012 Disable or Modify Linux Audit System Using another process or third-party tools, monitor for potentially malicious modifications or access to the auditd system process. Enterprise T1055 Process Injection Monitor for changes made to processes that may inject code into processes in order to evade process-based defenses as well as possibly elevate privileges. .001 Dynamic-link Library Injection Monitor for changes made to processes that may inject dynamic-link libraries (DLLs) into processes in order to evade process-based defenses as well as possibly elevate privileges. Injecting a malicious DLL into a process is a common adversary TTP. Although the ways of doing this are numerous, mavinject.exe is a commonly used tool for doing so because it roles up many of the necessary steps into one, and is available within Windows. Attackers may rename the executable, so we also use the common argument \"INJECTRUNNING\" as a related signature here. Whitelisting certain applications may be necessary to reduce noise for this analytic. Analytic 1 - DLL Injection with Mavinject mavinject_processes = filter processes where ( exe = \"C:\\Windows\\SysWOW64\\mavinject.exe\" OR Image=\"C:\\Windows\\System32\\mavinject.exe\" OR command_line = \"/INJECTRUNNING\" .002 Portable Executable Injection Monitor for changes made to processes that may inject portable executables (PE) into processes in order to evade process-based defenses as well as possibly elevate privileges. .003 Thread Execution Hijacking Monitor for changes made to processes that may inject malicious code into hijacked processes in order to evade process-based defenses as well as possibly elevate privileges. .004 Asynchronous Procedure Call Monitor for changes made to processes that may inject malicious code into processes via the asynchronous procedure call (APC) queue in order to evade process-based defenses as well as possibly elevate privileges. .005 Thread Local Storage Monitor for changes made to processes that may inject malicious code into processes via thread local storage (TLS) callbacks in order to evade process-based defenses as well as possibly elevate privileges. .008 Ptrace System Calls Monitor for changes made to processes that may inject malicious code into processes via ptrace (process trace) system calls in order to evade process-based defenses as well as possibly elevate privileges. .012 Process Hollowing Monitor for changes made to processes that may inject malicious code into suspended and hollowed processes in order to evade process-based defenses. .015 ListPlanting Monitor for changes made to processes that may inject code into processes in order to evade process-based defenses as well as possibly elevate privileges. Analyze process behavior to determine if a process is performing unusual actions, such as opening network connections, reading files, or other suspicious actions that could relate to post-compromise behavior. Process: Process Termination Exit of a running process (ex: Sysmon EID 5 or Windows EID 4689) Process: Process Termination Exit of a running process (ex: Sysmon EID 5 or Windows EID 4689) Domain ID Name Detects ICS T0803 Block Command Message Monitor for the termination of processes or services associated with ICS automation protocols and application software which could help detect blocked communications. ICS T0804 Block Reporting Message Monitor for the termination of processes or services associated with ICS automation protocols and application software which could help detect blocked communications. ICS T0805 Block Serial COM Monitor for the termination of processes or services associated with ICS automation protocols and application software which could help detect blocked communications. Enterprise T1562 Impair Defenses Monitor for unexpected deletions of a running process (ex: Sysmon EID 5 or Windows EID 4689) that may maliciously modify components of a victim environment in order to hinder or disable defensive mechanisms. .001 Disable or Modify Tools Monitor processes for unexpected termination related to security tools/services. Specifically, before execution of ransomware, monitor for rootkit tools, such as GMER, PowerTool or TDSSKiller, that may detect and terminate hidden processes and the host antivirus software. Mobile T1629 Impair Defenses Mobile security products integrated with Samsung Knox for Mobile Threat Defense can monitor processes to see if security tools are killed or stop running. Enterprise T1489 Service Stop Monitor processes and command-line arguments to see if critical processes are terminated or stop running. ICS T0881 Service Stop Monitor processes and command-line arguments to see if critical processes are terminated or stop running. For added context on adversary procedures and background see Service Stop. References Microsoft. (2018, May 31). Processes and Threads. Retrieved September 28, 2021. Microsoft TechNet. (n.d.). Retrieved April 25, 2017. Microsoft TechNet. (n.d.). Retrieved April 25, 2017. Microsoft TechNet. (n.d.). Retrieved April 25, 2017. Schofield, M. & Satran, M. (2018, May 30). Process Creation Flags. Retrieved June 4, 2019. Secuirtyinbits . (2019, May 14). Parent PID Spoofing (Stage 2) Ataware Ransomware Part 3. Retrieved June 6, 2019. Microsoft. (n.d.). AddMonitor function. Retrieved November 12, 2014. Apple. (n.d.). Keychain Items. Retrieved April 12, 2022. Mercer, W. and Rascagneres, P. (2018, February 12). Olympic Destroyer Takes Aim At Winter Olympics. Retrieved March 14, 2019. Microsoft. (2018, December 5). CredEnumarateA function (wincred.h). Retrieved November 24, 2020. Delpy, B. (2017, December 12). howto ~ credential manager saved credentials. Retrieved November 23, 2020. Schroeder, W. (2017, October 30). A Guide to Attacking Domain Trusts. Retrieved February 14, 2019. Microsoft. (n.d.). Domain.GetAllTrustRelationships Method. Retrieved February 14, 2019. Hosseini, A. (2017, July 18). Ten Process Injection Techniques: A Technical Survey Of Common And Trending Process Injection Techniques. Retrieved December 7, 2017. Moe, O. (2018, January 14). Putting Data in Alternate Data Streams and How to Execute It. Retrieved June 30, 2018. Moe, O. (2018, April 11). Putting Data in Alternate Data Streams and How to Execute It - Part 2. Retrieved June 30, 2018. Atkinson, J. (2017, July 18). Host-based Threat Modeling & Indicator Design. Retrieved March 21, 2018. Saini, A. and Hossein, J. (2022, January 27). North Korea\u2019s Lazarus APT leverages Windows Update client, GitHub in latest campaign. Retrieved January 27, 2022. Microsoft. (n.d.). Hooks Overview. Retrieved December 12, 2017. Volatility Labs. (2012, September 24). MoVP 3.1 Detecting Malware Hooks in the Windows GUI Subsystem. Retrieved December 12, 2017. Prekas, G. (2011, July 11). Winhook. Retrieved December 12, 2017. Satiro, J. (2011, September 14). GetHooks. Retrieved December 12, 2017. Felici, M. (2006, December 6). Any application-defined hook procedure on my machine?. Retrieved December 12, 2017. Eye of Ra. (2017, June 27). Windows Keylogger Part 2: Defense against user-land. Retrieved December 12, 2017. Tinaztepe, E. (n.d.). The Adventures of a Keystroke: An in-depth look into keyloggers on Windows. Retrieved April 27, 2016. Dell SecureWorks. (2015, January 12). Skeleton Key Malware Analysis. Retrieved April 8, 2019. Microsoft. (2021, October 21). NPLogonNotify function (npapi.h). Retrieved March 30, 2023. Russinovich, M. & Sharkey, K. (2006, January 10). Reghide. Retrieved August 9, 2018. Reitz, B. (2017, July 14). Hiding Registry keys with PSReflect. Retrieved August 9, 2018. Russinovich, M. & Sharkey, K. (2016, July 4). RegDelNull v1.11. Retrieved August 10, 2018. Brennan, M. (2022, February 16). Hackers No Hashing: Randomizing API Hashes to Evade Cobalt Strike Shellcode Detection. Retrieved August 22, 2022. Pinola, M. (2014, December 14). 3 tools to check your hard drive's health and make sure it's not already dying on you. Retrieved October 2, 2018. SanDisk. (n.d.). Self-Monitoring, Analysis and Reporting Technology (S.M.A.R.T.). Retrieved October 2, 2018. smartmontools. (n.d.). smartmontools. Retrieved October 2, 2018. Ligh, M.H. et al.. (2014, July). The Art of Memory Forensics: Detecting Malware and Threats in Windows, Linux, and Mac Memory. Retrieved December 20, 2017. GNU. (2010, February 5). The GNU Accounting Utilities. Retrieved December 20, 2017. Jahoda, M. et al.. (2017, March 14). redhat Security Guide - Chapter 7 - System Auditing. Retrieved December 20, 2017. stderr. (2014, February 14). Detecting Userland Preload Rootkits. Retrieved December 20, 2017. Microsoft. (n.d.). GetWindowLong function. Retrieved December 16, 2017. Microsoft. (n.d.). SetWindowLong function. Retrieved December 16, 2017. Microsoft. (n.d.). SendNotifyMessage function. Retrieved December 16, 2017. Liberman, T. & Kogan, E. (2017, December 7). Lost in Transaction: Process Doppelg\u00e4nging. Retrieved December 20, 2017. hasherezade. (2017, December 18). Process Doppelg\u00e4nging \u2013 a new way to impersonate a process. Retrieved December 20, 2017. 0x00pico. (2017, September 25). Super-Stealthy Droppers. Retrieved October 4, 2021. Landry, J. (2016, April 21). Teaching an old RAT new tricks. Retrieved October 4, 2021. Microsoft. (n.d.). Graphics.CopyFromScreen Method. Retrieved March 24, 2020. Thomas Reed. (2017, January 18). New Mac backdoor using antiquated code. Retrieved July 5, 2017. FBI. (2020, November 19). Indicators of Compromise Associated with Ragnar Locker Ransomware. Retrieved April 1, 2021. ise. (2019, February 19). Password Managers: Under the Hood of Secrets Management. Retrieved January 22, 2021. VerSprite. (2018, January 24). Exploiting VyprVPN for MacOS. Retrieved April 20, 2022. French, D. (2018, October 2). Detecting Attempts to Steal Passwords from Memory. Retrieved October 11, 2019. Stepanic, D.. (2020, January 13). Embracing offensive tooling: Building detections against Koadic using EQL. Retrieved November 30, 2020. Mathers, B. (2017, May 31). Windows Time Service Tools and Settings. Retrieved March 26, 2018. Russinovich, M. (2016, January 4). Autoruns for Windows v13.51. Retrieved June 6, 2016. Chrome Enterprise and Education Help. (n.d.). Use Chrome Browser with Roaming User Profiles. Retrieved March 28, 2023. Adrien Bataille, Anders Vejlby, Jared Scott Wilson, and Nader Zaveri. (2021, December 14). Azure Run Command for Dummies. Retrieved March 13, 2023. Arntz, P. (2016, March 30). The Windows Vault . Retrieved November 23, 2020. Pierce, Sean. (2015, November). Defending Against Malicious Application Compatibility Shims. Retrieved June 22, 2017. Shanbhag, M. (2010, March 24). Image File Execution Options (IFEO). Retrieved December 18, 2017. Hybrid Analysis. (2018, June 12). c9b65b764985dfd7a11d3faf599c56b8.exe. Retrieved August 19, 2018. Hybrid Analysis. (2018, May 30). 2a8efbfadd798f6111340f7c1c956bee.dll. Retrieved August 19, 2018. Daman, R. (2020, February 4). The return of the spoof part 2: Command line spoofing. Retrieved November 19, 2021. Pena, E., Erikson, C. (2019, October 10). Staying Hidden on the Endpoint: Evading Detection with Shellcode. Retrieved November 29, 2021. Brown, J. (2020, May 7). Detecting COR_PROFILER manipulation for persistence. Retrieved June 24, 2020. Hamilton, C. (2019, June 4). Hunting COM Objects. Retrieved June 10, 2019. Nelson, M. (2017, January 5). Lateral Movement using the MMC20 Application COM Object. Retrieved November 21, 2017. Sarah Edwards. (2020, April 30). Analysis of Apple Unified Logs: Quarantine Edition [Entry 6] \u2013 Working From Home? Remote Logins. Retrieved August 19, 2021. Loobeek, L. (2017, December 8). leoloobeek Status. Retrieved December 12, 2017. Lee, T., Hanzlik, D., Ahl, I. (2013, August 7). Breaking Down the China Chopper Web Shell - Part I. Retrieved March 27, 2015. NSA Cybersecurity Directorate. (n.d.). Mitigating Web Shells. Retrieved July 22, 2021. Graeber, M. (2017, December 22). Code Signing Certificate Cloning Attacks and Defenses. Retrieved April 3, 2018. Russinovich, M. et al.. (2017, May 22). Sigcheck. Retrieved April 3, 2018. Microsoft. (2021, February 15). Enable Loading of Test Signed Drivers. Retrieved April 22, 2021. Moe, O. (2017, August 13). Bypassing Device guard UMCI using CHM \u2013 CVE-2017-8625. Retrieved October 3, 2018. Merc\u00eas, F. (2014, January 27). CPL Malware - Malicious Control Panel Items. Retrieved January 18, 2018. Seetharaman, N. (2018, July 7). Detecting CMSTP-Enabled Code Execution and UAC Bypass With Sysmon.. Retrieved August 6, 2018. Jamie Harries. (2022, May 25). Hunting a Global Telecommunications Threat: DecisiveArchitect and Its Custom Implant JustForFun. Retrieved October 18, 2022. LOLBAS. (n.d.). Wmic.exe. Retrieved July 31, 2019. Desimone, J. (2018, April 18). Status Update. Retrieved July 3, 2018. Atkinson, J., Winchester, R. (2017, December 7). A Process is No One: Hunting for Token Manipulation. Retrieved December 21, 2017. Loh, I. (2018, December 21). Detecting Parent PID Spoofing. Retrieved June 3, 2019. Hastings, M. (2014, July 16). Investigating PowerShell Attacks. Retrieved December 1, 2021. Aliz Hammond. (2019, August 15). Hiding Malicious Code with \"Module Stomping\": Part 1. Retrieved July 14, 2022. "
},
{
"id": 1981,
"title": "User Interface, Data Source DS0042",
"path": "/datasources/DS0042/index.html",
"content": " User Interface Visual activity on the device that could alert the user to potentially malicious behavior. ID: DS0042 \u24d8 Platforms: Android, iOS \u24d8 Collection Layer: Device Version: 1.0 Created: 13 March 2023 Last Modified: 13 March 2023 Version Permalink Live Version Data Components This data source does not have any techniques in the selected domain(s) User Interface: Permissions Request System prompts triggered when an application requests new or additional permissions User Interface: Permissions Request System prompts triggered when an application requests new or additional permissions Domain ID Name Detects Mobile T1626 Abuse Elevation Control Mechanism When an application requests administrator permission, the user is presented with a popup and the option to grant or deny the request. .001 Device Administrator Permissions The user is prompted for approval when an application requests device administrator permissions. Mobile T1638 Adversary-in-the-Middle On both Android and iOS, the user must grant consent to an application to act as a VPN. Both platforms also provide visual context to the user in the top status bar when a VPN connection is active. The user can see registered VPN services in the device settings. Mobile T1662 Data Destruction The user is prompted for approval when an application requests device administrator permissions. Mobile T1420 File and Directory Discovery On Android, the user is presented with a permissions popup when an application requests access to external device storage. Mobile T1663 Remote Access Software Remote access software typically requires many privileged permissions, such as accessibility services or device administrator. User Interface: System Notifications Notifications generated by the OS User Interface: System Notifications Notifications generated by the OS Domain ID Name Detects Mobile T1616 Call Control The user can review available call logs for irregularities, such as missing or unrecognized calls. Mobile T1627 .001 Execution Guardrails: Geofencing On Android 10 and later, the system shows a notification to the user when an app has been accessing device location in the background. Mobile T1541 Foreground Persistence The user can see persistent notifications in their notification drawer and can subsequently uninstall applications that do not belong. Mobile T1430 .001 Location Tracking: Remote Device Management Services Google sends a notification to the device when Android Device Manager is used to locate it. Additionally, Google provides the ability for users to view their general account activity and alerts users when their credentials have been used on a new device. Apple iCloud also provides notifications to users of account activity such as when credentials have been used. Mobile T1655 Masquerading Unexpected behavior from an application could be an indicator of masquerading. .001 Match Legitimate Name or Location Unexpected behavior from an application could be an indicator of masquerading. Mobile T1464 Network Denial of Service Mobile T1644 Out of Band Data If the user sees a notification with text they do not recognize, they should review their list of installed applications. Mobile T1635 Steal Application Access Token On Android, users may be presented with a popup to select the appropriate application to open a URI in. If the user sees an application they do not recognize, they can remove it. .001 URI Hijacking On Android, users may be presented with a popup to select the appropriate application to open the URI in. If the user sees an application they do not recognize, they can remove it. User Interface: System Settings Settings visible to the user on the device User Interface: System Settings Settings visible to the user on the device Domain ID Name Detects Mobile T1626 .001 Abuse Elevation Control Mechanism: Device Administrator Permissions The user can see which applications are registered as device administrators in the device settings. Mobile T1517 Access Notifications The user can also inspect and modify the list of applications that have notification access through the device settings (e.g. Apps & notification -> Special app access -> Notification access). Mobile T1429 Audio Capture In iOS 14 and up, an orange dot (or orange square if the Differentiate Without Color setting is enabled) appears in the status bar when the microphone is being used by an application. However, there have been demonstrations indicating it may still be possible to access the microphone in the background without triggering this visual indicator by abusing features that natively access the microphone or camera but do not trigger the visual indicators.[1] In Android 12 and up, a green dot appears in the status bar when the microphone is being used by an application.[2] Mobile T1616 Call Control The user can view their default phone app in device settings. Mobile T1662 Data Destruction The user may view applications with administrator access through the device settings and may also notice if user data is inexplicably missing. Mobile T1642 Endpoint Denial of Service On Android, the user can review which applications have Device Administrator access in the device settings and revoke permission where appropriate. Mobile T1627 Execution Guardrails The user can review which applications have location and sensitive phone information permissions in the operating system\u2019s settings menu. .001 Geofencing The user can review which applications have location permissions in the operating system\u2019s settings menu. Mobile T1643 Generate Traffic from Victim On Android, the user can review which applications can use premium SMS features in the \"Special access\" page within application settings. Mobile T1628 Hide Artifacts The user can examine the list of all installed applications in the device settings. .001 Suppress Application Icon The user can examine the list of all installed applications, including those with a suppressed icon, in the device settings. If the user is redirected to the device settings when tapping an application\u2019s icon, they should inspect the application to ensure it is genuine. Mobile T1629 .001 Impair Defenses: Prevent Application Removal The user can view a list of device administrators and applications that have registered accessibility services in device settings. The user can typically visually see when an action happens that they did not initiate and can subsequently review installed applications for any out of place or unknown ones. Applications that register an accessibility service or request device administrator permissions should be scrutinized further for malicious behavior. .002 Impair Defenses: Device Lockout The user can view a list of device administrators in device settings and revoke permission where appropriate. Applications that request device administrator permissions should be scrutinized further for malicious behavior. .003 Impair Defenses: Disable or Modify Tools The user can view a list of active device administrators in the device settings. Mobile T1630 Indicator Removal on Host The user can view applications with administrator access through the device settings, and may also notice if user data is inexplicably missing. The user can see a list of applications that can use accessibility services in the device settings. .001 Uninstall Malicious Application The user can see a list of applications that can use accessibility services in the device settings. .002 File Deletion The user can view applications with administrator access through the device settings, and may also notice if user data is inexplicably missing. Mobile T1417 Input Capture The user can view and manage installed third-party keyboards. .001 Keylogging On Android, the user can view and manage which applications have third-party keyboard access through the device settings in System -> Languages & input -> Virtual keyboard. On iOS, the user can view and manage which applications have third-party keyboard access through the device settings in General -> Keyboard. .002 GUI Input Capture An Android user can view and manage which applications hold the SYSTEM_ALERT_WINDOW permission through the device settings in Apps & notifications -> Special app access -> Display over other apps (the exact menu location may vary between Android versions). Mobile T1516 Input Injection The user can view applications that have registered accessibility services in the accessibility menu within the device settings. Mobile T1430 Location Tracking In both Android (6.0 and up) and iOS, the user can view which applications have the permission to access the device location through the device settings screen and revoke permissions as necessary. Mobile T1636 Protected User Data The user can view permissions granted to an application in device settings. .001 Calendar Entries On both Android and iOS, the user can manage which applications have permission to access calendar information through the device settings screen, revoke the permission if necessary. .002 Call Log On Android, the user can manage which applications have permission to access the call log through the device settings screen, revoking the permission if necessary. .003 Contact List On both Android and iOS, the user can manage which applications have permission to access the contact list through the device settings screen, revoking the permission if necessary. .004 SMS Messages On Android, the user can manage which applications have permission to access SMS messages through the device settings screen, revoking the permission if necessary. Mobile T1513 Screen Capture The user can view a list of apps with accessibility service privileges in the device settings. Mobile T1582 SMS Control The user can view the default SMS handler in system settings. Mobile T1632 Subvert Trust Controls On Android, the user can use the device settings menu to view trusted CA certificates and look for unexpected or unknown certificates. A mobile security product could similarly examine the trusted CA certificate store for anomalies. Users can use the device settings menu to view which applications on the device are allowed to install unknown applications. On iOS, the user can use the device settings menu to view installed Configuration Profiles and look for unexpected or unknown profiles. A Mobile Device Management (MDM) system could use the iOS MDM APIs to examine the list of installed Configuration Profiles for anomalies. .001 Code Signing Policy Modification On Android, the user can use the device settings menu to view trusted CA certificates and look for unexpected or unknown certificates. A mobile security product could similarly examine the trusted CA certificate store for anomalies. Users can use the device settings menu to view which applications on the device are allowed to install unknown applications. On iOS, the user can use the device settings menu to view installed Configuration Profiles and look for unexpected or unknown profiles. A Mobile Device Management (MDM) system could use the iOS MDM APIs to examine the list of installed Configuration Profiles for anomalies. Mobile T1512 Video Capture The user can view which applications have permission to use the camera through the device settings screen, where the user can then choose to revoke the permissions. References ZecOps Research Team. (2021, November 4). How iOS Malware Can Spy on Users Silently. Retrieved April 1, 2022. Google. (n.d.). Privacy Indicators. Retrieved April 20, 2022. "
},
{
"id": 1982,
"title": "Network Traffic, Data Source DS0029",
"path": "/datasources/DS0029/index.html",
"content": " Network Traffic Data transmitted across a network (ex: Web, DNS, Mail, File, etc.), that is either summarized (ex: Netflow) and/or captured as raw data in an analyzable format (ex: PCAP) ID: DS0029 \u24d8 Platforms: Android, IaaS, Linux, Windows, iOS, macOS \u24d8 Collection Layers: Cloud Control Plane, Host, Network Contributors: Center for Threat-Informed Defense (CTID); ExtraHop Version: 1.1 Created: 20 October 2021 Last Modified: 20 April 2023 Version Permalink Live Version Data Components This data source does not have any techniques in the selected domain(s) Network Traffic: Network Connection Creation Initial construction of a network connection, such as capturing socket information with a source/destination IP and port(s) (ex: Windows EID 5156, Sysmon EID 3, or Zeek conn.log) Network Traffic: Network Connection Creation Initial construction of a network connection, such as capturing socket information with a source/destination IP and port(s) (ex: Windows EID 5156, Sysmon EID 3, or Zeek conn.log) Domain ID Name Detects Mobile T1638 Adversary-in-the-Middle Mobile security products can potentially detect rogue Wi-Fi access points if the adversary is attempting to decrypt traffic using an untrusted SSL certificate. Enterprise T1020 Automated Exfiltration Monitor for newly constructed network connections associated with processes performing collection activity, especially those involving abnormal/untrusted hosts. .001 Traffic Duplication Monitor for newly constructed network connections that are sent or received by abnormal or untrusted hosts. Enterprise T1197 BITS Jobs Monitor for newly constructed network activity generated by BITS. BITS jobs use HTTP(S) and SMB for remote connections and are tethered to the creating user and will only function when that user is logged on (this rule applies even if a user attaches the job to a service account). Enterprise T1176 Browser Extensions Monitor for newly constructed network connections that are sent or received by untrusted hosts. Enterprise T1612 Build Image on Host Monitor for established network communications with anomalous IPs that have never been seen before in the environment that may indicate the download of malicious code. Enterprise T1602 Data from Configuration Repository Monitor for newly constructed network connections that are sent or received by untrusted hosts or uncommon data flows. Consider analyzing packet contents to detect application layer protocols, leveraging SSL/TLS inspection for encrypted traffic, that do not follow the expected protocol standards and traffic flows (e.g. unauthorized, gratuitous, or anomalous traffic patterns attempting to access configuration content) .001 SNMP (MIB Dump) Monitor for newly constructed network connections that are sent or received by untrusted hosts or uncommon data flows. Consider analyzing packet contents to detect application layer protocols, leveraging SSL/TLS inspection for encrypted traffic, that do not follow the expected protocol standards and traffic flows(e.g. snmp traffic originating from unauthorized or untrusted hosts, signature detection for strings mapped to device configuration(s), and anomolies in snmp request(s)) .002 Network Device Configuration Dump Monitor for newly constructed network connections that are sent or received by untrusted hosts or uncommon data flows. Consider analyzing packet contents to detect application layer protocols, leveraging SSL/TLS inspection for encrypted traffic, that do not follow the expected protocol standards and traffic flows (e.g. unauthorized, gratuitous, or anomalous traffic patterns attempting to access network configuration content) Enterprise T1039 Data from Network Shared Drive Monitor for newly constructed network connections that may search network shares on computers they have compromised to find files of interest. Network Analysis frameworks such as Zeek can be used to capture, decode, and alert on network protocols such as SMB that revolve around network shares. Enterprise T1030 Data Transfer Size Limits Monitor for newly constructed network connections that are sent or received by untrusted hosts or uncommon data flows (e.g. unusual network communications or suspicious communications sending fixed size data packets at regular intervals as well as unusually long connection patterns). Consider analyzing packet contents to detect application layer protocols, leveraging SSL/TLS inspection for encrypted traffic, that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, protocol port mismatch, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments (e.g. monitor anomalies in use of files that do not normally initiate network connections or unusual connections initiated Enterprise T1189 Drive-by Compromise Monitor for newly constructed network connections to untrusted hosts that are used to send or receive data. ICS T0817 Drive-by Compromise Monitor for newly constructed network connections to untrusted hosts that are used to send or receive data. Enterprise T1568 Dynamic Resolution Monitor for newly constructed network connections that are sent or received by untrusted hosts. .001 Fast Flux DNS Monitor for newly constructed network connections that may use Fast Flux DNS to hide a command and control channel behind an array of rapidly changing IP addresses linked to a single domain resolution. Enterprise T1114 Email Collection Monitor for newly constructed network connections that are sent or received by untrusted hosts. .002 Remote Email Collection Monitor for newly constructed network connections that are sent or received by untrusted hosts. Enterprise T1048 Exfiltration Over Alternative Protocol Monitor for newly constructed network connections that are sent or received by untrusted hosts. .001 Exfiltration Over Symmetric Encrypted Non-C2 Protocol Monitor for newly constructed network connections that are sent or received by untrusted hosts. .002 Exfiltration Over Asymmetric Encrypted Non-C2 Protocol Monitor for newly constructed network connections that are sent or received by untrusted hosts. .003 Exfiltration Over Unencrypted Non-C2 Protocol Monitor for newly constructed network connections that are sent or received by untrusted hosts. Enterprise T1041 Exfiltration Over C2 Channel Monitor for newly constructed network connections that are sent or received by untrusted hosts. Note: Network Analysis frameworks such as Zeek can be used to capture, decode, and alert on TCP network connection creation. Enterprise T1011 Exfiltration Over Other Network Medium Monitor for newly constructed network connections that may attempt to exfiltrate data over a different network medium than the command and control channel. Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. Note: Network Analysis frameworks such as Zeek can be used to capture, decode, and alert on TCP network connection creation. The below analytic is using an event ID from OSQuery. Analytic 1 - Windows Process Network Connection netcon_from_sysproc = filter process_open_sockets where remote_port != 0 AND proc_name!= '';\" .001 Exfiltration Over Bluetooth Monitor for newly constructed network connections that may attempt to exfiltrate data over Bluetooth rather than the command and control channel. Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. Enterprise T1567 Exfiltration Over Web Service Monitor for newly constructed network connections to web and cloud services associated with abnormal or non-browser processes. .002 Exfiltration to Cloud Storage Monitor for newly constructed network connections to cloud services associated with abnormal or non-browser processes. Enterprise T1133 External Remote Services Monitor for newly constructed network connections that may use Valid Accounts to access and/or persist within a network using External Remote Services. Use of External Remote Services may be legitimate depending on the environment and how it\u2019s used. Other factors, such as access patterns and activity that occurs after a remote login, may indicate suspicious or malicious behavior using External Remote Services. Enterprise T1008 Fallback Channels Monitor for newly constructed network connections that may use fallback or alternate communication channels if the primary channel is compromised or inaccessible in order to maintain reliable command and control and to avoid data transfer thresholds. Processes utilizing the network that do not normally have network communication or have never been seen before may be suspicious. Note: Network Analysis frameworks such as Zeek can be used to capture, decode, and alert on TCP network connection creation. The below analytic is using an event ID from OSQuery. Analytic 1 - Windows Process Network Connection netcon_from_sysproc = filter process_open_sockets where remote_port != 0 AND proc_name!= '';\" Enterprise T1105 Ingress Tool Transfer Monitor for newly constructed network connections that are sent or received by untrusted hosts or creating files on-system may be suspicious. Use of utilities, such as FTP, that does not normally occur may also be suspicious. Enterprise T1104 Multi-Stage Channels Monitor for newly constructed network connections that are sent or received by untrusted hosts. Enterprise T1542 Pre-OS Boot Monitor for newly constructed network device configuration and system image against a known-good version to discover unauthorized changes to system boot, startup configuration, or the running OS. The same process can be accomplished through a comparison of the run-time memory, though this is non-trivial and may require assistance from the vendor. .005 TFTP Boot Monitor for newly constructed network device configuration and system image against a known-good version to discover unauthorized changes to system boot, startup configuration, or the running OS. [1] [2] The same process can be accomplished through a comparison of the run-time memory, though this is non-trivial and may require assistance from the vendor. Enterprise T1572 Protocol Tunneling Monitor for newly constructed network connections that are sent or received by untrusted hosts. Enterprise T1090 Proxy Monitor for newly constructed network connections that are sent or received by untrusted hosts. .001 Internal Proxy Monitor for newly constructed network connections that are sent or received by untrusted hosts. .002 External Proxy Monitor for newly constructed network connections that are sent or received by untrusted hosts. .003 Multi-hop Proxy Monitor for newly constructed network connections that are sent or received by untrusted hosts. Enterprise T1219 Remote Access Software Monitor for newly constructed network connections that are sent or received by untrusted hosts. Enterprise T1021 Remote Services Monitor for newly constructed network connections that may use Valid Accounts to log into a service specifically designed to accept remote connections, such as RDP, telnet, SSH, and VNC. Monitor network connections involving common remote management protocols, such as ports tcp:3283 and tcp:5900, as well as ports tcp: 3389 and tcp:22 for remote login. Note: Network Analysis frameworks such as Zeek can be used to capture, decode, and alert on network service protocols such as SSH and RDP. Analytic 1 - Suspicious Protocols suspicious_protocol = filter network_traffic where ((server_port = \"636\" AND protocol = \"6\") OR (server_port = \"389\" AND protocol = \"17\")) .001 Remote Desktop Protocol Monitor for newly constructed network connections (typically over port 3389) that may use Valid Accounts to log into a computer using the Remote Desktop Protocol (RDP). The adversary may then perform actions as the logged-on user. Other factors, such as access patterns and activity that occurs after a remote login, may indicate suspicious or malicious behavior with RDP. .002 SMB/Windows Admin Shares Monitor for newly constructed network connections (typically over ports 139 or 445), especially those that are sent or received by abnormal or untrusted hosts. Correlate these network connections with remote login events and associated SMB-related activity such as file transfers and remote process execution. Note: Event ID is for Zeek but can also be implemented in other Network Analysis Frameworks by parsing & decoding captured SMB2 network traffic. Preference would be to detect smb2_write_response event (instead of smb2_write_request), because it would confirm the file was actually written to the remote destination. Unfortunately, Bro/Zeek does not have an event for that SMB message-type yet. From a network traffic capture standpoint, it\u2019s important to capture the right traffic for this type of detection to function (e.g., all endpoint to endpoint if possible or workstation to server and workstation to workstation). As such, it is helpful to have a centralized server area where it is possible to monitor communications between servers and endpoints. Analytic 1 and 2 are very similar, with the key difference being that Implementation 2 is intended to capture multiple attempts at lateral movement originating from the same host within a short time period (5 minutes). Analytic 1 is indication of an SMB file write to a Windows Admin File Share: ADMIN$ or C$ Analytic 2 is observed originating from the same host, regardless of write-attempts and regardless of whether or not any connection is successful \u2014just connection attempts\u2014 within a specified period of time. From a network traffic capture standpoint, it\u2019s important to capture the right traffic for this type of detection to function (e.g., all endpoint to endpoint if possible or workstation to server and workstation to workstation). As such, it is helpful to have a centralized server area where it is possible to monitor communications between servers and endpoints.The Service Control Manager (SCM) can be used to copy a file to the ADMIN$ share and execute it as a service. This can be detected by looking for incoming RPC network connections to the Service Control Manager, followed by services.exe spawning a child process. Analytic 1 - Basic suspicious_smb_traffic = filter log_events where ((event_id == \"smb2_write_request\" OR event_type == \"smb1_write_andx_response\") AND (connection.smb_state.path == \"ADMIN$\" OR connection.smb_state.path == \"C$\")) Analytic 2 - Multiple Attempts (Time Window) suspicious_smb_traffic = filter log_events where ( (event_type == \"smb2_tree_connect_request\" OR event_type == \"smb1_tree_connect_andx_request\") AND (connection.smb_state.path == \"ADMIN$\" OR connection.smb_state.path == \"C$\") REPEATS 5 TIMES WITHIN 5 MINUTES FROM SAME src_ip ) .003 Distributed Component Object Model Monitor for newly constructed network connections that may use Valid Accounts to interact with remote machines using Distributed Component Object Model (DCOM). The adversary may then perform actions as the logged-on user. Monitor for any influxes or abnormal increases in DCOM related Distributed Computing Environment/Remote Procedure Call (DCE/RPC) traffic (typically over port 135). Note: Network Analysis frameworks such as Zeek can be used to capture, decode, and alert on RPC network flows. Traffic to the RPC Endpoint Mapper will always have the destination port of 135. Assuming success, RPC traffic will continue to the endpoint. The endpoint and the client both bind to dynamically assigned ports (on Windows, this is typically greater than 49152). The traffic between the client and endpoint can be detected by looking at traffic to 135 followed by traffic where the source and destination ports are at least 49152. Analytic 1 - RPC Mapper rpc_mapper = filter flows where (dest_port == 135)rpc_endpoint = filter flows where (dest_port >= 49152 and src_port >= 49152)rpc = join rpc_mapper, rpc_endpoint where ( (rpc_mapper.time < rpc_endpoint.time < rpc_mapper.time + 2 seconds) AND (rpc_mapper.src_ip == rpc_endpoint.src_ip AND rpc_mapper.dest_ip == rpc_endpoint.dest_ip)) .004 SSH Monitor for newly constructed network connections (typically port 22) that may use Valid Accounts to log into remote machines using Secure Shell (SSH). Use of SSH may be legitimate depending on the environment and how it\u2019s used. Other factors, such as access patterns and activity that occurs after a remote login, may indicate suspicious or malicious behavior with SSH. Network Analysis Frameworks such as Zeek can be used to capture, decode, and alert on network traffic. Accordingly, they can be used to look for the creation of SSH network connections. .005 VNC Monitor for newly constructed network connections that may use Valid Accounts to remotely control machines using Virtual Network Computing (VNC). Use of VNC may be legitimate depending on the environment and how it\u2019s used. Other factors, such as access patterns and activity that occurs after a remote login, may indicate suspicious or malicious behavior using VNC. .006 Windows Remote Management Monitor for newly constructed network connections using Windows Remote Management (WinRM), such as remote WMI connection attempts (typically over port 5985 when using HTTP and 5986 for HTTPS). ICS T0886 Remote Services Monitor for newly constructed network connections into a service specifically designed to accept remote connections, such as RDP, Telnet, SSH, and VNC. Monitor network connections involving common remote management protocols, such as ports tcp:3283 and tcp:5900, as well as ports tcp:3389 and tcp:22 for remote logins. The adversary may use Valid Accounts to enable remote logins. Enterprise T1018 Remote System Discovery Monitor for newly constructed network connections associated with pings/scans that may attempt to get a listing of other systems by IP address, hostname, or other logical identifier on a network that may be used for Lateral Movement from the current system. Enterprise T1496 Resource Hijacking Monitor for newly constructed network connections that are sent or received by untrusted hosts, look for connections to/from strange ports, as well as reputation of IPs and URLs related cryptocurrency hosts. Note: Destination Host Name is not a comprehensive list of potential cryptocurrency URLs. Analytic 1 - Suspicious Port Connections suspicious_netcoms = filter network traffic where ((src_port = \"3333\" OR src_port = \"4444\" OR src_port = \"5555\" OR src_port = \"6666\") AND (dst_host_name = \"cryptmonero.com\" OR dst_host_name = \"crypto-pool.fr\" OR dst_host_name = \"crypto-pool.info\" OR dst_host_name = \"cryptonight-hub.miningpoolhub.com\")) Enterprise T1029 Scheduled Transfer Monitor for newly constructed network connections that are sent or received by untrusted hosts. Enterprise T1218 System Binary Proxy Execution Monitor for newly constructed network connections that are sent or received by untrusted hosts. .003 CMSTP Monitor for newly constructed network connections that are sent or received by untrusted hosts, such as Sysmon Event 3 (Network connection) where Image contains CMSTP.exe and DestinationIP is external. .005 Mshta Monitor for newly constructed network connections that are sent or received by untrusted hosts. .007 Msiexec Monitor for newly constructed network connections that are sent or received by untrusted hosts. .010 Regsvr32 Monitor for newly constructed network connections that are sent or received by untrusted hosts. Enterprise T1221 Template Injection Monitor for newly constructed network connections that are sent or received by untrusted hosts. Enterprise T1205 Traffic Signaling Monitor for newly constructed network connections that are sent or received by untrusted hosts. .001 Port Knocking Monitor for newly constructed network connections that are sent or received by untrusted hosts. .002 Socket Filters Monitor recently started applications creating raw socket connections.[3] Enterprise T1204 User Execution Monitor for newly constructed web-based network connections that are sent to malicious or suspicious destinations (e.g. destinations attributed to phishing campaigns). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments (e.g. monitor anomalies in use of files that do not normally initiate network connections or unusual connections initiated by regsvr32.exe, rundll.exe, .SCF, HTA, MSI, DLLs, or msiexec.exe). .001 Malicious Link Monitor for newly constructed web-based network connections that are sent to malicious or suspicious destinations (e.g. destinations attributed to phishing campaigns). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments (e.g. monitor anomalies in use of files that do not normally initiate network connections or unusual connections initiated by regsvr32.exe, rundll.exe, .SCF, HTA, MSI, DLLs, or msiexec.exe). ICS T0863 User Execution Monitor for newly constructed web-based network connections that are sent to malicious or suspicious destinations (e.g., destinations attributed to phishing campaigns). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments (e.g., monitor anomalies in use of files that do not normally initiate network connections or unusual connections initiated by regsvr32.exe, rundll.exe, SCF, HTA, MSI, DLLs, or msiexec.exe). Enterprise T1102 Web Service Monitor for newly constructed network connections that are sent or received by untrusted hosts. .002 Bidirectional Communication Monitor for newly constructed network connections that are sent or received by untrusted hosts. .003 One-Way Communication Monitor for newly constructed network connections that are sent or received by untrusted hosts. Mobile T1481 Web Service Many properly configured firewalls may naturally block command and control traffic. .001 Dead Drop Resolver Many properly configured firewalls may naturally block command and control traffic. .002 Bidirectional Communication Many properly configured firewalls may naturally block bidirectional command and control traffic. .003 One-Way Communication Many properly configured firewalls may naturally block one-way command and control traffic. Enterprise T1047 Windows Management Instrumentation Monitor network traffic for WMI connections for potential use to remotely edit configuration, start services, or query files. When remote WMI requests are over RPC it connects to a DCOM interface within the RPC group netsvcs. To detect this activity, a sensor is needed at the network level that can decode RPC traffic or on the host where the communication can be detected more natively, such as Event Tracing for Windows. Using wireshark/tshark decoders, the WMI interfaces can be extracted so that WMI activity over RPC can be detected. Although the description details how to detect remote WMI precisely, a decent estimate has been to look for the string RPCSS within the initial RPC connection on 135/tcp. It returns a superset of this activity, and will trigger on all DCOM-related services running within RPC, which is likely to also be activity that should be detected between hosts. More about RPCSS at : rpcss_dcom_interfaces.html After the WMI connection has been initialized, a process can be remotely launched using the command: wmic /node:\"\" process call create \"\", which is detected in the third Detection Pseudocode. This leaves artifacts at both a network (RPC) and process (command line) level. When wmic.exe (or the schtasks API) is used to remotely create processes, Windows uses RPC (135/tcp) to communicate with the the remote machine. After RPC authenticates, the RPC endpoint mapper opens a high port connection, through which the schtasks Remote Procedure Call is actually implemented. With the right packet decoders, or by looking for certain byte streams in raw data, these functions can be identified. When the command line is executed, it has the parent process of C:\\windows\\system32\\wbem\\WmiPrvSE.exe. This analytic looks for these two events happening in sequence, so that the network connection and target process are output. Certain strings can be identifiers of the WMI by looking up the interface UUID for IRemUnknown2 in different formats- UUID 00000143-0000-0000-c000-000000000046 (decoded)- Hex 43 01 00 00 00 00 00 00 c0 00 00 00 00 00 00 46 (raw)- ASCII CF (printable text only) This identifier is present three times during the RPC request phase. Any sensor that has access to the byte code as raw, decoded, or ASCII could implement this analytic. The transfer syntax is- UUID 8a885d04-1ceb-11c9-9fe8-08002b104860 (decoded)- Hex 04 5d 88 8a eb 1c c9 11 9f e8 08 00 2b 10 48 60 (raw)- ASCII `]+H`` (printable text only) Thus, a great ASCII based signature is- CF]+HCFCFhost\" Note: To detect WMI over RPC (using DCOM), a sensor needs to exist that has the insight into individual connections and can actually decode and make sense of RPC traffic. Specifically, WMI can be detected by looking at RPC traffic where the target interface matches that of WMI, which is IRemUnknown2. Look for instances of the WMI querying in network traffic, and find the cases where a process is launched immediately after a connection is seen. This essentially merges the request to start a remote process via WMI with the process execution. If other processes are spawned from wmiprvse.exe in this time frame, it is possible for race conditions to occur, and the wrong process may be merged. If this is the case, it may be useful to look deeper into the network traffic to see if the desired command can be extracted. Analytic 1 - Remote WMI over RPC wmi_flow = filter network_flow where (dest_port == 135 and proto_info.rpc_interface == \"IRemUnknown2\") Analytic 2 : Remotely Launched Executables via WMI wmi_children = filter processes where (parent_process == \"wmiprvse.exe\")wmi_flow = filter network flow where (src_port \u2265 49152 and dest_port \u2265 49152 and proto_info.rpc_interface == \"IRemUnknown2\")remote_wmi_process = join wmi_children, wmi_flow where (wmi_flow.time < wmi_children.time < wmi_flow.time + 1 sec and wmi_flow.hostname == wmi_children.hostname Network Traffic: Network Traffic Content Logged network traffic data showing both protocol header and body values (ex: PCAP) Network Traffic: Network Traffic Content Logged network traffic data showing both protocol header and body values (ex: PCAP) Domain ID Name Detects Enterprise T1087 .002 Account Discovery: Domain Account Monitor and analyze traffic patterns and packet inspection associated to LDAP and MSRPC that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). ICS T0800 Activate Firmware Update Mode Monitor ICS automation network protocols for information that an asset has been placed into Firmware Update Mode. Enterprise T1595 Active Scanning Monitor and analyze traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). .002 Vulnerability Scanning Monitor and analyze traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). .003 Wordlist Scanning Monitor for suspicious network traffic that could be indicative of scanning, such as large quantities originating from a single source (especially if the source is known to be associated with an adversary/botnet). Enterprise T1557 Adversary-in-the-Middle Monitor network traffic for anomalies associated with known AiTM behavior. .001 LLMNR/NBT-NS Poisoning and SMB Relay Monitor for traffic on ports UDP 5355 and UDP 137 if LLMNR/NetBIOS is disabled by security policy. .002 ARP Cache Poisoning Monitor network traffic for unusual ARP traffic, gratuitous ARP replies may be suspicious. Consider collecting changes to ARP caches across endpoints for signs of ARP poisoning. For example, if multiple IP addresses map to a single MAC address, this could be an indicator that the ARP cache has been poisoned. .003 DHCP Spoofing Monitor network traffic for suspicious/malicious behavior involving DHCP, such as changes in DNS and/or gateway parameters. Additionally, monitor network traffic for rogue DHCPv6 activity. ICS T0830 Adversary-in-the-Middle Monitor network traffic for anomalies associated with known AiTM behavior. For Collection activity where transmitted data is not manipulated, anomalies may be present in network management protocols (e.g., ARP, DHCP). Enterprise T1071 Application Layer Protocol Monitor and analyze traffic patterns and packet inspection associated to protocol(s), leveraging SSL/TLS inspection for encrypted traffic, that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). .001 Web Protocols Monitor and analyze traffic patterns and packet inspection associated to protocol(s), leveraging SSL/TLS inspection for encrypted traffic, that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). .002 File Transfer Protocols Monitor and analyze traffic patterns and packet inspection associated to protocol(s), leveraging SSL/TLS inspection for encrypted traffic, that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). .003 Mail Protocols Monitor and analyze traffic patterns and packet inspection associated to protocol(s), leveraging SSL/TLS inspection for encrypted traffic, that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). .004 DNS Monitor and analyze traffic patterns and packet inspection associated to protocol(s), leveraging SSL/TLS inspection for DNS over TLS (DoT) and DNS over HTTPS (DoH), that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). ICS T0802 Automated Collection Monitor for information collection on assets that may indicate deviations from standard operational tools. Examples include unexpected industrial automation protocol functions, new high volume communication sessions, or broad collection across many hosts within the network. Enterprise T1020 Automated Exfiltration Monitor network traffic content for evidence of data exfiltration, such as gratuitous or anomalous outbound traffic containing collected data. Consider correlation with process monitoring and command lines associated with collection and exfiltration. ICS T0806 Brute Force I/O Monitor network traffic for ICS functions related to write commands for an excessive number of I/O points or manipulating a single value an excessive number of times. Enterprise T1612 Build Image on Host Monitor for network traffic associated with requests and/or downloads of container images, especially those that may be anomalous or known malicious. ICS T0892 Change Credential Monitor for device credential changes observable in automation or management network protocols. ICS T0858 Change Operating Mode Monitor ICS management protocols for functions that change an asset\u2019s operating mode. ICS T0885 Commonly Used Port Monitor for mismatches between protocols and their expected ports (e.g., non-HTTP traffic on tcp:80). Analyze packet contents to detect communications that do not follow the expected protocol behavior for the port that is being used.[4] Enterprise T1586 Compromise Accounts Monitor and analyze traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). .001 Social Media Accounts Monitor and analyze traffic patterns and packet inspection associated to protocol(s), leveraging SSL/TLS inspection for encrypted traffic, that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). ICS T0884 Connection Proxy Monitor and analyze traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g., extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g., monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). Enterprise T1659 Content Injection Monitor for other unusual network traffic that may indicate additional malicious content transferred to the system. Use network intrusion detection systems, sometimes with SSL/TLS inspection, to look for known malicious payloads, content obfuscation, and exploit code. Enterprise T1132 Data Encoding Monitor for network data for uncommon data flows (e.g., a client sending significantly more data than it receives from a server). Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. Analyze packet contents to detect communications that do not follow the expected protocol behavior for the port that is being used. Note: Network Analysis frameworks such as Zeek can be used to capture, decode, and alert on network protocols and packet contents. .001 Standard Encoding Monitor for network data for uncommon data flows (e.g., a client sending significantly more data than it receives from a server). Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. Analyze packet contents to detect communications that do not follow the expected protocol behavior for the port that is being used. .002 Non-Standard Encoding Monitor for network data for uncommon data flows (e.g., a client sending significantly more data than it receives from a server). Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. Analyze packet contents to detect communications that do not follow the expected protocol behavior for the port that is being used. Enterprise T1602 Data from Configuration Repository Monitor and analyze traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g. unauthorized, gratuitous, or anomalous traffic patterns attempting to access configuration content) .001 SNMP (MIB Dump) Monitor and analyze traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flow (e.g. snmp traffic originating from unauthorized or untrusted hosts, signature detection for strings mapped to device configuration(s), and anomolies in snmp request(s)) .002 Network Device Configuration Dump Monitor and analyze traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g. unauthorized, gratuitous, or anomalous traffic patterns attempting to access network configuration content) Enterprise T1039 Data from Network Shared Drive Monitor and analyze traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). Enterprise T1565 Data Manipulation Monitor for networks that solicits and obtains the configuration information of the queried device. .002 Transmitted Data Manipulation Monitor for networks that solicits and obtains the configuration information of the queried device. Enterprise T1001 Data Obfuscation Monitor and analyze traffic patterns and packet inspection associated to protocol(s), leveraging SSL/TLS inspection for encrypted traffic, that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). .001 Junk Data Monitor and analyze traffic patterns and packet inspection associated to protocol(s), leveraging SSL/TLS inspection for encrypted traffic, that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). .002 Steganography Monitor and analyze traffic patterns and packet inspection associated to protocol(s), leveraging SSL/TLS inspection for encrypted traffic, that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). .003 Protocol Impersonation Monitor and analyze traffic patterns and packet inspection associated to protocol(s), leveraging SSL/TLS inspection for encrypted traffic, that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). Enterprise T1491 Defacement Monitor and analyze traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g. unauthorized, gratuitous, or anomalous traffic patterns attempting to access internal and external websites and services). Consider correlating with application monitoring for indication of unplanned service interruptions or unauthorized content changes. .001 Internal Defacement Monitor and analyze traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). .002 External Defacement Monitor and analyze traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). ICS T0812 Default Credentials Monitor network traffic for default credential use in protocols that allow unencrypted authentication. ICS T0814 Denial of Service Monitor and analyze traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g., extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g., monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). ICS T0868 Detect Operating Mode Monitor ICS automation network protocols for functions related to reading an asset\u2019s operating mode. In some cases, there may be multiple ways to detect a device\u2019s operating mode, one of which is typically used in the operational environment. Monitor for the operating mode being checked in unexpected ways. ICS T0816 Device Restart/Shutdown Monitor ICS automation protocols for functions that restart or shutdown a device. Commands to restart or shutdown devices may also be observable in traditional IT management protocols. Enterprise T1482 Domain Trust Discovery Monitor and analyze traffic patterns and packet inspection associated to LDAP and MSRPC that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Mobile T1407 Download New Code at Runtime Mobile security products may provide URL inspection services that could determine if a domain being visited is malicious. Enterprise T1189 Drive-by Compromise Monitor for other unusual network traffic that may indicate additional tools transferred to the system. Use network intrusion detection systems, sometimes with SSL/TLS inspection, to look for known malicious scripts (recon, heap spray, and browser identification scripts have been frequently reused), common script obfuscation, and exploit code. ICS T0817 Drive-by Compromise Monitor for unusual network traffic that may indicate additional tools transferred to the system. Use network intrusion detection systems, sometimes with SSL/TLS inspection, to look for known malicious scripts (recon, heap spray, and browser identification scripts have been frequently reused), common script obfuscation, and exploit code. Enterprise T1568 Dynamic Resolution Monitor and analyze traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). .003 DNS Calculation Monitor and analyze traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). Enterprise T1573 Encrypted Channel Monitor and analyze traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). .001 Symmetric Cryptography Monitor and analyze traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). .002 Asymmetric Cryptography Monitor and analyze traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). Enterprise T1499 Endpoint Denial of Service Monitor and analyze traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). .001 OS Exhaustion Flood Monitor and analyze traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). .002 Service Exhaustion Flood Monitor and analyze traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). .003 Application Exhaustion Flood Monitor and analyze traffic patterns and packet inspection associated to protocol(s), leveraging SSL/TLS inspection for encrypted traffic, that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). .004 Application or System Exploitation Monitor and analyze traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). Enterprise T1585 Establish Accounts Monitor and analyze traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). .001 Social Media Accounts Monitor and analyze traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). Enterprise T1048 Exfiltration Over Alternative Protocol Monitor and analyze traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). .001 Exfiltration Over Symmetric Encrypted Non-C2 Protocol Monitor and analyze traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). .002 Exfiltration Over Asymmetric Encrypted Non-C2 Protocol Monitor and analyze traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). .003 Exfiltration Over Unencrypted Non-C2 Protocol Monitor and analyze traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). Enterprise T1041 Exfiltration Over C2 Channel Monitor and analyze traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). Enterprise T1011 Exfiltration Over Other Network Medium Monitor and analyze traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). .001 Exfiltration Over Bluetooth Monitor and analyze traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). Enterprise T1567 Exfiltration Over Web Service Monitor and analyze traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). .001 Exfiltration to Code Repository Monitor and analyze traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). .002 Exfiltration to Cloud Storage Monitor and analyze traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). .003 Exfiltration to Text Storage Sites Monitor and analyze network traffic for exfiltration attempts using text storage sites, i.e. POST requests to text storage sites. .004 Exfiltration Over Webhook Monitor and analyze traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g., extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g., monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). Enterprise T1190 Exploit Public-Facing Application Use deep packet inspection to look for artifacts of common exploit traffic, such as SQL injection strings or known payloads. ICS T0819 Exploit Public-Facing Application Use deep packet inspection to look for artifacts of common exploit traffic, such as known payloads. Enterprise T1210 Exploitation of Remote Services Use deep packet inspection to look for artifacts of common exploit traffic, such as known payloads. Mobile T1428 Exploitation of Remote Services Network traffic analysis could reveal patterns of compromise if devices attempt to access unusual targets or resources. ICS T0866 Exploitation of Remote Services Use deep packet inspection to look for artifacts of common exploit traffic, such as known payloads. Enterprise T1133 External Remote Services Monitor and analyze traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). Enterprise T1187 Forced Authentication For internal traffic, monitor the workstation-to-workstation unusual (vs. baseline) SMB traffic. For many networks there should not be any, but it depends on how systems on the network are configured and where resources are located. Enterprise T1589 Gather Victim Identity Information Monitor for suspicious network traffic that could be indicative of probing for user information, such as large/iterative quantities of authentication requests originating from a single source (especially if the source is known to be associated with an adversary/botnet). Analyzing web metadata may also reveal artifacts that can be attributed to potentially malicious activity, such as referer or user-agent string HTTP/S fields. .002 Email Addresses Monitor for suspicious network traffic that could be indicative of probing for email addresses and/or usernames, such as large/iterative quantities of authentication requests originating from a single source (especially if the source is known to be associated with an adversary/botnet). Analyzing web metadata may also reveal artifacts that can be attributed to potentially malicious activity, such as referer or user-agent string HTTP/S fields. Enterprise T1615 Group Policy Discovery Monitor and analyze traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). ICS T0891 Hardcoded Credentials Monitor network traffic for hardcoded credential use in protocols that allow unencrypted authentication. Enterprise T1070 Indicator Removal Monitor and analyze traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). .005 Network Share Connection Removal Monitoring for SMB traffic between systems may also be captured and decoded to look for related network share session and file transfer activity. Enterprise T1105 Ingress Tool Transfer Monitor network traffic content for files and other potentially malicious content, especially data coming in from abnormal/unknown domain and IPs. Enterprise T1534 Internal Spearphishing Monitor and analyze traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). ICS T0883 Internet Accessible Device Monitor for unusual logins to Internet connected devices or unexpected protocols to/from the Internet. Network traffic content will provide valuable context and details about the content of network flows. Enterprise T1570 Lateral Tool Transfer Monitor for unusual processes with internal network connections creating files on-system may be suspicious Note: Analytic Event Type is for Zeek but can also be implemented in other Network Analysis Frameworks by parsing & decoding captured SMB2 network traffic. From a network traffic capture standpoint, it\u2019s important to capture the right traffic for this type of detection to function (e.g., all endpoint to endpoint if possible or workstation to server and workstation to workstation). As such, it is helpful to have a centralized server area where it is possible to monitor communications between servers and endpoints. Analytic 1 and 2 are very similar, with the key difference being that Implementation 2 is intended to capture multiple attempts at lateral movement originating from the same host within a short time period (5 minutes). Analytic 1 - Basic suspicious_smb_traffic = filter log_events where ((event_id == \"smb2_write_response\" OR event_id == \"smb1_write_response\" OR event_id == \"smb1_write_andx_response\") AND (connection.smb_state.path == \"ADMIN$\" OR connection.smb_state.path == \"C$\") ) Analytic 2 - Multiple Attempts (Time Window) suspicious_smb_traffic = filter log_events where ((event_id == \"smb2_write_response\" OR event_id == \"smb1_write_response\" OR event_id == \"smb1_write_andx_response\") AND (connection.smb_state.path == \"ADMIN$\" OR connection.smb_state.path == \"C$\") REPEATS 5 TIMES WITHIN 5 MINUTES FROM SAME src_ip) ICS T0867 Lateral Tool Transfer Monitor for unusual processes with internal network connections creating files on-system which may be suspicious. ICS T0838 Modify Alarm Settings Monitor for alarm setting changes observable in automation or management network protocols. ICS T0836 Modify Parameter Monitor ICS management protocols for parameter changes, including for unexpected values, changes far exceeding standard values, or for parameters being changed in an unexpected way (e.g., via a new function, at an unusual time). ICS T0889 Modify Program Monitor device management protocols for functions that modify programs such as online edit and program append events. ICS T0839 Module Firmware Monitor ICS management protocols / file transfer protocols for protocol functions related to firmware changes. ICS T0801 Monitor Process State Monitor ICS automation network protocols for functions related to reading an operational process state (e.g., \"Read\" function codes in protocols like DNP3 or Modbus). In some cases, there may be multiple ways to monitor an operational process\u2019 state, one of which is typically used in the operational environment. Monitor for the operating mode being checked in unexpected ways. Enterprise T1599 Network Boundary Bridging Monitor and analyze traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). .001 Network Address Translation Traversal Monitor and analyze traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). Enterprise T1095 Non-Application Layer Protocol Monitor and analyze traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). Enterprise T1571 Non-Standard Port Analyze packet contents to detect communications that do not follow the expected protocol behavior for the port that is being used. Enterprise T1003 OS Credential Dumping Monitor and analyze traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). .006 DCSync Monitor and analyze traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). Enterprise T1566 Phishing Monitor and analyze SSL/TLS traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). Filtering based on DKIM+SPF or header analysis can help detect when the email sender is spoofed.[5][6] .001 Spearphishing Attachment Monitor and analyze SSL/TLS traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). Filtering based on DKIM+SPF or header analysis can help detect when the email sender is spoofed.[5][6] .002 Spearphishing Link Monitor and analyze SSL/TLS traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g. extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). Furthermore, monitor network traffic for cloned sites as well as homographs via the use of internationalized domain names abusing different character sets (e.g. Cyrillic vs Latin versions of trusted sites). .003 Spearphishing via Service Monitor and analyze traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). Mobile T1660 Phishing Mobile security products may provide URL inspection services that could determine if a domain being visited is malicious. Enterprise T1598 Phishing for Information Monitor and analyze traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). .001 Spearphishing Service Monitor and analyze traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). .002 Spearphishing Attachment Monitor and analyze traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). .003 Spearphishing Link Monitor and analyze traffic patterns and packet inspection associated to protocol(s), leveraging SSL/TLS inspection for encrypted traffic, that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). Furthermore, monitor network traffic for homographs via the use of internationalized domain names abusing different character sets (e.g. Cyrillic vs Latin versions of trusted sites). Also monitor and analyze traffic patterns and packet inspection for indicators of cloned websites. For example, if adversaries use HTTrack to clone websites, Mirrored from (victim URL) may be visible in the HTML section of packets. ICS T0861 Point & Tag Identification Monitor ICS automation protocols for anomalies related to reading point or tag data, such as new assets using these functions, changes in volume or timing, or unusual information being queried. Many protocols provide multiple ways to achieve the same result (e.g., functions with/without an acknowledgment or functions that operate on a single point vs. multiple points). Monitor for changes in the functions used. ICS T0843 Program Download Monitor for protocol functions related to program download or modification. Program downloads may be observable in ICS automation protocols and remote management protocols. ICS T0845 Program Upload Program uploads may be observable in ICS management protocols or file transfer protocols. Note when protocol functions related to program uploads occur. In cases where the ICS protocols is not well understood, one option is to examine network traffic for the program files themselves using signature-based tools. Enterprise T1572 Protocol Tunneling Monitor and analyze traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). Enterprise T1090 Proxy Monitor and analyze traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). .001 Internal Proxy Monitor and analyze traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). .002 External Proxy Monitor and analyze traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). .003 Multi-hop Proxy Monitor and analyze traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). .004 Domain Fronting Monitor and analyze traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). Enterprise T1219 Remote Access Software Monitor and analyze traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). Enterprise T1563 Remote Service Session Hijacking Monitor and analyze traffic patterns and packet inspection associated to protocol(s), leveraging SSL/TLS inspection for encrypted traffic, that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). .001 SSH Hijacking Monitor and analyze traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). .002 RDP Hijacking Monitor and analyze traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). Network Analysis frameworks such as Zeek can be used to capture, decode, and alert on network protocols including RDP. ICS T0846 Remote System Discovery Monitor for anomalies related to discovery related ICS functions, including devices that have not previously used these functions or for functions being sent to many outstations. Note that some ICS protocols use broadcast or multicast functionality, which may produce false positives. Also monitor for hosts enumerating network connected resources using non-ICS enterprise protocols. ICS T0888 Remote System Information Discovery Monitor for anomalies related to discovery related ICS functions, including devices that have not previously used these functions or for functions being sent to many outstations. Note that some ICS protocols use broadcast or multicast functionality, which may produce false positives. Also monitor for hosts enumerating network connected resources using non-ICS enterprise protocols. Enterprise T1207 Rogue Domain Controller Monitor and analyze network traffic associated with data replication (such as calls to DrsAddEntry, DrsReplicaAdd, and especially GetNCChanges) between DCs as well as to/from non DC hosts. [7][8] DC replication will naturally take place every 15 minutes but can be triggered by an adversary or by legitimate urgent changes (ex: passwords). ICS T0848 Rogue Master Monitor for unexpected ICS protocol functions from new and existing devices. Monitoring known devices requires ICS function level insight to determine if an unauthorized device is issuing commands (e.g., a historian). Enterprise T1505 Server Software Component Monitor and analyze traffic patterns and packet inspection associated to protocol(s), leveraging SSL/TLS inspection for encrypted traffic, that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). [9] .003 Web Shell Monitor and analyze traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). ICS T0865 Spearphishing Attachment Monitor network traffic for suspicious email attachments. Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g., monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). Use web proxies to review content of emails including sender information, headers, and attachments for potentially malicious content. ICS T0856 Spoof Reporting Message Spoofed reporting messages may be detected by reviewing the content of automation protocols, either through detecting based on expected values or comparing to other out of band process data sources. Spoofed messages may not precisely match legitimate messages which may lead to malformed traffic, although traffic may be malformed for many benign reasons. Monitor reporting messages for changes in how they are constructed. Various techniques enable spoofing a reporting message. Consider monitoring for Rogue Master and Adversary-in-the-Middle activity. ICS T0869 Standard Application Layer Protocol Monitor and analyze traffic patterns and packet inspection associated to protocol(s), leveraging SSL/TLS inspection for encrypted traffic, that do not follow the expected protocol standards and traffic flows (e.g., extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g., monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). ICS T0857 System Firmware Monitor ICS management protocols / file transfer protocols for protocol functions related to firmware changes. Enterprise T1033 System Owner/User Discovery Monitor and analyze traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). Note: Network Analysis frameworks such as Zeek can be used to capture, decode, and alert on network protocols. Enterprise T1221 Template Injection Monitor and analyze traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). Enterprise T1205 Traffic Signaling Monitor and analyze network packet contents to detect application layer protocols, leveraging SSL/TLS inspection for encrypted traffic, that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, protocol port mismatch, anomalous syntax, or structure). Consider packet inspection for Wake-on-LAN magic packet consists of 6 bytes of FF followed by sixteen repetitions of the target system's IEEE address. Seeing this string anywhere in a packet's payload may be indicative of a Wake-on-LAN attempt.[10] Enterprise T1537 Transfer Data to Cloud Account Monitor network traffic content for evidence of data exfiltration, such as gratuitous or anomalous internal traffic containing collected data. Consider correlation with process monitoring and command lines associated with collection and exfiltration. Enterprise T1199 Trusted Relationship Monitor and analyze traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure) from a trusted entity. Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). ICS T0855 Unauthorized Command Message Monitor for unexpected ICS protocol command functions to controllers from existing master devices (including from new processes) or from new devices. The latter is like detection for Rogue Master but requires ICS function level insight to determine if an unauthorized device is issuing commands (e.g., a historian). Monitoring for unexpected or problematic values below the function level will provide better insights into potentially malicious activity but at the cost of additional false positives depending on the underlying operational process. Enterprise T1204 User Execution Monitor and analyze traffic patterns and packet inspection associated with web-based network connections that are sent to malicious or suspicious detinations (e.g. destinations attributed to phishing campaigns). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments (e.g. monitor anomalies in use of files that do not normally initiate network connections or unusual connections initiated by regsvr32.exe, rundll.exe, .SCF, HTA, MSI, DLLs, or msiexec.exe). .001 Malicious Link Monitor and analyze traffic patterns and packet inspection associated with web-based network connections that are sent to malicious or suspicious detinations (e.g. destinations attributed to phishing campaigns). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments (e.g. monitor anomalies in use of files that do not normally initiate network connections or unusual connections initiated by regsvr32.exe, rundll.exe, .SCF, HTA, MSI, DLLs, or msiexec.exe). ICS T0863 User Execution Monitor and analyze traffic patterns and packet inspection associated with web-based network connections that are sent to malicious or suspicious destinations (e.g., destinations attributed to phishing campaigns). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments (e.g., monitor anomalies in use of files that do not normally initiate network connections or unusual connections initiated by regsvr32.exe, rundll.exe, SCF, HTA, MSI, DLLs, or msiexec.exe). Enterprise T1102 Web Service Monitor and analyze traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). .001 Dead Drop Resolver Monitor and analyze traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). .002 Bidirectional Communication Monitor and analyze traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). .003 One-Way Communication Monitor and analyze traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). Network Traffic: Network Traffic Flow Summarized network packet data, with metrics, such as protocol headers and volume (ex: Netflow or Zeek http.log) Network Traffic: Network Traffic Flow Summarized network packet data, with metrics, such as protocol headers and volume (ex: Netflow or Zeek http.log) Domain ID Name Detects Enterprise T1595 Active Scanning Monitor network data for uncommon data flows. Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. .001 Scanning IP Blocks Monitor network data for uncommon data flows. Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. .002 Vulnerability Scanning Monitor network data for uncommon data flows. Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. Enterprise T1557 Adversary-in-the-Middle Monitor for network traffic originating from unknown/unexpected hardware devices. Local network traffic metadata (such as source MAC addressing) as well as usage of network management protocols such as DHCP may be helpful in identifying hardware. .001 LLMNR/NBT-NS Poisoning and SMB Relay Monitor for network traffic originating from unknown/unexpected hardware devices. Local network traffic metadata (such as source MAC addressing) as well as usage of network management protocols such as DHCP may be helpful in identifying hardware. .002 ARP Cache Poisoning Monitor for network traffic originating from unknown/unexpected hardware devices. Local network traffic metadata (such as source MAC addressing) as well as usage of network management protocols such as DHCP may be helpful in identifying hardware. .003 DHCP Spoofing Monitor network traffic for anomalies associated with known AiTM behavior. Consider monitoring for modifications to system configuration files involved in shaping network traffic flow. ICS T0830 Adversary-in-the-Middle Monitor for network traffic originating from unknown/unexpected hosts. Local network traffic metadata (such as source MAC addressing) as well as usage of network management protocols such as DHCP may be helpful in identifying hardware. For added context on adversary procedures and background see Adversary-in-the-Middle and applicable sub-techniques. ICS T0878 Alarm Suppression Monitor for loss of network traffic which could indicate alarms are being suppressed. A loss of expected communications associated with network protocols used to communicate alarm events or process data could indicate this technique is being used. This will not directly detect the technique\u2019s execution, but instead may provide additional evidence that the technique has been used and may complement other detections. Enterprise T1071 Application Layer Protocol Monitor and analyze traffic flows that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, or gratuitous or anomalous traffic patterns). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). .001 Web Protocols Monitor for web traffic to/from known-bad or suspicious domains and analyze traffic flows that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, or gratuitous or anomalous traffic patterns). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). .002 File Transfer Protocols Monitor and analyze traffic flows that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, or gratuitous or anomalous traffic patterns). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). .003 Mail Protocols Monitor and analyze traffic flows that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, or gratuitous or anomalous traffic patterns). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). .004 DNS Monitor for DNS traffic to/from known-bad or suspicious domains and analyze traffic flows that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, or gratuitous or anomalous traffic patterns). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). Enterprise T1020 Automated Exfiltration Monitor and analyze network flows associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, or gratuitous or anomalous traffic patterns). Consider analyzing newly constructed network connections that are sent or received by untrusted hosts, unexpected hardware devices, or other uncommon data flows. .001 Traffic Duplication Monitor and analyze network flows associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, or gratuitous or anomalous traffic patterns). Consider analyzing newly constructed network connections that are sent or received by untrusted hosts, unexpcted hardware devices, or other uncommon data flows. ICS T0803 Block Command Message Monitor for a loss of network communications, which may indicate this technique is being used. ICS T0804 Block Reporting Message Monitor for a loss of network communications, which may indicate this technique is being used. ICS T0805 Block Serial COM Monitor for a loss of network communications, which may indicate this technique is being used. Enterprise T1612 Build Image on Host Monitor for established network communications with anomalous IPs that have never been seen before in the environment that may indicate the download of malicious code. ICS T0885 Commonly Used Port Analyze network data for uncommon data flows (e.g., new protocols in use between hosts, unexpected ports in use). Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. ICS T0884 Connection Proxy Monitor for known proxy protocols (e.g., SOCKS, Tor, peer-to-peer protocols) and tool usage (e.g., Squid, peer-to-peer software) on the network that are not part of normal operations. Also monitor network data for uncommon data flows. Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. Enterprise T1543 .003 Create or Modify System Process: Windows Service Monitor for several ways that code can execute on a remote host. One of the most common methods is via the Windows Service Control Manager (SCM), which allows authorized users to remotely create and modify services. Several tools, such as PsExec, use this functionality. When a client remotely communicates with the Service Control Manager, there are two observable behaviors. First, the client connects to the RPC Endpoint Mapper over 135/tcp. This handles authentication, and tells the client what port the endpoint\u2014in this case the SCM\u2014is listening on. Then, the client connects directly to the listening port on services.exe. If the request is to start an existing service with a known command line, the the SCM process will run the corresponding command. This compound behavior can be detected by looking for services.exe receiving a network connection and immediately spawning a child process. Analytic 1 - Remotely Launched Executables via Services service = filter process where (parent_exe == \"services.exe\")remote_start = join (flow, service ) where ( flow.hostname == service.hostname and flow.pid == service.pid and (flow.time < service.time < flow.time + 1 second)) Enterprise T1039 Data from Network Shared Drive Monitor network data for uncommon data flows. Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. Network Analysis frameworks such as Zeek can be used to capture, decode, and alert on network protocols such as SMB that revolve around network shares. Although there may be more native ways to detect detailed SMB events on the host, they can be extracted out of network traffic. With the right protocol decoders, port 445 traffic can be filtered and even the file path (relative to the share) can be retrieved. Looking at this activity more closely to obtain an adequate sense of situational awareness may make it possible to detect adversaries moving between hosts in a way that deviates from normal activity. Because SMB traffic is heavy in many environments, this analytic may be difficult to turn into something that can be used to quickly detect an APT. In some cases, it may make more sense to run this analytic in a forensic fashion. Looking through and filtering its output after an intrusion has been discovered may be helpful in identifying the scope of compromise. Analytic 1 - SMB Events Monitoring smb_events = filter flow where (dest_port == \"445\" and protocol == \"smb\")smb_events.file_name = smb_events.proto_info.file_name Enterprise T1565 Data Manipulation Monitor for network traffic originating from unknown/unexpected hardware devices. .002 Transmitted Data Manipulation Monitor for network traffic originating from unknown/unexpected hardware devices. Enterprise T1030 Data Transfer Size Limits Monitor and analyze traffic flows that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, or gratuitous or anomalous traffic patterns). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). ICS T0814 Denial of Service Monitor network data for uncommon data flows. Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. ICS T0816 Device Restart/Shutdown Monitor for a loss of network communications, which may indicate a device has been shutdown or restarted. This will not directly detect the technique\u2019s execution, but instead may provide additional evidence that the technique has been used and may complement other detections. Enterprise T1568 Dynamic Resolution Monitor network data for uncommon data flows. Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. .001 Fast Flux DNS In general, detecting usage of fast flux DNS is difficult due to web traffic load balancing that services client requests quickly. In single flux cases only IP addresses change for static domain names. In double flux cases, nothing is static. Defenders such as domain registrars and service providers are likely in the best position for detection. .002 Domain Generation Algorithms Detecting dynamically generated domains can be challenging due to the number of different DGA algorithms, constantly evolving malware families, and the increasing complexity of the algorithms. There is a myriad of approaches for detecting a pseudo-randomly generated domain name, including using frequency analysis, Markov chains, entropy, proportion of dictionary words, ratio of vowels to other characters, and more. [11] CDN domains may trigger these detections due to the format of their domain names. In addition to detecting a DGA domain based on the name, another more general approach for detecting a suspicious domain is to check for recently registered names or for rarely visited domains.Machine learning approaches to detecting DGA domains have been developed and have seen success in applications. One approach is to use N-Gram methods to determine a randomness score for strings used in the domain name. If the randomness score is high, and the domains are not whitelisted (CDN, etc), then it may be determined if a domain is related to a legitimate host or DGA. [12] Another approach is to use deep learning to classify domains as DGA-generated[13]] Enterprise T1499 Endpoint Denial of Service Monitor network data for uncommon data flows. Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. .001 OS Exhaustion Flood Monitor network data for uncommon data flows. Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. .002 Service Exhaustion Flood Monitor network data for uncommon data flows. Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. .003 Application Exhaustion Flood Monitor network data for uncommon data flows. Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. .004 Application or System Exploitation Monitor network data for uncommon data flows. Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. Enterprise T1048 Exfiltration Over Alternative Protocol Monitor network data for uncommon data flows. Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. .001 Exfiltration Over Symmetric Encrypted Non-C2 Protocol Monitor network data for uncommon data flows. Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. .002 Exfiltration Over Asymmetric Encrypted Non-C2 Protocol Monitor network data for uncommon data flows. Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. .003 Exfiltration Over Unencrypted Non-C2 Protocol Monitor network data for uncommon data flows. Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. Enterprise T1041 Exfiltration Over C2 Channel Monitor network data for uncommon data flows. Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. Enterprise T1011 Exfiltration Over Other Network Medium Monitor network data for uncommon data flows., such as the usage of abnormal/unexpected protocols. .001 Exfiltration Over Bluetooth Monitor network data for uncommon data flows., such as the usage of abnormal/unexpected protocols. Enterprise T1567 Exfiltration Over Web Service Monitor network data for uncommon data flows. Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. .001 Exfiltration to Code Repository Monitor network data for uncommon data flows. Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. Monitor for use of code repositories for data exfiltration. Analytic 1 - Suspicious Data Exfil suspicious_exfil = filter network_traffic where (httpHost = \"github.com\" or httpHost =\"justpaste.it\" or httpHost= \"pastebin.com\" or httpHost=\"onpaste.com\" or httpHost=\"transfernow.net\" or httpHost = \"codepad.org\") .002 Exfiltration to Cloud Storage Monitor network data for uncommon data flows. Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. Monitor for cloud storages for data exfiltration. Analytic 1 - Suspicious Data Exfil suspicious_exfil = filter network_traffic where (httpHost = \"dropbox.com\" or httpHost = \"box.com\" or httpHost = \"drive.google.com\" or httpHost = \"mega.io\" or httpHost = \"mediafire.com\") .003 Exfiltration to Text Storage Sites Monitor network data for uncommon data flows, specifically to text storage sites such as Pastebin[.]com, Paste[.]ee, and Pastebin[.]pl. .004 Exfiltration Over Webhook Monitor network data for uncommon data flows. Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. Enterprise T1133 External Remote Services Monitor for network traffic originating from unknown/unexpected hardware devices. Local network traffic metadata (such as source MAC addressing) as well as usage of network management protocols such as DHCP may be helpful in identifying hardware. ICS T0822 External Remote Services Monitor for network traffic originating from unknown/unexpected systems. Enterprise T1008 Fallback Channels Monitor network data for uncommon data flows, such as unexpected surges or other abnormal inbound/outbound patterns. Enterprise T1187 Forced Authentication Monitor for SMB traffic on TCP ports 139, 445 and UDP port 137 and WebDAV traffic attempting to exit the network to unknown external systems.If attempts are detected, then investigate endpoint data sources to find the root cause. Analytic 1 - SMB Session Setups smb_setup = filter flow where (dest_port == 445 and protocol == smb.setup)smb_setup.user = smb_write.proto_info.user_namesmb_setup.target_host = smb_write.proto_info.hostname Enterprise T1200 Hardware Additions Monitor for network traffic originating from unknown/unexpected hardware devices. Local network traffic metadata (such as source MAC addressing) as well as usage of network management protocols such as DHCP may be helpful in identifying hardware. Enterprise T1105 Ingress Tool Transfer Monitor network data for uncommon data flows (e.g., a client sending significantly more data than it receives from a server). Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. Enterprise T1534 Internal Spearphishing Monitor network data for uncommon data flows. Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. ICS T0883 Internet Accessible Device Monitor for unexpected protocols to/from the Internet. While network traffic content and logon session metadata may directly identify a login event, new Internet-based network flows may also be a reliable indicator of this technique. Enterprise T1570 Lateral Tool Transfer Monitor for network traffic originating from unknown/unexpected hardware devices. Local network traffic metadata (such as source MAC addressing) as well as usage of network management protocols such as DHCP may be helpful in identifying hardware. ICS T0867 Lateral Tool Transfer Monitor for network traffic originating from unknown/unexpected hosts. Local network traffic metadata (such as source MAC addressing) as well as usage of network management protocols such as DHCP may be helpful in identifying hardware. Mobile T1430 .002 Location Tracking: Impersonate SS7 Nodes Network carriers may be able to use firewalls, Intrusion Detection Systems (IDS), or Intrusion Prevention Systems (IPS) to detect and/or block SS7 exploitation.[14] The CSRIC also suggests threat information sharing between telecommunications industry members. Enterprise T1112 Modify Registry Remote access to the registry can be achieved via Windows API function RegConnectRegistry command line via reg.exe graphically via regedit.exe All of these behaviors call into the Windows API, which uses the NamedPipe WINREG over SMB to handle the protocol information. This network can be decoded with wireshark or a similar sensor, and can also be detected by hooking the API function. Analytic 1 - Remote Registry flows = search Flow:Messagewinreg = filter flows where (dest_port == 445 and proto_info.pipe == \"WINREG\")winreg_modify = filter flows where (proto_info.function == \"Create\" or proto_info.function == \"SetValue\") Enterprise T1104 Multi-Stage Channels Monitor network data for uncommon data flows. Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. Enterprise T1599 Network Boundary Bridging Monitor network data for uncommon data flows. Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. .001 Network Address Translation Traversal Monitor network data for uncommon data flows. Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. Enterprise T1498 Network Denial of Service Monitor network data for uncommon data flows. Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. .001 Direct Network Flood Monitor network data for uncommon data flows. Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. .002 Reflection Amplification Monitor network data for uncommon data flows. Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. Enterprise T1046 Network Service Discovery Monitor network data for uncommon data flows. Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. It should be noted that when a host/ port/ service scan is performed from a compromised machine, a single machine makes multiple calls to other hosts in the network to identify live hosts and services. After compromising an initial machine, adversaries commonly attempt to laterally move across the network. The first step to attempt the Lateral Movement often involves conducting host identification, port and service scans on the internal network via the compromised machine using tools such as Nmap, Cobalt Strike, etc. Analytic 1 - Identifying Port Scanning Activity flow = filter flow where (src_type = \"firewall_logs\" AND dest_ip = \"internal_subnet\" ) Enterprise T1095 Non-Application Layer Protocol Monitor network data for uncommon data flows. Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. Enterprise T1571 Non-Standard Port Monitor network data flows for unexpected patterns and metadata that may be indicative of a mismatch between protocol and utilized port. Mobile T1509 Non-Standard Port Many properly configured firewalls may also naturally block command and control traffic over non-standard ports. Enterprise T1003 OS Credential Dumping Monitor network data for uncommon data flows. Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. .006 DCSync Monitor network data for uncommon data flows. Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. Enterprise T1566 Phishing Monitor network data for uncommon data flows. Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. .001 Spearphishing Attachment Monitor network data for uncommon data flows. Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. .002 Spearphishing Link Monitor network data for uncommon data flows. Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. .003 Spearphishing via Service Monitor network data for uncommon data flows. Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. Mobile T1660 Phishing Enterprises may be able to detect anomalous traffic originating from mobile devices, which could indicate compromise. Enterprise T1598 Phishing for Information Monitor network data for uncommon data flows. Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. .001 Spearphishing Service Monitor network data for uncommon data flows. Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. .002 Spearphishing Attachment Monitor network data for uncommon data flows. Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. .003 Spearphishing Link Monitor network data for uncommon data flows. Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. ICS T0845 Program Upload Monitor device communication patterns to identify irregular bulk transfers of data between the embedded ICS asset and other nodes within the network. Note these indicators are dependent on the profile of normal operations and the capabilities of the industrial automation protocols involved (e.g., partial program uploads). Enterprise T1572 Protocol Tunneling Monitor network data for uncommon data flows. Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. Enterprise T1090 Proxy Monitor network data for uncommon data flows. Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. .001 Internal Proxy Monitor network data for uncommon data flows. Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. .002 External Proxy Monitor network data for uncommon data flows. Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. .003 Multi-hop Proxy Monitor network data for uncommon data flows. Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. Mobile T1604 Proxy Through Victim Enterprises may be able to detect anomalous traffic originating from mobile devices, which could indicate compromise. Enterprise T1219 Remote Access Software Monitor network data for uncommon data flows. Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. Analytic 1 - Suspicious Port Usage suspicious_ports = filter network_traffic where ((protocol =\"6\" and (serverPort = 5938 or serverPort = 6568 or serverPort = 5650 or serverPort = 5655 or serverPort =5631)) or (protocol = \"17\" and (serverPort = 15000 and serverPort = 5632 )) or(httpHost = \"remoteutilities.com\")) Enterprise T1563 Remote Service Session Hijacking Monitor network data for uncommon data flows. Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. .001 SSH Hijacking Monitor network data for uncommon data flows. Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. .002 RDP Hijacking Monitor network data for uncommon data flows. Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. RDP sessions may be split up into multiple flows and would therefore need to be aggregated. Anomaly detection using machine learning or other methods based on baselined RDP network flows may be a viable approach to alerting on potential RDP session hijacking. Enterprise T1021 Remote Services Monitor network data for uncommon data flows that may be related to abuse of Valid Accounts to log into a service specifically designed to accept remote connections, such as RDP, telnet, SSH, and VNC. .001 Remote Desktop Protocol Monitor network traffic for uncommon data flows that may use Valid Accounts to log into a computer using the Remote Desktop Protocol (RDP). The Remote Desktop Protocol (RDP), built in to Microsoft operating systems, allows a user to remotely log in to the desktop of another host. It allows for interactive access of the running windows, and forwards key presses, mouse clicks, etc. Network administrators, power users, and end-users may use RDP for day-to-day operations. From an adversary\u2019s perspective, RDP provides a means to laterally move to a new host. Determining which RDP connections correspond to adversary activity can be a difficult problem in highly dynamic environments, but will be useful in identifying the scope of a compromise.Remote Desktop can be detected in several ways Network connections to port 3389/tcp (assuming use of the default port) Packet capture analysis Windows security logs (Event ID 4624, 4634, 4647, 4778) Detecting network connections from mstsc.exe Execution of the process rdpclip.exe Runs as the clipboard manager on the RDP target if clipboard sharing is enabled Analytic 1 rdp_start = filter flow_start where (port == \"3389\")rdp_end = filter flow_start where (port == \"3389\")rdp = group flow_start, flow_end by src_ip, src_port, dest_ip, dest_port .002 SMB/Windows Admin Shares Monitor network data for uncommon SMB data flows. Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. Network Analysis frameworks such as Zeek can be used to capture, decode, and alert on SMB network flows. Notes: The logic for Implementation 1 is based around detecting on SMB write requests, which are often used by adversaries to move laterally to another host. Unlike SMB Reads, SMB Write requests typically require an additional level of access, resulting in less activity. Focusing on SMB Write activity narrows the field to looking at techniques associated with actively changing remote hosts, instead of passively reading files. The logic for Implementation 2 is based around detection of new processes that were created from a file written to an SMB share. First, a file is remotely written to a host via an SMB share; then, a variety of Execution techniques can be used to remotely establish execution of the file or script. To detect this behavior, look for files that are written to a host over SMB and then later run directly as a process or in the command line arguments. SMB File Writes and Remote Execution may happen normally in an environment, but the combination of the two behaviors is less frequent and more likely to indicate adversarial activity. Analytic 1 - SMB Write smb_write = filter flow where (dest_port == \"445\" AND protocol == \"smb.write\") Analytic 2 - SMB Copy and Execution remote_start = join (smb:write, process:create) where ( smb_write.hostname == process.hostname AND smb_write.file_path == process.image_path AND (smb_write.time < process.time)) Analytic 3 - RPC Activity rpc_mapper = filter flows where (dest_port == 135)rpc_endpoint = filter flows where (dest_port >= 49152 and src_port >= 49152)rpc = join rpc_mapper, rpc_endpoint where ( (rpc_mapper.time < rpc_endpoint.time < rpc_mapper.time + 2 seconds) and (rpc_mapper.src_ip == rpc_endpoint.src_ip and rpc_mapper.dest_ip == rpc_endpoint.dest_ip)) .006 Windows Remote Management Monitor network data for uncommon data flows. Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. Network Analysis frameworks such as Zeek can be used to capture, decode, and alert on RPC network flows. When a Windows Remote Management connection is opened, the client sends HTTP requests to port 5985 for HTTP or 5986 for HTTPS on the target host. Each HTTP(S) request to the URI \"/wsman\" is called, and other information is set in the headers. Depending on the operation, the HTTP method may vary (i.e., GET, POST, etc.). This analytic would detect Remote PowerShell, as well as other communications that rely on WinRM. Additionally, it outputs the executable on the client host, the connection information, and the hostname of the target host. Look for network connections to port 5985 and 5986. To really decipher what is going on, these outputs should be fed into something that can do packet analysis. Note: Traffic to the RPC Endpoint Mapper will always have the destination port of 135. Assuming success, RPC traffic will continue to the endpoint. The endpoint and the client both bind to dynamically assigned ports (on Windows, this is typically greater than 49152). The traffic between the client and endpoint can be detected by looking at traffic to 135 followed by traffic where the source and destination ports are at least 49152. Analytic 1 - RPC Activity rpc_mapper = filter flows where (dest_port == 135)rpc_endpoint = filter flows where (dest_port >= 49152 and src_port >= 49152)rpc = join rpc_mapper, rpc_endpoint where ( (rpc_mapper.time < rpc_endpoint.time < rpc_mapper.time + 2 seconds) AND (rpc_mapper.src_ip == rpc_endpoint.src_ip AND rpc_mapper.dest_ip == rpc_endpoint.dest_ip)) Analytic 2 - WinRM winrm = filter flow where (dest_port == 5985)winrm_s = filter flow where (dest_port == 5986) ICS T0886 Remote Services Monitor network data for uncommon data flows (e.g., time of day, unusual source/destination address) that may be related to abuse of Valid Accounts to log into a service specifically designed to accept remote connections, such as RDP, Telnet, SSH, and VNC. ICS T0846 Remote System Discovery Monitor for new ICS protocol connections to existing assets or for device scanning (i.e., a host connecting to many devices) over ICS and enterprise protocols (e.g., ICMP, DCOM, WinRM). For added context on adversary enterprise procedures and background see Remote System Discovery. ICS T0888 Remote System Information Discovery Monitor for new ICS protocol connections to existing assets or for device scanning (i.e., a host connecting to many devices) over ICS and enterprise protocols (e.g., ICMP, DCOM, WinRM). Enterprise T1496 Resource Hijacking Monitor network data for uncommon data flows. Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. ICS T0848 Rogue Master Monitor for network traffic originating from unknown/unexpected devices or addresses. Local network traffic metadata could be used to identify unexpected connections, including unknown/unexpected source MAC addresses connecting to ports associated with operational protocols. Also, network management protocols such as DHCP and ARP may be helpful in identifying unexpected devices. Enterprise T1053 .002 Scheduled Task/Job: At Monitor network data for uncommon data flows. Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. When AT.exe is used to remotely schedule tasks, Windows uses named pipes over SMB to communicate with the API on the remote machine. After authentication over SMB, the Named Pipe ATSVC is opened, over which the JobAdd function is called. On the remote host, the job files are created by the Task Scheduler and follow the convention C:\\Windows\\System32\\AT. This pipe activity could be discovered with a network decoder, such as that in wireshark, that can inspect SMB traffic to identify the use of pipes. It could also be detected by looking for raw packet capture streams or from a custom sensor on the host that hooks the appropriate API functions. If no network or API level of visibility is possible, this traffic may inferred by looking at SMB connections over 445/tcp followed by the creation of files matching the pattern C:\\Windows\\System32\\AT\\<job_id>. To detect AT via network traffic, a sensor is needed that has the ability to extract and decode PCAP information. Specifically, it needs to properly decode SMB and the functions that are implemented over it via NamedPipes. If a sensor meets these criteria, then the PCAP data needs to search for instances of the command JobAdd over the pipe ATSVC, which is all implemented over Windows SMB 445/tcp. Analytic 1 - Remotely Scheduled Tasks via AT flows = search Flow:Messageat_proto = filter flows where (dest_port == 445 and proto_info.pipe == \"ATSVC\")at_create = filter flows where (proto_info.function == \"JobAdd\") .005 Scheduled Task/Job: Scheduled Task Monitor network data for uncommon data flows. Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. Look for RPC traffic after being mapped, which implies a destination port of at least 49152. If network inspection is available via packet captures or a NIDS, then traffic through the ITaskSchedulerService interface can be detected. Microsoft has a list of the possible methods that are implemented for the ITaskSchedulerService interface, which may be useful in differentiating read and query operations from creations and modifications. When scheduled tasks are created remotely, Windows uses RPC (135/tcp) to communicate with the Task Scheduler on the remote machine. Once an RPC connection is established, the client communicates with the Scheduled Tasks endpoint, which runs within the service group netsvcs. With packet capture and the right packet decoders or byte-stream based signatures, remote invocations of these functions can be identified.Certain strings can be identifiers of the schtasks, by looking up the interface UUID of ITaskSchedulerService in different formats UUID 86d35949-83c9-4044-b424-db363231fd0c (decoded) Hex 49 59 d3 86 c9 83 44 40 b4 24 db 36 32 31 fd 0c (raw) ASCII IYD@$621 (printable bytes only) This identifier is present three times during the RPC request phase. Any sensor that has access to the byte code as raw, decoded, or ASCII could implement this analytic. Analytic 1 - Remotely Scheduled Tasks via Schtasks schtasks_rpc = filter flows where (src_port >= 49152 AND dest_port >= 49152 AND proto_info.rpc_interface == \"ITaskSchedulerService\")sch_create = filter flows where (proto_info.function == \"SchRpcRegisterTask\" OR proto_info.function == \"SchRpcRun\" OR proto_info.function == \"SchRpcEnableTask\") Enterprise T1029 Scheduled Transfer Monitor for network traffic originating from unknown/unexpected hardware devices. Local network traffic metadata (such as source MAC addressing) as well as usage of network management protocols such as DHCP may be helpful in identifying hardware. Enterprise T1505 Server Software Component Monitor network data for uncommon data flows. Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. .003 Web Shell Monitor network data for uncommon data flows. Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. ICS T0856 Spoof Reporting Message Various techniques enable spoofing a reporting message. Consider monitoring for Rogue Master and Adversary-in-the-Middle activity which may precede this technique. ICS T0869 Standard Application Layer Protocol Monitor and analyze traffic flows that do not follow the expected protocol standards and traffic flows (e.g., extraneous packets that do not belong to established flows , or gratuitous or anomalous traffic patterns). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g., monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). Enterprise T1033 System Owner/User Discovery Monitor network data for uncommon data flows. Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. Enterprise T1569 .002 System Services: Service Execution Monitor network data for uncommon data flows. Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. Analytic 1 - Service Control Manager spawning Command Shell service_proto = filter flows where (dest_port == 445 and proto_info.pipe == \"SVCCTL\")service_create = filter flows where (proto_info.function == \"CreateServiceW\" OR proto_info.function == \"CreateServiceA\" OR proto_info.function == \"StartServiceW\" OR proto_info.function == \"StartServiceA\" ) Enterprise T1205 Traffic Signaling Monitor and analyze network flows associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, or gratuitous or anomalous traffic patterns). Consider analyzing newly constructed network connections that are sent or received by untrusted hosts, unexpcted hardware devices, or other uncommon data flows. .001 Port Knocking Monitor and analyze network flows associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, or gratuitous or anomalous traffic patterns). Consider analyzing newly constructed network connections that are sent or received by untrusted hosts, unexpcted hardware devices, or other uncommon data flows. ICS T0864 Transient Cyber Asset Monitor for network traffic originating from unknown/unexpected hardware devices. Local network traffic metadata (such as source MAC addressing) may be helpful in identifying transient assets. ICS T0855 Unauthorized Command Message Monitor for new or unexpected connections to controllers, which could indicate an Unauthorized Command Message being sent via Rogue Master. Enterprise T1102 Web Service Monitor network data for uncommon data flows. Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. .001 Dead Drop Resolver Monitor network data for uncommon data flows. Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. .002 Bidirectional Communication Monitor network data for uncommon data flows. Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. .003 One-Way Communication Monitor network data for uncommon data flows. Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. ICS T0860 Wireless Compromise New or irregular network traffic flows may indicate potentially unwanted devices or sessions on wireless networks. In Wi-Fi networks monitor for changes such as rogue access points or low signal strength, indicating a device is further away from the access point then expected and changes in the physical layer signal.[15] [16] Network traffic content will provide important context, such as hardware (e.g., MAC) addresses, user accounts, and types of messages sent. ICS T0887 Wireless Sniffing Purely passive network sniffing cannot be detected effectively. In cases where the adversary interacts with the wireless network (e.g., joining a Wi-Fi network) detection may be possible. Monitor for new or irregular network traffic flows which may indicate potentially unwanted devices or sessions on wireless networks. In Wi-Fi networks monitor for changes such as rogue access points or low signal strength, indicating a device is further away from the access point then expected and changes in the physical layer signal.[15] [16] Network traffic content will provide important context, such as hardware (e.g., MAC) addresses, user accounts, and types of messages sent. References Cisco. (n.d.). Cisco IOS Software Integrity Assurance - Secure Boot. Retrieved October 19, 2020. Cisco. (n.d.). Cisco IOS Software Integrity Assurance - Cisco IOS Image File Verification. Retrieved October 19, 2020. Jamie Harries. (2022, May 25). Hunting a Global Telecommunications Threat: DecisiveArchitect and Its Custom Implant JustForFun. Retrieved October 18, 2022. Gardiner, J., Cova, M., Nagaraja, S. (2014, February). Command & Control Understanding, Denying and Detecting. Retrieved April 20, 2016. Microsoft. (2020, October 13). Anti-spoofing protection in EOP. Retrieved October 19, 2020. Australian Cyber Security Centre. (2012, December). Mitigating Spoofed Emails Using Sender Policy Framework. Retrieved October 19, 2020. Spencer S. (2018, February 22). DCSYNCMonitor. Retrieved March 30, 2018. Delpy, B. & LE TOUX, V. (n.d.). DCShadow. Retrieved March 20, 2018. US-CERT. (2015, November 13). Compromised Web Servers and Web Shells - Threat Awareness and Guidance. Retrieved June 8, 2016. Perry, David. (2020, August 11). WakeOnLAN (WOL). Retrieved February 17, 2021. Jacobs, J. (2014, October 2). Building a DGA Classifier: Part 2, Feature Engineering. Retrieved February 18, 2019. Chen, L., Wang, T.. (2017, May 5). Detecting Algorithmically Generated Domains Using Data Visualization and N-Grams Methods . Retrieved April 26, 2019. Ahuja, A., Anderson, H., Grant, D., Woodbridge, J.. (2016, November 2). Predicting Domain Generation Algorithms with Long Short-Term Memory Networks. Retrieved April 26, 2019. Communications Security, Reliability, Interoperability Council (CSRIC). (2017, March). Working Group 10 Legacy Systems Risk Reductions Final Report. Retrieved May 24, 2017. Koopmann, Lennart. (n.d.). Nzyme Alerts Introduction. Retrieved September 26, 2022. Tomko, A.; Rieser, C; Buell, H.; Zeret, D.; Turner, W.. (2007, March). Wireless Intrusion Detection. Retrieved September 26, 2022. "
},
{
"id": 1983,
"title": "Image, Data Source DS0007",
"path": "/datasources/DS0007/index.html",
"content": " Image A single file used to deploy a virtual machine/bootable disk into an on-premise or third-party cloud environment[1][2] ID: DS0007 \u24d8 Platform: IaaS \u24d8 Collection Layer: Cloud Control Plane Contributors: Center for Threat-Informed Defense (CTID) Version: 1.0 Created: 20 October 2021 Last Modified: 10 November 2021 Version Permalink Live Version Data Components This data source does not have any techniques in the selected domain(s) Image: Image Creation Initial construction of a virtual machine image (ex: Azure Compute Service Images PUT) Image: Image Creation Initial construction of a virtual machine image (ex: Azure Compute Service Images PUT) Domain ID Name Detects Enterprise T1612 Build Image on Host Monitor for unexpected Docker image build requests to the Docker daemon on hosts in the environment. Enterprise T1525 Implant Internal Image Monitor interactions with images and containers by users to identify ones that are added anomalously. Enterprise T1204 User Execution Monitor for newly constructed image that may use an existing, legitimate external Web service to exfiltrate data rather than their primary command and control channel. .003 Malicious Image Monitor the local image registry to make sure malicious images are not added. Image: Image Deletion Removal of a virtual machine image (ex: Azure Compute Service Images DELETE) Image: Image Deletion Removal of a virtual machine image (ex: Azure Compute Service Images DELETE) Domain ID Name Detects Enterprise T1485 Data Destruction Monitor for unexpected deletion of a virtual machine image (ex: Azure Compute Service Images DELETE) Image: Image Metadata Contextual data about a virtual machine image such as name, resource group, state, or type Image: Image Metadata Contextual data about a virtual machine image such as name, resource group, state, or type Domain ID Name Detects Enterprise T1564 .006 Hide Artifacts: Run Virtual Instance Consider monitoring the size of virtual machines running on the system. Adversaries may create virtual images which are smaller than those of typical virtual machines.[3] Network adapter information may also be helpful in detecting the use of virtual instances. Enterprise T1525 Implant Internal Image Periodically baseline virtual machine images to identify malicious modifications or additions. Enterprise T1036 Masquerading Collecting disk and resource filenames for binaries, comparing that the InternalName, OriginalFilename, and/or ProductName match what is expected, could provide useful leads but may not always be indicative of malicious activity. [4] .005 Match Legitimate Name or Location In containerized environments, use image IDs and layer hashes to compare images instead of relying only on their names.[5] Monitor for the unexpected creation of new resources within your cluster in Kubernetes, especially those created by atypical users. Image: Image Modification Changes made to a virtual machine image, including setting and/or control data (ex: Azure Compute Service Images PATCH) Image: Image Modification Changes made to a virtual machine image, including setting and/or control data (ex: Azure Compute Service Images PATCH) Domain ID Name Detects Enterprise T1525 Implant Internal Image Monitor interactions with images and containers by users to identify ones that are modified anomalously.In containerized environments, changes may be detectable by monitoring the Docker daemon logs or setting up and monitoring Kubernetes audit logs depending on registry configuration. References Microsoft. (2021, August 23). Create a managed image of a generalized VM in Azure. Retrieved October 13, 2021. Amazon. (n.d.). Amazon Machine Images (AMI). Retrieved October 13, 2021. Johann Rehberger. (2020, September 23). Beware of the Shadowbunny - Using virtual machines to persist and evade detections. Retrieved September 22, 2021. Ewing, P. (2016, October 31). How to Hunt: The Masquerade Ball. Retrieved October 31, 2016. Docker. (n.d.). Docker Images. Retrieved April 6, 2021. "
},
{
"id": 1984,
"title": "Logon Session, Data Source DS0028",
"path": "/datasources/DS0028/index.html",
"content": " Logon Session Logon occurring on a system or resource (local, domain, or cloud) to which a user/device is gaining access after successful authentication and authorization[1] ID: DS0028 \u24d8 Platforms: Azure AD, Google Workspace, IaaS, Linux, Office 365, SaaS, Windows, macOS \u24d8 Collection Layers: Cloud Control Plane, Host, Network Contributors: Center for Threat-Informed Defense (CTID) Version: 1.1 Created: 20 October 2021 Last Modified: 07 December 2022 Version Permalink Live Version Data Components This data source does not have any techniques in the selected domain(s) Logon Session: Logon Session Creation Initial construction of a successful new user logon following an authentication attempt. (e.g. Windows EID 4624, /var/log/utmp, or /var/log/wmtp) Logon Session: Logon Session Creation Initial construction of a successful new user logon following an authentication attempt. (e.g. Windows EID 4624, /var/log/utmp, or /var/log/wmtp) Domain ID Name Detects Enterprise T1185 Browser Session Hijacking Authentication logs can be used to audit logins to specific web applications, but determining malicious logins versus benign logins may be difficult if activity matches typical user behavior. Enterprise T1538 Cloud Service Dashboard Monitor for newly constructed logon behavior across cloud service management consoles.[2] Enterprise T1213 Data from Information Repositories Monitor for newly constructed logon behavior within Microsoft's SharePoint can be configured to report access to certain pages and documents. [3] Sharepoint audit logging can also be configured to report when a user shares a resource. [4]The user access logging within Atlassian's Confluence can also be configured to report access to certain pages and documents through AccessLogFilter. [5] Additional log storage and analysis infrastructure will likely be required for more robust detection capabilities. .001 Confluence Monitor for newly constructed logon behavior across Atlassian's Confluence which can be configured to report access to certain pages and documents through AccessLogFilter. [5] Additional log storage and analysis infrastructure will likely be required for more robust detection capabilities. .002 Sharepoint Monitor for newly constructed logon behavior across Microsoft's SharePoint which can be configured to report access to certain pages and documents. [3] As information repositories generally have a considerably large user base, detection of malicious use can be non-trivial. .003 Code Repositories Monitor for newly constructed logon behavior across code repositories (e.g. Github) which can be configured to report access to certain pages and documents. ICS T0811 Data from Information Repositories Monitor for newly constructed logon behavior within Microsoft's SharePoint can be configured to report access to certain pages and documents.[3] Sharepoint audit logging can also be configured to report when a user shares a resource.[4] The user access logging within Atlassian's Confluence can also be configured to report access to certain pages and documents through AccessLogFilter.[5] Additional log storage and analysis infrastructure will likely be required for more robust detection capabilities. ICS T0812 Default Credentials Monitor logon sessions for default credential use. Enterprise T1114 Email Collection Monitor for unusual login activity from unknown or abnormal locations, especially for privileged accounts (ex: Exchange administrator account). .002 Remote Email Collection Monitor for unusual login activity from unknown or abnormal locations, especially for privileged accounts (ex: Exchange administrator account). Enterprise T1606 Forge Web Credentials Monitor for anomalous authentication activity, such as logons or other user session activity associated with unknown accounts and/or using SAML tokens which do not have corresponding 4769 and 1200 events in the domain.[6]. Monitor for unexpected and abnormal access to resources, including access of websites and cloud-based applications by the same user in different locations or by different systems that do not match expected configurations. These logins may occur on any on-premises resources as well as from any cloud environment that trusts the credentials.[7] .001 Web Cookies Monitor for anomalous authentication activity, such as logons or other user session activity associated with unknown accounts. Monitor for unexpected and abnormal access to resources, including access of websites and cloud-based applications by the same user in different locations or by different systems that do not match expected configurations. .002 SAML Tokens Monitor for logins using SAML tokens which do not have corresponding 4769 and 1200 events in the domain.[6] These logins may occur on any on-premises resources as well as from any cloud environment that trusts the certificate.[7] ICS T0823 Graphical User Interface Monitor for user accounts logged into systems they would not normally access or abnormal access patterns, such as multiple systems over a relatively short period of time. Correlate use of login activity related to remote services with unusual behavior or other malicious or suspicious activity. Remote Services may be used to access a host\u2019s GUI. ICS T0891 Hardcoded Credentials Monitor logon sessions for hardcoded credential use, when feasible. Enterprise T1556 Modify Authentication Process Monitor for newly constructed logon behavior across systems that share accounts, either user, admin, or service accounts. Examples: one account logged into multiple systems simultaneously; multiple accounts logged into the same machine simultaneously; accounts logged in at odd times (ex: when the user is not present) or outside of business hours. Activity may be from interactive login sessions or process ownership from accounts being used to execute binaries on a remote system as a particular account. Correlate other security systems with login information (e.g., a user has an active login session but has not entered the building or does not have VPN access). Configure robust, consistent account activity audit policies across the enterprise and with externally accessible services.[8] .001 Domain Controller Authentication Monitor for newly constructed logon behavior across systems that share accounts, either user, admin, or service accounts. Examples: one account logged into multiple systems simultaneously; multiple accounts logged into the same machine simultaneously; accounts logged in at odd times (ex: when the user is not present) or outside of business hours. Activity may be from interactive login sessions or process ownership from accounts being used to execute binaries on a remote system as a particular account. Correlate other security systems with login information (e.g., a user has an active login session but has not entered the building or does not have VPN access). Configure robust, consistent account activity audit policies across the enterprise and with externally accessible services.[8] .003 Pluggable Authentication Modules Monitor for newly constructed logon behavior across systems that share accounts, either user, admin, or service accounts. Examples: one account logged into multiple systems simultaneously; multiple accounts logged into the same machine simultaneously; accounts logged in at odd times (ex: when the user is not present) or outside of business hours. Activity may be from interactive login sessions or process ownership from accounts being used to execute binaries on a remote system as a particular account. Correlate other security systems with login information (e.g., a user has an active login session but has not entered the building or does not have VPN access). .006 Multi-Factor Authentication Monitor for logon sessions for user accounts and devices that did not require MFA for authentication. .007 Hybrid Identity Monitor for discrepancies in authentication to cloud services, such as PTA sign-ins recorded in Azure AD that lack corresponding events in AD.[9] Enterprise T1621 Multi-Factor Authentication Request Generation Monitor 2FA/MFA application logs for suspicious events such as rapid login attempts with valid credentials. Enterprise T1003 .001 OS Credential Dumping: LSASS Memory Monitor for newly constructed logon behavior from credentials being accessed by process memory of the LSASS. For example, detect behaviors of Secretsdump against a system, not being a Domain Controller. Enterprise T1563 Remote Service Session Hijacking Monitor for user accounts logged into systems they would not normally access or access patterns to multiple systems over a relatively short period of time. .001 SSH Hijacking Monitor for user accounts logged into systems they would not normally access or access patterns to multiple systems over a relatively short period of time. Also monitor user SSH-agent socket files being used by different users. .002 RDP Hijacking Use of RDP may be legitimate, depending on the network environment and how it is used. Other factors, such as access patterns and activity that occurs after a remote login, may indicate suspicious or malicious behavior with RDP. Windows security log Event ID 4624 (An account was successfully logged on) is generated when a user logs onto a remote machine using RDP. Correlating logon session creation events with RDP network flows can provide a clearer picture of RDP activity and serve as a useful starting point for investigating suspicious RDP connections. Enterprise T1021 Remote Services Monitor for user accounts logged into systems they would not normally access or abnormal access patterns, such as multiple systems over a relatively short period of time. Correlate use of login activity related to remote services with unusual behavior or other malicious or suspicious activity. Adversaries will likely need to learn about an environment and the relationships between systems through Discovery techniques prior to attempting Lateral Movement. For example, in macOS you can review logs for \"screensharingd\" and \"Authentication\" event messages. [10][11] Note: When using Security event id 4624, %$ means user names that do not end with $ character. Usually, computer accounts or local system accounts names end with the $ character. When using Security event 4624, UserName and UserLogonId correspond to TargetUserName and TargetLogonId respectively. When using Security event 4624, LogonType 3 corresponds to a Network Logon Analytic 1 - New services being created under network logon sessions by non-system users remote_logon_sessions = filter Hostname, UserName, UserLogonId, SourceIp where event_id == \"4624\" AND LogonType == \"3\" AND UserName NOT LIKE '%$' new_services = filter UserName, UserLogonId, ServiceName where event_id = \"4697\" suspicious_services = filter l.UserName, l.UserLogonId, l.SourceIp, s.ServicenameFROM remote_logon_sessions lINNER JOIN new_services sON l.UserLogonId = s.UserLogonId .001 Remote Desktop Protocol Monitor for user accounts logged into systems associated with RDP (ex: Windows EID 4624 Logon Type 10). Other factors, such as access patterns (ex: multiple systems over a relatively short period of time) and activity that occurs after a remote login, may indicate suspicious or malicious behavior with RDP. Monitoring logon and logoff events for hosts on the network is very important for situational awareness. This information can be used as an indicator of unusual activity as well as to corroborate activity seen elsewhere. Could be applied to a number of different types of monitoring depending on what information is desired. Some use cases include monitoring for all remote connections and building login timelines for users. Logon events are Windows Event Code 4624 for Windows Vista and above, 518 for pre-Vista. Logoff events are 4634 for Windows Vista and above, 538 for pre-Vista. Analytic filtered_logons = filter logon_events where ( (event_id = \"4624\") AND user NOT IN TOP30(user)) .002 SMB/Windows Admin Shares Monitor for logon behavior (ex: EID 4624 Logon Type 3) using Valid Accounts to interact with a remote network share using Server Message Block (SMB). The adversary may then perform actions as the logged-on user. Ensure that proper logging of accounts used to log into systems is turned on and centrally collected. Windows logging is able to collect success/failure for accounts that may be used to move laterally and can be collected using tools such as Windows Event Forwarding. [12][13] .004 SSH Monitor for user accounts logged into systems that may use Valid Accounts to log into remote machines using Secure Shell (SSH). For example, on Linux systems SSH logon activity can be found in the logs located in /var/log/auth.log or /var/log/secure depending on the distro you are using. For Linux systems, the Audit framework (auditd) can be used to monitor any writes to SSH log files that store information about logged in accounts such as /var/log/auth.log. For macOS systems (10.12+), Unified Logs can be queried to show SSH daemon (sshd) messages that include information on logged in accounts. The following command-line can be used to query the last hour\u2019s worth of unified logs in this manner: log show -info --debug --predicate 'processImagePath CONTAINS \"sshd\" AND eventMessage CONTAINS \"Accepted\"' --last 1h | grep sshd .005 VNC Monitor for user accounts logged into systems that may use Valid Accounts to remotely control machines using Virtual Network Computing (VNC). For example, on macOS systems log show --predicate 'process = \"screensharingd\" and eventMessage contains \"Authentication:\"' can be used to review incoming VNC connection attempts for suspicious activity.[11] .006 Windows Remote Management Monitor for user accounts logging into the system via Valid Accounts to interact with remote systems using Windows Remote Management (WinRM). The adversary may then perform actions as the logged-on user. .007 Cloud Services Monitor for newly constructed logon behavior to cloud services. For example, in Azure AD, consider using Identity Protection to monitor for suspicious login behaviors to cloud resources. [14] .008 Direct Cloud VM Connections Monitor cloud audit logs and host logs for logon session events. These can be found in CloudTrail, Unified Audit Logs, Windows Event Logs and /var/log/auth.log or /var/log/secure for Linux systems. ICS T0886 Remote Services Monitor for user accounts logged into systems they would not normally access or abnormal access patterns, such as multiple systems over a relatively short period of time. Correlate use of login activity related to remote services with unusual behavior or other malicious or suspicious activity. Adversaries will likely need to learn about an environment and the relationships between systems through Discovery techniques prior to attempting Lateral Movement. For added context on adversary procedures and background see Remote Services and applicable sub-techniques. Enterprise T1649 Steal or Forge Authentication Certificates Monitor certificate-based authentication events, such as EID 4768 when an AD CS certificate is used for Kerberos authentication (especially those that don\u2019t correspond to legitimately issued certificates) or when Secure Channel (Schannel, associated with SSL/TLS) is highlighted as the Logon Process associated with an EID 4624 logon event.[15] Enterprise T1199 Trusted Relationship Monitor for newly constructed logon behavior that may breach or otherwise leverage organizations who have access to intended victims. Enterprise T1550 Use Alternate Authentication Material Look for suspicious account behavior across systems that share accounts, either user, admin, or service accounts. Examples: one account logged into multiple systems simultaneously; multiple accounts logged into the same machine simultaneously; accounts logged in at odd times or outside of business hours. Activity may be from interactive login sessions or process ownership from accounts being used to execute binaries on a remote system as a particular account. .002 Pass the Hash Monitor newly created logons and credentials used in events and review for discrepancies. Unusual remote logins that correlate with other suspicious activity (such as writing and executing binaries) may indicate malicious activity. Note: Analytic Event ID is for Windows Security Log (Event ID 4624 - An account was successfully logged on). The successful use of Pass the Hash for lateral movement between workstations would trigger Event ID 4624, with an event level of Information, from the Windows Security log. This event would show an account logon with a LogonType of 3 using NTLM authentication, a logon that is not a domain logon, and the user account not being the ANONYMOUS LOGON account. Analytic 1 logons = filter log_events where (event_id== \"4624\" AND target_user_name != \"ANONYMOUS LOGON\" ANDauthentication_package_name == \"NTLM\") .003 Pass the Ticket Monitor for newly constructed logon behavior that may \"pass the ticket\" using stolen Kerberos tickets to move laterally within an environment, bypassing normal system access controls. Enterprise T1078 Valid Accounts Monitor for newly constructed logon behavior that may obtain and abuse credentials of existing accounts as a means of gaining Initial Access, Persistence, Privilege Escalation, or Defense Evasion. Correlate other security systems with login information (e.g., a user has an active login session but has not entered the building or does not have VPN access). .001 Default Accounts Monitor for newly constructed logon behavior across default accounts that have been activated or logged into. These audits should also include checks on any appliances and applications for default credentials or SSH keys, and if any are discovered, they should be updated immediately. .002 Domain Accounts Monitor for suspicious account behavior across systems that share accounts, either user, admin, or service accounts. Examples: one account logged into multiple systems simultaneously; multiple accounts logged into the same machine simultaneously; accounts logged in at odd times or outside of business hours. Activity may be from interactive login sessions or process ownership from accounts being used to execute binaries on a remote system as a particular account. A remote desktop logon, through Remote Desktop Protocol, may be typical of a system administrator or IT support, but only from select workstations. Monitoring remote desktop logons and comparing to known/approved originating systems can detect lateral movement of an adversary. Multiple users logged into a single machine at the same time, or even within the same hour, do not typically occur in networks we have observed.Logon events are Windows Event Code 4624 for Windows Vista and above, 518 for pre-Vista. Logoff events are 4634 for Windows Vista and above, 538 for pre-Vista. Logon types 2, 3, 9 and 10 are of interest. For more details see the Logon Types table on Microsoft\u2019s Audit Logon Events page. Analytic 1 - Remote Desktop Logon suspicious_netconn = filter network_connections where (event_id = \"4624\" AND AuthenticationPackageName = 'Negotiate' AND Severity = \"Information\" AND logon_type = \"10\") Analytic 2 - Simultaneous Logins on a Host users_grouped = group users_list by hostnameusers_grouped = from users_grouped select min(time) as earliest_time, max(time) as latest_time count(user) as user_countmultiple_logins = filter users_grouped where (latest_time - earliest_time <= 1 hour and user_count > 1) .003 Local Accounts Monitor for suspicious account behavior across systems that share accounts, either user, admin, or service accounts. Examples: one account logged into multiple systems simultaneously; multiple accounts logged into the same machine simultaneously; accounts logged in at odd times or outside of business hours. Activity may be from interactive login sessions or process ownership from accounts being used to execute binaries on a remote system as a particular account. A remote desktop logon, through Remote Desktop Protocol, may be typical of a system administrator or IT support, but only from select workstations. Monitoring remote desktop logons and comparing to known/approved originating systems can detect lateral movement of an adversary. Multiple users logged into a single machine at the same time, or even within the same hour, do not typically occur in networks we have observed.Logon events are Windows Event Code 4624 for Windows Vista and above, 518 for pre-Vista. Logoff events are 4634 for Windows Vista and above, 538 for pre-Vista. Logon types 2, 3, 9 and 10 are of interest. For more details see the Logon Types table on Microsoft\u2019s Audit Logon Events page. Analytic 1 - Remote Desktop Logon suspicious_netconn = filter network_connections where (event_id = \"4624\" AND AuthenticationPackageName = 'Negotiate' AND Severity = \"Information\" AND logon_type = \"10\") Analytic 2 - Simultaneous Logins on a Host users_grouped = group users_list by hostnameusers_grouped = from users_grouped select min(time) as earliest_time, max(time) as latest_time count(user) as user_countmultiple_logins = filter users_grouped where (latest_time - earliest_time <= 1 hour and user_count > 1) .004 Cloud Accounts Monitor for suspicious account behavior across cloud services that share account. ICS T0859 Valid Accounts Monitor for logon behavior that may abuse credentials of existing accounts as a means of gaining Lateral Movement or Persistence. Correlate other security systems with login information (e.g., a user has an active login session but has not entered the building or does not have VPN access). ICS T0860 Wireless Compromise Monitor login sessions for new or unexpected devices or sessions on wireless networks. Logon Session: Logon Session Metadata Contextual data about a logon session, such as username, logon type, access tokens (security context, user SIDs, logon identifiers, and logon SID), and any activity associated within it Logon Session: Logon Session Metadata Contextual data about a logon session, such as username, logon type, access tokens (security context, user SIDs, logon identifiers, and logon SID), and any activity associated within it Domain ID Name Detects Enterprise T1133 External Remote Services Follow best practices for detecting adversary use of Valid Accounts for authenticating to remote services. Collect authentication logs and analyze for unusual access patterns, windows of activity, and access outside of normal business hours. ICS T0822 External Remote Services Monitor authentication logs and analyze for unusual access patterns, windows of activity, and access outside of normal business hours, including use of Valid Accounts. Enterprise T1606 .002 Forge Web Credentials: SAML Tokens Consider modifying SAML responses to include custom elements for each service provider. Monitor these custom elements in service provider access logs to detect any anomalous requests.[6] ICS T0883 Internet Accessible Device Monitor logon activity for unexpected or unusual access to devices from the Internet. Enterprise T1621 Multi-Factor Authentication Request Generation Monitor 2FA/MFA application logs for suspicious events such as unusual login attempt source location, mismatch in location of login attempt and smart device approving 2FA/MFA request prompts. Enterprise T1021 .001 Remote Services: Remote Desktop Protocol Monitor authentication logs and analyze for unusual access patterns. A remote desktop logon, through RDP, may be typical of a system administrator or IT support, but only from select workstations. Monitoring remote desktop logons and comparing to known/approved originating systems can detect lateral movement of an adversary. Analytic suspicious_logon = filter logons where (event_id = \"4624\" AND AuthenticationPackageName = 'Negotiate' AND Severity = \"Information\" AND logon_type = \"10\") Enterprise T1558 Steal or Forge Kerberos Tickets Enable Audit Kerberos Service Ticket Operations to log Kerberos TGS service ticket requests. Particularly investigate irregular patterns of activity (ex: accounts making numerous requests, Event ID 4769, within a small time frame, especially if they also request RC4 encryption [Type 0x17]).[16] [17] .001 Golden Ticket Monitor for anomalous Kerberos activity, such as malformed or blank fields in Windows logon/logoff events (Event ID 4624, 4634, 4672). Correlate other security systems with login information (e.g., a user has the KRBTGT account password hash and forges Kerberos ticket-granting tickets). .002 Silver Ticket Monitor for anomalous Kerberos activity, such as malformed or blank fields in Windows logon/logoff events (Event ID 4624, 4634, 4672). Enterprise T1199 Trusted Relationship Correlate other security systems with login information (e.g., a user has an active login session but has not entered the building or does not have VPN access). Enterprise T1078 Valid Accounts Look for suspicious account behavior across systems that share accounts, either user, admin, or service accounts. Examples: one account logged into multiple systems simultaneously; multiple accounts logged into the same machine simultaneously; accounts logged in at odd times or outside of business hours. Activity may be from interactive login sessions or process ownership from accounts being used to execute binaries on a remote system as a particular account. .002 Domain Accounts Correlate other security systems with login information (e.g., a user has an active login session but has not entered the building or does not have VPN access). .003 Local Accounts Correlate other security systems with login information (e.g., a user has an active login session but has not entered the building or does not have VPN access). .004 Cloud Accounts Correlate other security systems with login information (e.g., a user has an active login session but has not entered the building or does not have VPN access). ICS T0859 Valid Accounts Monitor for suspicious account behavior across systems that share accounts, either user, admin, or service accounts. Examples: one account logged into multiple systems simultaneously; multiple accounts logged into the same machine simultaneously; accounts logged in at odd times or outside of business hours. Activity may be from interactive login sessions or process ownership from accounts being used to execute binaries on a remote system as a particular account. References Microsoft. (2021, September 6). Audit logon events. Retrieved September 28, 2021. Pany, D. & Hanley, C. (2023, May 3). Cloudy with a Chance of Bad Logs: Cloud Platform Log Configurations to Consider in Investigations. Retrieved October 16, 2023. Microsoft. (2017, July 19). Configure audit settings for a site collection. Retrieved April 4, 2018. Microsoft. (n.d.). Sharepoint Sharing Events. Retrieved October 8, 2021. Atlassian. (2018, January 9). How to Enable User Access Logging. Retrieved April 4, 2018. Sygnia. (2020, December). Detection and Hunting of Golden SAML Attack. Retrieved January 6, 2021. MSRC. (2020, December 13). Customer Guidance on Recent Nation-State Cyber Attacks. Retrieved December 17, 2020. Microsoft. (2016, April 15). Audit Policy Recommendations. Retrieved June 3, 2016. Dr. Nestori Syynimaa. (2022, September 20). Exploiting Azure AD PTA vulnerabilities: Creating backdoor and harvesting credentials. Retrieved September 28, 2022. Dan Borges. (2019, July 21). MacOS Red Teaming 206: ARD (Apple Remote Desktop Protocol). Retrieved September 10, 2021. Sarah Edwards. (2020, April 30). Analysis of Apple Unified Logs: Quarantine Edition [Entry 6] \u2013 Working From Home? Remote Logins. Retrieved August 19, 2021. Payne, J. (2015, November 26). Tracking Lateral Movement Part One - Special Groups and Specific Service Accounts. Retrieved February 1, 2016. Payne, J. (2015, November 23). Monitoring what matters - Windows Event Forwarding for everyone (even if you already have a SIEM.). Retrieved February 1, 2016. Microsoft. (2022, August 26). Protecting Microsoft 365 from on-premises attacks. Retrieved February 21, 2023. Schroeder, W. & Christensen, L. (2021, June 22). Certified Pre-Owned - Abusing Active Directory Certificate Services. Retrieved August 2, 2022. Bani, M. (2018, February 23). Detecting Kerberoasting activity using Azure Security Center. Retrieved March 23, 2018. Metcalf, S. (2015, December 31). Cracking Kerberos TGS Tickets Using Kerberoast \u2013 Exploiting Kerberos to Compromise the Active Directory Domain. Retrieved March 22, 2018. "
}
]